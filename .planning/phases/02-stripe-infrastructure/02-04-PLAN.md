---
phase: 02-stripe-infrastructure
plan: 04
type: execute
wave: 3
depends_on: ["02-01", "02-02", "02-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Stripe secrets are configured in Supabase project"
    - "Migrations are deployed to live database"
    - "Edge Functions are deployed and callable"
    - "Webhook endpoint is registered in Stripe Dashboard"
  artifacts: []
  key_links:
    - from: "Supabase secrets"
      to: "Edge Functions"
      via: "Deno.env.get() reads from supabase secrets"
      pattern: "STRIPE_SECRET_KEY|STRIPE_WEBHOOK_SECRET"
---

<objective>
Deploy all Phase 02 artifacts to the live environment: push database migrations, deploy Edge Functions, configure Supabase secrets for Stripe, and verify the Stripe webhook endpoint registration.

Purpose: Without deployment and secret configuration, the tables and functions created in Plans 01-03 are just local files. This plan bridges from local code to running infrastructure.
Output: Live database has 3 new tables, 2 Edge Functions are deployed and responding, Stripe secrets are configured.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-stripe-infrastructure/02-01-SUMMARY.md
@.planning/phases/02-stripe-infrastructure/02-02-SUMMARY.md
@.planning/phases/02-stripe-infrastructure/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Push database migrations and deploy Edge Functions</name>
  <files></files>
  <action>
**Step 1: Push database migrations to live Supabase:**
```bash
npx supabase db push --linked
```
This applies the 3 new migration files (stripe_customers, webhook_events, payment_intents) to the live database.

If `supabase db push` is not available or fails due to CLI issues, use the Supabase SQL Editor (MCP or dashboard) to run each migration SQL manually in order:
1. 20260218120000_stripe_customers_table.sql
2. 20260218120001_webhook_events_table.sql
3. 20260218120002_payment_intents_table.sql

**Step 2: Verify tables exist in live database:**
Run via SQL Editor or supabase CLI:
```sql
SELECT table_name FROM information_schema.tables
WHERE table_schema = 'public'
AND table_name IN ('stripe_customers', 'webhook_events', 'payment_intents');
```
Should return 3 rows.

**Step 3: Deploy create-payment-intent Edge Function:**
```bash
npx supabase functions deploy create-payment-intent --project-ref qbaiviuluiqdbaymgxhq
```
If this fails because the function needs `--no-verify-jwt` (it requires JWT by default, which is what we want), just deploy normally.

**Step 4: Deploy payment-webhook Edge Function:**
```bash
npx supabase functions deploy payment-webhook --project-ref qbaiviuluiqdbaymgxhq --no-verify-jwt
```
IMPORTANT: payment-webhook MUST use `--no-verify-jwt` because Stripe sends webhooks without a JWT. The function handles its own authentication via HMAC signature verification.

**Step 5: Verify Edge Functions are responding:**
```bash
# create-payment-intent should return 401 (no JWT provided)
curl -s -o /dev/null -w "%{http_code}" https://qbaiviuluiqdbaymgxhq.supabase.co/functions/v1/create-payment-intent

# payment-webhook should return 400 (no stripe-signature header)
curl -s -o /dev/null -w "%{http_code}" -X POST https://qbaiviuluiqdbaymgxhq.supabase.co/functions/v1/payment-webhook
```
Expected: create-payment-intent returns 401, payment-webhook returns 400 or 401.
  </action>
  <verify>
- `supabase db push` completes without errors (or manual SQL execution succeeds)
- SQL query confirms 3 tables exist in public schema
- `supabase functions deploy` succeeds for both functions
- curl to create-payment-intent returns 401 (auth required)
- curl to payment-webhook returns 400 (missing signature header)
  </verify>
  <done>
Database migrations applied (3 tables live), both Edge Functions deployed and responding to HTTP requests.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Configure Stripe secrets in Supabase</name>
  <what-built>Database tables and Edge Functions are deployed. Edge Functions need Stripe API keys to function.</what-built>
  <action>
The user needs to set Supabase secrets for the Stripe integration. Claude cannot retrieve these from the Stripe Dashboard.

**Required secrets to set:**

1. Get your Stripe Secret Key from: Stripe Dashboard -> Developers -> API keys -> Secret key
   - Use `sk_test_...` for test mode

2. Get your Stripe Webhook Secret from: Stripe Dashboard -> Developers -> Webhooks
   - If webhook endpoint does not exist yet, create one:
     - URL: `https://qbaiviuluiqdbaymgxhq.supabase.co/functions/v1/payment-webhook`
     - Events to listen for: `payment_intent.succeeded`, `payment_intent.payment_failed`, `payment_intent.canceled`, `payment_intent.requires_action`, `charge.refunded`
   - Copy the Signing secret (starts with `whsec_...`)

3. Set the secrets in Supabase:
```bash
npx supabase secrets set STRIPE_SECRET_KEY=sk_test_your_key_here --project-ref qbaiviuluiqdbaymgxhq
npx supabase secrets set STRIPE_WEBHOOK_SECRET=whsec_your_secret_here --project-ref qbaiviuluiqdbaymgxhq
```

Or via Supabase Dashboard -> Edge Functions -> Secrets.

**Stripe Dashboard webhook configuration:**
- Endpoint URL: `https://qbaiviuluiqdbaymgxhq.supabase.co/functions/v1/payment-webhook`
- Events: payment_intent.succeeded, payment_intent.payment_failed, payment_intent.canceled, payment_intent.requires_action, charge.refunded
- API version: Leave as default (account default)
  </action>
  <how-to-verify>
After setting secrets, verify by sending a test webhook from Stripe Dashboard:
1. Go to Stripe Dashboard -> Developers -> Webhooks -> Select endpoint
2. Click "Send test webhook"
3. Select event type "payment_intent.succeeded"
4. Click "Send test webhook"
5. Check that the response status is 200 (not 500 or timeout)

Alternatively, check Supabase Edge Function logs:
- Supabase Dashboard -> Edge Functions -> payment-webhook -> Logs
- Should see log entries from the test webhook (may show "Signature verification failed" if Stripe sends test events differently -- that is OK for initial verification; the important thing is the function is running)
  </how-to-verify>
  <resume-signal>Type "secrets configured" after setting STRIPE_SECRET_KEY and STRIPE_WEBHOOK_SECRET, and creating the webhook endpoint in Stripe Dashboard</resume-signal>
</task>

</tasks>

<verification>
1. 3 tables exist in live Supabase database (stripe_customers, webhook_events, payment_intents)
2. create-payment-intent Edge Function deployed and returns 401 on unauthenticated request
3. payment-webhook Edge Function deployed with --no-verify-jwt and returns 400 on request without signature
4. STRIPE_SECRET_KEY and STRIPE_WEBHOOK_SECRET set as Supabase secrets
5. Webhook endpoint registered in Stripe Dashboard with correct URL and event subscriptions
</verification>

<success_criteria>
- All 3 migration files applied to live database
- Both Edge Functions deployed and HTTP-reachable
- Stripe secrets configured in Supabase
- Webhook endpoint registered in Stripe Dashboard
- Test webhook from Stripe returns 200 from payment-webhook function
</success_criteria>

<output>
After completion, create `.planning/phases/02-stripe-infrastructure/02-04-SUMMARY.md`
</output>
