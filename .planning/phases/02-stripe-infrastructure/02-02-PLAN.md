---
phase: 02-stripe-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
# NOTE: 02-02 and 02-03 can execute concurrently after 02-01 completes.
# They modify different files with no overlap.
files_modified:
  - supabase/functions/create-payment-intent/index.ts
autonomous: true
user_setup:
  - service: stripe
    why: "Payment processing - Edge Function needs Stripe API key"
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Secret key (sk_test_... for test mode)"
    dashboard_config:
      - task: "Ensure Stripe account is in Mexico mode (MXN currency)"
        location: "Stripe Dashboard -> Settings -> Business -> Country"

must_haves:
  truths:
    - "Edge Function accepts POST with unit_id, amount, description, idempotency_key, payment_method_type"
    - "Function validates JWT and extracts user identity"
    - "Function verifies amount does not exceed unit's outstanding balance (total_receivable)"
    - "Function creates or retrieves existing Stripe Customer for the resident+unit"
    - "Function creates a Stripe PaymentIntent with the correct idempotency key"
    - "Function inserts a record into payment_intents table"
    - "Function returns clientSecret and paymentIntentId to the mobile client"
    - "Function returns proper error responses (401, 400, 422, 500) with JSON error messages"
  artifacts:
    - path: "supabase/functions/create-payment-intent/index.ts"
      provides: "Edge Function for creating Stripe PaymentIntents"
      min_lines: 100
  key_links:
    - from: "create-payment-intent"
      to: "stripe_customers table"
      via: "get-or-create pattern using supabase service_role client"
      pattern: "stripe_customers"
    - from: "create-payment-intent"
      to: "payment_intents table"
      via: "INSERT after Stripe API call"
      pattern: "payment_intents"
    - from: "create-payment-intent"
      to: "unit_balances view"
      via: "SELECT total_receivable to validate amount"
      pattern: "unit_balances"
    - from: "create-payment-intent"
      to: "Stripe API"
      via: "stripe.paymentIntents.create()"
      pattern: "paymentIntents\\.create"
---

<objective>
Create the `create-payment-intent` Edge Function that mobile clients call to initiate a payment. This function handles the full flow: validate JWT, verify amount against unit balance, get-or-create Stripe Customer, create Stripe PaymentIntent, save to payment_intents table, and return the clientSecret for the mobile PaymentSheet.

Purpose: This is the server-side entry point for all payments. The mobile app calls this before showing the Stripe PaymentSheet. It enforces business rules (amount validation) and creates the audit trail in payment_intents.
Output: A single Deno Edge Function file ready for deployment via `supabase functions deploy`.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-stripe-infrastructure/02-01-SUMMARY.md

Reference for Edge Function patterns:
- Supabase Edge Functions use Deno runtime (Deno 2)
- Import Stripe: `import Stripe from "npm:stripe@17"`
- Import Supabase: `import { createClient } from "jsr:@supabase/supabase-js@2"`
- Env vars: `Deno.env.get("STRIPE_SECRET_KEY")`, `Deno.env.get("SUPABASE_URL")`, `Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")`
- JWT auth: create user client from Authorization header, then call supabase.auth.getUser()
- CORS: must handle OPTIONS preflight and set Access-Control headers

Reference for DB state:
@supabase/migrations/20260129192018_unit_balances_view.sql (unit_balances.total_receivable)
@supabase/migrations/20260129191023_record_payment_charge.sql (record_payment signature)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create the create-payment-intent Edge Function</name>
  <files>supabase/functions/create-payment-intent/index.ts</files>
  <action>
Create `supabase/functions/create-payment-intent/index.ts` as a Deno Edge Function.

**Request format:**
```typescript
// POST /functions/v1/create-payment-intent
// Headers: Authorization: Bearer <jwt>
// Body:
{
  unit_id: string,        // UUID of the unit being paid for
  amount: number,         // Amount in MXN (e.g., 1500.00)
  description: string,    // e.g., "Cuota Mantenimiento Febrero 2026"
  idempotency_key: string, // Client-generated UUID to prevent double-charge
  payment_method_type?: string // 'card' (default) or 'oxxo'
}
```

**Implementation flow (in order):**

1. **CORS handling**: Return 200 for OPTIONS with `Access-Control-Allow-Origin: *`, `Access-Control-Allow-Headers: authorization, x-client-info, apikey, content-type`.

2. **Reject non-POST**: Return 405 Method Not Allowed.

3. **Initialize clients**:
   - Stripe client: `new Stripe(Deno.env.get("STRIPE_SECRET_KEY")!, { apiVersion: "2025-04-30.basil" })` -- use latest API version. If the exact version causes issues, use `"2024-12-18.acacia"` which is the latest stable.
   - Supabase service client (for DB writes): `createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY)`
   - Supabase user client (for auth): `createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { global: { headers: { Authorization: req.headers.get("Authorization")! } } })`

4. **Authenticate user**: `const { data: { user }, error } = await userClient.auth.getUser()`. Return 401 if error or no user.

5. **Parse and validate body**: Extract unit_id, amount, description, idempotency_key, payment_method_type. Return 400 if any required field missing. Default payment_method_type to 'card'.

6. **Get user's resident record**: Query `residents` table where `user_id = user.id AND deleted_at IS NULL`. Return 403 if not a resident.

7. **Verify unit access**: Query `occupancies` table where `resident_id = resident.id AND unit_id = body.unit_id AND deleted_at IS NULL`. Return 403 if no active occupancy.

8. **Validate amount against balance**: Query `unit_balances` view where `unit_id = body.unit_id`. Check `amount <= total_receivable`. Return 422 with message "Amount exceeds outstanding balance" if over. Also check `amount > 0` and `amount <= 999999.99` (Stripe MXN max). Return 400 for invalid amounts.

9. **Get or create Stripe Customer**:
   - Query `stripe_customers` where `resident_id = resident.id AND unit_id = body.unit_id AND deleted_at IS NULL`.
   - If exists, use that `stripe_customer_id`.
   - If not, create via `stripe.customers.create({ email: user.email, name: resident.first_name + ' ' + resident.last_name, metadata: { community_id: resident.community_id, resident_id: resident.id, unit_id: body.unit_id } })`, then INSERT into `stripe_customers` table.

10. **Create Stripe PaymentIntent**:
    ```typescript
    const paymentIntent = await stripe.paymentIntents.create({
      amount: Math.round(body.amount * 100), // Stripe uses centavos
      currency: 'mxn',
      customer: stripeCustomerId,
      description: body.description,
      payment_method_types: body.payment_method_type === 'oxxo' ? ['oxxo'] : ['card'],
      metadata: {
        community_id: resident.community_id,
        unit_id: body.unit_id,
        resident_id: resident.id,
        idempotency_key: body.idempotency_key,
      },
    }, {
      idempotencyKey: body.idempotency_key,
    });
    ```

11. **Insert payment_intents record**: INSERT into `payment_intents` with community_id, unit_id, resident_id, stripe_payment_intent_id, stripe_customer_id, amount, currency ('MXN'), status (paymentIntent.status), payment_method_type, description, idempotency_key, metadata, expires_at (set for OXXO: now + 48 hours).

12. **Return response**:
    ```json
    {
      "clientSecret": paymentIntent.client_secret,
      "paymentIntentId": paymentIntent.id,
      "customerId": stripeCustomerId,
      "status": paymentIntent.status
    }
    ```
    With status 201.

**Error handling**: Wrap the entire flow in try/catch. Catch Stripe errors specifically (`error.type === 'StripeCardError'` etc.) and return appropriate status codes. For Stripe rate limit errors, return 429. For all others, return 500 with `{ error: "Internal server error" }` (do NOT leak Stripe error details to client in production, but log them with console.error).

**Security considerations**:
- Do NOT import or use `SUPABASE_SERVICE_ROLE_KEY` for anything except DB writes after authentication is confirmed.
- Validate all inputs (UUID format, positive amount, string lengths).
- The idempotency_key in the DB protects against duplicate DB records; the Stripe idempotencyKey protects against duplicate Stripe charges.

**OXXO specifics**: When payment_method_type is 'oxxo', set `payment_method_options: { oxxo: { expires_after_days: 2 } }` in the Stripe create call, and set expires_at on the payment_intents record to `new Date(Date.now() + 48 * 60 * 60 * 1000).toISOString()`.
  </action>
  <verify>
Verify the file:
1. Imports use Deno-compatible paths: `npm:stripe@17`, `jsr:@supabase/supabase-js@2`
2. CORS handler returns proper headers
3. Auth flow: getUser() -> resident lookup -> occupancy check (3-step authorization)
4. Amount validation checks unit_balances.total_receivable
5. Get-or-create Stripe Customer pattern (query first, create if not found, insert into stripe_customers)
6. Stripe PaymentIntent created with idempotencyKey
7. payment_intents record inserted with all required fields
8. Response includes clientSecret, paymentIntentId
9. Error responses return JSON with appropriate HTTP status codes
10. No secrets leaked in error responses
  </verify>
  <done>
Edge Function file exists at supabase/functions/create-payment-intent/index.ts with complete implementation: JWT auth, amount validation against unit_balances, get-or-create Stripe Customer, PaymentIntent creation with idempotency, payment_intents table insert, and clientSecret response. Handles both card and OXXO payment method types.
  </done>
</task>

</tasks>

<verification>
1. File exists: supabase/functions/create-payment-intent/index.ts
2. Function handles CORS preflight (OPTIONS -> 200)
3. Function authenticates via JWT (Authorization header)
4. Function validates resident has occupancy in the target unit
5. Function checks amount against unit_balances.total_receivable
6. Function uses get-or-create pattern for stripe_customers
7. Function creates Stripe PaymentIntent with idempotency
8. Function inserts into payment_intents table
9. Function returns { clientSecret, paymentIntentId } on success
10. All error paths return JSON with proper HTTP status codes
</verification>

<success_criteria>
- create-payment-intent/index.ts exists with >100 lines of implementation
- Uses Deno imports (npm:stripe@17, jsr:@supabase/supabase-js@2)
- 3-step auth: JWT -> resident -> occupancy
- Amount validated against unit_balances.total_receivable
- Stripe Customer get-or-create with stripe_customers table
- PaymentIntent created with idempotency_key
- payment_intents record saved to DB
- Supports card and oxxo payment_method_type
- Returns clientSecret for mobile PaymentSheet
</success_criteria>

<output>
After completion, create `.planning/phases/02-stripe-infrastructure/02-02-SUMMARY.md`
</output>
