---
phase: 12-admin-dashboard-operations
plan: 03
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - packages/admin/src/hooks/useAnnouncements.ts
  - packages/admin/src/components/announcements/AnnouncementForm.tsx
  - packages/admin/src/components/announcements/RecipientTable.tsx
  - packages/admin/src/app/(dashboard)/operations/announcements/page.tsx
  - packages/admin/src/app/(dashboard)/operations/announcements/[id]/page.tsx
  - packages/mobile/src/hooks/useAnnouncements.ts
  - packages/mobile/app/(resident)/announcements/_layout.tsx
  - packages/mobile/app/(resident)/announcements/index.tsx
  - packages/mobile/app/(resident)/announcements/[id].tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view list of announcements with status (draft, published, scheduled), read count, and creation date"
    - "Admin can create a new announcement with title, body, target segment (all, owners, tenants, building, delinquent), schedule, urgency flag, and acknowledgment requirement"
    - "After creating an announcement, expand_announcement_recipients() RPC is called to generate recipient records"
    - "Admin can view read receipts for an announcement showing which residents read it and when"
    - "Resident can view a feed of announcements sorted by date with unread indicator"
    - "Resident can open an announcement and it is automatically marked as read"
  artifacts:
    - path: "packages/admin/src/hooks/useAnnouncements.ts"
      provides: "Announcement queries and mutations (list, detail, create with recipient expansion, recipients)"
    - path: "packages/admin/src/app/(dashboard)/operations/announcements/page.tsx"
      provides: "Announcement list page with create form"
    - path: "packages/admin/src/app/(dashboard)/operations/announcements/[id]/page.tsx"
      provides: "Announcement detail with read receipts table"
    - path: "packages/mobile/src/hooks/useAnnouncements.ts"
      provides: "Mobile announcement feed query and mark-read mutation"
    - path: "packages/mobile/app/(resident)/announcements/index.tsx"
      provides: "Announcement feed screen with unread indicators"
    - path: "packages/mobile/app/(resident)/announcements/[id].tsx"
      provides: "Announcement detail screen that marks as read on mount"
  key_links:
    - from: "packages/admin/src/hooks/useAnnouncements.ts"
      to: "expand_announcement_recipients RPC"
      via: "supabase.rpc('expand_announcement_recipients', { p_announcement_id: id })"
    - from: "packages/mobile/src/hooks/useAnnouncements.ts"
      to: "announcement_recipients table"
      via: "supabase.from('announcement_recipients').update({ read_at }) where resident_id = residentId"
---

<objective>
Build admin announcement management (create with targeting, read receipts) and resident announcement feed (view and mark as read) on both platforms.

Purpose: Announcements are the primary admin-to-resident communication channel. Admin needs to create targeted announcements and track who read them. Residents need to see and acknowledge announcements.
Output: Admin announcement hooks/pages (list, create, detail with read receipts), mobile announcement hooks/screens (feed, detail with auto-read).
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-admin-dashboard-operations/12-RESEARCH.md
@.planning/phases/12-admin-dashboard-operations/12-01-SUMMARY.md

Key existing files to reference:
@packages/admin/src/hooks/useResidents.ts
@packages/admin/src/app/(dashboard)/residents/page.tsx
@packages/admin/src/components/ui/DataTable.tsx
@packages/admin/src/components/ui/Card.tsx
@packages/mobile/src/hooks/useAuth.ts
@packages/mobile/app/(resident)/visitors/index.tsx
@packages/mobile/app/(resident)/visitors/[id].tsx
@packages/shared/src/queries/keys.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin announcement hooks, components, and pages</name>
  <files>
    packages/admin/src/hooks/useAnnouncements.ts
    packages/admin/src/components/announcements/AnnouncementForm.tsx
    packages/admin/src/components/announcements/RecipientTable.tsx
    packages/admin/src/app/(dashboard)/operations/announcements/page.tsx
    packages/admin/src/app/(dashboard)/operations/announcements/[id]/page.tsx
  </files>
  <action>
**1. Create `packages/admin/src/hooks/useAnnouncements.ts`:**

Follow the established pattern (lazy createClient in queryFn, useAuth, queryKeys, toast from sonner).

Hooks:
- `useAnnouncements(filters)` -- paginated list. Filters: search (title ilike), page, pageSize. Select: `id, title, target_segment, publish_at, is_urgent, requires_acknowledgment, total_recipients, read_count, created_at, created_by`. Order by `created_at` descending. Use `queryKeys.announcements.list(communityId!)` with filters. Count: exact.

- `useAnnouncement(id)` -- detail query. Select: `*`. Single row by id. Use `queryKeys.announcements.detail(id)`.

- `useAnnouncementRecipients(announcementId, page, pageSize)` -- paginated list of recipients. Select from `announcement_recipients`: `id, resident_id, read_at, acknowledged_at, residents!inner(first_name, paternal_surname, email)`. Filter by `announcement_id`. Order by `read_at` descending nulls last. Count: exact. Use `queryKeys.announcements.recipients(announcementId)`.

- `useCreateAnnouncement()` -- mutation with TWO steps:
  1. Insert into `announcements` table: `community_id`, `title`, `body`, `target_segment`, `target_criteria` (JSON, nullable), `publish_at` (default to now if not scheduled), `is_urgent` (default false), `requires_acknowledgment` (default false), `created_by` from `supabase.auth.getUser()`. Select the inserted row.
  2. IMMEDIATELY call `supabase.rpc('expand_announcement_recipients', { p_announcement_id: announcement.id })` to generate recipient records. This is NOT automatic -- it MUST be called explicitly. If this RPC call fails, throw the error (the announcement was already created but has no recipients).
  On success: toast "Aviso enviado a {recipientCount} destinatarios". Invalidate announcements queries.

- `useDeleteAnnouncement()` -- mutation: soft-delete by updating `deleted_at = now()`. Invalidate queries.

**2. Create `packages/admin/src/components/announcements/AnnouncementForm.tsx`:**

A modal/inline form component for creating announcements. Props: `onSubmit(data)`, `onCancel()`, `isSubmitting: boolean`.

Form fields:
- Title: text input, required
- Body: textarea (multiline), required, with basic text formatting hint ("Puedes usar saltos de linea")
- Target segment: dropdown select with options matching the DB enum: `all` (Todos), `owners` (Propietarios), `tenants` (Inquilinos), `building` (Por edificio -- shows building text input when selected), `delinquent` (Morosos), `role` (Por rol -- shows role select when selected)
- When "building" or "role" is selected, show an additional input for `target_criteria` (building name string or role name). Store as JSON: `{ building: "A" }` or `{ role: "resident" }`.
- Schedule: optional date-time input. If empty, publish immediately. If set, schedule for that time.
- Urgency toggle: checkbox "Marcar como urgente"
- Acknowledgment toggle: checkbox "Requiere confirmacion de lectura"

Submit button: "Publicar Aviso" (or "Programar Aviso" if scheduled).

**3. Create `packages/admin/src/components/announcements/RecipientTable.tsx`:**

Props: `announcementId: string, requiresAcknowledgment: boolean`.

Uses `useAnnouncementRecipients(announcementId, page, pageSize)` internally. Renders a DataTable with columns:
- Resident name (first_name + paternal_surname)
- Email
- Read status: "Leido" with date or "No leido" (Badge success/neutral)
- If requiresAcknowledgment: Acknowledged status column

Summary row above table: "X de Y destinatarios han leido este aviso" with a percentage.

**4. Create `packages/admin/src/app/(dashboard)/operations/announcements/page.tsx`:**

`'use client'; export const dynamic = 'force-dynamic';`

Structure:
- Page header: "Avisos" with "Nuevo Aviso" button
- Search input (debounced)
- DataTable with columns: Title (as Link to detail), Target segment (badge), Published date (formatted), Recipients (total_recipients), Read count / total with percentage, Urgency (red badge if urgent)
- Pagination via DataTable
- Create modal/overlay: when "Nuevo Aviso" is clicked, show AnnouncementForm. On submit call useCreateAnnouncement.

**5. Create `packages/admin/src/app/(dashboard)/operations/announcements/[id]/page.tsx`:**

`'use client'; export const dynamic = 'force-dynamic';`

- Back link to `/operations/announcements`
- Header: announcement title, target segment badge, published date, urgency badge
- Body card: rendered announcement body (preserve newlines with `whitespace-pre-wrap`)
- Stats row: total recipients, read count, read percentage, acknowledged count (if applicable)
- RecipientTable component showing read receipts
  </action>
  <verify>
Run `npx tsc --noEmit` from packages/admin. Navigate to `/operations/announcements` in browser. Create an announcement and verify recipient expansion call happens. View announcement detail with read receipts table.
  </verify>
  <done>
Admin can view announcements list, create new announcements with targeting, recipients are expanded via RPC call, and admin can view read receipts per announcement. All files compile.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create mobile announcement feed and detail screens</name>
  <files>
    packages/mobile/src/hooks/useAnnouncements.ts
    packages/mobile/app/(resident)/announcements/_layout.tsx
    packages/mobile/app/(resident)/announcements/index.tsx
    packages/mobile/app/(resident)/announcements/[id].tsx
  </files>
  <action>
**1. Create `packages/mobile/src/hooks/useAnnouncements.ts`:**

Follow the mobile hook pattern (import supabase from `@/lib/supabase`, useAuth for residentId/communityId).

Hooks:
- `useAnnouncementFeed()` -- query: select from `announcement_recipients` where `resident_id = residentId`. Join announcement data: `announcement_id, read_at, acknowledged_at, announcements!inner(id, title, body, target_segment, is_urgent, requires_acknowledgment, publish_at, created_at)`. Filter: `announcements.publish_at <= now()` (only published), `announcements.deleted_at IS NULL`. Order by `announcements.created_at` descending. Use `queryKeys.announcements.feed(residentId!)`.

  NOTE: The query fetches via `announcement_recipients` (which only has records for the current resident after `expand_announcement_recipients` was called). This naturally filters to announcements targeting this resident.

- `useAnnouncementDetail(id)` -- query: select single announcement by id from `announcements`. Select `*`. Use `queryKeys.announcements.detail(id)`.

- `useMarkAnnouncementRead()` -- mutation: update `announcement_recipients` set `read_at = new Date().toISOString()` where `announcement_id = id` AND `resident_id = residentId` AND `read_at IS NULL` (only update if not already read). On success invalidate feed query. No toast needed.

- `useAcknowledgeAnnouncement()` -- mutation: update `announcement_recipients` set `acknowledged_at = new Date().toISOString()` where `announcement_id = id` AND `resident_id = residentId`. On success invalidate feed and detail queries. Toast: "Aviso confirmado".

**2. Create `packages/mobile/app/(resident)/announcements/_layout.tsx`:**
Stack layout identical to visitors/_layout.tsx pattern:
```typescript
import { Stack } from 'expo-router';
export default function AnnouncementsLayout() {
  return <Stack screenOptions={{ headerShown: false }}>
    <Stack.Screen name="index" />
    <Stack.Screen name="[id]" />
  </Stack>;
}
```

**3. Create `packages/mobile/app/(resident)/announcements/index.tsx`:**

Feed screen:
- Header: "Avisos"
- Use `useAnnouncementFeed()` to fetch
- FlatList of announcement cards. Each card shows:
  - Title (bold)
  - Truncated body (2 lines max with `numberOfLines={2}`)
  - Published date (relative time with date-fns `formatDistanceToNow`)
  - Urgency: if `is_urgent`, show red "URGENTE" badge
  - Unread indicator: if `read_at` is null, show blue dot on the left side of the card
- Each card is a Pressable navigating to `/announcements/${announcement_id}`
- Empty state: "No hay avisos" with icon
- Loading state: skeleton cards
- Pull to refresh via FlatList `onRefresh` prop

**4. Create `packages/mobile/app/(resident)/announcements/[id].tsx`:**

Detail screen:
- Header: back button + "Aviso"
- Use `useAnnouncementDetail(id)` (id from useLocalSearchParams)
- On mount (useEffect), call `useMarkAnnouncementRead` mutation with the announcement id. This auto-marks as read when the resident opens it.
- Content:
  - Title (large, bold)
  - Published date (formatted)
  - Urgency badge if applicable
  - Body text (full, with whitespace-pre-wrap equivalent -- just render as Text)
  - If `requires_acknowledgment`: show "Confirmar lectura" button at bottom. When pressed, call `useAcknowledgeAnnouncement`. Show checkmark and "Confirmado" if already acknowledged.
  </action>
  <verify>
Run `npx tsc --noEmit` from packages/mobile. Open app, navigate to announcements tab/screen. Verify feed renders with unread indicators. Open an announcement and verify it marks as read. If requires_acknowledgment, verify acknowledge button works.
  </verify>
  <done>
Resident can view announcement feed with unread indicators, open announcements (auto-marked as read), and acknowledge announcements when required. All 4 files compile and follow mobile patterns.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for both packages/admin and packages/mobile
2. Admin announcements list page renders with search and pagination
3. Create announcement form works with targeting options and calls expand_announcement_recipients RPC
4. Announcement detail shows read receipt table with read/unread status
5. Mobile feed shows announcements with unread dot indicator
6. Opening a mobile announcement auto-marks it as read
7. Acknowledge button works for announcements requiring acknowledgment
</verification>

<success_criteria>
- AOPS-04: Admin can create and schedule announcements with targeting -- COVERED by create form with segment options and schedule
- AOPS-05: Admin can view announcement read receipts -- COVERED by detail page RecipientTable
- RCOMM-01: Resident can view announcements feed sorted by date -- COVERED by mobile feed screen
- RCOMM-02: Resident can mark announcements as read -- COVERED by auto-read on detail open
- Note: RCOMM-03 (push notification for high-priority announcements) DEFERRED to Phase 16
</success_criteria>

<output>
After completion, create `.planning/phases/12-admin-dashboard-operations/12-03-SUMMARY.md`
</output>
