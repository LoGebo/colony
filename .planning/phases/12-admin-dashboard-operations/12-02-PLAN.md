---
phase: 12-admin-dashboard-operations
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - packages/mobile/src/hooks/useTickets.ts
  - packages/mobile/app/(resident)/maintenance/_layout.tsx
  - packages/mobile/app/(resident)/maintenance/index.tsx
  - packages/mobile/app/(resident)/maintenance/create.tsx
  - packages/mobile/app/(resident)/maintenance/[id].tsx
autonomous: true

must_haves:
  truths:
    - "Resident can see a list of their submitted maintenance tickets with status badges"
    - "Resident can submit a new maintenance request with title, description, category, priority, and photos"
    - "Resident can view the detail of a ticket including its status timeline and system-generated comments"
    - "Resident can add a comment to their ticket"
    - "Photos are uploaded to Supabase Storage ticket-attachments bucket before ticket creation"
  artifacts:
    - path: "packages/mobile/src/hooks/useTickets.ts"
      provides: "Mobile ticket queries and mutations (list own tickets, create ticket, ticket detail, add comment)"
    - path: "packages/mobile/app/(resident)/maintenance/index.tsx"
      provides: "Ticket list screen with create button"
    - path: "packages/mobile/app/(resident)/maintenance/create.tsx"
      provides: "Ticket creation form with category picker, priority, photo upload"
    - path: "packages/mobile/app/(resident)/maintenance/[id].tsx"
      provides: "Ticket detail with status timeline, comments, add comment form"
  key_links:
    - from: "packages/mobile/app/(resident)/maintenance/create.tsx"
      to: "packages/mobile/src/hooks/useTickets.ts"
      via: "useCreateTicket mutation"
    - from: "packages/mobile/src/hooks/useTickets.ts"
      to: "tickets table"
      via: "supabase.from('tickets').insert with reported_by = residentId (NOT auth.uid())"
    - from: "packages/mobile/app/(resident)/maintenance/create.tsx"
      to: "ticket-attachments bucket"
      via: "pickAndUploadImage from @/lib/upload"
---

<objective>
Build the resident-facing mobile maintenance screens: ticket list, ticket creation with photo attachments, and ticket detail with status timeline and comments.

Purpose: Residents need to submit maintenance requests and track their progress, completing the mobile side of the maintenance workflow that the admin dashboard (12-01) manages.
Output: Mobile ticket hooks, maintenance stack layout, ticket list/create/detail screens.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-admin-dashboard-operations/12-RESEARCH.md
@.planning/phases/12-admin-dashboard-operations/12-01-SUMMARY.md

Key existing files to reference:
@packages/mobile/src/hooks/useAuth.ts
@packages/mobile/src/hooks/useOccupancy.ts
@packages/mobile/src/hooks/useVisitors.ts
@packages/mobile/app/(resident)/visitors/_layout.tsx
@packages/mobile/app/(resident)/visitors/index.tsx
@packages/mobile/app/(resident)/visitors/create.tsx
@packages/mobile/app/(resident)/visitors/[id].tsx
@packages/mobile/app/(resident)/payments/upload-proof.tsx
@packages/mobile/src/lib/upload.ts
@packages/shared/src/constants/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mobile ticket hooks</name>
  <files>
    packages/mobile/src/hooks/useTickets.ts
  </files>
  <action>
Create `packages/mobile/src/hooks/useTickets.ts` following the exact same pattern as `useVisitors.ts` (import supabase from `@/lib/supabase`, useAuth for residentId/communityId, queryKeys from shared, TanStack Query hooks).

Include these hooks:

- `useMyTickets()` -- query: select from `tickets` where `community_id = communityId` AND `reported_by = residentId` (CRITICAL: use residentId, NOT auth.uid()). Select: `id, title, status, priority, created_at, ticket_categories(name, icon, color)`. Filter `deleted_at IS NULL`. Order by `created_at` descending. Use `queryKeys.tickets.list(communityId!)`.

- `useTicketDetail(id)` -- query: select single ticket by id. Select: `*, ticket_categories(name, icon, color), ticket_comments(id, content, author_id, author_role, is_system, is_internal, photo_urls, created_at)`. Use `queryKeys.tickets.detail(id)`.

- `useTicketCategories()` -- query: select from `ticket_categories` where `community_id = communityId` AND `is_active = true`. Select: `id, name, icon, color, description`. Used for the create form category picker.

- `useCreateTicket()` -- mutation: insert into `tickets` table with fields:
  - `community_id: communityId`
  - `reported_by: residentId` (CRITICAL: NOT auth.uid())
  - `unit_id: unitId` (from useResidentUnit, can be null)
  - `title, description, category_id, priority` from input
  - `location` from input (optional)

  After ticket insert, if `photo_paths` array is provided and non-empty, insert a ticket_comment with `author_id` from `supabase.auth.getUser()`, `author_role: 'reporter'`, `content: 'Fotos adjuntas al reporte'`, `photo_urls: photo_paths`, `is_internal: false`, `is_system: false`.

  On success: invalidate tickets queries, show no toast (let the screen handle navigation).

- `useAddComment()` -- mutation: insert into `ticket_comments` with `ticket_id`, `author_id` from `supabase.auth.getUser()`, `author_role: 'reporter'`, `content` from input, `is_internal: false`, `is_system: false`. On success invalidate ticket detail query.

Import `useResidentUnit` from `./useOccupancy` for the unitId in useCreateTicket.
  </action>
  <verify>
Run `npx tsc --noEmit` from packages/mobile root (or the shared typecheck script). Verify all hooks are exported and types resolve.
  </verify>
  <done>
All 5 hooks compile. `useCreateTicket` uses `residentId` for `reported_by` (not auth.uid()). Photo attachment creates a comment, not a field on the ticket itself.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create mobile maintenance screens</name>
  <files>
    packages/mobile/app/(resident)/maintenance/_layout.tsx
    packages/mobile/app/(resident)/maintenance/index.tsx
    packages/mobile/app/(resident)/maintenance/create.tsx
    packages/mobile/app/(resident)/maintenance/[id].tsx
  </files>
  <action>
Follow the exact same patterns as the existing visitors screens (`_layout.tsx`, `index.tsx`, `create.tsx`, `[id].tsx`). Use NativeWind classes for styling (className prop on RN components).

**1. `_layout.tsx` -- Stack layout:**
```typescript
import { Stack } from 'expo-router';

export default function MaintenanceLayout() {
  return (
    <Stack screenOptions={{ headerShown: false }}>
      <Stack.Screen name="index" />
      <Stack.Screen name="create" />
      <Stack.Screen name="[id]" />
    </Stack>
  );
}
```

**2. `index.tsx` -- Ticket list screen:**

- Header: "Mantenimiento" title with "+" button (navigates to `create`)
- Use `useMyTickets()` to fetch tickets
- FlatList or ScrollView of ticket cards, each showing:
  - Title (bold, truncated)
  - Category name + icon
  - Status badge (colored text: open=blue, assigned=amber, in_progress=amber, resolved=green, closed=gray, cancelled=red)
  - Priority indicator (low=gray, medium=blue, high=orange, urgent=red dot)
  - Relative time (e.g., "hace 2 horas") using date-fns `formatDistanceToNow` with `{ locale: es, addSuffix: true }`
- Each card is a Pressable that navigates to `/maintenance/${id}`
- Empty state: "No tienes tickets de mantenimiento" with a button to create one
- Loading state: skeleton cards (animated View placeholders)

**3. `create.tsx` -- Create ticket screen:**

- Header: "Nuevo Reporte" with back button
- ScrollView form with:
  - Category picker: horizontal ScrollView of category chips (from useTicketCategories). Selected chip is highlighted. Required field.
  - Title: TextInput, required, placeholder "Titulo breve del problema"
  - Description: multiline TextInput, required, placeholder "Describe el problema en detalle..."
  - Priority: 4 selectable chips (Baja, Media, Alta, Urgente) defaulting to "Media"
  - Location: optional TextInput, placeholder "Ubicacion (ej: Estacionamiento nivel 2)"
  - Photos section: "Agregar fotos" button that calls `pickAndUploadImage` from `@/lib/upload` with `STORAGE_BUCKETS.TICKET_ATTACHMENTS` bucket and communityId. Show photo previews (Image components with the uploaded URIs). Max 5 photos. Remove button on each photo.
  - Submit button: "Enviar Reporte" -- calls `useCreateTicket` mutation with form data + photo_paths array. On success navigate back to index. Show ActivityIndicator while submitting.

  Handle validation: title required (min 5 chars), description required (min 10 chars), category required. Show inline error messages.

**4. `[id].tsx` -- Ticket detail screen:**

- Header: back button + ticket title
- Use `useTicketDetail(id)` (id from `useLocalSearchParams`)
- ScrollView with:
  - Status section: large status badge, priority badge, category name
  - SLA info: if response_due_at exists, show "Respuesta esperada: {date}". If resolution_due_at exists, show "Resolucion esperada: {date}". If breached, show in red.
  - Description card: full ticket description
  - Timeline section: ordered list of `ticket_comments` by created_at. Each entry:
    - System comments (is_system=true): gray background, italic text, shows what changed (e.g., "Estado cambiado a Asignado")
    - User comments: white background, shows author_role label, content, timestamp
    - Photo comments: show small image thumbnails (Pressable to view full screen or open URL)
  - Add comment form at bottom: TextInput + "Enviar" button. Uses `useAddComment` mutation. Clear input on success.
  - Loading state: skeleton layout
  </action>
  <verify>
Run `npx tsc --noEmit` from packages/mobile. Open the app on simulator/Expo Go, navigate to maintenance tab (if present in tab nav) or deep link to `/maintenance`. Verify list, create, and detail screens render.
  </verify>
  <done>
Resident can view their ticket list, create a new ticket with photos (uploaded to Storage), view ticket detail with status timeline and comments, and add comments to their tickets. All 4 screens compile and follow existing mobile patterns.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for packages/mobile
2. Ticket list screen shows resident's own tickets (filtered by residentId, not auth.uid())
3. Create screen validates inputs, uploads photos to `ticket-attachments` bucket, inserts ticket with `reported_by = residentId`
4. Detail screen shows comment timeline including system-generated comments
5. Add comment form works and invalidates detail query
6. All screens follow NativeWind styling patterns consistent with existing visitor/payment screens
</verification>

<success_criteria>
- RMAINT-01: Resident can submit maintenance request with category, description, and photos -- COVERED by create screen
- RMAINT-02: Resident can view status timeline of their tickets -- COVERED by detail screen timeline
- RMAINT-04: Resident can add comments to their tickets -- COVERED by detail screen comment form
- Note: RMAINT-03 (push notifications on status changes) is DEFERRED to Phase 16
</success_criteria>

<output>
After completion, create `.planning/phases/12-admin-dashboard-operations/12-02-SUMMARY.md`
</output>
