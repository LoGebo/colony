---
phase: 12-admin-dashboard-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/shared/src/queries/keys.ts
  - packages/admin/src/app/(dashboard)/layout.tsx
  - packages/admin/src/hooks/useTickets.ts
  - packages/admin/src/components/tickets/TicketStatusBadge.tsx
  - packages/admin/src/components/tickets/TicketKanbanBoard.tsx
  - packages/admin/src/components/tickets/TicketSLAIndicator.tsx
  - packages/admin/src/app/(dashboard)/operations/page.tsx
  - packages/admin/src/app/(dashboard)/operations/tickets/page.tsx
  - packages/admin/src/app/(dashboard)/operations/tickets/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view maintenance tickets in a paginated table with search, status filter, and priority filter"
    - "Admin can toggle between table view and kanban board view grouped by ticket status"
    - "Admin can click a ticket to see its detail page with assignment, status workflow, comments, and SLA indicators"
    - "Admin can assign a ticket to a staff member and update ticket status (only valid transitions shown)"
    - "Admin sees SLA breach/warning indicators on tickets and aggregate SLA metrics on the tickets page"
    - "Operations sidebar nav item expands to show children sub-routes (Tickets, Avisos, Accesos, Documentos, Amenidades)"
  artifacts:
    - path: "packages/shared/src/queries/keys.ts"
      provides: "Query key factories for tickets, announcements, documents"
      contains: "tickets|announcements|documents"
    - path: "packages/admin/src/hooks/useTickets.ts"
      provides: "Ticket queries and mutations (list, detail, assign, update status, add comment, SLA metrics)"
    - path: "packages/admin/src/app/(dashboard)/operations/tickets/page.tsx"
      provides: "Ticket list page with table/kanban toggle, filters, SLA summary cards"
    - path: "packages/admin/src/app/(dashboard)/operations/tickets/[id]/page.tsx"
      provides: "Ticket detail with assignment, status transitions, timeline, SLA indicators"
  key_links:
    - from: "packages/admin/src/app/(dashboard)/operations/tickets/page.tsx"
      to: "packages/admin/src/hooks/useTickets.ts"
      via: "useTickets hook import"
    - from: "packages/admin/src/hooks/useTickets.ts"
      to: "packages/shared/src/queries/keys.ts"
      via: "queryKeys.tickets"
    - from: "packages/admin/src/app/(dashboard)/layout.tsx"
      to: "/operations/tickets"
      via: "sidebar nav children"
---

<objective>
Build the admin maintenance ticket dashboard with table/kanban views, ticket assignment, status workflow enforcement, and SLA metrics. Also add shared query key factories for all Phase 12 domains (tickets, announcements, documents) and expand the admin sidebar operations nav with children sub-routes.

Purpose: Gives administrators a full maintenance operations view -- the core of Phase 12. Establishes shared infrastructure (query keys, sidebar) for all subsequent Phase 12 plans.
Output: Shared query key factories, admin sidebar with operations children, ticket hooks, ticket components, ticket list page (table + kanban), ticket detail page.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-admin-dashboard-operations/12-RESEARCH.md

Key existing files to reference:
@packages/shared/src/queries/keys.ts
@packages/admin/src/app/(dashboard)/layout.tsx
@packages/admin/src/hooks/useResidents.ts
@packages/admin/src/app/(dashboard)/residents/page.tsx
@packages/admin/src/components/ui/DataTable.tsx
@packages/admin/src/components/ui/Badge.tsx
@packages/admin/src/components/ui/Card.tsx
@packages/admin/src/lib/export.ts
@packages/admin/src/lib/formatters.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add shared query key factories and update sidebar navigation</name>
  <files>
    packages/shared/src/queries/keys.ts
    packages/admin/src/app/(dashboard)/layout.tsx
  </files>
  <action>
**1. Add query key factories to `packages/shared/src/queries/keys.ts`:**

Add three new factories BEFORE the `queryKeys` merge call, following the exact same pattern as existing factories (e.g., `residents`, `accessLogs`):

```typescript
export const tickets = createQueryKeys('tickets', {
  all: null,
  list: (communityId: string) => [{ communityId }],
  detail: (id: string) => [id],
  comments: (ticketId: string) => [{ ticketId }],
  slaMetrics: (communityId: string) => [{ communityId }],
});

export const announcements = createQueryKeys('announcements', {
  all: null,
  list: (communityId: string) => [{ communityId }],
  detail: (id: string) => [id],
  recipients: (announcementId: string) => [{ announcementId }],
  feed: (residentId: string) => [{ residentId }],
});

export const documents = createQueryKeys('documents', {
  all: null,
  list: (communityId: string) => [{ communityId }],
  detail: (id: string) => [id],
  versions: (documentId: string) => [{ documentId }],
});
```

Then update the `mergeQueryKeys` call to include `tickets, announcements, documents`:

```typescript
export const queryKeys = mergeQueryKeys(
  residents, visitors, payments, accessLogs, amenities,
  notifications, kpis, communities, units, guards,
  packages, occupancies, shifts,
  tickets, announcements, documents,
);
```

**2. Update sidebar nav in `packages/admin/src/app/(dashboard)/layout.tsx`:**

Replace the existing operations nav item (line 30):
```typescript
{ href: '/operations', label: 'Operaciones', icon: 'wrench' },
```

With a nav item that has children (same pattern as the existing finances nav item):
```typescript
{
  href: '/operations',
  label: 'Operaciones',
  icon: 'wrench',
  children: [
    { href: '/operations/tickets', label: 'Tickets' },
    { href: '/operations/announcements', label: 'Avisos' },
    { href: '/operations/access-logs', label: 'Accesos' },
    { href: '/operations/documents', label: 'Documentos' },
    { href: '/operations/amenities', label: 'Amenidades' },
  ],
},
```
  </action>
  <verify>
Run `npx tsc --noEmit` from packages/shared to verify keys.ts compiles. Verify that `tickets`, `announcements`, `documents` are exported from `queryKeys`.
  </verify>
  <done>
`queryKeys.tickets.list(id)`, `queryKeys.announcements.list(id)`, `queryKeys.documents.list(id)` all resolve without TypeScript errors. Admin sidebar "Operaciones" item has 5 children sub-routes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ticket hooks, components, and page routes</name>
  <files>
    packages/admin/src/hooks/useTickets.ts
    packages/admin/src/components/tickets/TicketStatusBadge.tsx
    packages/admin/src/components/tickets/TicketKanbanBoard.tsx
    packages/admin/src/components/tickets/TicketSLAIndicator.tsx
    packages/admin/src/app/(dashboard)/operations/page.tsx
    packages/admin/src/app/(dashboard)/operations/tickets/page.tsx
    packages/admin/src/app/(dashboard)/operations/tickets/[id]/page.tsx
  </files>
  <action>
**1. Create `packages/admin/src/hooks/useTickets.ts`:**

Follow the exact same pattern as `useResidents.ts` (lazy `createClient()` inside queryFn, `useAuth()` for communityId, `toast` from sonner, `queryKeys` from shared).

Include these hooks:
- `useTickets(filters)` -- paginated list with search, status, priority filters. Select: `id, title, description, status, priority, created_at, response_due_at, resolution_due_at, response_breached, resolution_breached, first_responded_at, resolved_at, assigned_to, reported_by, ticket_categories(name, icon, color), residents!tickets_reported_by_fkey(first_name, paternal_surname)`. Use FK hint `residents!tickets_reported_by_fkey` to avoid ambiguous join. Count: exact. Order by `created_at` descending.
- `useTicket(id)` -- single ticket detail. Also select `ticket_assignments(id, assigned_to, assigned_by, notes, created_at), ticket_comments(id, content, author_id, author_role, is_system, is_internal, photo_urls, created_at)` in addition to above fields.
- `useAssignTicket()` -- mutation: insert into `ticket_assignments` table (ticket_id, assigned_to, assigned_by from auth.getUser(), notes). On success invalidate tickets queries. Then update ticket status to 'assigned' if currently 'open' (use `.eq('status', 'open')` filter so it's a no-op if already assigned).
- `useUpdateTicketStatus()` -- mutation: update `tickets` set `status = newStatus` where `id = ticketId`. The DB trigger validates transitions. On error show toast with the error message (which will include "Invalid ticket status transition..." if invalid).
- `useAddTicketComment()` -- mutation: insert into `ticket_comments` (ticket_id, author_id from auth.getUser(), author_role: 'admin', content, is_internal, is_system: false). Invalidate ticket detail query on success.
- `useTicketCategories()` -- query: select from `ticket_categories` where `community_id = communityId`, `is_active = true`. Used for filter dropdowns and ticket creation.
- `computeSLAMetrics(tickets)` -- exported utility function (not a hook). Takes array of ticket objects, returns `{ total, openCount, responseBreachRate, resolutionBreachRate, avgResponseMinutes, avgResolutionMinutes }`. Calculate avg response time from `first_responded_at - created_at` for tickets with `first_responded_at`. Calculate avg resolution time from `resolved_at - created_at` for tickets with `resolved_at`.

Also export the `VALID_TRANSITIONS` constant:
```typescript
export const VALID_TRANSITIONS: Record<string, string[]> = {
  open: ['assigned', 'cancelled'],
  assigned: ['in_progress', 'open', 'cancelled'],
  in_progress: ['pending_parts', 'pending_resident', 'resolved', 'assigned'],
  pending_parts: ['in_progress', 'cancelled'],
  pending_resident: ['in_progress', 'resolved', 'cancelled'],
  resolved: ['closed', 'in_progress'],
  closed: [],
  cancelled: [],
};
```

**2. Create `packages/admin/src/components/tickets/TicketStatusBadge.tsx`:**

A small component that maps ticket status to Badge variant and Spanish label:
```typescript
const statusVariant: Record<string, 'success' | 'info' | 'neutral' | 'warning' | 'danger'> = {
  open: 'info',
  assigned: 'warning',
  in_progress: 'warning',
  pending_parts: 'neutral',
  pending_resident: 'neutral',
  resolved: 'success',
  closed: 'success',
  cancelled: 'danger',
};
const statusLabel: Record<string, string> = {
  open: 'Abierto',
  assigned: 'Asignado',
  in_progress: 'En progreso',
  pending_parts: 'Pend. refacciones',
  pending_resident: 'Pend. residente',
  resolved: 'Resuelto',
  closed: 'Cerrado',
  cancelled: 'Cancelado',
};
```
Render `<Badge variant={statusVariant[status]}>{statusLabel[status]}</Badge>`.

**3. Create `packages/admin/src/components/tickets/TicketKanbanBoard.tsx`:**

Props: `tickets: Ticket[]`, `onTicketClick: (id: string) => void`.

Group tickets by status using `Object.groupBy` (or manual reduce for older targets). Render 6 CSS Grid columns for statuses: open, assigned, in_progress, pending_parts, pending_resident, resolved (exclude closed and cancelled -- they go in table view only).

Each column: gray-100 background, rounded-lg, status header with count badge, then ticket cards. Each card: white bg, rounded, shadow-sm, p-3, shows title, priority badge (low/medium/high/urgent with color), reporter name, and `created_at` relative time. Card is clickable via `onTicketClick`.

Use `overflow-x-auto` on the grid container for horizontal scrolling on smaller screens. `min-w-[220px]` per column.

**4. Create `packages/admin/src/components/tickets/TicketSLAIndicator.tsx`:**

Props: `responseDueAt?: string, resolutionDueAt?: string, responseBreached?: boolean, resolutionBreached?: boolean, firstRespondedAt?: string, resolvedAt?: string`.

Shows two small inline indicators:
- Response SLA: green check if responded before due, red "Breach" if `responseBreached`, yellow clock if due is approaching (< 2 hours), gray if no due date.
- Resolution SLA: same logic for resolution.

Use simple colored text/icons, no external dependencies.

**5. Create `packages/admin/src/app/(dashboard)/operations/page.tsx`:**

Simple redirect page: `'use client'; export const dynamic = 'force-dynamic';` then `import { redirect } from 'next/navigation'; export default function OperationsPage() { redirect('/operations/tickets'); }` -- redirects to tickets by default.

**6. Create `packages/admin/src/app/(dashboard)/operations/tickets/page.tsx`:**

`'use client'; export const dynamic = 'force-dynamic';`

Structure:
- Page header: "Tickets de Mantenimiento" with view toggle buttons (Table | Kanban)
- SLA summary row: 4 KPICard-style cards showing Total tickets, Avg response time, Avg resolution time, Breach rate (use `computeSLAMetrics` on current filtered data)
- Filter bar: search input (debounced), status dropdown (all + 8 statuses), priority dropdown (all, low, medium, high, urgent)
- Conditional render: if table view, render DataTable with columns (ID truncated, Title as Link, Category, Status via TicketStatusBadge, Priority badge, Reporter name, SLA via TicketSLAIndicator, Created date). Pagination via DataTable's `pagination`/`onPaginationChange` props (PaginationState pattern from existing pages).
- If kanban view, render TicketKanbanBoard with same filtered data. Clicking a card navigates to `/operations/tickets/${id}`.

**7. Create `packages/admin/src/app/(dashboard)/operations/tickets/[id]/page.tsx`:**

`'use client'; export const dynamic = 'force-dynamic';`

Use `useParams()` to get ticket ID. Use `useTicket(id)` for detail data.

Layout:
- Back link to `/operations/tickets`
- Header: ticket title, TicketStatusBadge, priority badge, TicketSLAIndicator
- Two-column layout (lg:grid-cols-3):
  - Left (col-span-2): Description card, then Timeline card showing `ticket_comments` ordered by created_at. System comments (is_system=true) shown differently (gray, italic). Each comment shows author_role, content, timestamp. Photo URLs rendered as clickable links/thumbnails.
  - Right (col-span-1): Info card (category, reporter, unit, created date), Assignment card (current assignee, "Assign" button that shows a select dropdown of residents/guards/admins in community -- for simplicity just a text input for assignee ID with a button), Status workflow card (show current status and buttons for each valid next status from VALID_TRANSITIONS).

Below timeline: "Add Comment" form with textarea and "Internal note" checkbox. Submit calls `useAddTicketComment`.
  </action>
  <verify>
Run `npx tsc --noEmit` from packages/admin. Navigate to `/operations/tickets` in the browser -- should show ticket list. Click a ticket to see detail page with assignment and status controls.
  </verify>
  <done>
Admin can view tickets in table or kanban view, filter by status/priority/search, see SLA metrics summary, click into ticket detail, assign tickets, update status with only valid transitions shown, and add comments. All 7 files compile without errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for both `packages/shared` and `packages/admin`
2. Admin sidebar "Operaciones" expands to show 5 sub-route links
3. `/operations` redirects to `/operations/tickets`
4. Ticket list page renders with table view (DataTable with pagination) and kanban view toggle
5. SLA summary cards show aggregate metrics
6. Ticket detail page shows assignment controls, valid status transitions, comment timeline
7. `queryKeys.tickets`, `queryKeys.announcements`, `queryKeys.documents` all exist and work
</verification>

<success_criteria>
- AOPS-01: Admin can view maintenance tickets in table or kanban view -- COVERED by tickets page with view toggle
- AOPS-02: Admin can assign tickets to staff and update status -- COVERED by ticket detail page
- AOPS-03: Admin can view SLA metrics -- COVERED by SLA summary cards and per-ticket SLA indicators
- Shared query key factories created for all Phase 12 domains (tickets, announcements, documents)
- Admin sidebar operations nav has children for all 5 sub-sections
</success_criteria>

<output>
After completion, create `.planning/phases/12-admin-dashboard-operations/12-01-SUMMARY.md`
</output>
