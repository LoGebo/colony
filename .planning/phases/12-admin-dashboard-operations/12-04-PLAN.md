---
phase: 12-admin-dashboard-operations
plan: 04
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - packages/admin/src/hooks/useAccessLogs.ts
  - packages/admin/src/hooks/useDocuments.ts
  - packages/admin/src/hooks/useAmenities.ts
  - packages/admin/src/lib/export.ts
  - packages/admin/src/app/(dashboard)/operations/access-logs/page.tsx
  - packages/admin/src/app/(dashboard)/operations/documents/page.tsx
  - packages/admin/src/app/(dashboard)/operations/amenities/page.tsx
  - packages/admin/src/app/(dashboard)/operations/amenities/[id]/page.tsx
  - packages/admin/src/components/charts/AmenityUtilizationChart.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view access logs in a paginated table with date range filter, gate filter, and person type filter"
    - "Admin can export filtered access logs to CSV file"
    - "Admin can view documents grouped by category, upload new documents to Supabase Storage, and set document visibility"
    - "Admin can create and edit amenities with rules and schedules"
    - "Admin can view amenity utilization report showing booking rates and peak hours"
  artifacts:
    - path: "packages/admin/src/hooks/useAccessLogs.ts"
      provides: "Access log query with date range, gate, person type, direction filters"
    - path: "packages/admin/src/hooks/useDocuments.ts"
      provides: "Document queries and mutations (list, create, upload version, update visibility)"
    - path: "packages/admin/src/hooks/useAmenities.ts"
      provides: "Amenity queries and mutations (list, detail, create, edit, rules, utilization data)"
    - path: "packages/admin/src/app/(dashboard)/operations/access-logs/page.tsx"
      provides: "Access log report page with filters and CSV export"
    - path: "packages/admin/src/app/(dashboard)/operations/documents/page.tsx"
      provides: "Document repository page with upload and category management"
    - path: "packages/admin/src/app/(dashboard)/operations/amenities/page.tsx"
      provides: "Amenity list page with create/edit"
    - path: "packages/admin/src/app/(dashboard)/operations/amenities/[id]/page.tsx"
      provides: "Amenity detail with rules, schedule, and utilization chart"
  key_links:
    - from: "packages/admin/src/app/(dashboard)/operations/access-logs/page.tsx"
      to: "packages/admin/src/lib/export.ts"
      via: "exportToCSV function for CSV export"
    - from: "packages/admin/src/hooks/useDocuments.ts"
      to: "document-files storage bucket"
      via: "supabase.storage.from('document-files').upload()"
    - from: "packages/admin/src/hooks/useAmenities.ts"
      to: "reservations table"
      via: "Aggregation query for utilization report"
---

<objective>
Build admin access log reports with CSV export, document repository management, and amenity CRUD with utilization reports -- the remaining three operations sub-sections.

Purpose: Completes the admin operations dashboard with access monitoring, document management, and amenity administration. These are the three remaining tabs under /operations.
Output: Access log hooks/page with filters and CSV export, document hooks/page with upload, amenity hooks/pages with rules and utilization charts.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-admin-dashboard-operations/12-RESEARCH.md
@.planning/phases/12-admin-dashboard-operations/12-01-SUMMARY.md

Key existing files to reference:
@packages/admin/src/hooks/useResidents.ts
@packages/admin/src/app/(dashboard)/residents/page.tsx
@packages/admin/src/components/ui/DataTable.tsx
@packages/admin/src/lib/export.ts
@packages/admin/src/lib/formatters.ts
@packages/admin/src/components/charts/KPICard.tsx
@packages/shared/src/queries/keys.ts
@packages/shared/src/constants/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create access log hooks/page and add CSV export utility</name>
  <files>
    packages/admin/src/hooks/useAccessLogs.ts
    packages/admin/src/lib/export.ts
    packages/admin/src/app/(dashboard)/operations/access-logs/page.tsx
  </files>
  <action>
**1. Add `exportToCSV` to `packages/admin/src/lib/export.ts`:**

Add a new exported function alongside the existing `exportToExcel`:

```typescript
/**
 * Export an array of objects to a CSV file.
 * Triggers a browser download of the file.
 */
export function exportToCSV(
  data: Record<string, unknown>[],
  filename: string
): void {
  const worksheet = XLSX.utils.json_to_sheet(data);
  const csvContent = XLSX.utils.sheet_to_csv(worksheet);
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `${filename}.csv`;
  link.click();
  URL.revokeObjectURL(link.href);
}
```

**2. Create `packages/admin/src/hooks/useAccessLogs.ts`:**

Follow established patterns.

Hooks:
- `useAccessLogs(filters)` -- paginated query. Filters: `dateFrom?: string, dateTo?: string, accessPointId?: string, personType?: string, direction?: string, page: number, pageSize: number`. Select from `access_logs`: `id, logged_at, person_name, person_type, direction, method, decision, denial_reason, plate_number, guard_notes, access_points!inner(name, access_point_type)`. Filter by `community_id = communityId`. If dateFrom: `.gte('logged_at', dateFrom)`. If dateTo: `.lte('logged_at', dateTo + 'T23:59:59')`. If accessPointId: `.eq('access_point_id', accessPointId)`. If personType: `.eq('person_type', personType)`. If direction: `.eq('direction', direction)`. Order by `logged_at` descending. Count exact. Range pagination.

  Use `queryKeys.accessLogs.today(communityId!)` base key with filters appended.

  IMPORTANT: access_logs is append-only and grows unboundedly. Always enforce date range filters in the UI. Default to last 7 days if no filter specified.

- `useAccessPoints()` -- query: select from `access_points` where `community_id = communityId` AND `deleted_at IS NULL`. Select: `id, name, access_point_type`. Used for the gate filter dropdown.

- `useAccessLogsForExport(filters)` -- same query as useAccessLogs but WITHOUT pagination (no .range()). This fetches ALL matching records for export. Limit to 10,000 rows max (`.limit(10000)`) to prevent memory issues. Only enabled when explicitly called (use `enabled: false` and return the refetch function).

**3. Create `packages/admin/src/app/(dashboard)/operations/access-logs/page.tsx`:**

`'use client'; export const dynamic = 'force-dynamic';`

Structure:
- Page header: "Registro de Accesos" with "Exportar CSV" button
- Filter bar:
  - Date range: two `<input type="date">` inputs (Desde, Hasta). Default: last 7 days.
  - Gate filter: select dropdown populated from useAccessPoints (+ "Todos" option)
  - Person type filter: select dropdown with options: Todos, resident, visitor, provider, employee, delivery, other
  - Direction filter: select dropdown with options: Todos, entry, exit
  - "Filtrar" button to apply (or auto-apply on change)
- DataTable with columns:
  - Date/Time (formatted from logged_at)
  - Person name
  - Person type (badge)
  - Gate/Access point name
  - Direction (entry=green arrow up, exit=red arrow down, or text badge)
  - Method (badge: qr, manual, plate, facial, remote)
  - Decision (allowed=green, denied=red)
  - Denial reason (if applicable)
- Pagination via DataTable

Export button behavior: when clicked, call `useAccessLogsForExport.refetch()` to get all filtered data (no pagination), then call `exportToCSV()` with mapped rows:
```typescript
const rows = data.map(log => ({
  'Fecha': formatDate(log.logged_at, 'dd/MM/yyyy HH:mm'),
  'Persona': log.person_name,
  'Tipo': log.person_type,
  'Acceso': log.access_points?.name ?? '',
  'Direccion': log.direction,
  'Metodo': log.method,
  'Decision': log.decision,
  'Razon denegacion': log.denial_reason ?? '',
  'Placa': log.plate_number ?? '',
  'Notas guardia': log.guard_notes ?? '',
}));
exportToCSV(rows, `accesos-${dateFrom}-${dateTo}`);
```
  </action>
  <verify>
Run `npx tsc --noEmit` from packages/admin. Navigate to `/operations/access-logs`. Verify filters work, table paginates, and CSV export downloads a file.
  </verify>
  <done>
Admin can view access logs with date range, gate, person type, and direction filters. Pagination works. CSV export downloads a file with all filtered records. Default filter is last 7 days.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create document repository and amenity management pages</name>
  <files>
    packages/admin/src/hooks/useDocuments.ts
    packages/admin/src/hooks/useAmenities.ts
    packages/admin/src/app/(dashboard)/operations/documents/page.tsx
    packages/admin/src/app/(dashboard)/operations/amenities/page.tsx
    packages/admin/src/app/(dashboard)/operations/amenities/[id]/page.tsx
    packages/admin/src/components/charts/AmenityUtilizationChart.tsx
  </files>
  <action>
**1. Create `packages/admin/src/hooks/useDocuments.ts`:**

Hooks:
- `useDocuments(filters)` -- paginated list. Filters: search, category, page, pageSize. Select from `documents`: `id, title, category, description, visibility, is_mandatory, current_version_id, created_at, updated_at`. Filter by `community_id = communityId`, `deleted_at IS NULL`. If category filter: `.eq('category', category)`. If search: `.ilike('title', '%search%')`. Order by `created_at` descending. Count exact.

- `useDocumentCategories()` -- query: select DISTINCT `category` from `documents` where `community_id = communityId` AND `deleted_at IS NULL`. This gives the list of existing categories for the filter dropdown.

- `useCreateDocument()` -- mutation with two steps:
  1. Upload file to Supabase Storage bucket `document-files` at path `{communityId}/documents/{uuid}-{filename}`. Use `supabase.storage.from('document-files').upload(path, file)`.
  2. Insert into `documents` table: `community_id`, `title`, `category`, `description`, `visibility` (public/private/role-based), `is_mandatory`, `created_by` from auth. Then insert into `document_versions` table: `document_id`, `file_path` (the storage path), `file_name` (original name), `file_size`, `mime_type`, `uploaded_by` from auth. The DB trigger `set_document_version` auto-sets the version number and `update_document_current_version` updates `documents.current_version_id`.

  On success: toast "Documento subido exitosamente". Invalidate documents queries.

- `useUpdateDocumentVisibility()` -- mutation: update `documents` set `visibility = newVisibility` where `id = docId`. Invalidate queries on success.

- `useDeleteDocument()` -- mutation: soft-delete by setting `deleted_at = now()`. Invalidate queries.

**2. Create `packages/admin/src/hooks/useAmenities.ts`:**

Hooks:
- `useAmenities()` -- list. Select from `amenities` where `community_id = communityId` AND `deleted_at IS NULL`. Select: `id, name, description, amenity_type, location, capacity, is_reservable, requires_approval, is_active, created_at`. Order by `name` ascending.

- `useAmenity(id)` -- detail. Select: `*, amenity_rules(id, rule_type, rule_value, priority, is_active)`. Single row.

- `useCreateAmenity()` -- mutation: insert into `amenities` table with `community_id`, `name`, `description`, `amenity_type`, `location`, `capacity`, `is_reservable`, `requires_approval`, `is_active`. On success toast and invalidate.

- `useUpdateAmenity()` -- mutation: update `amenities` with provided fields. On success toast and invalidate.

- `useAmenityUtilization(amenityId, dateFrom, dateTo)` -- query: select from `reservations` where `amenity_id = amenityId` AND `status IN ('confirmed', 'completed')`. Select: `id, reserved_range, status, created_at`. Filter by date range on `created_at`. This returns raw reservation data that the chart component will aggregate into booking rates and peak hours.

- `useCreateAmenityRule()` -- mutation: insert into `amenity_rules`. Fields: `amenity_id`, `rule_type` (enum: max_duration, min_advance, max_advance, max_concurrent, blackout_period, owner_only, quota_per_period, min_duration, cancellation_deadline, require_deposit), `rule_value` (JSONB), `priority` (integer), `is_active`. On success invalidate amenity detail.

- `useUpdateAmenityRule()` -- mutation: update `amenity_rules`. Invalidate on success.

**3. Create `packages/admin/src/app/(dashboard)/operations/documents/page.tsx`:**

`'use client'; export const dynamic = 'force-dynamic';`

Structure:
- Page header: "Documentos" with "Subir Documento" button
- Filter bar: search input, category dropdown (populated from useDocumentCategories)
- DataTable with columns:
  - Title (text)
  - Category (badge)
  - Visibility (badge: public=green, private=yellow, role-based=blue)
  - Mandatory (checkmark or dash)
  - Last updated (formatted date)
  - Actions: visibility toggle dropdown, delete button
- Upload modal (when "Subir Documento" clicked):
  - Title input (required)
  - Category input (text with datalist suggestions from existing categories)
  - Description textarea (optional)
  - Visibility select: public, private, role-based
  - Mandatory checkbox
  - File input (`<input type="file">`) accepting `.pdf,.doc,.docx,.xls,.xlsx,.jpg,.png`
  - Submit button: calls useCreateDocument
- Pagination

**4. Create `packages/admin/src/app/(dashboard)/operations/amenities/page.tsx`:**

`'use client'; export const dynamic = 'force-dynamic';`

Structure:
- Page header: "Amenidades" with "Nueva Amenidad" button
- Grid of amenity cards (not DataTable -- amenities are typically fewer items). Each card shows:
  - Name, description (truncated), type badge, capacity, location
  - Reservable indicator, requires approval indicator
  - Active/inactive toggle
  - "Ver detalle" link to `/operations/amenities/${id}`
- Create form (inline or modal):
  - Name (required), description, amenity_type (dropdown: pool, gym, salon, court, bbq, playground, parking, other), location, capacity (number), is_reservable (checkbox), requires_approval (checkbox)

**5. Create `packages/admin/src/app/(dashboard)/operations/amenities/[id]/page.tsx`:**

`'use client'; export const dynamic = 'force-dynamic';`

Structure:
- Back link to `/operations/amenities`
- Header: amenity name, type badge, active status
- Two-column layout (lg:grid-cols-2):
  - Left: Details card (description, location, capacity, type, reservable, requires approval). Edit button opens inline edit form.
  - Left below: Rules card. Lists existing `amenity_rules` with rule_type label, rule_value display, active toggle. "Add Rule" button shows form with rule_type dropdown, rule_value input (JSON-appropriate input based on rule_type), priority number, active checkbox.
  - Right: Utilization report card. Date range picker (default last 30 days). Uses `useAmenityUtilization`. Shows:
    - Total bookings count
    - Booking rate (bookings / days in range)
    - AmenityUtilizationChart component

**6. Create `packages/admin/src/components/charts/AmenityUtilizationChart.tsx`:**

Props: `reservations: Array<{ reserved_range: string, status: string, created_at: string }>`.

Processes reservation data to compute:
- Bookings per day (for a bar chart) using the `reserved_range` start date
- Peak hours distribution (group by hour of day from reserved_range start)

Renders a Recharts BarChart showing bookings per day over the selected period. Follow the exact same Recharts pattern as existing chart components (CollectionChart, DelinquencyChart). Use `'use client'` directive. Import from 'recharts': `BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer`.

Below the daily chart, show a small "Peak Hours" section: horizontal bar chart or simple text list showing the top 5 busiest hours.
  </action>
  <verify>
Run `npx tsc --noEmit` from packages/admin. Navigate to `/operations/access-logs`, `/operations/documents`, `/operations/amenities`. Verify each page renders with its respective data and functionality.
  </verify>
  <done>
Admin can view/filter/export access logs. Admin can manage document repository (upload, categorize, set visibility). Admin can manage amenities (create, edit, set rules) and view utilization reports with booking charts. All files compile.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for packages/admin
2. Access logs page renders with date range, gate, person type, direction filters
3. CSV export downloads a valid CSV file
4. Documents page shows document list, upload form works, visibility can be changed
5. Amenities page shows amenity cards, create form works
6. Amenity detail shows rules management and utilization chart
7. All 5 operations sub-routes (/tickets, /announcements, /access-logs, /documents, /amenities) are reachable from sidebar
</verification>

<success_criteria>
- AOPS-06: Admin can view access log reports with date range and gate filters -- COVERED by access logs page
- AOPS-07: Admin can export access logs to CSV -- COVERED by exportToCSV integration
- AOPS-08: Admin can manage document repository (upload, categorize, set visibility) -- COVERED by documents page
- AOPS-09: Admin can manage amenities (create, edit, set rules and schedules) -- COVERED by amenities pages
- AOPS-10: Admin can view amenity utilization reports -- COVERED by amenity detail utilization chart
</success_criteria>

<output>
After completion, create `.planning/phases/12-admin-dashboard-operations/12-04-SUMMARY.md`
</output>
