---
phase: 16-push-notifications-real-time
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - packages/mobile/src/components/notifications/NotificationBell.tsx
  - packages/mobile/src/components/notifications/NotificationListScreen.tsx
  - packages/mobile/app/(resident)/notifications.tsx
  - packages/mobile/app/(guard)/notifications.tsx
  - packages/mobile/app/(resident)/_layout.tsx
  - packages/mobile/app/(guard)/_layout.tsx
autonomous: true

must_haves:
  truths:
    - "Resident sees unread notification badge on the tab bar"
    - "Tapping notification bell opens a list of all notifications ordered by newest first"
    - "Each notification shows type icon, title, body, and relative time"
    - "Tapping a notification marks it as read and navigates to the related entity"
    - "Guard sees unread notification badge on their tab bar"
  artifacts:
    - path: "packages/mobile/src/components/notifications/NotificationBell.tsx"
      provides: "Bell icon with unread count badge overlay"
      min_lines: 30
    - path: "packages/mobile/src/components/notifications/NotificationListScreen.tsx"
      provides: "Full-screen notification list with type icons, mark-read, navigation"
      min_lines: 80
    - path: "packages/mobile/app/(resident)/notifications.tsx"
      provides: "Resident notification screen route"
    - path: "packages/mobile/app/(guard)/notifications.tsx"
      provides: "Guard notification screen route"
  key_links:
    - from: "packages/mobile/src/components/notifications/NotificationBell.tsx"
      to: "useUnreadCount hook"
      via: "displays badge count"
      pattern: "useUnreadCount"
    - from: "packages/mobile/src/components/notifications/NotificationListScreen.tsx"
      to: "useNotificationList hook"
      via: "fetches and renders notification list"
      pattern: "useNotificationList"
    - from: "packages/mobile/src/components/notifications/NotificationListScreen.tsx"
      to: "useMarkNotificationRead hook"
      via: "marks notification read on tap"
      pattern: "useMarkNotificationRead"
---

<objective>
Build the in-app notification UI: a notification bell with unread badge for tab bars, a full notification list screen showing all notification types with icons and relative timestamps, and mark-as-read + deep navigation on tap. Add notification screens to both resident and guard route groups.

Purpose: Users need to see and interact with their notifications in-app, not just via push banners. The notification list is the central hub for all alerts across modules.
Output: NotificationBell component for tab bars, NotificationListScreen for viewing all notifications, route screens for resident and guard.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-push-notifications-real-time/16-RESEARCH.md
@.planning/phases/16-push-notifications-real-time/16-01-SUMMARY.md

Key codebase files:
@packages/mobile/src/hooks/useNotifications.ts (from 16-01: useNotificationList, useUnreadCount, useMarkNotificationRead)
@packages/mobile/src/hooks/useAuth.ts
@packages/mobile/app/(resident)/_layout.tsx
@packages/mobile/app/(guard)/_layout.tsx
@packages/shared/src/queries/keys.ts

Database context:
- notifications table: id, user_id, community_id, type (notification_type enum), title, body, data (json), action_url, read_at, dismissed_at, created_at
- notification_type enum: ticket_created, ticket_assigned, ticket_status_changed, ticket_comment_added, sla_warning, sla_breach, new_message, message_reaction, conversation_mention, document_published, signature_required, signature_reminder, announcement, survey_published, payment_due, payment_received, visitor_arrived, package_arrived, emergency_alert
- mark_notification_read RPC: { p_notification_id: string } -> boolean
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NotificationBell component and NotificationListScreen</name>
  <files>
    packages/mobile/src/components/notifications/NotificationBell.tsx
    packages/mobile/src/components/notifications/NotificationListScreen.tsx
  </files>
  <action>
    **A. Create packages/mobile/src/components/notifications/NotificationBell.tsx**

    A compact bell icon component with unread count badge, designed for use in tab bar headers or navigation bars.

    Props: `onPress: () => void` (navigation to notifications screen)

    Implementation:
    - Import useUnreadCount from '@/hooks/useNotifications'
    - Render a TouchableOpacity wrapping a bell emoji/icon (use Text with bell character or a simple SVG)
    - If unreadCount > 0, render a small red circle badge with count (cap at "9+" if > 9)
    - Badge: absolute positioned, top-right corner, red background (#ef4444), white text, min-width 18, height 18, borderRadius 9, fontSize 11, fontWeight bold, centered text
    - Bell icon: use a text-based icon "üîî" with fontSize 22 (consistent with existing tab bar emoji pattern)
    - Style the container: padding 8 for touch target

    **B. Create packages/mobile/src/components/notifications/NotificationListScreen.tsx**

    Full notification list screen component (reusable between resident and guard).

    Implementation:
    1. Import useNotificationList, useMarkNotificationRead from '@/hooks/useNotifications'
    2. Import useAuth for role context (determines navigation targets)
    3. Import useRouter from 'expo-router'

    4. Type icon mapping function `getNotificationIcon(type: string): string`:
       - ticket_created, ticket_assigned, ticket_status_changed, ticket_comment_added: "üîß"
       - sla_warning, sla_breach: "‚è∞"
       - new_message, message_reaction, conversation_mention: "üí¨"
       - document_published, signature_required, signature_reminder: "üìÑ"
       - announcement, survey_published: "üì¢"
       - payment_due, payment_received: "üí≥"
       - visitor_arrived: "üë•"
       - package_arrived: "üì¶"
       - emergency_alert: "üö®"
       - default: "üîî"

    5. Navigation mapping function `handleNotificationPress(notification)`:
       - Call markRead mutation with notification.id
       - Parse notification.data (Json field) for entity references
       - Route based on notification.type:
         - visitor_arrived: router.push('/(resident)/visitors/') or for guard router.push('/(guard)/')
         - payment_due, payment_received: router.push('/(resident)/payments/')
         - ticket_*: router.push('/(resident)/maintenance/')
         - announcement, survey_published: router.push('/(resident)/announcements/')
         - package_arrived: router.push('/(resident)/more/packages')
         - emergency_alert: stay on current screen (alert already shown)
         - default: dismiss (no navigation)
       - Role-aware: if guard, route guard-specific paths; if resident, route resident paths

    6. Render:
       - SafeAreaView with white background, flex: 1
       - Header bar: "Notificaciones" title (text-xl font-bold), right side: "Marcar todo" button
       - FlatList of notifications:
         - Each item: View row with icon (left), content (center: title bold + body + relative time gray), unread dot (right, blue circle if read_at is null)
         - Relative time: use date-fns formatDistanceToNow with { addSuffix: true, locale: es } (date-fns already installed)
         - Unread items: slightly different background (bg-blue-50 or white with left blue border)
         - Touchable: onPress calls handleNotificationPress
       - Empty state: centered "Sin notificaciones" message with bell icon
       - Loading: ActivityIndicator centered

    7. "Marcar todo" button: batch-marks all visible unread notifications as read by calling markRead for each (or a simple update query). Invalidate queries on completion.

    Styling: Use NativeWind classes throughout (className prop). Follow the existing app styling conventions with Tailwind classes. Use View, Text, TouchableOpacity, FlatList, SafeAreaView, ActivityIndicator from react-native.

    IMPORTANT for date-fns locale: Import `import { es } from 'date-fns/locale'` and use `formatDistanceToNow(new Date(notification.created_at), { addSuffix: true, locale: es })`. If the es locale import causes issues, fall back to default English locale.
  </action>
  <verify>
    Both files exist and export their components.
    NotificationBell renders a bell with badge count from useUnreadCount.
    NotificationListScreen renders a FlatList using useNotificationList data.
    TypeScript compiles: `cd packages/mobile && npx tsc --noEmit`
  </verify>
  <done>
    NotificationBell shows unread count badge (capped at 9+).
    NotificationListScreen displays all notifications with type icons, relative time, read/unread styling, and tap-to-navigate.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add notification screens and wire bell into tab bars</name>
  <files>
    packages/mobile/app/(resident)/notifications.tsx
    packages/mobile/app/(guard)/notifications.tsx
    packages/mobile/app/(resident)/_layout.tsx
    packages/mobile/app/(guard)/_layout.tsx
  </files>
  <action>
    **A. Create packages/mobile/app/(resident)/notifications.tsx**

    Simple route screen that renders NotificationListScreen:
    ```tsx
    import { NotificationListScreen } from '@/components/notifications/NotificationListScreen';
    export default function ResidentNotifications() {
      return <NotificationListScreen />;
    }
    ```

    **B. Create packages/mobile/app/(guard)/notifications.tsx**

    Same pattern:
    ```tsx
    import { NotificationListScreen } from '@/components/notifications/NotificationListScreen';
    export default function GuardNotifications() {
      return <NotificationListScreen />;
    }
    ```

    **C. Update packages/mobile/app/(resident)/_layout.tsx**

    Add a notification bell to the resident tab bar. The existing layout uses Tabs with 5 screens (Inicio, Visitantes, Pagos, Comunidad, Mas).

    1. Import NotificationBell from '@/components/notifications/NotificationBell'
    2. Import useRouter from 'expo-router'

    3. Add the notifications screen to the tab navigator but hide it from the tab bar (like guard's gate pattern: `href: null`):
       ```tsx
       <Tabs.Screen
         name="notifications"
         options={{ href: null }}
       />
       ```

    4. Add a headerRight to the Tabs screenOptions that renders the NotificationBell:
       ```tsx
       screenOptions={{
         headerShown: true,  // Change from false to true to show header with bell
         tabBarActiveTintColor: '#2563eb',
         tabBarInactiveTintColor: '#9ca3af',
         headerRight: () => {
           const router = useRouter();
           return (
             <NotificationBell onPress={() => router.push('/(resident)/notifications')} />
           );
         },
       }}
       ```

       IMPORTANT: If the existing app design has headerShown: false and screens manage their own headers, do NOT change headerShown. Instead, place the NotificationBell inside each screen's custom header OR add a floating bell button. Check the existing pattern first.

       ALTERNATIVE approach (if headerShown should stay false): Add the notifications tab as a visible tab with a bell icon:
       ```tsx
       <Tabs.Screen
         name="notifications"
         options={{
           tabBarLabel: 'Alertas',
           tabBarIcon: ({ color }) => <NotificationBell onPress={() => {}} />,
         }}
       />
       ```
       But this is less ideal since the bell already shows the badge. Better: keep headerShown:false, hide notifications route, and let users access notifications through the home dashboard or a floating button. Since the existing home dashboard (resident index) likely has a header area, the bell can be placed there.

       SIMPLEST approach that preserves existing layout: Add the notifications Tabs.Screen with `href: null` (hidden from tab bar). Users navigate to it via the NotificationBell placed in the home screen header. For now, just register the route. The bell will be integrated into existing screens by adding it to their local header.

    **D. Update packages/mobile/app/(guard)/_layout.tsx**

    Same pattern as resident:
    1. Add hidden notifications route:
       ```tsx
       <Tabs.Screen
         name="notifications"
         options={{ href: null }}
       />
       ```

    2. Keep the existing PanicButton and all other tabs unchanged.

    **NAVIGATION NOTE:** With the routes registered as hidden tabs, users can navigate to them via `router.push('/(resident)/notifications')` from any component. The NotificationBell in Task 1 already handles this via its onPress prop. For the initial integration, notifications are accessible via:
    - Push notification tap (deep link from 16-01)
    - The NotificationBell component (which can be placed in any screen header by importing it)

    To make the bell universally accessible without changing headerShown, export a `NotificationBellHeader` wrapper that can be dropped into any screen's Stack.Screen options headerRight, or placed in screen-level headers.
  </action>
  <verify>
    Route files exist at (resident)/notifications.tsx and (guard)/notifications.tsx.
    Both layouts register the notifications route (href: null).
    Navigation works: router.push('/(resident)/notifications') would render NotificationListScreen.
    TypeScript compiles: `cd packages/mobile && npx tsc --noEmit`
    Existing tab bar structure unchanged (no visual regression).
  </verify>
  <done>
    Notification list accessible as a screen for both resident and guard roles.
    Routes registered as hidden tabs (no tab bar clutter).
    NotificationBell available for integration into screen headers.
    Push notification taps route through to notification list or specific screens.
  </done>
</task>

</tasks>

<verification>
1. NotificationBell shows unread count from useUnreadCount hook, capped at 9+
2. NotificationListScreen fetches from notifications table, renders with type icons
3. Each notification row shows: icon, title (bold), body, relative time (Spanish locale)
4. Unread notifications visually distinct from read
5. Tapping notification: marks as read via RPC + navigates to related entity
6. Route screens exist for both resident and guard
7. Layouts register hidden notification routes
8. "Marcar todo" button marks all visible notifications as read
9. TypeScript compiles without errors
</verification>

<success_criteria>
- NotificationBell component renders bell with dynamic unread badge (0 = no badge, 1-9 = number, 10+ = "9+")
- NotificationListScreen shows notification list with type-specific icons for all 19 notification types
- Tapping a notification marks it read and navigates to the correct module screen
- Both resident and guard have accessible notification screens
- Empty state renders gracefully with "Sin notificaciones" message
- Existing tab bar layout and PanicButton (guard) remain unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/16-push-notifications-real-time/16-02-SUMMARY.md`
</output>
