---
phase: 15-admin-governance-analytics
plan: 03
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - packages/admin/src/hooks/useViolations.ts
  - packages/admin/src/app/(dashboard)/violations/page.tsx
  - packages/admin/src/app/(dashboard)/violations/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view violations list with severity, status, unit, and type columns"
    - "Admin can create violation records with evidence photos and violation type"
    - "Admin can issue warnings and sanctions (verbal, written, fine, suspension)"
    - "Admin can manage violation appeals and view resolution status"
    - "Admin can see repeat offender tracking via offense_number display"
  artifacts:
    - path: "packages/admin/src/hooks/useViolations.ts"
      provides: "TanStack Query hooks for violations CRUD, sanctions, appeals"
      contains: "useViolations"
    - path: "packages/admin/src/app/(dashboard)/violations/page.tsx"
      provides: "Violations list with DataTable, severity badges, filters"
      contains: "force-dynamic"
    - path: "packages/admin/src/app/(dashboard)/violations/[id]/page.tsx"
      provides: "Violation detail with sanctions timeline, appeals, evidence gallery, create forms"
      contains: "force-dynamic"
  key_links:
    - from: "packages/admin/src/app/(dashboard)/violations/page.tsx"
      to: "packages/admin/src/hooks/useViolations.ts"
      via: "useViolations hook"
      pattern: "useViolations"
    - from: "packages/admin/src/hooks/useViolations.ts"
      to: "supabase.from('violations')"
      via: "lazy Supabase client in queryFn"
      pattern: "from\\('violations'\\)"
    - from: "packages/admin/src/app/(dashboard)/violations/[id]/page.tsx"
      to: "supabase.from('violation_sanctions')"
      via: "useViolationSanctions hook"
      pattern: "violation_sanctions"
---

<objective>
Build the violations management UI: list with filtering, detail with sanctions/appeals workflow, and violation creation.

Purpose: Fulfills AVIOL-01 through AVIOL-04 -- admin can create violations with evidence, issue sanctions, manage appeals, and track repeat offenders.
Output: 3 page files + 1 hooks file implementing the full violations lifecycle.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-admin-governance-analytics/15-RESEARCH.md
@packages/admin/src/hooks/useAccessLogs.ts
@packages/admin/src/components/ui/DataTable.tsx
@packages/admin/src/components/ui/Badge.tsx
@packages/admin/src/lib/formatters.ts
@packages/admin/src/lib/export.ts
@supabase/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create violations hooks</name>
  <files>packages/admin/src/hooks/useViolations.ts</files>
  <action>
Create `packages/admin/src/hooks/useViolations.ts` following the useAccessLogs.ts pattern (lazy Supabase client in queryFn, useAuth for communityId):

1. **Types** (export all):
   - `ViolationRow`: id, violation_number, description, severity, status, occurred_at, reported_at, offense_number, location, photo_urls, video_urls, witness_names, unit_id, resident_id, violation_type_id, resolution_notes, resolved_at. Plus joined fields: `units: { unit_number: string } | null`, `violation_types: { name: string; category: string } | null`
   - `ViolationFilters`: severity?: string, status?: string, violationTypeId?: string, page: number, pageSize: number
   - `SanctionRow`: id, sanction_type, description, fine_amount, status, issued_at, notification_method, notified_at, suspended_amenities, suspension_start, suspension_end
   - `AppealRow`: id, appeal_reason, status, decision, hearing_date, hearing_notes, decided_at, supporting_documents, fine_reduced_to, sanction_modified_to

2. **useViolations(filters: ViolationFilters)** -- paginated list from `violations` table. Select: `id, violation_number, description, severity, status, occurred_at, reported_at, offense_number, location, photo_urls, units!inner(unit_number), violation_types!inner(name, category)`. Apply filters: severity (as never), status (as never), violationTypeId. Order by occurred_at desc. Uses `queryKeys.violations.list(communityId!)` extended with filters. Return `{ data, count }`.

3. **useViolationDetail(id: string)** -- single violation with full data. Select: `*, units(unit_number), violation_types(name, category, default_severity), residents(first_name, last_name)`. Uses `queryKeys.violations.detail(id)`.

4. **useViolationSanctions(violationId: string)** -- list from `violation_sanctions` where violation_id = violationId, ordered by issued_at desc. Uses `queryKeys.violations.sanctions(violationId)`.

5. **useViolationAppeals(violationId: string)** -- list from `violation_appeals` where violation_id = violationId, ordered by created_at desc. Uses `queryKeys.violations.appeals(violationId)`.

6. **useViolationTypes()** -- list from `violation_types` where community_id matches and is_active = true and deleted_at is null. Uses `queryKeys.violations.types(communityId!)`.

7. **useCreateViolation()** -- useMutation inserting into `violations`. Required: community_id, unit_id, violation_type_id, description, severity (as never), occurred_at, violation_number (generate as `VIOL-${Date.now()}`). Optional: resident_id, location, photo_urls, video_urls, witness_names. Invalidate violations.list on success.

8. **useCreateSanction()** -- useMutation inserting into `violation_sanctions`. Required: violation_id, sanction_type (as never -- verbal_warning, written_warning, fine, suspension, access_restriction), description. Optional: fine_amount, suspension_start, suspension_end, suspended_amenities. Invalidate violations.sanctions and violations.detail on success.

9. **useUpdateViolationStatus()** -- useMutation updating violations.status. Takes { id, status, resolution_notes? }. If status is 'resolved', also set resolved_at to now(). Use as never for status. Invalidate violations.detail and violations.list.

10. **useResolveAppeal()** -- useMutation updating violation_appeals. Takes { id, decision (as never), hearing_notes?, fine_reduced_to?, sanction_modified_to? }. Set decided_at to new Date().toISOString(). Invalidate violations.appeals.
  </action>
  <verify>Run `cd packages/admin && npx tsc --noEmit` -- no TypeScript errors.</verify>
  <done>All 10 hooks created with proper typing, lazy Supabase client, query key factories, and as-never casts for enums.</done>
</task>

<task type="auto">
  <name>Task 2: Create violations list and detail pages</name>
  <files>
    packages/admin/src/app/(dashboard)/violations/page.tsx
    packages/admin/src/app/(dashboard)/violations/[id]/page.tsx
  </files>
  <action>
**Create `packages/admin/src/app/(dashboard)/violations/page.tsx`:**
- `'use client'` + `export const dynamic = 'force-dynamic'`
- **Filters row:** severity select (minor, moderate, serious, critical), status select (open, under_review, resolved, dismissed), violation type select (populated from useViolationTypes hook)
- **DataTable** with columns:
  - Numero (violation_number)
  - Unidad (units.unit_number)
  - Tipo (violation_types.name)
  - Severidad (severity badge: minor=info, moderate=warning, serious=danger, critical=danger)
  - Estado (status badge: open=warning, under_review=info, resolved=success, dismissed=neutral)
  - Reincidencia (offense_number -- show "#{offense_number}" and highlight red if > 1)
  - Fecha (occurred_at formatted with formatDate)
- Pagination with useViolations hook
- "Nueva Infraccion" button opens a modal/drawer form (see create form below)
- Row click navigates to `/violations/${id}`

**Create violation form** (inline in page.tsx or separate component):
- Modal with: unit selector (dropdown), violation_type selector (dropdown), severity select, description (textarea), occurred_at (datetime-local), location (optional text), witness_names (comma-separated text input split into array), photo_urls (text inputs for now -- photo upload is out of scope for this plan)
- Submit calls useCreateViolation mutation
- Close modal and show success toast on completion

**Create `packages/admin/src/app/(dashboard)/violations/[id]/page.tsx`:**
- `'use client'` + `export const dynamic = 'force-dynamic'`
- **Header:** violation_number, severity badge, status badge, action buttons (Resolver, Desestimar)
- **Info Card:** description, occurred_at, location, unit_number, violation type name+category, offense_number (highlighted if >1 as "Reincidencia #{n}"), reporter info
- **Evidence Card:** grid of photo_urls as images (3-column grid), video_urls as links. If empty show "Sin evidencia"
- **Sanctions section (Card):**
  - List each sanction: sanction_type badge (verbal_warning=info, written_warning=warning, fine=danger, suspension=danger, access_restriction=danger), description, fine_amount (formatted as currency if present), issued_at, status
  - If suspension: show suspension_start to suspension_end date range
  - "Aplicar Sancion" button opens inline form:
    - sanction_type select (verbal_warning, written_warning, fine, suspension, access_restriction)
    - description (textarea, required)
    - fine_amount (number input, shown only if fine selected)
    - suspension_start/suspension_end (date inputs, shown only if suspension selected)
    - Submit calls useCreateSanction

- **Appeals section (Card):**
  - List each appeal: status badge (pending=warning, approved=success, rejected=danger, partially_approved=info), appeal_reason, hearing_date, decision
  - If appeal is pending: "Resolver Apelacion" button opens inline form:
    - decision select (approved, rejected, partially_approved -- as never)
    - hearing_notes (textarea)
    - fine_reduced_to (number, optional -- shown if partially_approved)
    - Submit calls useResolveAppeal

- **Resolution actions:**
  - "Resolver" button: opens modal with resolution_notes textarea, calls useUpdateViolationStatus with status='resolved'
  - "Desestimar" button: confirm dialog, calls useUpdateViolationStatus with status='dismissed'

Badge variant mapping:
- severity: minor='info', moderate='warning', serious='danger', critical='danger'
- status: open='warning', under_review='info', resolved='success', dismissed='neutral'
- sanction_type: verbal_warning='info', written_warning='warning', fine='danger', suspension='danger', access_restriction='danger'
- appeal status: pending='warning', approved='success', rejected='danger', partially_approved='info'
  </action>
  <verify>Run `cd packages/admin && npx tsc --noEmit` -- no TypeScript errors. Verify both pages exist with 'use client' + force-dynamic.</verify>
  <done>Violations list shows DataTable with severity/status/reincidencia columns and create modal. Violation detail shows info, evidence gallery, sanctions with add form, appeals with resolve form, and status update actions.</done>
</task>

</tasks>

<verification>
- `cd packages/admin && npx tsc --noEmit` passes
- Violations list: DataTable with filters (severity, status, type), create modal, row navigation
- Violation detail: info card, evidence gallery, sanctions list + add form, appeals list + resolve form
- Repeat offender tracking visible via offense_number highlighting
- All pages use force-dynamic and lazy Supabase client
- No Badge size prop usage, enum values use 'as never'
</verification>

<success_criteria>
- AVIOL-01: Admin can create violation records with evidence (create modal with type, severity, description)
- AVIOL-02: Admin can issue warnings and sanctions (sanction form with verbal/written/fine/suspension types)
- AVIOL-03: Admin can manage appeals and resolutions (appeal resolve form with decision options)
- AVIOL-04: Admin can view violation history with repeat offender tracking (offense_number column + highlighting)
</success_criteria>

<output>
After completion, create `.planning/phases/15-admin-governance-analytics/15-03-SUMMARY.md`
</output>
