---
phase: 15-admin-governance-analytics
plan: 05
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - packages/admin/src/hooks/useAnalytics.ts
  - packages/admin/src/components/charts/PatrolCompletionChart.tsx
  - packages/admin/src/components/charts/ResponseTimeChart.tsx
  - packages/admin/src/app/(dashboard)/analytics/guards/page.tsx
  - packages/admin/src/app/(dashboard)/analytics/audit/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view guard performance metrics with patrol completion rates and response times"
    - "Admin can view audit trail of administrative actions with date/user/action filters"
    - "Admin can export audit trail to CSV"
    - "Guard analytics show KPI cards and Recharts bar/line charts"
  artifacts:
    - path: "packages/admin/src/hooks/useAnalytics.ts"
      provides: "Hooks for guard metrics (patrol logs, incidents, shifts) and audit trail"
      contains: "useGuardPerformance"
    - path: "packages/admin/src/components/charts/PatrolCompletionChart.tsx"
      provides: "Recharts bar chart showing patrols completed vs scheduled per guard"
      contains: "BarChart"
    - path: "packages/admin/src/components/charts/ResponseTimeChart.tsx"
      provides: "Recharts bar chart showing average incident response times"
      contains: "BarChart"
    - path: "packages/admin/src/app/(dashboard)/analytics/guards/page.tsx"
      provides: "Guard performance dashboard with KPI cards and charts"
      contains: "force-dynamic"
    - path: "packages/admin/src/app/(dashboard)/analytics/audit/page.tsx"
      provides: "Audit trail viewer with DataTable and filters"
      contains: "force-dynamic"
  key_links:
    - from: "packages/admin/src/app/(dashboard)/analytics/guards/page.tsx"
      to: "packages/admin/src/hooks/useAnalytics.ts"
      via: "useGuardPerformance hook"
      pattern: "useGuardPerformance"
    - from: "packages/admin/src/hooks/useAnalytics.ts"
      to: "supabase.from('patrol_logs')"
      via: "lazy Supabase client in queryFn"
      pattern: "patrol_logs"
    - from: "packages/admin/src/app/(dashboard)/analytics/audit/page.tsx"
      to: "packages/admin/src/lib/export.ts"
      via: "exportToCSV for audit trail export"
      pattern: "exportToCSV"
---

<objective>
Build guard performance analytics dashboard with KPI cards and charts, and an audit trail viewer with filtering and CSV export.

Purpose: Fulfills ACONF-03 (guard performance metrics), ACONF-04 (audit trail), and ACONF-05 (bulk operations display). Provides admin with operational intelligence on guard performance and a compliance-ready audit trail.
Output: 2 chart components + 2 page files + 1 hooks file for analytics and audit.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-admin-governance-analytics/15-RESEARCH.md
@packages/admin/src/hooks/useAccessLogs.ts
@packages/admin/src/components/charts/CollectionChart.tsx
@packages/admin/src/components/charts/KPICard.tsx
@packages/admin/src/components/ui/DataTable.tsx
@packages/admin/src/lib/formatters.ts
@packages/admin/src/lib/export.ts
@supabase/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics hooks and chart components</name>
  <files>
    packages/admin/src/hooks/useAnalytics.ts
    packages/admin/src/components/charts/PatrolCompletionChart.tsx
    packages/admin/src/components/charts/ResponseTimeChart.tsx
  </files>
  <action>
**Create `packages/admin/src/hooks/useAnalytics.ts`:**

1. **useGuardPerformance(dateFrom: string, dateTo: string)** -- aggregates guard metrics from multiple tables in a single queryFn:

   a. Query `patrol_logs` where community_id matches and started_at between dateFrom and dateTo. Select: id, guard_id, checkpoints_total, checkpoints_visited, status, started_at, completed_at. Also join `guards(first_name, last_name)` if available -- if guards table doesn't have first_name, join through `guards(user_id)` then just use guard_id as identifier.

   b. Query `incidents` (the existing incidents table) where community_id matches and created_at between dateFrom and dateTo. Select: id, severity, status, created_at.

   c. Compute client-side aggregations from the raw data:
      - `totalPatrols`: count of patrol_logs
      - `completedPatrols`: count where status = 'completed'
      - `completionRate`: (completedPatrols / totalPatrols * 100) or 0
      - `totalIncidents`: count of incidents
      - `avgResponseMinutes`: average time between incident created_at and first status change (if not computable from current data, set to 0 with a note)
      - `patrolByGuard`: group patrol_logs by guard_id, for each: { guard_name, patrols_completed (status='completed'), patrols_scheduled (total), completion_rate }
      - `incidentsBySeverity`: group incidents by severity, count each

   d. Return the aggregated metrics object. Uses `queryKeys['guard-metrics'].performance(communityId!, { from: dateFrom, to: dateTo })`.

2. **useAuditLogs(filters: { dateFrom: string; dateTo: string; tableName?: string; action?: string; page: number; pageSize: number })** -- Query approach: Since there's no dedicated `audit_log` table in database.types.ts, build the audit trail from the `created_by`, `updated_by`, `created_at`, `updated_at` columns that exist on most tables.

   ALTERNATIVE APPROACH (simpler and more practical): Query a set of key tables (violations, elections, assemblies, announcements, tickets) and union their recent mutations into an audit-like view. For each table, select id, created_at (as timestamp), created_by (as user_id), 'create' as action, '{table_name}' as entity_type. Filter by date range.

   SIMPLEST APPROACH: Query the most recently modified records across governance tables, sorted by updated_at desc. This gives a "recent activity" feed rather than a formal audit log.

   Implementation: In a single queryFn, make parallel queries to:
   - `elections` (select id, title as entity_name, created_at, updated_at, created_by, 'elections' as entity_type)
   - `assemblies` (same pattern)
   - `violations` (same pattern with violation_number as entity_name)
   - `announcements` (same pattern)
   - `tickets` (same pattern)

   Merge all results into a unified array, sort by most recent date (use updated_at), deduplicate, paginate client-side (total list should be manageable). Add action inference: if created_at === updated_at then 'Creado', else 'Actualizado'.

   Uses `queryKeys.audit.logs(communityId!, filters)`.

3. **useAuditLogsForExport(filters: Omit<...>)** -- same as useAuditLogs but enabled: false, no pagination, limit 5000. For CSV export via refetch().

**Create `packages/admin/src/components/charts/PatrolCompletionChart.tsx`:**
- Follow the exact pattern from CollectionChart.tsx (Recharts BarChart, ResponsiveContainer)
- Props: `data: Array<{ guard_name: string; patrols_completed: number; patrols_scheduled: number }>`
- Two bars: "Completados" (fill #22c55e, green) and "Programados" (fill #6366f1, indigo)
- XAxis: guard_name, YAxis: count, CartesianGrid, Tooltip, Legend
- Empty state: "Sin datos de patrullaje disponibles"
- Height: 300px

**Create `packages/admin/src/components/charts/ResponseTimeChart.tsx`:**
- Follow same Recharts pattern
- Props: `data: Array<{ date: string; avg_minutes: number }>`
- Single Bar: "Tiempo Promedio (min)" (fill #f59e0b, amber)
- XAxis: date, YAxis: minutes
- Empty state: "Sin datos de tiempo de respuesta"
- Height: 300px
- NOTE: If response time data is not readily available from current schema, the chart should gracefully show empty state. The hook can return an empty array for response_times initially.
  </action>
  <verify>Run `cd packages/admin && npx tsc --noEmit` -- no TypeScript errors. Verify 3 files exist.</verify>
  <done>Analytics hooks provide guard performance aggregations from patrol_logs and incidents tables. Two Recharts chart components ready for guard analytics dashboard. Audit trail hook merges recent mutations across governance tables.</done>
</task>

<task type="auto">
  <name>Task 2: Create guard analytics dashboard and audit trail pages</name>
  <files>
    packages/admin/src/app/(dashboard)/analytics/guards/page.tsx
    packages/admin/src/app/(dashboard)/analytics/audit/page.tsx
  </files>
  <action>
**Create `packages/admin/src/app/(dashboard)/analytics/guards/page.tsx`:**
- `'use client'` + `export const dynamic = 'force-dynamic'`
- **Date range filter:** dateFrom and dateTo inputs (default: last 30 days). Use state, recalculate on change.
- **Header:** "Metricas de Guardias" title, "Desempeno y estadisticas del equipo de seguridad" subtitle
- **KPI Cards row** (4 cards in grid-cols-1 sm:grid-cols-4 gap-4):
  1. "Total Patrullajes" -- totalPatrols, text-gray-900
  2. "Tasa de Completitud" -- completionRate + "%" , text-green-600
  3. "Incidentes Atendidos" -- totalIncidents, text-gray-900
  4. "Patrullajes Completos" -- completedPatrols, text-indigo-600

  Use Card component with padding="p-4". Each card: label (text-sm font-medium text-gray-500), value (mt-1 text-2xl font-bold). Follow KPICard.tsx pattern if it exists, otherwise inline.

- **Charts row** (grid-cols-1 lg:grid-cols-2 gap-6):
  1. Card with "Patrullajes por Guardia" title + PatrolCompletionChart (data from metrics.patrolByGuard)
  2. Card with "Incidentes por Severidad" title + simple Recharts BarChart inline:
     - Data from metrics.incidentsBySeverity (array of { severity, count })
     - Single bar with severity-based colors or single color
     - XAxis: severity label, YAxis: count

- **Loading state:** show skeleton cards while useGuardPerformance is loading
- **Empty state:** if no patrol data, show message "No hay datos de patrullaje para el periodo seleccionado"

**Create `packages/admin/src/app/(dashboard)/analytics/audit/page.tsx`:**
- `'use client'` + `export const dynamic = 'force-dynamic'`
- **Header:** "Registro de Auditoria" title, "Exportar CSV" button (right-aligned)
- **Filters row:**
  - dateFrom (date input, default 30 days ago)
  - dateTo (date input, default today)
  - action select: "" (Todas), "Creado", "Actualizado"
  - entity_type select: "" (Todos), "elections" (Elecciones), "assemblies" (Asambleas), "violations" (Infracciones), "announcements" (Avisos), "tickets" (Tickets)

- **DataTable** with columns:
  - Fecha/Hora: timestamp formatted with formatDate (or more detailed datetime format)
  - Accion: action text ("Creado" / "Actualizado") with badge (Creado=success, Actualizado=info)
  - Tipo: entity_type translated to Spanish
  - Entidad: entity_name (election title, violation number, etc.)
  - ID: entity id (truncated UUID, first 8 chars)

- **Export:** "Exportar CSV" button calls useAuditLogsForExport.refetch(), then on data available call exportToCSV with formatted rows: { 'Fecha': timestamp, 'Accion': action, 'Tipo': entity_type, 'Entidad': entity_name, 'ID': id }

- **Pagination:** client-side pagination since audit data is merged from multiple tables (use DataTable without server-side pagination, or implement simple client-side slice)

- **Empty state:** "No se encontraron registros de auditoria para los filtros seleccionados"

NOTE on ACONF-05 (bulk operations): Bulk charge generation already exists in Phase 11 (finances/charges page). Bulk notification sending will be handled in Phase 16. This plan focuses on the analytics/audit visibility of these operations. The audit trail will naturally capture bulk operations through their created_at/updated_at timestamps.
  </action>
  <verify>Run `cd packages/admin && npx tsc --noEmit` -- no TypeScript errors. Verify both pages exist with 'use client' + force-dynamic.</verify>
  <done>Guard analytics page shows KPI cards + patrol completion chart + incidents chart with date range filter. Audit trail page shows unified activity log from governance tables with filters and CSV export.</done>
</task>

</tasks>

<verification>
- `cd packages/admin && npx tsc --noEmit` passes
- Guard analytics: 4 KPI cards, patrol completion chart, incidents chart, date range filter
- Audit trail: DataTable with date/action/type filters, CSV export button
- Chart components follow established Recharts patterns (ResponsiveContainer, empty states)
- All pages use force-dynamic + lazy Supabase client
- No Badge size prop usage
</verification>

<success_criteria>
- ACONF-03: Admin can view guard performance metrics including patrol completion rates (KPI cards + charts)
- ACONF-04: Admin can view audit trail of administrative actions (audit page with filters + export)
- ACONF-05: Bulk operations are visible through audit trail (charge generation and notifications show as records)
</success_criteria>

<output>
After completion, create `.planning/phases/15-admin-governance-analytics/15-05-SUMMARY.md`
</output>
