---
phase: 15-admin-governance-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/src/app/(dashboard)/layout.tsx
  - packages/shared/src/queries/keys.ts
autonomous: true

must_haves:
  truths:
    - "Admin sidebar shows Governance, Violations, Emergency, Devices, and Analytics navigation sections"
    - "Query key factories exist for all Phase 15 entities enabling cache management"
  artifacts:
    - path: "packages/admin/src/app/(dashboard)/layout.tsx"
      provides: "Sidebar navigation with governance, violations, emergency, devices, analytics sections"
      contains: "governance"
    - path: "packages/shared/src/queries/keys.ts"
      provides: "Query key factories for assemblies, violations, emergencyContacts, devices, audit, guardMetrics"
      contains: "assemblies"
  key_links:
    - from: "packages/admin/src/app/(dashboard)/layout.tsx"
      to: "governance/elections"
      via: "NavItem href"
      pattern: "governance/elections"
    - from: "packages/shared/src/queries/keys.ts"
      to: "mergeQueryKeys"
      via: "export in merged queryKeys"
      pattern: "assemblies"
---

<objective>
Add Phase 15 navigation sections to the admin sidebar and create query key factories for all new governance/analytics entities.

Purpose: Foundation for all Phase 15 plans -- sidebar nav enables page routing, query keys enable cache management across elections, assemblies, violations, emergency contacts, devices, guard metrics, and audit trail.
Output: Updated sidebar with 5 new nav sections + expanded query key factories ready for hooks.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-admin-governance-analytics/15-RESEARCH.md
@packages/admin/src/app/(dashboard)/layout.tsx
@packages/shared/src/queries/keys.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Phase 15 sidebar navigation sections</name>
  <files>packages/admin/src/app/(dashboard)/layout.tsx</files>
  <action>
Add 5 new NavItem entries to the `navItems` array in the dashboard layout, positioned after the existing Marketplace entry and before Settings:

1. **Governance** (href: '/governance', icon: 'scale', label: 'Gobernanza')
   - Children: elections ('/governance/elections', 'Elecciones'), assemblies ('/governance/assemblies', 'Asambleas')

2. **Violations** (href: '/violations', icon: 'shield-exclamation', label: 'Infracciones')
   - No children (single page with detail routes)

3. **Emergency** (href: '/emergency', icon: 'bell-alert', label: 'Emergencia')
   - Children: contacts ('/emergency/contacts', 'Contactos'), medical ('/emergency/medical', 'Info Medica'), evacuation ('/emergency/evacuation', 'Evacuacion')

4. **Devices** (href: '/devices', icon: 'key', label: 'Dispositivos')
   - No children (single page with detail routes)

5. **Analytics** (href: '/analytics', icon: 'chart-bar', label: 'Analiticas')
   - Children: guards ('/analytics/guards', 'Guardias'), audit ('/analytics/audit', 'Auditoria')

Add corresponding SVG icons to the NavIcon component using inline Heroicons (matching the existing pattern -- h-5 w-5, fill="none", viewBox="0 0 24 24", strokeWidth={1.5}):
- 'scale': Heroicon "scale" (justice scales)
- 'shield-exclamation': Heroicon "shield-exclamation"
- 'bell-alert': Heroicon "bell-alert"
- 'key': Heroicon "key"
- 'chart-bar': Heroicon "chart-bar-square" (different from existing 'chart' icon)

IMPORTANT: Keep the existing 'chart' icon case for '/reports'. The new 'chart-bar' case is distinct. Use the Heroicons outline set from https://heroicons.com for correct SVG paths.
  </action>
  <verify>Run `cd packages/admin && npx tsc --noEmit` -- no TypeScript errors. Visually inspect layout.tsx to confirm 5 new nav items with correct hrefs, labels, icons, and children.</verify>
  <done>Sidebar has Gobernanza, Infracciones, Emergencia, Dispositivos, and Analiticas nav sections with correct child routes and distinct SVG icons.</done>
</task>

<task type="auto">
  <name>Task 2: Add query key factories for Phase 15 entities</name>
  <files>packages/shared/src/queries/keys.ts</files>
  <action>
Add the following query key factories to the shared keys file, following the exact established pattern (createQueryKeys + add to mergeQueryKeys):

1. **assemblies** (key: 'assemblies'):
   - all: null
   - list: (communityId: string) => [{ communityId }]
   - detail: (id: string) => [id]
   - attendance: (assemblyId: string) => [{ assemblyId }]
   - agreements: (assemblyId: string) => [{ assemblyId }]

2. **violations** (key: 'violations'):
   - all: null
   - list: (communityId: string) => [{ communityId }]
   - detail: (id: string) => [id]
   - sanctions: (violationId: string) => [{ violationId }]
   - appeals: (violationId: string) => [{ violationId }]
   - types: (communityId: string) => [{ communityId }]

3. **emergencyContacts** (key: 'emergency-contacts'):
   - all: null
   - byResident: (residentId: string) => [{ residentId }]
   - byUnit: (unitId: string) => [{ unitId }]
   - evacuation: (communityId: string) => [{ communityId }]
   - medical: (communityId: string) => [{ communityId }]

4. **devices** (key: 'devices'):
   - all: null
   - list: (communityId: string) => [{ communityId }]
   - detail: (id: string) => [id]
   - types: (communityId: string) => [{ communityId }]
   - assignments: (deviceId: string) => [{ deviceId }]

5. **guardMetrics** (key: 'guard-metrics'):
   - all: null
   - performance: (communityId: string, dateRange?: { from: string; to: string }) => [{ communityId, dateRange }]
   - patrolStats: (communityId: string) => [{ communityId }]

6. **audit** (key: 'audit'):
   - all: null
   - logs: (communityId: string, filters?: Record<string, unknown>) => [{ communityId, filters }]

Add all 6 new factories to the `mergeQueryKeys` call at the bottom. Keep alphabetical ordering consistent with existing entries.

NOTE: The `elections` factory already exists (lines 125-130). Do NOT duplicate it.
  </action>
  <verify>Run `cd packages/shared && npx tsc --noEmit` and `cd packages/admin && npx tsc --noEmit` -- no TypeScript errors. Verify the new factories are importable: `queryKeys.assemblies.list(...)`, `queryKeys.violations.detail(...)`, etc.</verify>
  <done>6 new query key factories (assemblies, violations, emergencyContacts, devices, guardMetrics, audit) exist in shared keys.ts and are included in the merged queryKeys export.</done>
</task>

</tasks>

<verification>
- `cd packages/shared && npx tsc --noEmit` passes
- `cd packages/admin && npx tsc --noEmit` passes
- Sidebar layout has 5 new navigation sections with proper href paths
- Query key factories cover all Phase 15 entities
</verification>

<success_criteria>
- Admin sidebar shows Gobernanza, Infracciones, Emergencia, Dispositivos, Analiticas with correct children
- All 6 new query key factories are accessible via `queryKeys.*`
- No TypeScript compilation errors in either package
</success_criteria>

<output>
After completion, create `.planning/phases/15-admin-governance-analytics/15-01-SUMMARY.md`
</output>
