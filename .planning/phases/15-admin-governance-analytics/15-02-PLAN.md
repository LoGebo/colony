---
phase: 15-admin-governance-analytics
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - packages/admin/src/hooks/useGovernance.ts
  - packages/admin/src/app/(dashboard)/governance/elections/page.tsx
  - packages/admin/src/app/(dashboard)/governance/elections/[id]/page.tsx
  - packages/admin/src/app/(dashboard)/governance/elections/new/page.tsx
  - packages/admin/src/app/(dashboard)/governance/assemblies/page.tsx
  - packages/admin/src/app/(dashboard)/governance/assemblies/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view elections list with status, quorum, and type columns"
    - "Admin can create new elections with title, type, options, and schedule"
    - "Admin can open/close voting and view real-time results with quorum progress bar"
    - "Admin can view assemblies list and manage attendance with coefficient-weighted quorum"
    - "Admin can record assembly agreements and action items"
  artifacts:
    - path: "packages/admin/src/hooks/useGovernance.ts"
      provides: "TanStack Query hooks for elections, assemblies, attendance, agreements, and votes"
      contains: "useElections"
    - path: "packages/admin/src/app/(dashboard)/governance/elections/page.tsx"
      provides: "Elections list with DataTable, status badges, quorum indicators"
      contains: "force-dynamic"
    - path: "packages/admin/src/app/(dashboard)/governance/elections/[id]/page.tsx"
      provides: "Election detail with quorum progress bar, results bar chart, open/close voting actions"
      contains: "BarChart"
    - path: "packages/admin/src/app/(dashboard)/governance/elections/new/page.tsx"
      provides: "Multi-step election creation wizard"
      contains: "useForm"
    - path: "packages/admin/src/app/(dashboard)/governance/assemblies/page.tsx"
      provides: "Assemblies list with DataTable"
      contains: "force-dynamic"
    - path: "packages/admin/src/app/(dashboard)/governance/assemblies/[id]/page.tsx"
      provides: "Assembly detail with attendance tracking, quorum display, agreements list"
      contains: "calculate_assembly_quorum"
  key_links:
    - from: "packages/admin/src/app/(dashboard)/governance/elections/[id]/page.tsx"
      to: "packages/admin/src/hooks/useGovernance.ts"
      via: "useElectionDetail, useElectionOptions hooks"
      pattern: "useElectionDetail"
    - from: "packages/admin/src/hooks/useGovernance.ts"
      to: "supabase.from('elections')"
      via: "lazy Supabase client in queryFn"
      pattern: "from\\('elections'\\)"
    - from: "packages/admin/src/app/(dashboard)/governance/assemblies/[id]/page.tsx"
      to: "supabase.rpc('calculate_assembly_quorum')"
      via: "hook calling database RPC"
      pattern: "calculate_assembly_quorum"
---

<objective>
Build the governance management UI: elections with voting/quorum tracking, assemblies with attendance, and agreements management.

Purpose: Fulfills AGOV-01 through AGOV-05 -- admin can manage the full governance lifecycle from creating elections to recording assembly agreements.
Output: 6 page files + 1 hooks file implementing elections CRUD, assembly management, and governance workflows.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-admin-governance-analytics/15-RESEARCH.md
@packages/admin/src/hooks/useAccessLogs.ts
@packages/admin/src/components/ui/DataTable.tsx
@packages/admin/src/components/ui/Badge.tsx
@packages/admin/src/components/charts/CollectionChart.tsx
@packages/admin/src/lib/formatters.ts
@supabase/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create governance hooks and elections pages</name>
  <files>
    packages/admin/src/hooks/useGovernance.ts
    packages/admin/src/app/(dashboard)/governance/elections/page.tsx
    packages/admin/src/app/(dashboard)/governance/elections/[id]/page.tsx
    packages/admin/src/app/(dashboard)/governance/elections/new/page.tsx
  </files>
  <action>
**Create `packages/admin/src/hooks/useGovernance.ts`** with these hooks following the useAccessLogs.ts pattern (lazy Supabase client in queryFn, useAuth for communityId):

1. `useElections(filters: { status?: string; page: number; pageSize: number })` -- paginated list from `elections` table with count, ordered by created_at desc. Select: id, election_number, title, election_type, status, opens_at, closes_at, quorum_required, total_coefficient_voted, quorum_met, created_at. Filter by status if provided (use `as never` cast). Uses `queryKeys.elections.list(communityId!)`.

2. `useElectionDetail(id: string)` -- single election with its options. Select election by id, then in same queryFn fetch `election_options` where election_id = id, ordered by display_order. Return `{ election, options }`. Uses `queryKeys.elections.detail(id)`.

3. `useCreateElection()` -- useMutation that inserts into `elections` table and then batch-inserts `election_options`. On success invalidate elections.list. Generate election_number as `ELEC-${Date.now()}` or let database generate. Required fields: community_id, title, election_type (cast as never), opens_at, closes_at. Then for each option: insert into election_options with election_id, title, display_order.

4. `useUpdateElectionStatus()` -- useMutation that updates election status (open/close). Takes `{ id: string; status: 'open' | 'closed' }`. Uses `as never` cast for status enum. On success invalidate elections.detail and elections.list.

5. `useAssemblies(filters: { status?: string; page: number; pageSize: number })` -- paginated list from `assemblies`. Select: id, assembly_number, title, assembly_type, status, scheduled_date, scheduled_time, location, quorum_met, quorum_percentage, quorum_coefficient_present. Filter by status. Uses `queryKeys.assemblies.list(communityId!)`.

6. `useAssemblyDetail(id: string)` -- single assembly with attendance and agreements. In queryFn: fetch assembly by id, fetch `assembly_attendance` where assembly_id = id (with unit join for unit_number), fetch `assembly_agreements` where assembly_id = id ordered by agreement_number. Return `{ assembly, attendance, agreements }`. Uses `queryKeys.assemblies.detail(id)`.

7. `useAssemblyQuorum(assemblyId: string)` -- calls `supabase.rpc('calculate_assembly_quorum', { p_assembly_id: assemblyId })`. Uses `queryKeys.assemblies.attendance(assemblyId)`.

8. `useAddAttendee()` -- useMutation inserting into `assembly_attendance`. Required: assembly_id, unit_id, attendee_type (as never), coefficient. Optional: is_proxy, proxy_grantor_id, attendee_name. Invalidate assemblies.detail and assemblies.attendance.

9. `useAddAgreement()` -- useMutation inserting into `assembly_agreements`. Required: assembly_id, agreement_number, title, description, display_order. Optional: action_required, action_description, action_due_date, action_responsible. Invalidate assemblies.detail.

**Create `packages/admin/src/app/(dashboard)/governance/elections/page.tsx`:**
- `'use client'` + `export const dynamic = 'force-dynamic'`
- DataTable with columns: Numero (election_number), Titulo (title), Tipo (election_type badge), Estado (status badge with color variants: draft=neutral, open=info, closed=success, cancelled=danger), Quorum (quorum_met ? success badge : warning badge), Apertura (opens_at formatted), Cierre (closes_at formatted)
- Status filter dropdown (draft, open, closed, cancelled)
- "Nueva Eleccion" button linking to `/governance/elections/new`
- Row click navigates to `/governance/elections/${id}`
- Follow exact DataTable pattern from access-logs page (pagination state, onPaginationChange)

**Create `packages/admin/src/app/(dashboard)/governance/elections/[id]/page.tsx`:**
- `'use client'` + `export const dynamic = 'force-dynamic'`
- Header: title, election_number, status badge, election_type badge
- Action buttons: "Abrir Votacion" (if draft -> set status to open), "Cerrar Votacion" (if open -> set status to closed)
- Quorum progress section: horizontal progress bar showing `total_coefficient_voted / quorum_required * 100`, percentage text, quorum_met badge
- Results chart: Recharts BarChart showing each election_option with `coefficient_total` as the bar value, option title as x-axis. Use indigo fill matching existing chart patterns.
- Options table: list each option with title, description, votes_count, coefficient_total
- Use formatDate from @/lib/formatters for dates

**Create `packages/admin/src/app/(dashboard)/governance/elections/new/page.tsx`:**
- `'use client'` + `export const dynamic = 'force-dynamic'`
- Multi-step form wizard (3 steps):
  - Step 1 (Info Basica): title (required), description (optional), election_type select (board_election, budget_approval, rules_amendment, general_vote -- use as never for each)
  - Step 2 (Opciones): dynamic list of options with title + description. Add/remove buttons. Minimum 2 options.
  - Step 3 (Programacion): opens_at (datetime-local input), closes_at (datetime-local input). closes_at must be after opens_at.
- Use react-hook-form with step state management (useState for current step)
- On submit call useCreateElection mutation, navigate to elections list on success
- Previous/Next buttons, Submit on final step

Badge variant mapping for election_status: draft='neutral', open='info', closed='success', cancelled='danger'.
Badge variant mapping for election_type: board_election='info', budget_approval='warning', rules_amendment='neutral', general_vote='success'.
  </action>
  <verify>Run `cd packages/admin && npx tsc --noEmit` -- no TypeScript errors. Verify all 4 files exist and have correct 'use client' + force-dynamic declarations.</verify>
  <done>Elections list page shows DataTable with pagination, election detail shows quorum progress + results chart + open/close actions, election creation wizard has 3-step form. All hooks use lazy Supabase client and established query key factories.</done>
</task>

<task type="auto">
  <name>Task 2: Create assemblies pages with attendance and agreements</name>
  <files>
    packages/admin/src/app/(dashboard)/governance/assemblies/page.tsx
    packages/admin/src/app/(dashboard)/governance/assemblies/[id]/page.tsx
  </files>
  <action>
**Create `packages/admin/src/app/(dashboard)/governance/assemblies/page.tsx`:**
- `'use client'` + `export const dynamic = 'force-dynamic'`
- DataTable with columns: Numero (assembly_number), Titulo (title), Tipo (assembly_type badge), Estado (status badge), Fecha (scheduled_date + scheduled_time formatted), Ubicacion (location), Quorum (quorum_met ? success badge 'Alcanzado' : warning badge 'Pendiente')
- Status filter dropdown (scheduled, in_progress, completed, cancelled)
- Row click navigates to `/governance/assemblies/${id}`
- Follow DataTable pagination pattern

Badge variant mapping for assembly_status: scheduled='neutral', in_progress='info', completed='success', cancelled='danger'.
Badge variant mapping for assembly_type: ordinary='info', extraordinary='warning'.

**Create `packages/admin/src/app/(dashboard)/governance/assemblies/[id]/page.tsx`:**
- `'use client'` + `export const dynamic = 'force-dynamic'`
- **Header section:** title, assembly_number, assembly_type badge, status badge, scheduled_date + scheduled_time, location
- **Quorum section (Card):**
  - Call useAssemblyQuorum to get real-time quorum calculation
  - Show progress bar: `present_coefficient / total_coefficient * 100`
  - Display: "Coeficiente presente: {present_coefficient}%", "Requerido: depends on convocatoria"
  - Show which convocatoria requirements are met (convocatoria_1, _2, _3 booleans from RPC)
  - quorum_met badge

- **Attendance section (Card):**
  - Table showing attendees: Unidad (unit_number from joined unit), Asistente (attendee_name or 'Propietario'), Tipo (attendee_type badge: owner/tenant/proxy), Coeficiente (coefficient), Llegada (checked_in_at formatted), Es Poder (is_proxy badge)
  - "Registrar Asistente" button that opens inline form:
    - Unit selector (dropdown of community units -- query units table)
    - attendee_type select (owner, tenant, proxy -- cast as never)
    - coefficient (auto-fill from selected unit if possible)
    - is_proxy checkbox, if checked show proxy_grantor_id field
    - Submit calls useAddAttendee mutation
  - Count: "{attendance.length} asistentes registrados"

- **Agreements section (Card):**
  - List of agreements ordered by agreement_number with: number, title, description, approved status (si/no/null badge), action_required indicator
  - If action_required: show action_description, action_due_date, action_responsible, action_completed_at
  - "Agregar Acuerdo" button with inline form:
    - agreement_number (auto-increment from existing max)
    - title (required)
    - description (required)
    - action_required checkbox
    - If action_required: action_description, action_due_date (date input), action_responsible (text)
    - Submit calls useAddAgreement mutation

For the unit selector in attendance form: use a simple useQuery to fetch units (id, unit_number, coefficient) from units table where community_id matches. This can be a small inline hook or reuse useUnits if it provides coefficient data.
  </action>
  <verify>Run `cd packages/admin && npx tsc --noEmit` -- no TypeScript errors. Verify both assembly pages exist with correct structure.</verify>
  <done>Assemblies list page shows DataTable with status/quorum. Assembly detail shows live quorum calculation from RPC, attendance management with add form, and agreements list with add form and action item tracking.</done>
</task>

</tasks>

<verification>
- `cd packages/admin && npx tsc --noEmit` passes
- Elections: list page with DataTable, detail with quorum bar + results chart, create wizard with 3 steps
- Assemblies: list page with DataTable, detail with attendance + quorum + agreements
- All pages use 'use client' + force-dynamic
- All hooks use lazy Supabase client pattern
- Badge component has NO size prop usage
- Enum values use 'as never' cast
</verification>

<success_criteria>
- AGOV-01: Admin can create elections with voting rules (create wizard with type, options, schedule)
- AGOV-02: Admin can open/close voting and view real-time results with quorum tracking (detail page)
- AGOV-03: Admin can manage assemblies with coefficient-weighted quorum (detail page with RPC)
- AGOV-04: Surveys handled via assembly agreements (no separate surveys table exists in DB)
- AGOV-05: Admin can record assembly agreements and action items (agreements section in detail)
</success_criteria>

<output>
After completion, create `.planning/phases/15-admin-governance-analytics/15-02-SUMMARY.md`
</output>
