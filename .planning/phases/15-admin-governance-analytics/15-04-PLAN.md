---
phase: 15-admin-governance-analytics
plan: 04
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - packages/admin/src/hooks/useEmergency.ts
  - packages/admin/src/hooks/useDevices.ts
  - packages/admin/src/app/(dashboard)/emergency/contacts/page.tsx
  - packages/admin/src/app/(dashboard)/emergency/medical/page.tsx
  - packages/admin/src/app/(dashboard)/emergency/evacuation/page.tsx
  - packages/admin/src/app/(dashboard)/devices/page.tsx
  - packages/admin/src/app/(dashboard)/devices/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view emergency contacts per resident with privacy-aware display"
    - "Admin can view medical conditions and accessibility needs"
    - "Admin can generate evacuation priority list from database RPC"
    - "Admin can view access device inventory with status and serial numbers"
    - "Admin can assign devices to units/residents and track lifecycle"
    - "Admin can process device returns, lost reports, and replacement fees"
  artifacts:
    - path: "packages/admin/src/hooks/useEmergency.ts"
      provides: "Hooks for emergency contacts, medical conditions, evacuation list"
      contains: "useEvacuationList"
    - path: "packages/admin/src/hooks/useDevices.ts"
      provides: "Hooks for device inventory, assignments, events"
      contains: "useDevices"
    - path: "packages/admin/src/app/(dashboard)/emergency/contacts/page.tsx"
      provides: "Emergency contacts by unit/resident"
      contains: "force-dynamic"
    - path: "packages/admin/src/app/(dashboard)/emergency/medical/page.tsx"
      provides: "Medical conditions and accessibility needs list"
      contains: "force-dynamic"
    - path: "packages/admin/src/app/(dashboard)/emergency/evacuation/page.tsx"
      provides: "Evacuation priority list from RPC"
      contains: "get_evacuation_priority_list"
    - path: "packages/admin/src/app/(dashboard)/devices/page.tsx"
      provides: "Device inventory with DataTable"
      contains: "force-dynamic"
    - path: "packages/admin/src/app/(dashboard)/devices/[id]/page.tsx"
      provides: "Device detail with assignment history and lifecycle actions"
      contains: "force-dynamic"
  key_links:
    - from: "packages/admin/src/app/(dashboard)/emergency/evacuation/page.tsx"
      to: "supabase.rpc('get_evacuation_priority_list')"
      via: "useEvacuationList hook"
      pattern: "get_evacuation_priority_list"
    - from: "packages/admin/src/hooks/useDevices.ts"
      to: "supabase.from('access_devices')"
      via: "lazy Supabase client in queryFn"
      pattern: "access_devices"
---

<objective>
Build emergency management (contacts, medical info, evacuation) and access device inventory with lifecycle tracking.

Purpose: Fulfills AEMRG-01 through AEMRG-03 (emergency preparedness) and AKEY-01 through AKEY-04 (device management). Enables admin to manage emergency contacts with privacy controls, generate evacuation lists, and track access device lifecycle.
Output: 5 page files + 2 hooks files for emergency and device management.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-admin-governance-analytics/15-RESEARCH.md
@packages/admin/src/hooks/useAccessLogs.ts
@packages/admin/src/components/ui/DataTable.tsx
@packages/admin/src/components/ui/Badge.tsx
@packages/admin/src/lib/formatters.ts
@packages/admin/src/lib/export.ts
@supabase/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create emergency hooks and pages (contacts, medical, evacuation)</name>
  <files>
    packages/admin/src/hooks/useEmergency.ts
    packages/admin/src/app/(dashboard)/emergency/contacts/page.tsx
    packages/admin/src/app/(dashboard)/emergency/medical/page.tsx
    packages/admin/src/app/(dashboard)/emergency/evacuation/page.tsx
  </files>
  <action>
**Create `packages/admin/src/hooks/useEmergency.ts`:**

1. `useEmergencyContactsByUnit(unitId: string)` -- calls `supabase.rpc('get_emergency_contacts_for_unit', { p_unit_id: unitId })`. Returns array of { resident_id, resident_name, contact_name, relationship, phone_primary, phone_secondary, priority, contact_for }. Uses `queryKeys['emergency-contacts'].byUnit(unitId)`.

2. `useAllEmergencyContacts(page: number, pageSize: number)` -- paginated query from `emergency_contacts` table with joins: `*, residents!inner(first_name, last_name, user_id), units:occupancies!inner(units!inner(unit_number))`. Filter by community_id. This is complex due to the join path (emergency_contacts -> residents -> occupancies -> units). Alternative simpler approach: query emergency_contacts with `residents(first_name, last_name)` join, ordered by contact_name. Uses `queryKeys['emergency-contacts'].all` extended with pagination.

    NOTE: If the join path through occupancies is too complex for PostgREST, fallback to just joining `residents(first_name, last_name)` and displaying resident name without unit. The admin can click to see unit context.

3. `useMedicalConditions()` -- query from `medical_conditions` table where community_id matches and deleted_at is null. Select: `*, residents!inner(first_name, last_name)`. Uses `queryKeys['emergency-contacts'].medical(communityId!)`.

4. `useAccessibilityNeeds()` -- query from `accessibility_needs` table where community_id matches and deleted_at is null. Select: `*, residents!inner(first_name, last_name)`. Uses `queryKeys['emergency-contacts'].medical(communityId!)` extended with 'accessibility'.

5. `useEvacuationList()` -- calls `supabase.rpc('get_evacuation_priority_list', { p_community_id: communityId! })`. Returns array of { resident_id, resident_name, unit_id, unit_number, floor_number, needs_evacuation_assistance, uses_mobility_device, mobility_device_type, need_type, evacuation_notes }. Uses `queryKeys['emergency-contacts'].evacuation(communityId!)`.

**Create `packages/admin/src/app/(dashboard)/emergency/contacts/page.tsx`:**
- `'use client'` + `export const dynamic = 'force-dynamic'`
- Two-column layout:
  - Left: Unit selector dropdown (list of units). On select, show emergency contacts for that unit using useEmergencyContactsByUnit
  - Right: Contact cards displaying: contact_name, relationship badge, phone_primary, phone_secondary (if exists), priority number, contact_for array as tag badges
- If no unit selected: show prompt "Seleccione una unidad para ver contactos de emergencia"
- "Exportar" button: export all contacts for selected unit to CSV using exportToCSV from @/lib/export
- Use Card component for each contact, privacy-aware display (show all data since admin has full access per RLS)

**Create `packages/admin/src/app/(dashboard)/emergency/medical/page.tsx`:**
- `'use client'` + `export const dynamic = 'force-dynamic'`
- Privacy banner at top: "Informacion medica confidencial - Solo visible para administradores" with a warning icon
- Two sections:

  Section 1 - Medical Conditions:
  - DataTable or card list from useMedicalConditions
  - Columns/fields: Residente (first_name + last_name), Condicion (condition_type), Severidad (severity badge), Medicacion (medications), Notas (notes)
  - If no data: empty state "No hay condiciones medicas registradas"

  Section 2 - Accessibility Needs:
  - Card list from useAccessibilityNeeds
  - Fields: Residente, Tipo (need_type badge), Descripcion, Dispositivo de movilidad (if uses_mobility_device: mobility_device_type), Animal de servicio (if has_service_animal: service_animal_type), Necesita asistencia de evacuacion (boolean badge), Notas de evacuacion

**Create `packages/admin/src/app/(dashboard)/emergency/evacuation/page.tsx`:**
- `'use client'` + `export const dynamic = 'force-dynamic'`
- Header: "Lista de Prioridad de Evacuacion"
- Call useEvacuationList hook
- Display as ordered list (ordered by floor_number desc -- highest floors first):
  - Each row: Piso {floor_number}, Unidad {unit_number}, Residente {resident_name}, need_type badge, mobility info, evacuation_notes
  - Highlight rows where needs_evacuation_assistance = true with amber/yellow background
- "Imprimir" button: calls window.print() for browser print dialog
- "Exportar CSV" button: exportToCSV with formatted data
- Summary at top: "Total con asistencia requerida: {count}" / "Total registros: {total}"
  </action>
  <verify>Run `cd packages/admin && npx tsc --noEmit` -- no TypeScript errors. Verify 4 files exist.</verify>
  <done>Emergency contacts page shows per-unit contacts with export. Medical page shows conditions and accessibility needs with privacy banner. Evacuation page shows priority list from RPC with print and export functionality.</done>
</task>

<task type="auto">
  <name>Task 2: Create device inventory hooks and pages</name>
  <files>
    packages/admin/src/hooks/useDevices.ts
    packages/admin/src/app/(dashboard)/devices/page.tsx
    packages/admin/src/app/(dashboard)/devices/[id]/page.tsx
  </files>
  <action>
**IMPORTANT NOTE:** The `access_devices`, `access_device_types`, `access_device_assignments`, and `access_device_events` tables exist in the database (migration 20260130043911) but are NOT present in database.types.ts. The types file has the `device_type` and `device_status` enums but not the table types. You MUST cast query results with `as unknown as DeviceRow[]` (or similar) and define manual TypeScript interfaces for these tables.

**Create `packages/admin/src/hooks/useDevices.ts`:**

Define manual types (since tables are not in database.types.ts):

```typescript
export interface DeviceRow {
  id: string;
  community_id: string;
  device_type_id: string;
  serial_number: string;
  internal_code: string | null;
  batch_number: string | null;
  purchased_at: string | null;
  vendor: string | null;
  status: string; // device_status enum
  status_changed_at: string;
  current_assignment_id: string | null;
  notes: string | null;
  created_at: string;
  // Joined
  device_type_name?: string;
}

export interface DeviceTypeRow {
  id: string;
  device_type: string;
  name: string;
  description: string | null;
  deposit_amount: number;
  replacement_fee: number;
  is_active: boolean;
}

export interface DeviceAssignmentRow {
  id: string;
  device_id: string;
  unit_id: string;
  resident_id: string | null;
  assigned_at: string;
  returned_at: string | null;
  deposit_collected: number;
  deposit_returned: number | null;
  replacement_fee_charged: number | null;
  notes: string | null;
  assigned_by: string | null;
  returned_to: string | null;
}
```

Hooks:

1. `useDevices(filters: { status?: string; deviceTypeId?: string; page: number; pageSize: number })` -- query `access_devices` table. Select: `*, access_device_types(name, device_type)`. Apply filters (status as never, device_type_id). Order by created_at desc. Paginate with range. Cast result as unknown as DeviceRow[]. Uses `queryKeys.devices.list(communityId!)`.

2. `useDeviceDetail(id: string)` -- single device with type info. Select from access_devices by id, join access_device_types. Cast result. Uses `queryKeys.devices.detail(id)`.

3. `useDeviceAssignments(deviceId: string)` -- list from `access_device_assignments` where device_id = deviceId, ordered by assigned_at desc. Join units(unit_number) and residents(first_name, last_name). Cast result. Uses `queryKeys.devices.assignments(deviceId)`.

4. `useDeviceTypes()` -- list from `access_device_types` where community_id matches and is_active = true. Cast result. Uses `queryKeys.devices.types(communityId!)`.

5. `useCreateDevice()` -- useMutation inserting into `access_devices`. Required: community_id, device_type_id, serial_number, status ('in_inventory' as never). Optional: internal_code, batch_number, purchased_at, vendor, notes. Invalidate devices.list.

6. `useAssignDevice()` -- useMutation that: (a) inserts into `access_device_assignments` (device_id, unit_id, resident_id, deposit_collected), (b) updates `access_devices` set status = 'assigned' (as never), current_assignment_id = new assignment id. Invalidate devices.detail, devices.list, devices.assignments.

7. `useReturnDevice()` -- useMutation that: (a) updates `access_device_assignments` set returned_at = now(), deposit_returned, (b) updates `access_devices` set status = 'in_inventory' (as never), current_assignment_id = null. Invalidate same.

8. `useReportLost()` -- useMutation that: (a) updates `access_devices` set status = 'lost' (as never), (b) optionally charges replacement fee on the assignment (update replacement_fee_charged). Invalidate devices.detail, devices.list.

**Create `packages/admin/src/app/(dashboard)/devices/page.tsx`:**
- `'use client'` + `export const dynamic = 'force-dynamic'`
- **Filters:** status select (in_inventory, assigned, lost, damaged, deactivated, retired), device type select (from useDeviceTypes)
- **DataTable** with columns:
  - Serial (serial_number)
  - Codigo (internal_code or '-')
  - Tipo (device type name from joined access_device_types)
  - Estado (status badge: in_inventory=success, assigned=info, lost=danger, damaged=warning, deactivated=neutral, retired=neutral)
  - Compra (purchased_at formatted or '-')
  - Proveedor (vendor or '-')
- Row click navigates to `/devices/${id}`
- "Nuevo Dispositivo" button opens modal form:
  - device_type_id select (from useDeviceTypes)
  - serial_number (text, required)
  - internal_code (text, optional)
  - batch_number (text, optional)
  - purchased_at (date, optional)
  - vendor (text, optional)
  - notes (textarea, optional)
  - Submit calls useCreateDevice
- "Exportar" button: exportToExcel with device inventory data

**Create `packages/admin/src/app/(dashboard)/devices/[id]/page.tsx`:**
- `'use client'` + `export const dynamic = 'force-dynamic'`
- **Header:** serial_number, internal_code, type name, status badge
- **Device Info Card:** all device fields (serial, code, batch, vendor, purchased_at, notes, status_changed_at)
- **Action buttons** (conditional on current status):
  - If 'in_inventory': "Asignar" button opens assignment form (unit selector, optional resident selector, deposit_collected number input)
  - If 'assigned': "Devolver" button opens return form (deposit_returned number input), "Reportar Perdido" button (confirm dialog then calls useReportLost with optional replacement_fee_charged)
  - If 'lost': "Reemplazar" button (changes status to 'retired', creates new device -- or just show info)
- **Assignment History section:**
  - Use useDeviceAssignments hook
  - Table: Unidad (unit_number), Residente (name), Asignado (assigned_at formatted), Devuelto (returned_at formatted or 'Actual'), Deposito (deposit_collected formatted as currency), Devuelto (deposit_returned or '-'), Cargo (replacement_fee_charged or '-')
- **Deposit/Fee summary:** total deposits collected vs returned, replacement fees charged
  </action>
  <verify>Run `cd packages/admin && npx tsc --noEmit` -- no TypeScript errors. Verify 3 files exist. NOTE: TypeScript may show warnings about access_device* tables not being in Database types -- the manual interfaces and `as unknown` casts should handle this.</verify>
  <done>Device inventory page shows DataTable with filters and create modal. Device detail shows info, lifecycle action buttons (assign/return/lost), and full assignment history with deposit tracking.</done>
</task>

</tasks>

<verification>
- `cd packages/admin && npx tsc --noEmit` passes
- Emergency contacts: per-unit view with export
- Medical info: conditions + accessibility needs with privacy banner
- Evacuation: priority list from RPC with print + CSV export
- Devices: inventory DataTable with create/assign/return/lost lifecycle
- All pages use force-dynamic + lazy Supabase client
- Device table queries use `as unknown` cast for tables not in database.types.ts
</verification>

<success_criteria>
- AEMRG-01: Admin can manage emergency contacts per resident (contacts page with unit selector)
- AEMRG-02: Admin can view medical conditions and accessibility needs (medical page with privacy banner)
- AEMRG-03: Admin can generate evacuation priority list (evacuation page with RPC + print)
- AKEY-01: Admin can manage access device inventory (devices list with create modal)
- AKEY-02: Admin can assign and track device assignments (detail page assign action + history)
- AKEY-03: Admin can process returns, transfers, and lost reports (detail page return/lost actions)
- AKEY-04: Admin can track device replacement fees (assignment history with fee columns)
</success_criteria>

<output>
After completion, create `.planning/phases/15-admin-governance-analytics/15-04-SUMMARY.md`
</output>
