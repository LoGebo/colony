---
phase: 08-governance-analytics
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/TIMESTAMP_emergency_contacts.sql
  - supabase/migrations/TIMESTAMP_medical_accessibility.sql
autonomous: true

must_haves:
  truths:
    - "Emergency contacts have relationship, priority, and contact-for categories"
    - "Medical conditions include severity and emergency instructions"
    - "Accessibility needs track accommodations and evacuation requirements"
    - "Security can access necessary emergency information via RLS"
  artifacts:
    - path: "supabase/migrations/*_emergency_contacts.sql"
      provides: "emergency_contacts table with priority ordering"
    - path: "supabase/migrations/*_medical_accessibility.sql"
      provides: "medical_conditions, accessibility_needs tables"
  key_links:
    - from: "emergency_contacts.resident_id"
      to: "residents.id"
      via: "foreign key with CASCADE"
    - from: "medical_conditions.share_with_security"
      to: "RLS policies"
      via: "controls guard access to medical info"
---

<objective>
Create the emergency preparedness schema with emergency contacts, medical conditions, and accessibility needs per resident.

Purpose: Enable communities to maintain critical emergency information for residents that security staff can access during emergencies while respecting privacy for non-emergency scenarios.

Output: Emergency contacts, medical conditions, and accessibility needs tables with privacy-aware RLS.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-governance-analytics/08-RESEARCH.md

# Prior infrastructure
@.planning/phases/02-identity-crm/02-02-SUMMARY.md (residents)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create emergency contacts table</name>
  <files>supabase/migrations/TIMESTAMP_emergency_contacts.sql</files>
  <action>
Create migration with emergency contacts:

**emergency_contacts table:**
- id UUID PK DEFAULT generate_uuid_v7()
- community_id UUID NOT NULL REFERENCES communities(id)
- resident_id UUID NOT NULL REFERENCES residents(id) ON DELETE CASCADE
- Contact info: contact_name TEXT NOT NULL, relationship TEXT NOT NULL CHECK IN ('spouse', 'parent', 'child', 'sibling', 'friend', 'doctor', 'employer', 'neighbor', 'other')
- Phone numbers: phone_primary TEXT NOT NULL, phone_secondary TEXT
- Location: address TEXT, city TEXT
- priority INTEGER NOT NULL DEFAULT 1 -- Lower = call first
- contact_for TEXT[] NOT NULL DEFAULT ARRAY['general']::TEXT[] -- Categories: 'medical', 'security', 'general', 'financial'
- notes TEXT
- is_active BOOLEAN NOT NULL DEFAULT true
- Standard audit columns (created_at, updated_at)

**Indexes:**
- idx_emergency_contacts_resident ON emergency_contacts(resident_id, priority) WHERE is_active = true
- idx_emergency_contacts_community ON emergency_contacts(community_id)

**Function get_emergency_contacts(p_resident_id) function:**
- Returns TABLE(contact_name, relationship, phone_primary, phone_secondary, priority, contact_for)
- Ordered by priority ASC (call first)
- Only returns active contacts

**Function get_emergency_contacts_for_unit(p_unit_id) function:**
- Returns all emergency contacts for all residents in a unit
- Useful for guard booth access

RLS policies:
- Residents can full CRUD their own contacts
- Staff can SELECT all for emergency access
- Guards can SELECT (security staff needs this during emergencies)
  </action>
  <verify>Run migration. Create contacts for resident with different priorities. Verify ordering and RLS.</verify>
  <done>Emergency contacts with priority ordering and role-based access</done>
</task>

<task type="auto">
  <name>Task 2: Create medical conditions and accessibility needs tables</name>
  <files>supabase/migrations/TIMESTAMP_medical_accessibility.sql</files>
  <action>
Create migration with medical and accessibility information:

**medical_conditions table:**
- id UUID PK DEFAULT generate_uuid_v7()
- community_id UUID NOT NULL REFERENCES communities(id)
- resident_id UUID NOT NULL REFERENCES residents(id) ON DELETE CASCADE
- condition_type TEXT NOT NULL CHECK IN ('allergy', 'chronic_condition', 'disability', 'medication', 'other')
- condition_name TEXT NOT NULL
- severity TEXT CHECK IN ('mild', 'moderate', 'severe', 'life_threatening')
- description TEXT
- For allergies: reaction_description TEXT
- medications TEXT[] -- Current medications
- emergency_instructions TEXT -- Critical: what to do in emergency
- Medical provider: doctor_name TEXT, doctor_phone TEXT, hospital_preference TEXT
- Documentation: document_url TEXT (medical letter, prescription scan)
- Privacy: share_with_security BOOLEAN NOT NULL DEFAULT true, share_with_neighbors BOOLEAN NOT NULL DEFAULT false
- Standard audit columns

**accessibility_needs table:**
- id UUID PK DEFAULT generate_uuid_v7()
- community_id UUID NOT NULL REFERENCES communities(id)
- resident_id UUID NOT NULL REFERENCES residents(id) ON DELETE CASCADE
- need_type TEXT NOT NULL CHECK IN ('wheelchair', 'visual', 'hearing', 'cognitive', 'mobility', 'respiratory', 'other')
- description TEXT NOT NULL
- accommodations TEXT[] -- Required accommodations: 'ramp_access', 'elevator_priority', 'large_print', 'sign_language', etc.
- Equipment: uses_mobility_device BOOLEAN DEFAULT false, mobility_device_type TEXT CHECK IN ('wheelchair', 'walker', 'scooter', 'cane', 'other')
- Service animal: has_service_animal BOOLEAN DEFAULT false, service_animal_type TEXT
- Evacuation: needs_evacuation_assistance BOOLEAN DEFAULT false, evacuation_notes TEXT
- Unit modifications: unit_modifications TEXT[] -- What has been modified in their unit
- Standard audit columns

**Indexes:**
- idx_medical_conditions_resident ON medical_conditions(resident_id)
- idx_medical_conditions_security ON medical_conditions(community_id) WHERE share_with_security = true
- idx_accessibility_needs_resident ON accessibility_needs(resident_id)
- idx_accessibility_evacuation ON accessibility_needs(community_id) WHERE needs_evacuation_assistance = true

**View for security staff:**
```sql
CREATE VIEW security_medical_summary AS
SELECT
  r.id AS resident_id,
  r.full_name,
  u.unit_number,
  mc.condition_type,
  mc.condition_name,
  mc.severity,
  mc.emergency_instructions,
  an.need_type,
  an.needs_evacuation_assistance,
  an.evacuation_notes
FROM residents r
JOIN occupancies o ON o.resident_id = r.id AND o.status = 'active'
JOIN units u ON u.id = o.unit_id
LEFT JOIN medical_conditions mc ON mc.resident_id = r.id AND mc.share_with_security = true
LEFT JOIN accessibility_needs an ON an.resident_id = r.id
WHERE r.deleted_at IS NULL;
```

**Function get_evacuation_priority_list(p_community_id) function:**
- Returns residents needing evacuation assistance
- Includes unit, floor, accessibility needs
- Ordered for emergency response (e.g., by floor descending for fire evacuation)

RLS policies:
- medical_conditions:
  - Residents can full CRUD their own
  - Staff can SELECT all
  - Guards can SELECT WHERE share_with_security = true
- accessibility_needs:
  - Residents can full CRUD their own
  - Staff and guards can SELECT all (needed for accommodation)
  </action>
  <verify>
Test flow:
1. Create medical condition with share_with_security = true
2. Verify guard role can SELECT it
3. Create condition with share_with_security = false
4. Verify guard role CANNOT SELECT it
5. Create accessibility need with needs_evacuation_assistance = true
6. Call get_evacuation_priority_list - verify resident appears
  </verify>
  <done>Medical conditions and accessibility needs with privacy-aware access control</done>
</task>

</tasks>

<verification>
-- Create emergency contacts with priorities
INSERT INTO emergency_contacts (community_id, resident_id, contact_name, relationship, phone_primary, priority, contact_for)
VALUES
  ('...', 'resident-id', 'Maria Rodriguez', 'spouse', '+52-555-123-4567', 1, ARRAY['medical', 'security', 'general']),
  ('...', 'resident-id', 'Dr. Garcia', 'doctor', '+52-555-987-6543', 2, ARRAY['medical']);

-- Get contacts ordered by priority
SELECT * FROM get_emergency_contacts('resident-id');
-- Should return Maria first (priority 1), then Dr. Garcia (priority 2)

-- Create medical condition shared with security
INSERT INTO medical_conditions (
  community_id, resident_id, condition_type, condition_name, severity,
  emergency_instructions, share_with_security
) VALUES (
  '...', 'resident-id', 'allergy', 'Severe Peanut Allergy', 'life_threatening',
  'EPIPEN IN LEFT POCKET. Call 911 immediately if ingested. Administer EpiPen to outer thigh.',
  true
);

-- Create condition NOT shared with security
INSERT INTO medical_conditions (
  community_id, resident_id, condition_type, condition_name,
  share_with_security
) VALUES (
  '...', 'resident-id', 'chronic_condition', 'Anxiety disorder', false
);

-- As guard role: should only see peanut allergy, not anxiety
SET LOCAL ROLE guard_user;
SELECT * FROM medical_conditions WHERE resident_id = 'resident-id';
-- Should only return peanut allergy row

-- Create accessibility need
INSERT INTO accessibility_needs (
  community_id, resident_id, need_type, description,
  uses_mobility_device, mobility_device_type,
  needs_evacuation_assistance, evacuation_notes
) VALUES (
  '...', 'resident-id', 'wheelchair', 'Full-time wheelchair user',
  true, 'wheelchair',
  true, 'Cannot use stairs. Requires elevator or stair chair for evacuation. Unit 305.'
);

-- Get evacuation priority list
SELECT * FROM get_evacuation_priority_list('community-id');
-- Should include resident with evacuation notes
</verification>

<success_criteria>
- emergency_contacts table with priority ordering
- contact_for array allows categorizing when to use each contact
- get_emergency_contacts() returns contacts in priority order
- medical_conditions captures allergies, chronic conditions, medications
- share_with_security flag controls guard access via RLS
- Life-threatening conditions include emergency_instructions
- accessibility_needs tracks accommodations and equipment
- needs_evacuation_assistance flag for emergency planning
- get_evacuation_priority_list() supports emergency response
- security_medical_summary view for guard booth quick access
- All tables have appropriate RLS for privacy protection
</success_criteria>

<output>
After completion, create `.planning/phases/08-governance-analytics/08-06-SUMMARY.md`
</output>
