---
phase: 08-governance-analytics
plan: 03
type: execute
wave: 2
depends_on: ["08-02"]
files_modified:
  - supabase/migrations/TIMESTAMP_assembly_enums.sql
  - supabase/migrations/TIMESTAMP_assemblies_tables.sql
  - supabase/migrations/TIMESTAMP_assembly_functions.sql
autonomous: true

must_haves:
  truths:
    - "Assemblies track ordinary and extraordinary meetings with convocatoria progression"
    - "Attendance records copy unit coefficient at check-in time"
    - "Proxy attendance is limited to 2 units per representative (Mexican law)"
    - "Quorum is calculated per convocatoria: 75%/50%+1/any for 1st/2nd/3rd"
    - "Assembly agreements link to elections when voted"
  artifacts:
    - path: "supabase/migrations/*_assembly_enums.sql"
      provides: "assembly_type, assembly_status enums"
    - path: "supabase/migrations/*_assemblies_tables.sql"
      provides: "assemblies, assembly_attendance, assembly_agreements tables"
    - path: "supabase/migrations/*_assembly_functions.sql"
      provides: "calculate_assembly_quorum(), validate_proxy_limit() functions"
  key_links:
    - from: "assembly_attendance.coefficient"
      to: "units.coefficient"
      via: "copied at check-in for immutability"
    - from: "assembly_agreements.election_id"
      to: "elections.id"
      via: "links voted agreements to election results"
    - from: "assemblies.id"
      to: "elections.assembly_id"
      via: "elections can be part of assembly"
---

<objective>
Create the assembly management schema with Mexican law compliant convocatoria progression, attendance tracking with proxy delegation limits, and agreement recording.

Purpose: Enable formal assembly documentation per Ley de Propiedad en Condominio with proper quorum validation for 1st/2nd/3rd convocatoria and proxy delegation limits.

Output: Assembly tables with attendance tracking, quorum calculation, and agreement documentation.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-governance-analytics/08-RESEARCH.md

# Prior infrastructure (required)
@.planning/phases/08-governance-analytics/08-02-SUMMARY.md (elections table for assembly_id FK)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create assembly enum types</name>
  <files>supabase/migrations/TIMESTAMP_assembly_enums.sql</files>
  <action>
Create migration with assembly-related enum types:

```sql
-- Assembly types per Mexican law
CREATE TYPE assembly_type AS ENUM (
  'ordinary',       -- Regular (yearly) assembly - asamblea ordinaria
  'extraordinary'   -- Special assembly for specific matters - asamblea extraordinaria
);

-- Assembly status with convocatoria progression
CREATE TYPE assembly_status AS ENUM (
  'scheduled',       -- Assembly scheduled
  'convocatoria_1',  -- First call (75% quorum required)
  'convocatoria_2',  -- Second call (50%+1 quorum required)
  'convocatoria_3',  -- Third call (any attendance valid)
  'in_progress',     -- Assembly in session
  'concluded',       -- Assembly finished
  'cancelled'
);
```

Include comment explaining Mexican convocatoria system:
- Primera convocatoria: 75% of coefficient required
- Segunda convocatoria: 50%+1 of coefficient required (30 min after first)
- Tercera convocatoria: Any attendance valid (30 min after second)
  </action>
  <verify>Run `supabase db reset` and check enum types exist with `\dT+ assembly_*`</verify>
  <done>Two assembly enums created with Mexican law convocatoria status</done>
</task>

<task type="auto">
  <name>Task 2: Create assemblies, attendance, and agreements tables</name>
  <files>supabase/migrations/TIMESTAMP_assemblies_tables.sql</files>
  <action>
Create migration with assembly management tables:

**assemblies table:**
- id UUID PK DEFAULT generate_uuid_v7()
- community_id UUID NOT NULL REFERENCES communities(id)
- assembly_number TEXT NOT NULL (format: ASM-YYYY-NNN)
- assembly_type assembly_type NOT NULL
- title TEXT NOT NULL, description TEXT
- Scheduling: scheduled_date DATE NOT NULL, scheduled_time TIME NOT NULL, location TEXT, meeting_url TEXT
- status assembly_status NOT NULL DEFAULT 'scheduled'
- Convocatoria tracking (Mexican law timing): convocatoria_1_at TIMESTAMPTZ, convocatoria_2_at TIMESTAMPTZ, convocatoria_3_at TIMESTAMPTZ
- Quorum: quorum_coefficient_present NUMERIC(7,4) DEFAULT 0, quorum_percentage NUMERIC(5,2) DEFAULT 0, quorum_met BOOLEAN DEFAULT false
- Actual times: started_at TIMESTAMPTZ, ended_at TIMESTAMPTZ
- Documentation: agenda_document_id UUID REFERENCES documents(id), minutes_document_id UUID REFERENCES documents(id)
- Standard audit columns with created_by
- UNIQUE (community_id, assembly_number)

**Create generate_assembly_number(p_community_id) function**

**Add FK to elections table:**
- ALTER TABLE elections ADD COLUMN assembly_id UUID REFERENCES assemblies(id)

**assembly_attendance table:**
- id UUID PK DEFAULT generate_uuid_v7()
- assembly_id UUID NOT NULL REFERENCES assemblies(id) ON DELETE CASCADE
- unit_id UUID NOT NULL REFERENCES units(id)
- coefficient NUMERIC(7,4) NOT NULL -- CRITICAL: Copied at check-in time
- Attendee: attendee_type TEXT NOT NULL CHECK IN ('owner', 'representative', 'proxy'), resident_id UUID REFERENCES residents(id), attendee_name TEXT
- Proxy delegation: is_proxy BOOLEAN NOT NULL DEFAULT false, proxy_grantor_id UUID REFERENCES residents(id), proxy_document_url TEXT
- Check-in: checked_in_at TIMESTAMPTZ NOT NULL DEFAULT now(), checked_out_at TIMESTAMPTZ
- arrived_at_convocatoria INTEGER CHECK BETWEEN 1 AND 3
- UNIQUE (assembly_id, unit_id) -- One attendance per unit per assembly

**assembly_agreements table:**
- id UUID PK DEFAULT generate_uuid_v7()
- assembly_id UUID NOT NULL REFERENCES assemblies(id) ON DELETE CASCADE
- agreement_number INTEGER NOT NULL -- Order in assembly (1, 2, 3...)
- title TEXT NOT NULL, description TEXT NOT NULL
- election_id UUID REFERENCES elections(id) -- If this was voted via election
- Approval: approved BOOLEAN, votes_for_coefficient NUMERIC(7,4), votes_against_coefficient NUMERIC(7,4), abstentions_coefficient NUMERIC(7,4)
- Action items: action_required BOOLEAN DEFAULT false, action_description TEXT, action_due_date DATE, action_responsible TEXT, action_completed_at TIMESTAMPTZ
- display_order INTEGER NOT NULL DEFAULT 0
- created_at TIMESTAMPTZ NOT NULL DEFAULT now()

**Indexes:**
- idx_assemblies_community_date ON assemblies(community_id, scheduled_date DESC)
- idx_assembly_attendance_assembly ON assembly_attendance(assembly_id)
- idx_assembly_attendance_resident ON assembly_attendance(resident_id) WHERE resident_id IS NOT NULL
- idx_assembly_agreements_assembly ON assembly_agreements(assembly_id)

RLS policies:
- assemblies: Community members can SELECT, admins can full CRUD
- assembly_attendance: Staff can full CRUD, residents can SELECT
- assembly_agreements: Community members can SELECT, admins can INSERT/UPDATE
  </action>
  <verify>Run migration. Create assembly, add attendance records. Verify unique constraint on unit attendance.</verify>
  <done>Assembly management tables with convocatoria tracking and proxy support</done>
</task>

<task type="auto">
  <name>Task 3: Create assembly quorum and proxy validation functions</name>
  <files>supabase/migrations/TIMESTAMP_assembly_functions.sql</files>
  <action>
Create migration with assembly management functions:

**validate_assembly_proxy_limit() trigger function:**
- BEFORE INSERT OR UPDATE on assembly_attendance
- If is_proxy = true AND resident_id IS NOT NULL:
  - Count existing proxy attendance in same assembly by same resident_id
  - RAISE EXCEPTION if count >= 2: 'A person cannot represent more than 2 units by proxy (Mexican law / No se puede representar mas de 2 unidades por poder)'

**Create trigger:** assembly_attendance_proxy_limit BEFORE INSERT OR UPDATE ON assembly_attendance

**record_attendance(p_assembly_id, p_unit_id, p_attendee_type, p_resident_id, p_is_proxy, p_proxy_grantor_id, p_proxy_document_url) function:**
- Returns UUID (attendance_id)
- Looks up unit.coefficient and copies to attendance record
- Determines arrived_at_convocatoria from current assembly status
- Inserts attendance record
- Calls calculate_assembly_quorum to update assembly totals

**calculate_assembly_quorum(p_assembly_id) function:**
- Returns TABLE(total_coefficient, present_coefficient, percentage, quorum_met, required_for_convocatoria_1 BOOLEAN, required_for_convocatoria_2 BOOLEAN, required_for_convocatoria_3 BOOLEAN)
- Calculates total coefficient from active units in community
- Sums coefficient from assembly_attendance where checked_out_at IS NULL
- Percentage = (present / total) * 100
- Updates assembly: quorum_coefficient_present, quorum_percentage, quorum_met
- Returns quorum thresholds:
  - convocatoria_1: percentage >= 75.00
  - convocatoria_2: percentage >= 50.01
  - convocatoria_3: TRUE (any attendance valid)

**advance_convocatoria(p_assembly_id) function:**
- Called when moving between convocatorias
- Validates current status and timing
- Updates assembly status and records convocatoria timestamp
- Recalculates quorum_met based on new threshold

**record_agreement(p_assembly_id, p_title, p_description, p_approved, p_votes_for, p_votes_against, p_abstentions, p_election_id) function:**
- Returns UUID (agreement_id)
- Auto-assigns next agreement_number
- If election_id provided, pulls vote results from election
- Inserts agreement record

**Attendance coefficient trigger:**
- BEFORE INSERT on assembly_attendance
- Copies coefficient from units table if not provided
  </action>
  <verify>
Test flow:
1. Create assembly
2. record_attendance for unit 1 - verify coefficient copied
3. record_attendance as proxy for unit 2 - should succeed
4. record_attendance as proxy for unit 3 (same person) - should succeed
5. record_attendance as proxy for unit 4 (same person) - should fail (proxy limit)
6. calculate_assembly_quorum - verify thresholds
7. advance_convocatoria - verify status progression
8. record_agreement - verify auto-numbering
  </verify>
  <done>Assembly functions with Mexican law quorum rules and proxy limits</done>
</task>

</tasks>

<verification>
-- Create assembly
INSERT INTO assemblies (community_id, assembly_type, title, scheduled_date, scheduled_time)
VALUES ('...', 'ordinary', 'Asamblea Ordinaria 2026', '2026-03-15', '10:00');

-- Update to first convocatoria
UPDATE assemblies SET status = 'convocatoria_1', convocatoria_1_at = now() WHERE id = '...';

-- Record attendance (copies coefficient automatically)
SELECT record_attendance('assembly-id', 'unit-1-id', 'owner', 'resident-id', false, NULL, NULL);
-- Verify coefficient matches unit coefficient

-- Record proxy attendance
SELECT record_attendance('assembly-id', 'unit-2-id', 'proxy', 'representative-id', true, 'owner-id', 'carta_poder.pdf');
SELECT record_attendance('assembly-id', 'unit-3-id', 'proxy', 'representative-id', true, 'owner-id', 'carta_poder2.pdf');

-- Third proxy should fail
SELECT record_attendance('assembly-id', 'unit-4-id', 'proxy', 'representative-id', true, 'owner-id', 'carta_poder3.pdf');
-- Should raise: "Cannot represent more than 2 units by proxy"

-- Calculate quorum
SELECT * FROM calculate_assembly_quorum('assembly-id');
-- Returns: total_coefficient, present_coefficient, percentage, quorum_met,
--          required_for_convocatoria_1 (>= 75%), required_for_convocatoria_2 (>= 50.01%), required_for_convocatoria_3 (true)

-- If quorum not met, advance to second convocatoria
SELECT advance_convocatoria('assembly-id');
-- Status should change to 'convocatoria_2'

-- Record agreement
SELECT record_agreement('assembly-id', 'Budget Approval', 'Approved annual budget for 2026', true, 65.5, 20.0, 14.5, NULL);
-- Verify agreement_number = 1
</verification>

<success_criteria>
- Assembly enum types created with Mexican convocatoria status
- assemblies table with convocatoria timing and quorum tracking
- assembly_attendance copies coefficient at check-in (immutable)
- Proxy limit (2 max) enforced via trigger
- assembly_agreements track resolutions with voting results
- calculate_assembly_quorum returns thresholds per convocatoria:
  - 1st: 75%, 2nd: 50%+1, 3rd: any
- Elections can reference assembly via FK
- Agreement numbers auto-increment per assembly
</success_criteria>

<output>
After completion, create `.planning/phases/08-governance-analytics/08-03-SUMMARY.md`
</output>
