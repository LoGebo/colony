---
phase: 08-governance-analytics
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/TIMESTAMP_election_enums.sql
  - supabase/migrations/TIMESTAMP_elections_tables.sql
  - supabase/migrations/TIMESTAMP_voting_functions.sql
autonomous: true

must_haves:
  truths:
    - "Elections can be created for board elections and extraordinary decisions"
    - "Election options support candidates with photos or decision choices"
    - "Ballots capture vote weight from unit coefficient at vote time (immutable snapshot)"
    - "Quorum is calculated against total community coefficient"
    - "Proxy voting is limited to 2 units per representative (Mexican law)"
  artifacts:
    - path: "supabase/migrations/*_election_enums.sql"
      provides: "election_type, election_status enums"
    - path: "supabase/migrations/*_elections_tables.sql"
      provides: "elections, election_options, ballots tables"
    - path: "supabase/migrations/*_voting_functions.sql"
      provides: "cast_vote(), check_election_quorum() functions"
  key_links:
    - from: "ballots.vote_weight"
      to: "units.coefficient"
      via: "copied at vote time for immutability"
    - from: "cast_vote function"
      to: "occupancies table"
      via: "validates voter authorization"
    - from: "ballots.proxy_for_resident_id"
      to: "residents.id"
      via: "tracks proxy delegation"
---

<objective>
Create the election and voting schema with coefficient-weighted ballots, Mexican law compliance for quorum and proxy limits, and election lifecycle management.

Purpose: Enable formal voting for board elections and assembly decisions with legally compliant weighted voting per Mexican condominium law (Ley de Propiedad en Condominio).

Output: Elections, options, and ballots tables with voting functions that enforce quorum and proxy limits.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-governance-analytics/08-RESEARCH.md

# Prior infrastructure
@.planning/phases/02-identity-crm/02-01-SUMMARY.md (units with coefficient)
@.planning/phases/02-identity-crm/02-02-SUMMARY.md (residents, occupancies)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create election enum types</name>
  <files>supabase/migrations/TIMESTAMP_election_enums.sql</files>
  <action>
Create migration with election-related enum types:

```sql
-- Election types
CREATE TYPE election_type AS ENUM (
  'board_election',         -- Electing board members
  'bylaw_amendment',        -- Changing reglamento
  'extraordinary_expense',  -- Approving special assessment
  'general_decision'        -- Other assembly decisions
);

-- Election lifecycle status
CREATE TYPE election_status AS ENUM (
  'draft',        -- Being prepared
  'scheduled',    -- Approved, waiting for date
  'open',         -- Voting in progress
  'closed',       -- Voting ended, counting
  'certified',    -- Results certified
  'cancelled'
);
```

Include standard header comment with phase reference.
  </action>
  <verify>Run `supabase db reset` and check enum types exist with `\dT+ election_*`</verify>
  <done>Two election enums created: election_type, election_status</done>
</task>

<task type="auto">
  <name>Task 2: Create elections, options, and ballots tables</name>
  <files>supabase/migrations/TIMESTAMP_elections_tables.sql</files>
  <action>
Create migration with voting tables:

**elections table:**
- id UUID PK DEFAULT generate_uuid_v7()
- community_id UUID NOT NULL REFERENCES communities(id)
- election_number TEXT NOT NULL (format: ELEC-YYYY-NNN)
- election_type election_type NOT NULL
- title TEXT NOT NULL, description TEXT
- Voting rules: min_options_selectable INTEGER NOT NULL DEFAULT 1, max_options_selectable INTEGER NOT NULL DEFAULT 1
- Voting period: opens_at TIMESTAMPTZ NOT NULL, closes_at TIMESTAMPTZ NOT NULL
- status election_status NOT NULL DEFAULT 'draft'
- Quorum: quorum_required NUMERIC(5,2) NOT NULL DEFAULT 50.01 (Mexican law: 75%/50%+1/any for 1st/2nd/3rd convocatoria)
- Results: total_coefficient_voted NUMERIC(7,4) DEFAULT 0, quorum_met BOOLEAN
- Certification: certified_at TIMESTAMPTZ, certified_by UUID REFERENCES auth.users(id)
- assembly_id UUID (will reference assemblies table from next plan)
- Standard audit columns with created_by
- UNIQUE (community_id, election_number)
- CHECK (closes_at > opens_at)

**Create sequence for election numbers per community:**
- generate_election_number(p_community_id) function

**election_options table:**
- id UUID PK DEFAULT generate_uuid_v7()
- election_id UUID NOT NULL REFERENCES elections(id) ON DELETE CASCADE
- title TEXT NOT NULL, description TEXT
- For board elections: candidate_resident_id UUID REFERENCES residents(id), candidate_photo_url TEXT
- display_order INTEGER NOT NULL DEFAULT 0
- Results: votes_count INTEGER DEFAULT 0, coefficient_total NUMERIC(7,4) DEFAULT 0
- created_at TIMESTAMPTZ NOT NULL DEFAULT now()

**ballots table:**
- id UUID PK DEFAULT generate_uuid_v7()
- election_id UUID NOT NULL REFERENCES elections(id)
- Voter: unit_id UUID NOT NULL REFERENCES units(id), voted_by UUID NOT NULL REFERENCES residents(id)
- vote_weight NUMERIC(7,4) NOT NULL -- CRITICAL: Copied from unit.coefficient at vote time
- selected_options UUID[] NOT NULL -- Array for multi-select
- Proxy: is_proxy_vote BOOLEAN NOT NULL DEFAULT false, proxy_for_resident_id UUID REFERENCES residents(id), proxy_document_url TEXT
- Verification: voted_at TIMESTAMPTZ NOT NULL DEFAULT now(), ip_address INET, user_agent TEXT
- UNIQUE (election_id, unit_id) -- One vote per unit per election

**Indexes:**
- idx_elections_community_status ON elections(community_id, status)
- idx_election_options_election ON election_options(election_id)
- idx_ballots_election ON ballots(election_id)
- idx_ballots_voter ON ballots(voted_by, election_id)

RLS policies:
- elections: All community members can SELECT, admins can full CRUD
- election_options: Same as elections
- ballots: Voters can INSERT their own, SELECT restricted (anonymous voting - only show aggregates)
  </action>
  <verify>Run migration. Test CREATE election with options. Verify ballots table constraints.</verify>
  <done>Elections infrastructure with coefficient-weighted voting support</done>
</task>

<task type="auto">
  <name>Task 3: Create voting functions with Mexican law compliance</name>
  <files>supabase/migrations/TIMESTAMP_voting_functions.sql</files>
  <action>
Create migration with voting functions:

**cast_vote(p_election_id, p_unit_id, p_selected_options UUID[], p_is_proxy BOOLEAN, p_proxy_for UUID, p_proxy_document TEXT) function:**
- Returns UUID (ballot_id)
- SECURITY DEFINER for RLS bypass during vote recording
- Validations:
  1. Election exists and status = 'open'
  2. Current time within opens_at and closes_at
  3. Option count within min/max_options_selectable
  4. Unit exists in same community as election
  5. If NOT proxy: verify auth.uid() has active occupancy (owner/tenant) for unit
  6. If proxy: check proxy count for this voter in this election < 2 (Mexican law limit)
  7. If proxy: require proxy_document (carta poder)
  8. Unit hasn't voted yet in this election
- Actions:
  1. Copy unit.coefficient to vote_weight (CRITICAL for immutability)
  2. INSERT ballot record
  3. UPDATE elections.total_coefficient_voted += vote_weight
  4. UPDATE election_options votes_count and coefficient_total for selected options
- Error messages in Spanish/English for user-facing errors

**check_election_quorum(p_election_id) function:**
- Returns BOOLEAN
- STABLE (no side effects except update)
- Calculates total community coefficient (SUM from active units)
- Calculates voted coefficient (SUM from ballots)
- Percentage = (voted / total) * 100
- Updates election: total_coefficient_voted, quorum_met
- Returns whether percentage >= quorum_required

**get_election_results(p_election_id) function:**
- Returns TABLE(option_id, title, votes_count, coefficient_total, percentage)
- Calculates percentage of voted coefficient (not total community)
- Ordered by coefficient_total DESC

**validate_proxy_limit trigger function:**
- BEFORE INSERT on ballots
- If is_proxy_vote = true:
  - Count existing proxy ballots in same election by same voted_by
  - RAISE EXCEPTION if count >= 2: 'Cannot represent more than 2 units by proxy (Mexican law / Ley de Propiedad en Condominio)'

Create trigger: ballots_proxy_limit_check BEFORE INSERT ON ballots
  </action>
  <verify>
Test voting flow:
1. Create election with 2 options
2. cast_vote as unit owner - should succeed, vote_weight = unit coefficient
3. cast_vote same unit again - should fail (already voted)
4. cast_vote as proxy for 1st unit - should succeed
5. cast_vote as proxy for 2nd unit - should succeed
6. cast_vote as proxy for 3rd unit - should fail (proxy limit)
7. check_election_quorum - verify percentage calculation
8. get_election_results - verify weighted results
  </verify>
  <done>Voting system with Mexican law compliance for proxy limits and coefficient weighting</done>
</task>

</tasks>

<verification>
-- Create test election
INSERT INTO elections (community_id, election_type, title, opens_at, closes_at, quorum_required)
VALUES ('...', 'board_election', 'Board President 2026', now(), now() + INTERVAL '7 days', 50.01);

UPDATE elections SET status = 'open' WHERE id = '...';

-- Add candidates
INSERT INTO election_options (election_id, title, candidate_resident_id)
VALUES ('...', 'Juan Perez', '...'), ('...', 'Maria Lopez', '...');

-- Cast vote (direct)
SELECT cast_vote('election-id', 'unit-id', ARRAY['option-1-id']::UUID[], false, NULL, NULL);
-- Verify vote_weight matches unit coefficient

-- Attempt second vote for same unit
SELECT cast_vote('election-id', 'unit-id', ARRAY['option-2-id']::UUID[], false, NULL, NULL);
-- Should raise: "This unit has already voted in this election"

-- Cast proxy votes (max 2)
SELECT cast_vote('election-id', 'unit-2-id', ARRAY['option-1-id']::UUID[], true, 'owner-resident-id', 'carta_poder.pdf');
SELECT cast_vote('election-id', 'unit-3-id', ARRAY['option-1-id']::UUID[], true, 'owner-resident-id', 'carta_poder.pdf');

-- Third proxy should fail
SELECT cast_vote('election-id', 'unit-4-id', ARRAY['option-1-id']::UUID[], true, 'owner-resident-id', 'carta_poder.pdf');
-- Should raise: "Cannot represent more than 2 units by proxy (Mexican law)"

-- Check quorum
SELECT check_election_quorum('election-id');
-- Returns true/false based on coefficient voted vs required

-- Get results
SELECT * FROM get_election_results('election-id');
-- Shows weighted results
</verification>

<success_criteria>
- Election enum types created (type, status)
- elections table with quorum tracking and certification
- election_options table for candidates/choices with result tracking
- ballots table with coefficient snapshot (vote_weight)
- cast_vote() validates eligibility, enforces proxy limit (2 max)
- Proxy limit enforced via trigger (Mexican law compliance)
- check_election_quorum() calculates against total community coefficient
- Vote weight is copied from unit.coefficient at vote time (immutable)
- One vote per unit per election enforced via UNIQUE constraint
</success_criteria>

<output>
After completion, create `.planning/phases/08-governance-analytics/08-02-SUMMARY.md`
</output>
