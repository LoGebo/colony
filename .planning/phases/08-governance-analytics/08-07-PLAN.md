---
phase: 08-governance-analytics
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/TIMESTAMP_violation_enums.sql
  - supabase/migrations/TIMESTAMP_violations_tables.sql
  - supabase/migrations/TIMESTAMP_violation_workflow.sql
autonomous: true

must_haves:
  truths:
    - "Violation types define default severity and escalating penalties"
    - "Violations track offense number within 12-month window"
    - "Sanctions support warnings, fines, and suspensions"
    - "Appeals flow through review to decision"
    - "Violation status updates automatically on appeal decisions"
  artifacts:
    - path: "supabase/migrations/*_violation_enums.sql"
      provides: "violation_severity, sanction_type enums"
    - path: "supabase/migrations/*_violations_tables.sql"
      provides: "violation_types, violations, violation_sanctions tables"
    - path: "supabase/migrations/*_violation_workflow.sql"
      provides: "violation_appeals table, calculate_offense_number(), update_violation_on_appeal() functions"
  key_links:
    - from: "violations.violation_type_id"
      to: "violation_types.id"
      via: "defines severity and penalty schedule"
    - from: "violations.offense_number"
      to: "calculate_offense_number trigger"
      via: "auto-calculated on insert"
    - from: "violation_appeals status"
      to: "violations.status"
      via: "trigger updates on appeal decision"
---

<objective>
Create the violation management schema with configurable violation types, escalating penalties, sanction tracking, and formal appeal process.

Purpose: Enable communities to enforce rules with proper documentation, escalating consequences for repeat offenders, and fair appeal process.

Output: Violations infrastructure with automatic offense counting, sanctions, and appeal workflow.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-governance-analytics/08-RESEARCH.md

# Prior infrastructure
@.planning/phases/02-identity-crm/02-01-SUMMARY.md (units)
@.planning/phases/02-identity-crm/02-02-SUMMARY.md (residents)
@.planning/phases/04-financial-engine/04-02-SUMMARY.md (transactions for fines)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create violation enum types</name>
  <files>supabase/migrations/TIMESTAMP_violation_enums.sql</files>
  <action>
Create migration with violation-related enum types:

```sql
-- Violation severity levels
CREATE TYPE violation_severity AS ENUM (
  'minor',     -- Warning only (first offense typically)
  'moderate',  -- Fine possible
  'major',     -- Fine required
  'severe'     -- May result in access suspension
);

-- Sanction types (escalating)
CREATE TYPE sanction_type AS ENUM (
  'verbal_warning',
  'written_warning',
  'fine',
  'amenity_suspension',
  'access_restriction',
  'legal_action'
);
```

Include standard header comment with phase reference.
  </action>
  <verify>Run `supabase db reset` and check enum types exist with `\dT+ violation_*` and `\dT+ sanction_*`</verify>
  <done>Two enums created: violation_severity, sanction_type</done>
</task>

<task type="auto">
  <name>Task 2: Create violation types, violations, and sanctions tables</name>
  <files>supabase/migrations/TIMESTAMP_violations_tables.sql</files>
  <action>
Create migration with violation tracking tables:

**violation_types table:**
- id UUID PK DEFAULT generate_uuid_v7()
- community_id UUID NOT NULL REFERENCES communities(id)
- name TEXT NOT NULL, description TEXT NOT NULL
- category TEXT NOT NULL CHECK IN ('noise', 'parking', 'pet', 'common_area', 'payment', 'behavior', 'property', 'other')
- default_severity violation_severity NOT NULL DEFAULT 'minor'
- Escalation: escalate_after_count INTEGER NOT NULL DEFAULT 3 -- After N violations, increase severity
- Penalty schedule: first_offense_fine money_amount DEFAULT 0, second_offense_fine money_amount DEFAULT 0, third_offense_fine money_amount DEFAULT 0
- Consequences: can_suspend_amenities BOOLEAN DEFAULT false, can_restrict_access BOOLEAN DEFAULT false
- is_active BOOLEAN NOT NULL DEFAULT true
- Standard audit columns
- UNIQUE (community_id, name)

**violations table:**
- id UUID PK DEFAULT generate_uuid_v7()
- community_id UUID NOT NULL REFERENCES communities(id)
- violation_number TEXT NOT NULL (format: VIOL-YYYY-NNNNN)
- violation_type_id UUID NOT NULL REFERENCES violation_types(id)
- severity violation_severity NOT NULL
- Violator: unit_id UUID NOT NULL REFERENCES units(id), resident_id UUID REFERENCES residents(id)
- Details: description TEXT NOT NULL, location TEXT, occurred_at TIMESTAMPTZ NOT NULL
- Evidence: photo_urls TEXT[], video_urls TEXT[], witness_names TEXT[]
- Reporter: reported_by UUID REFERENCES auth.users(id), reported_at TIMESTAMPTZ NOT NULL DEFAULT now()
- status TEXT NOT NULL DEFAULT 'reported' CHECK IN ('reported', 'under_review', 'confirmed', 'sanctioned', 'appealed', 'appeal_denied', 'appeal_granted', 'closed', 'dismissed')
- Repeat offense: offense_number INTEGER NOT NULL DEFAULT 1, previous_violation_id UUID REFERENCES violations(id)
- Resolution: resolved_at TIMESTAMPTZ, resolved_by UUID REFERENCES auth.users(id), resolution_notes TEXT
- Standard audit columns
- UNIQUE (community_id, violation_number)

**Create generate_violation_number(p_community_id) function**

**violation_sanctions table:**
- id UUID PK DEFAULT generate_uuid_v7()
- violation_id UUID NOT NULL REFERENCES violations(id) ON DELETE CASCADE
- sanction_type sanction_type NOT NULL
- description TEXT NOT NULL
- Fine: fine_amount money_amount, transaction_id UUID REFERENCES transactions(id)
- Suspension: suspension_start DATE, suspension_end DATE, suspended_amenities UUID[]
- status TEXT NOT NULL DEFAULT 'pending' CHECK IN ('pending', 'notified', 'acknowledged', 'paid', 'served', 'appealed', 'cancelled')
- Notification: notified_at TIMESTAMPTZ, notification_method TEXT CHECK IN ('email', 'letter', 'in_person', 'app')
- Issued: issued_by UUID REFERENCES auth.users(id), issued_at TIMESTAMPTZ NOT NULL DEFAULT now()
- created_at TIMESTAMPTZ NOT NULL DEFAULT now()

**Indexes:**
- idx_violations_community_status ON violations(community_id, status)
- idx_violations_unit ON violations(unit_id, violation_type_id, occurred_at)
- idx_violation_sanctions_violation ON violation_sanctions(violation_id)

RLS policies:
- violation_types: Community members can SELECT, admins can full CRUD
- violations: Staff can full CRUD, residents can SELECT their own unit's violations
- violation_sanctions: Staff can full CRUD, residents can SELECT their own
  </action>
  <verify>Run migration. Create violation type, create violation. Verify number generation.</verify>
  <done>Violation tracking tables with penalty schedule and sanction support</done>
</task>

<task type="auto">
  <name>Task 3: Create violation appeals and automated workflows</name>
  <files>supabase/migrations/TIMESTAMP_violation_workflow.sql</files>
  <action>
Create migration with violation workflow automation:

**calculate_offense_number() trigger function:**
- BEFORE INSERT on violations
- Count previous violations of same type for same unit in last 12 months
- Only count status IN ('confirmed', 'sanctioned', 'appeal_denied', 'closed')
- Set NEW.offense_number = count + 1
- Link to most recent via previous_violation_id

**Create trigger:** violations_offense_number BEFORE INSERT ON violations

**violation_appeals table:**
- id UUID PK DEFAULT generate_uuid_v7()
- violation_id UUID NOT NULL REFERENCES violations(id)
- sanction_id UUID REFERENCES violation_sanctions(id)
- Appellant: appealed_by UUID NOT NULL REFERENCES residents(id)
- Appeal: appeal_reason TEXT NOT NULL, supporting_documents TEXT[]
- status TEXT NOT NULL DEFAULT 'submitted' CHECK IN ('submitted', 'under_review', 'hearing_scheduled', 'granted', 'denied', 'withdrawn')
- Hearing: hearing_date DATE, hearing_notes TEXT
- Decision: decision TEXT, decided_by UUID REFERENCES auth.users(id), decided_at TIMESTAMPTZ
- Relief granted: fine_reduced_to money_amount, sanction_modified_to TEXT
- Standard audit columns

**update_violation_on_appeal() trigger function:**
- AFTER INSERT on violation_appeals:
  - Update violations SET status = 'appealed'
  - Update violation_sanctions SET status = 'appealed' (if sanction_id provided)
- AFTER UPDATE on violation_appeals:
  - If NEW.status = 'granted': Update violations SET status = 'appeal_granted'
  - If NEW.status = 'denied': Update violations SET status = 'appeal_denied'

**Create trigger:** violation_appeal_status AFTER INSERT OR UPDATE ON violation_appeals

**issue_sanction(p_violation_id, p_sanction_type, p_description, p_fine_amount, p_suspension_start, p_suspension_end, p_suspended_amenities) function:**
- Returns UUID (sanction_id)
- Creates sanction record
- Updates violation status to 'sanctioned'
- If fine > 0, creates transaction (charge) in financial system
- Returns sanction_id

**get_violation_history(p_unit_id, p_months INTEGER DEFAULT 12) function:**
- Returns TABLE with violation history for unit
- Includes violation type, offense number, sanctions, appeal status
- Useful for determining escalation

**Link parking_violations to violations:**
- Add FK constraint: parking_violations.violation_record_id REFERENCES violations(id)

**Indexes:**
- idx_violation_appeals_violation ON violation_appeals(violation_id)
- idx_violation_appeals_appellant ON violation_appeals(appealed_by)

RLS policies:
- violation_appeals:
  - Residents can INSERT/SELECT their own appeals
  - Staff can full CRUD
  </action>
  <verify>
Test workflow:
1. Create violation type with escalating fines (0, 500, 1000)
2. Create first violation for unit - verify offense_number = 1
3. Create second violation (same type, same unit) - verify offense_number = 2
4. issue_sanction with fine - verify transaction created
5. Create appeal - verify violation.status = 'appealed'
6. Grant appeal - verify violation.status = 'appeal_granted'
7. Create third violation - verify offense_number = 3 (appeal_granted not counted)
  </verify>
  <done>Violation workflow with automatic offense counting and appeal integration</done>
</task>

</tasks>

<verification>
-- Create violation type with escalating fines
INSERT INTO violation_types (
  community_id, name, category, default_severity,
  first_offense_fine, second_offense_fine, third_offense_fine
) VALUES (
  '...', 'Noise After 10PM', 'noise', 'minor',
  0, 500.00, 1000.00
);

-- First violation
INSERT INTO violations (
  community_id, violation_type_id, unit_id, description, occurred_at, severity
) VALUES (
  '...', 'type-id', 'unit-id', 'Loud party until 2am', '2026-03-15 02:00', 'minor'
);
-- Verify offense_number = 1

-- Second violation (same type, same unit)
INSERT INTO violations (...) VALUES (...);
-- Verify offense_number = 2, previous_violation_id links to first

-- Issue sanction with fine
SELECT issue_sanction(
  'violation-id',
  'fine',
  'Second offense noise violation fine per community rules',
  500.00,
  NULL, NULL, NULL
);
-- Verify:
--   sanction created
--   transaction created in financial system
--   violation.status = 'sanctioned'

-- Create appeal
INSERT INTO violation_appeals (violation_id, appealed_by, appeal_reason)
VALUES ('violation-id', 'resident-id', 'I was not home that night, have proof');
-- Verify violation.status = 'appealed'

-- Deny appeal
UPDATE violation_appeals SET status = 'denied', decision = 'Evidence insufficient', decided_by = '...', decided_at = now()
WHERE id = 'appeal-id';
-- Verify violation.status = 'appeal_denied'

-- Get violation history
SELECT * FROM get_violation_history('unit-id', 12);
-- Shows complete history with offense tracking
</verification>

<success_criteria>
- Violation enum types created (severity, sanction_type)
- violation_types with configurable penalties and escalation
- violations auto-calculate offense_number via trigger
- Previous violations linked via previous_violation_id
- 12-month rolling window for offense counting
- violation_sanctions support fines and suspensions
- Fines create transactions in financial system via issue_sanction()
- violation_appeals with full workflow
- Appeal decisions update violation status via trigger
- Appeal-granted violations don't count toward future offenses
- get_violation_history() for escalation decisions
- parking_violations can link to formal violations
</success_criteria>

<output>
After completion, create `.planning/phases/08-governance-analytics/08-07-SUMMARY.md`
</output>
