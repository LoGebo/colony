---
phase: 08-governance-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/TIMESTAMP_incident_enums.sql
  - supabase/migrations/TIMESTAMP_incidents_tables.sql
  - supabase/migrations/TIMESTAMP_incident_timeline.sql
autonomous: true

must_haves:
  truths:
    - "Incidents can be reported with type, severity, location, and description"
    - "Incident status follows defined workflow: reported -> acknowledged -> investigating -> resolved -> closed"
    - "Timeline events are appended automatically on status changes"
    - "Incident media (photos, videos, audio) can be attached"
  artifacts:
    - path: "supabase/migrations/*_incident_enums.sql"
      provides: "incident_severity, incident_status enums"
    - path: "supabase/migrations/*_incidents_tables.sql"
      provides: "incident_types, incidents, incident_media, incident_assignments tables"
    - path: "supabase/migrations/*_incident_timeline.sql"
      provides: "add_incident_event() function and status change trigger"
  key_links:
    - from: "incidents.incident_type_id"
      to: "incident_types.id"
      via: "foreign key"
    - from: "incident_status_changed trigger"
      to: "incidents.timeline"
      via: "JSONB append on status change"
    - from: "incident_media.incident_id"
      to: "incidents.id"
      via: "foreign key with CASCADE"
---

<objective>
Create the incident management schema with incident types, core incident records, media attachments, and JSONB timeline for polymorphic event tracking.

Purpose: Enable communities to report, track, and resolve incidents (security, maintenance, noise, etc.) with full audit trail and SLA tracking.

Output: Incident management tables with state machine, timeline events, media storage, and assignment tracking.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-governance-analytics/08-RESEARCH.md

# Prior infrastructure
@.planning/phases/02-identity-crm/02-01-SUMMARY.md (units table)
@.planning/phases/03-access-control-security/03-01-SUMMARY.md (access_points, guards)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create incident enum types</name>
  <files>supabase/migrations/TIMESTAMP_incident_enums.sql</files>
  <action>
Create migration with incident-related enum types:

```sql
-- Incident severity levels
CREATE TYPE incident_severity AS ENUM (
  'low',        -- Nuisance, non-urgent
  'medium',     -- Requires attention within 24h
  'high',       -- Requires immediate attention
  'critical'    -- Emergency, life/safety at risk
);

-- Incident workflow status
CREATE TYPE incident_status AS ENUM (
  'reported',      -- Initial report received
  'acknowledged',  -- Staff aware, not yet assigned
  'investigating', -- Under investigation
  'in_progress',   -- Resolution in progress
  'pending_review',-- Awaiting supervisor review
  'resolved',      -- Issue resolved
  'closed'         -- Formally closed
);
```

Include standard header comment with phase reference.
  </action>
  <verify>Run `supabase db reset` and check enum types exist with `\dT+ incident_*`</verify>
  <done>Two incident enums created: incident_severity, incident_status</done>
</task>

<task type="auto">
  <name>Task 2: Create incident types, incidents, media, and assignments tables</name>
  <files>supabase/migrations/TIMESTAMP_incidents_tables.sql</files>
  <action>
Create migration with incident management tables:

**incident_types table:**
- id UUID PK DEFAULT generate_uuid_v7()
- community_id UUID NOT NULL REFERENCES communities(id)
- name TEXT NOT NULL, description TEXT
- category TEXT NOT NULL CHECK IN ('security', 'maintenance', 'noise', 'pet', 'parking', 'common_area', 'other')
- default_severity incident_severity NOT NULL DEFAULT 'medium'
- default_priority INTEGER NOT NULL DEFAULT 3 (1=highest)
- sla_response_hours INTEGER, sla_resolution_hours INTEGER
- is_active BOOLEAN NOT NULL DEFAULT true
- Standard audit columns (created_at, updated_at)
- UNIQUE constraint on (community_id, name)
- RLS: community members can SELECT, admins can full CRUD

**incidents table:**
- id UUID PK DEFAULT generate_uuid_v7()
- community_id UUID NOT NULL REFERENCES communities(id)
- incident_number TEXT NOT NULL (format: INC-YYYY-NNNNN)
- incident_type_id UUID REFERENCES incident_types(id)
- severity incident_severity NOT NULL DEFAULT 'medium'
- priority INTEGER NOT NULL DEFAULT 3
- Location: location_type TEXT CHECK IN ('common_area', 'unit', 'parking', 'entrance', 'exterior', 'other'), location_description TEXT, unit_id UUID REFERENCES units(id), access_point_id UUID REFERENCES access_points(id), gps_latitude NUMERIC(10,7), gps_longitude NUMERIC(10,7)
- Description: title TEXT NOT NULL, description TEXT NOT NULL
- Reporter: reported_by UUID REFERENCES residents(id), reported_by_guard UUID REFERENCES guards(id), reporter_name TEXT, reporter_phone TEXT, reported_at TIMESTAMPTZ DEFAULT now()
- Status: status incident_status NOT NULL DEFAULT 'reported', status_changed_at TIMESTAMPTZ DEFAULT now()
- Assignment: assigned_to UUID REFERENCES auth.users(id), assigned_at TIMESTAMPTZ
- Resolution: resolved_at TIMESTAMPTZ, resolved_by UUID REFERENCES auth.users(id), resolution_notes TEXT
- SLA tracking: first_response_at TIMESTAMPTZ
- Timeline: timeline JSONB NOT NULL DEFAULT '[]'::JSONB
- Standard audit columns with soft delete
- UNIQUE (community_id, incident_number)

**Create sequence for incident numbers per community:**
- Use generate_incident_number(p_community_id) function similar to transaction references

**incident_media table:**
- id UUID PK DEFAULT generate_uuid_v7()
- incident_id UUID NOT NULL REFERENCES incidents(id) ON DELETE CASCADE
- community_id UUID NOT NULL REFERENCES communities(id)
- media_type TEXT NOT NULL CHECK IN ('photo', 'video', 'audio', 'document')
- storage_path TEXT NOT NULL, file_name TEXT NOT NULL
- mime_type TEXT, file_size_bytes INTEGER
- caption TEXT, taken_at TIMESTAMPTZ
- transcription TEXT (for audio)
- uploaded_by UUID REFERENCES auth.users(id)
- created_at TIMESTAMPTZ NOT NULL DEFAULT now()
- RLS: community members can SELECT, staff can INSERT

**incident_assignments table:**
- id UUID PK DEFAULT generate_uuid_v7()
- incident_id UUID NOT NULL REFERENCES incidents(id) ON DELETE CASCADE
- assigned_to UUID NOT NULL REFERENCES auth.users(id)
- assigned_by UUID REFERENCES auth.users(id)
- role TEXT NOT NULL DEFAULT 'handler' CHECK IN ('handler', 'supervisor', 'observer')
- assigned_at TIMESTAMPTZ NOT NULL DEFAULT now()
- unassigned_at TIMESTAMPTZ
- notes TEXT

**Indexes:**
- idx_incidents_community_status ON incidents(community_id, status)
- idx_incidents_reported_at ON incidents(community_id, reported_at DESC)
- idx_incidents_unit ON incidents(unit_id) WHERE unit_id IS NOT NULL
- idx_incident_media_incident ON incident_media(incident_id)

RLS policies for incidents: Staff can full CRUD, residents can SELECT incidents in their community and INSERT (report)
  </action>
  <verify>Run migration. Test INSERT incident, verify incident_number auto-generated in correct format.</verify>
  <done>Four incident tables created with proper relationships and RLS</done>
</task>

<task type="auto">
  <name>Task 3: Create incident timeline functions and triggers</name>
  <files>supabase/migrations/TIMESTAMP_incident_timeline.sql</files>
  <action>
Create migration for timeline event management:

**add_incident_event(p_incident_id, p_event_type, p_actor_id, p_data JSONB) function:**
- Returns UUID (event ID)
- Looks up actor name from residents or guards table
- Builds event JSONB: { id, type, timestamp, actor_id, actor_name, data }
- Appends to incidents.timeline array
- Updates incidents.updated_at

Event types to support:
- 'created' - Incident reported
- 'status_changed' - Status transition (data: {from, to})
- 'assigned' - Assigned to user (data: {user_id, user_name})
- 'unassigned' - Removed from assignment
- 'comment' - Comment added (data: {text, is_internal})
- 'media_added' - Photo/video added (data: {media_id, media_type})
- 'escalated' - Priority increased (data: {from_priority, to_priority, reason})
- 'resolution' - Resolution attempt (data: {notes, successful})

**incident_status_changed() trigger function:**
- BEFORE UPDATE trigger on incidents
- If OLD.status IS DISTINCT FROM NEW.status:
  - Set NEW.status_changed_at = now()
  - Append status_changed event to NEW.timeline
  - Track first_response_at: if OLD.status = 'reported' and NEW.status != 'reported', set first_response_at = now()
  - Track resolution: if NEW.status = 'resolved', set resolved_at = now(), resolved_by = auth.uid()

**incident_created_event() trigger function:**
- AFTER INSERT trigger on incidents
- Adds 'created' event to timeline with reporter info

**incident_media_added() trigger function:**
- AFTER INSERT trigger on incident_media
- Calls add_incident_event to append 'media_added' event

Create all triggers on respective tables.
  </action>
  <verify>
Test flow:
1. INSERT incident - verify 'created' event in timeline
2. UPDATE status to 'acknowledged' - verify 'status_changed' event added
3. UPDATE status to 'resolved' - verify resolved_at and resolved_by set
4. INSERT media record - verify 'media_added' event in incident timeline
  </verify>
  <done>Incident timeline system with automatic event tracking via triggers</done>
</task>

</tasks>

<verification>
-- Verify incident creation with auto-generated number
INSERT INTO incident_types (community_id, name, category)
VALUES ('...', 'Noise Complaint', 'noise');

INSERT INTO incidents (community_id, incident_type_id, title, description, reported_by)
VALUES ('...', '...', 'Loud Party', 'Unit 205 playing loud music after midnight', '...');
-- Check incident_number = 'INC-2026-00001'
-- Check timeline has 'created' event

-- Verify status change tracking
UPDATE incidents SET status = 'acknowledged' WHERE id = '...';
-- Check timeline has 'status_changed' event with from: 'reported', to: 'acknowledged'

-- Verify first response tracking
SELECT first_response_at FROM incidents WHERE id = '...';
-- Should be set after moving from 'reported'

-- Verify media event
INSERT INTO incident_media (incident_id, community_id, media_type, storage_path, file_name)
VALUES ('...', '...', 'photo', 'incidents/123/photo1.jpg', 'evidence.jpg');
-- Check incident timeline has 'media_added' event
</verification>

<success_criteria>
- Incident enum types created (severity, status)
- incident_types table for configurable incident categories
- incidents table with auto-generated numbers, JSONB timeline, SLA tracking
- incident_media table for evidence attachments
- incident_assignments table for tracking handlers
- Timeline events auto-appended on status changes
- First response and resolution timestamps tracked
- All tables have proper RLS policies
</success_criteria>

<output>
After completion, create `.planning/phases/08-governance-analytics/08-01-SUMMARY.md`
</output>
