---
phase: 02-identity-crm
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - supabase/migrations/*_residents_table.sql
  - supabase/migrations/*_occupancies_table.sql
  - supabase/migrations/*_vehicles_table.sql
  - supabase/migrations/*_pets_tables.sql
autonomous: true

must_haves:
  truths:
    - "Residents link to auth.users via id with profile data"
    - "Residents have onboarding_status workflow (invited -> registered -> verified -> active)"
    - "Occupancies junction links residents to units with occupancy_type role"
    - "Same resident can have multiple roles in same unit (owner AND authorized)"
    - "Vehicles have normalized plates for LPR matching"
    - "Pets have vaccination records in separate table"
    - "Pet incidents can be tracked with resolution workflow"
  artifacts:
    - path: "supabase/migrations/*_residents_table.sql"
      provides: "residents table linked to auth.users"
      contains: "REFERENCES auth.users(id)"
    - path: "supabase/migrations/*_occupancies_table.sql"
      provides: "occupancies junction table"
      contains: "UNIQUE (unit_id, resident_id, occupancy_type)"
    - path: "supabase/migrations/*_vehicles_table.sql"
      provides: "vehicles table with LPR fields"
      contains: "plate_normalized TEXT NOT NULL GENERATED ALWAYS"
    - path: "supabase/migrations/*_pets_tables.sql"
      provides: "pets, pet_vaccinations, pet_incidents tables"
      contains: "CREATE TABLE pet_vaccinations"
  key_links:
    - from: "residents.id"
      to: "auth.users.id"
      via: "PRIMARY KEY REFERENCES"
      pattern: "PRIMARY KEY REFERENCES auth.users\\(id\\)"
    - from: "occupancies.unit_id"
      to: "units.id"
      via: "FOREIGN KEY"
      pattern: "REFERENCES units\\(id\\)"
    - from: "occupancies.resident_id"
      to: "residents.id"
      via: "FOREIGN KEY"
      pattern: "REFERENCES residents\\(id\\)"
    - from: "vehicles.resident_id"
      to: "residents.id"
      via: "FOREIGN KEY"
      pattern: "REFERENCES residents\\(id\\)"
    - from: "pets.resident_id"
      to: "residents.id"
      via: "FOREIGN KEY"
      pattern: "REFERENCES residents\\(id\\)"
---

<objective>
Create the core CRM tables: residents, occupancies, vehicles, and pets with their related tables.

Purpose: These tables model who lives in the community, their relationship to units, and their vehicles/pets. This is the heart of the CRM system.

Output:
- residents table (linked to auth.users)
- occupancies junction table (resident-unit relationships)
- vehicles table (with LPR-ready normalized plates)
- pets, pet_vaccinations, pet_incidents tables
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-identity-crm/02-RESEARCH.md
@.planning/phases/02-identity-crm/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create residents table linked to auth.users</name>
  <files>supabase/migrations/*_residents_table.sql</files>
  <action>
Create the residents table following research specifications. Key points:
- id is BOTH primary key AND foreign key to auth.users (1:1 relationship)
- ON DELETE CASCADE so deleting auth user removes profile
- Mexican name format (first_name, paternal_surname, maternal_surname)
- KYC verification fields (INE number, CURP)
- Onboarding workflow status (uses onboarding_status enum from 02-01)
- Generated full_name column for search

```sql
-- Enable extensions needed for search
CREATE EXTENSION IF NOT EXISTS pg_trgm;
CREATE EXTENSION IF NOT EXISTS unaccent;

-- Residents table: user profiles linked 1:1 to auth.users
CREATE TABLE residents (
  -- Links 1:1 with auth.users
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  community_id UUID NOT NULL REFERENCES communities(id) ON DELETE RESTRICT,

  -- Name (Mexican format: first + paternal + maternal)
  first_name TEXT NOT NULL,
  middle_name TEXT,
  paternal_surname TEXT NOT NULL,
  maternal_surname TEXT,

  -- Contact
  email TEXT NOT NULL,
  phone phone_number,
  phone_secondary phone_number,

  -- Profile
  photo_url TEXT,
  date_of_birth DATE,
  gender TEXT,

  -- Emergency contact
  emergency_contact_name TEXT,
  emergency_contact_phone phone_number,
  emergency_contact_relationship TEXT,

  -- KYC Verification
  kyc_status approval_status NOT NULL DEFAULT 'pending',
  kyc_verified_at TIMESTAMPTZ,
  kyc_verified_by UUID REFERENCES auth.users(id),

  -- INE (Mexican voter ID) verification fields
  ine_number TEXT,                      -- Clave de Elector
  ine_ocr TEXT,                         -- OCR code
  ine_cic TEXT,                         -- CIC code
  ine_verified BOOLEAN DEFAULT false,
  curp TEXT,                            -- Mexican national ID

  -- Document URLs (in Supabase Storage)
  ine_front_url TEXT,
  ine_back_url TEXT,
  proof_of_address_url TEXT,

  -- Onboarding workflow
  onboarding_status onboarding_status NOT NULL DEFAULT 'invited',
  invited_at TIMESTAMPTZ,
  registered_at TIMESTAMPTZ,
  verified_at TIMESTAMPTZ,
  activated_at TIMESTAMPTZ,

  -- App settings (user-editable preferences)
  notification_preferences JSONB DEFAULT '{
    "push": true,
    "email": true,
    "sms": false
  }'::JSONB,
  locale locale_code DEFAULT 'es-MX',

  -- Audit
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at TIMESTAMPTZ,

  -- Search optimization: generated column for full name
  full_name TEXT GENERATED ALWAYS AS (
    TRIM(first_name || ' ' || COALESCE(middle_name || ' ', '') ||
         paternal_surname || ' ' || COALESCE(maternal_surname, ''))
  ) STORED
);

-- Enable RLS
ALTER TABLE residents ENABLE ROW LEVEL SECURITY;

-- Audit trigger
CREATE TRIGGER set_residents_audit
  BEFORE INSERT OR UPDATE ON residents
  FOR EACH ROW
  EXECUTE FUNCTION set_audit_fields();

-- Indexes
CREATE INDEX idx_residents_community ON residents(community_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_residents_onboarding ON residents(community_id, onboarding_status) WHERE deleted_at IS NULL;
CREATE INDEX idx_residents_email ON residents(email) WHERE deleted_at IS NULL;

-- Full-text search index with accent insensitivity (will work once data exists)
-- Note: Index creation may warn if no data, that's OK
CREATE INDEX idx_residents_full_name_search ON residents
  USING gin(full_name gin_trgm_ops)
  WHERE deleted_at IS NULL;

-- RLS Policies

-- Super admins full access
CREATE POLICY "super_admins_full_access_residents"
  ON residents
  FOR ALL
  TO authenticated
  USING ((SELECT is_super_admin()));

-- Users can view residents in their community
CREATE POLICY "users_view_own_community_residents"
  ON residents
  FOR SELECT
  TO authenticated
  USING (
    community_id = (SELECT get_current_community_id())
    AND deleted_at IS NULL
  );

-- Users can update their own profile
CREATE POLICY "users_update_own_profile"
  ON residents
  FOR UPDATE
  TO authenticated
  USING (id = auth.uid() AND deleted_at IS NULL)
  WITH CHECK (id = auth.uid() AND deleted_at IS NULL);

-- Admins can manage all residents in their community
CREATE POLICY "admins_manage_residents"
  ON residents
  FOR ALL
  TO authenticated
  USING (
    community_id = (SELECT get_current_community_id())
    AND (SELECT get_current_user_role()) IN ('admin', 'manager')
  )
  WITH CHECK (
    community_id = (SELECT get_current_community_id())
    AND (SELECT get_current_user_role()) IN ('admin', 'manager')
  );

-- Comments
COMMENT ON TABLE residents IS 'User profiles linked 1:1 with auth.users, containing CRM data';
COMMENT ON COLUMN residents.full_name IS 'Generated column for search: first + middle + paternal + maternal';
COMMENT ON COLUMN residents.onboarding_status IS 'Workflow: invited -> registered -> verified -> active';
```

Apply using mcp__supabase__apply_migration tool.
  </action>
  <verify>
Use mcp__supabase__execute_sql to verify:
1. Table exists with key columns: `SELECT column_name FROM information_schema.columns WHERE table_name = 'residents' AND column_name IN ('id', 'community_id', 'onboarding_status', 'full_name');`
2. RLS enabled: `SELECT relrowsecurity FROM pg_class WHERE relname = 'residents';`
3. Policies exist: `SELECT policyname FROM pg_policies WHERE tablename = 'residents';`
  </verify>
  <done>Residents table exists linked to auth.users, with onboarding_status, KYC fields, Mexican name format, RLS enabled with 4 policies</done>
</task>

<task type="auto">
  <name>Task 2: Create occupancies junction table</name>
  <files>supabase/migrations/*_occupancies_table.sql</files>
  <action>
Create the occupancies junction table that links residents to units with roles:

```sql
-- Occupancies: junction table linking residents to units with relationship type
CREATE TABLE occupancies (
  id UUID PRIMARY KEY DEFAULT generate_uuid_v7(),
  community_id UUID NOT NULL REFERENCES communities(id) ON DELETE RESTRICT,
  unit_id UUID NOT NULL REFERENCES units(id) ON DELETE RESTRICT,
  resident_id UUID NOT NULL REFERENCES residents(id) ON DELETE RESTRICT,

  -- Role is part of the uniqueness constraint
  -- Allows same person to be owner AND authorized in same unit
  occupancy_type occupancy_type NOT NULL,

  -- Validity period
  start_date DATE NOT NULL DEFAULT CURRENT_DATE,
  end_date DATE,

  -- Status
  status general_status NOT NULL DEFAULT 'active',

  -- For tenants: can link to property owner
  authorized_by UUID REFERENCES residents(id),

  -- Notes
  notes TEXT,

  -- Audit
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at TIMESTAMPTZ,
  created_by UUID REFERENCES auth.users(id),

  -- Prevents duplicate role assignments for same person in same unit
  CONSTRAINT occupancies_unique_role
    UNIQUE (unit_id, resident_id, occupancy_type)
);

-- Enable RLS
ALTER TABLE occupancies ENABLE ROW LEVEL SECURITY;

-- Audit trigger
CREATE TRIGGER set_occupancies_audit
  BEFORE INSERT OR UPDATE ON occupancies
  FOR EACH ROW
  EXECUTE FUNCTION set_audit_fields();

-- Indexes for common queries
CREATE INDEX idx_occupancies_unit ON occupancies(unit_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_occupancies_resident ON occupancies(resident_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_occupancies_community ON occupancies(community_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_occupancies_active ON occupancies(community_id, status)
  WHERE deleted_at IS NULL AND status = 'active';

-- RLS Policies

-- Super admins full access
CREATE POLICY "super_admins_full_access_occupancies"
  ON occupancies
  FOR ALL
  TO authenticated
  USING ((SELECT is_super_admin()));

-- Users can view occupancies in their community
CREATE POLICY "users_view_own_community_occupancies"
  ON occupancies
  FOR SELECT
  TO authenticated
  USING (
    community_id = (SELECT get_current_community_id())
    AND deleted_at IS NULL
  );

-- Admins can manage occupancies
CREATE POLICY "admins_manage_occupancies"
  ON occupancies
  FOR ALL
  TO authenticated
  USING (
    community_id = (SELECT get_current_community_id())
    AND (SELECT get_current_user_role()) IN ('admin', 'manager')
  )
  WITH CHECK (
    community_id = (SELECT get_current_community_id())
    AND (SELECT get_current_user_role()) IN ('admin', 'manager')
  );

-- Comments
COMMENT ON TABLE occupancies IS 'Junction table: resident-unit relationships with occupancy_type role';
COMMENT ON COLUMN occupancies.occupancy_type IS 'Role: owner, tenant, authorized - same person can have multiple roles';
COMMENT ON CONSTRAINT occupancies_unique_role ON occupancies IS 'Prevents duplicate role per person-unit, but allows multiple roles';
```

Apply using mcp__supabase__apply_migration tool.
  </action>
  <verify>
Use mcp__supabase__execute_sql:
1. Table structure: `SELECT column_name FROM information_schema.columns WHERE table_name = 'occupancies';`
2. Unique constraint exists: `SELECT conname FROM pg_constraint WHERE conrelid = 'occupancies'::regclass AND contype = 'u';`
3. Policies: `SELECT policyname FROM pg_policies WHERE tablename = 'occupancies';`
  </verify>
  <done>Occupancies table exists with unit_id, resident_id, occupancy_type, unique constraint (unit_id, resident_id, occupancy_type), RLS enabled with 3 policies</done>
</task>

<task type="auto">
  <name>Task 3: Create vehicles table with LPR-ready plate storage</name>
  <files>supabase/migrations/*_vehicles_table.sql</files>
  <action>
Create the vehicles table with normalized plate for LPR matching:

```sql
-- Vehicles: registered vehicles with LPR-compatible plate storage
CREATE TABLE vehicles (
  id UUID PRIMARY KEY DEFAULT generate_uuid_v7(),
  community_id UUID NOT NULL REFERENCES communities(id) ON DELETE RESTRICT,
  resident_id UUID NOT NULL REFERENCES residents(id) ON DELETE RESTRICT,

  -- Original as entered by user (preserves formatting)
  plate_number TEXT NOT NULL,

  -- Normalized for LPR matching (uppercase, no hyphens/spaces)
  plate_normalized TEXT NOT NULL GENERATED ALWAYS AS (
    UPPER(REGEXP_REPLACE(plate_number, '[^A-Z0-9]', '', 'gi'))
  ) STORED,

  -- State of registration (affects plate format)
  plate_state TEXT NOT NULL,

  -- Vehicle identification
  make TEXT,
  model TEXT,
  year INTEGER,
  color TEXT,

  -- LPR-specific fields
  vehicle_image_url TEXT,      -- Photo of vehicle
  plate_image_url TEXT,        -- Photo of plate for training
  lpr_confidence NUMERIC(5,4), -- Last LPR match confidence (0.0000-1.0000)
  last_lpr_detection TIMESTAMPTZ,

  -- Access control
  sticker_number TEXT,
  sticker_issued_at TIMESTAMPTZ,
  access_enabled BOOLEAN NOT NULL DEFAULT true,

  -- Status
  status general_status NOT NULL DEFAULT 'active',

  -- Notes
  notes TEXT,

  -- Audit
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at TIMESTAMPTZ,
  created_by UUID REFERENCES auth.users(id)
);

-- Enable RLS
ALTER TABLE vehicles ENABLE ROW LEVEL SECURITY;

-- Audit trigger
CREATE TRIGGER set_vehicles_audit
  BEFORE INSERT OR UPDATE ON vehicles
  FOR EACH ROW
  EXECUTE FUNCTION set_audit_fields();

-- Indexes
-- Primary LPR lookup: normalized plate within community
CREATE INDEX idx_vehicles_plate_normalized
  ON vehicles(plate_normalized, community_id)
  WHERE deleted_at IS NULL AND access_enabled = true;

CREATE INDEX idx_vehicles_resident ON vehicles(resident_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_vehicles_community ON vehicles(community_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_vehicles_sticker ON vehicles(community_id, sticker_number)
  WHERE deleted_at IS NULL AND sticker_number IS NOT NULL;

-- RLS Policies

-- Super admins full access
CREATE POLICY "super_admins_full_access_vehicles"
  ON vehicles
  FOR ALL
  TO authenticated
  USING ((SELECT is_super_admin()));

-- Users can view vehicles in their community
CREATE POLICY "users_view_own_community_vehicles"
  ON vehicles
  FOR SELECT
  TO authenticated
  USING (
    community_id = (SELECT get_current_community_id())
    AND deleted_at IS NULL
  );

-- Users can manage their own vehicles
CREATE POLICY "users_manage_own_vehicles"
  ON vehicles
  FOR ALL
  TO authenticated
  USING (
    resident_id = auth.uid()
    AND deleted_at IS NULL
  )
  WITH CHECK (
    resident_id = auth.uid()
  );

-- Admins can manage all vehicles
CREATE POLICY "admins_manage_vehicles"
  ON vehicles
  FOR ALL
  TO authenticated
  USING (
    community_id = (SELECT get_current_community_id())
    AND (SELECT get_current_user_role()) IN ('admin', 'manager', 'guard')
  )
  WITH CHECK (
    community_id = (SELECT get_current_community_id())
    AND (SELECT get_current_user_role()) IN ('admin', 'manager', 'guard')
  );

-- Comments
COMMENT ON TABLE vehicles IS 'Registered vehicles with LPR-compatible normalized plate storage';
COMMENT ON COLUMN vehicles.plate_normalized IS 'Generated: uppercase alphanumeric only for LPR matching';
COMMENT ON COLUMN vehicles.lpr_confidence IS 'Last LPR match confidence score 0.0000-1.0000';
```

Apply using mcp__supabase__apply_migration tool.
  </action>
  <verify>
Use mcp__supabase__execute_sql:
1. Table and generated column: `SELECT column_name, is_generated FROM information_schema.columns WHERE table_name = 'vehicles' AND column_name IN ('plate_number', 'plate_normalized');`
2. Policies: `SELECT policyname FROM pg_policies WHERE tablename = 'vehicles';`
  </verify>
  <done>Vehicles table exists with plate_number, plate_normalized (generated), LPR fields, RLS enabled with 4 policies, index on normalized plate</done>
</task>

<task type="auto">
  <name>Task 4: Create pets tables with vaccinations and incidents</name>
  <files>supabase/migrations/*_pets_tables.sql</files>
  <action>
Create pets, pet_vaccinations, and pet_incidents tables:

```sql
-- Pets: registered pets with owner link
CREATE TABLE pets (
  id UUID PRIMARY KEY DEFAULT generate_uuid_v7(),
  community_id UUID NOT NULL REFERENCES communities(id) ON DELETE RESTRICT,
  resident_id UUID NOT NULL REFERENCES residents(id) ON DELETE RESTRICT,

  -- Identification
  name TEXT NOT NULL,
  species pet_species NOT NULL,
  breed TEXT,
  color TEXT,

  -- Physical characteristics
  weight_kg NUMERIC(5,2),
  date_of_birth DATE,

  -- Registration
  microchip_number TEXT,
  registration_number TEXT,           -- Community-issued pet tag
  photo_url TEXT,

  -- Status
  status general_status NOT NULL DEFAULT 'active',
  is_service_animal BOOLEAN NOT NULL DEFAULT false,

  -- Notes
  special_needs TEXT,
  notes TEXT,

  -- Audit
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at TIMESTAMPTZ,
  created_by UUID REFERENCES auth.users(id)
);

-- Enable RLS
ALTER TABLE pets ENABLE ROW LEVEL SECURITY;

-- Audit trigger
CREATE TRIGGER set_pets_audit
  BEFORE INSERT OR UPDATE ON pets
  FOR EACH ROW
  EXECUTE FUNCTION set_audit_fields();

-- Indexes
CREATE INDEX idx_pets_resident ON pets(resident_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_pets_community ON pets(community_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_pets_microchip ON pets(microchip_number)
  WHERE deleted_at IS NULL AND microchip_number IS NOT NULL;

-- Pet vaccinations: separate table for time-series vaccination records
CREATE TABLE pet_vaccinations (
  id UUID PRIMARY KEY DEFAULT generate_uuid_v7(),
  pet_id UUID NOT NULL REFERENCES pets(id) ON DELETE CASCADE,
  community_id UUID NOT NULL REFERENCES communities(id) ON DELETE RESTRICT,

  -- Vaccination details
  vaccine_type TEXT NOT NULL,        -- 'rabies', 'distemper', etc.
  vaccine_brand TEXT,
  batch_number TEXT,                 -- For recall tracking

  -- Dates
  administered_at DATE NOT NULL,
  expires_at DATE,

  -- Provider
  veterinarian_name TEXT,
  clinic_name TEXT,
  clinic_phone TEXT,

  -- Documentation
  certificate_url TEXT,              -- Link to Supabase Storage

  -- Audit
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  created_by UUID REFERENCES auth.users(id)
);

-- Enable RLS
ALTER TABLE pet_vaccinations ENABLE ROW LEVEL SECURITY;

-- Audit trigger
CREATE TRIGGER set_pet_vaccinations_audit
  BEFORE INSERT OR UPDATE ON pet_vaccinations
  FOR EACH ROW
  EXECUTE FUNCTION set_audit_fields();

-- Indexes
CREATE INDEX idx_pet_vaccinations_pet ON pet_vaccinations(pet_id);
CREATE INDEX idx_pet_vaccinations_expiry
  ON pet_vaccinations(pet_id, vaccine_type, expires_at)
  WHERE expires_at IS NOT NULL;

-- Pet incidents: biting, noise complaints, etc.
CREATE TABLE pet_incidents (
  id UUID PRIMARY KEY DEFAULT generate_uuid_v7(),
  pet_id UUID NOT NULL REFERENCES pets(id) ON DELETE CASCADE,
  community_id UUID NOT NULL REFERENCES communities(id) ON DELETE RESTRICT,

  -- Incident details
  incident_type TEXT NOT NULL,        -- 'bite', 'noise', 'damage', 'escape'
  incident_date DATE NOT NULL,
  description TEXT NOT NULL,

  -- Parties involved
  reported_by UUID REFERENCES residents(id),
  victim_resident_id UUID REFERENCES residents(id),
  victim_name TEXT,                   -- If not a resident

  -- Resolution
  resolution_status approval_status NOT NULL DEFAULT 'pending',
  resolution_notes TEXT,
  resolved_at TIMESTAMPTZ,
  resolved_by UUID REFERENCES auth.users(id),

  -- Documentation
  photo_urls TEXT[],                  -- Array of Storage URLs

  -- Audit
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  created_by UUID REFERENCES auth.users(id)
);

-- Enable RLS
ALTER TABLE pet_incidents ENABLE ROW LEVEL SECURITY;

-- Audit trigger
CREATE TRIGGER set_pet_incidents_audit
  BEFORE INSERT OR UPDATE ON pet_incidents
  FOR EACH ROW
  EXECUTE FUNCTION set_audit_fields();

-- Indexes
CREATE INDEX idx_pet_incidents_pet ON pet_incidents(pet_id);
CREATE INDEX idx_pet_incidents_community ON pet_incidents(community_id);
CREATE INDEX idx_pet_incidents_status ON pet_incidents(community_id, resolution_status);

-- RLS Policies for pets

CREATE POLICY "super_admins_full_access_pets"
  ON pets FOR ALL TO authenticated
  USING ((SELECT is_super_admin()));

CREATE POLICY "users_view_own_community_pets"
  ON pets FOR SELECT TO authenticated
  USING (community_id = (SELECT get_current_community_id()) AND deleted_at IS NULL);

CREATE POLICY "users_manage_own_pets"
  ON pets FOR ALL TO authenticated
  USING (resident_id = auth.uid() AND deleted_at IS NULL)
  WITH CHECK (resident_id = auth.uid());

CREATE POLICY "admins_manage_pets"
  ON pets FOR ALL TO authenticated
  USING (
    community_id = (SELECT get_current_community_id())
    AND (SELECT get_current_user_role()) IN ('admin', 'manager')
  )
  WITH CHECK (
    community_id = (SELECT get_current_community_id())
    AND (SELECT get_current_user_role()) IN ('admin', 'manager')
  );

-- RLS Policies for pet_vaccinations

CREATE POLICY "super_admins_full_access_pet_vaccinations"
  ON pet_vaccinations FOR ALL TO authenticated
  USING ((SELECT is_super_admin()));

CREATE POLICY "users_view_own_community_vaccinations"
  ON pet_vaccinations FOR SELECT TO authenticated
  USING (community_id = (SELECT get_current_community_id()));

CREATE POLICY "users_manage_own_pet_vaccinations"
  ON pet_vaccinations FOR ALL TO authenticated
  USING (
    pet_id IN (SELECT id FROM pets WHERE resident_id = auth.uid())
  )
  WITH CHECK (
    pet_id IN (SELECT id FROM pets WHERE resident_id = auth.uid())
  );

CREATE POLICY "admins_manage_vaccinations"
  ON pet_vaccinations FOR ALL TO authenticated
  USING (
    community_id = (SELECT get_current_community_id())
    AND (SELECT get_current_user_role()) IN ('admin', 'manager')
  )
  WITH CHECK (
    community_id = (SELECT get_current_community_id())
    AND (SELECT get_current_user_role()) IN ('admin', 'manager')
  );

-- RLS Policies for pet_incidents

CREATE POLICY "super_admins_full_access_pet_incidents"
  ON pet_incidents FOR ALL TO authenticated
  USING ((SELECT is_super_admin()));

CREATE POLICY "users_view_own_community_incidents"
  ON pet_incidents FOR SELECT TO authenticated
  USING (community_id = (SELECT get_current_community_id()));

CREATE POLICY "admins_manage_incidents"
  ON pet_incidents FOR ALL TO authenticated
  USING (
    community_id = (SELECT get_current_community_id())
    AND (SELECT get_current_user_role()) IN ('admin', 'manager')
  )
  WITH CHECK (
    community_id = (SELECT get_current_community_id())
    AND (SELECT get_current_user_role()) IN ('admin', 'manager')
  );

-- Allow residents to report incidents
CREATE POLICY "residents_create_incidents"
  ON pet_incidents FOR INSERT TO authenticated
  WITH CHECK (
    community_id = (SELECT get_current_community_id())
    AND reported_by = auth.uid()
  );

-- Comments
COMMENT ON TABLE pets IS 'Registered pets with owner link';
COMMENT ON TABLE pet_vaccinations IS 'Time-series vaccination records, separate from pets for queryability';
COMMENT ON TABLE pet_incidents IS 'Pet-related incidents with resolution workflow';
```

Apply using mcp__supabase__apply_migration tool.
  </action>
  <verify>
Use mcp__supabase__execute_sql:
1. Tables exist: `SELECT tablename FROM pg_tables WHERE tablename IN ('pets', 'pet_vaccinations', 'pet_incidents');`
2. Policies: `SELECT tablename, policyname FROM pg_policies WHERE tablename LIKE 'pet%';`
  </verify>
  <done>pets, pet_vaccinations, pet_incidents tables exist with proper FKs, RLS enabled, policies for viewing/managing, vaccination expiry tracking index</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Verify all tables exist:
```sql
SELECT tablename FROM pg_tables
WHERE schemaname = 'public'
AND tablename IN ('residents', 'occupancies', 'vehicles', 'pets', 'pet_vaccinations', 'pet_incidents');
```

2. Verify FK relationships:
```sql
SELECT
  tc.table_name,
  kcu.column_name,
  ccu.table_name AS foreign_table_name
FROM information_schema.table_constraints tc
JOIN information_schema.key_column_usage kcu ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage ccu ON ccu.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
AND tc.table_name IN ('residents', 'occupancies', 'vehicles', 'pets');
```

3. Verify RLS on all tables:
```sql
SELECT relname, relrowsecurity FROM pg_class
WHERE relname IN ('residents', 'occupancies', 'vehicles', 'pets', 'pet_vaccinations', 'pet_incidents');
```

4. Verify policy counts:
```sql
SELECT tablename, COUNT(*) as policy_count
FROM pg_policies
WHERE tablename IN ('residents', 'occupancies', 'vehicles', 'pets', 'pet_vaccinations', 'pet_incidents')
GROUP BY tablename;
```
</verification>

<success_criteria>
- residents table: linked to auth.users, has onboarding_status, Mexican name fields, KYC fields, 4 RLS policies
- occupancies table: junction with (unit_id, resident_id, occupancy_type) unique constraint, 3 RLS policies
- vehicles table: has plate_normalized generated column, LPR fields, 4 RLS policies
- pets table: has pet_species, 4 RLS policies
- pet_vaccinations: separate table with expiry tracking, 4 RLS policies
- pet_incidents: resolution workflow, 4 RLS policies
- All tables have audit triggers and community_id FK
- Migration files committed
</success_criteria>

<output>
After completion, create `.planning/phases/02-identity-crm/02-02-SUMMARY.md` following the summary template.
</output>
