---
phase: 02-identity-crm
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/*_units_table.sql
  - supabase/migrations/*_crm_enums.sql
autonomous: true

must_haves:
  truths:
    - "Units can be created with type (casa, departamento, local, bodega)"
    - "Units have area_m2 and coefficient for fee calculation"
    - "Units are isolated by community_id with RLS"
    - "New enums exist for onboarding, pet species, and document types"
  artifacts:
    - path: "supabase/migrations/*_crm_enums.sql"
      provides: "onboarding_status, pet_species, document_type enums"
      contains: "CREATE TYPE onboarding_status"
    - path: "supabase/migrations/*_units_table.sql"
      provides: "units table with coefficient"
      contains: "CREATE TABLE units"
  key_links:
    - from: "units.community_id"
      to: "communities.id"
      via: "FOREIGN KEY"
      pattern: "REFERENCES communities\\(id\\)"
    - from: "units.unit_type"
      to: "unit_type enum"
      via: "column type"
      pattern: "unit_type unit_type NOT NULL"
---

<objective>
Create the units table and new enum types needed for Phase 2 CRM entities.

Purpose: Units are the foundational entity that residents link to via occupancy. This plan establishes the property inventory that all CRM operations reference.

Output:
- 3 new enum types (onboarding_status, pet_species, document_type)
- units table with Mexican property types, coefficients, and RLS
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-identity-crm/02-RESEARCH.md
@.planning/phases/01-foundation-multi-tenant-security/01-01-SUMMARY.md
@.planning/phases/01-foundation-multi-tenant-security/01-02-SUMMARY.md
@.planning/phases/01-foundation-multi-tenant-security/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CRM enum types for Phase 2</name>
  <files>supabase/migrations/*_crm_enums.sql</files>
  <action>
Create a migration file with the three new enum types needed for CRM:

```sql
-- onboarding_status: workflow states for resident onboarding
CREATE TYPE onboarding_status AS ENUM (
  'invited',     -- Email/SMS invitation sent
  'registered',  -- Created account, pending verification
  'verified',    -- Identity verified (INE, etc.)
  'active',      -- Full access granted
  'suspended',   -- Temporarily blocked
  'inactive'     -- Left community or deactivated
);

-- pet_species: types of pets allowed
CREATE TYPE pet_species AS ENUM (
  'dog',
  'cat',
  'bird',
  'fish',
  'reptile',
  'rodent',
  'other'
);

-- document_type: categories for resident documents
CREATE TYPE document_type AS ENUM (
  'ine_front',
  'ine_back',
  'proof_of_address',
  'lease_contract',
  'property_deed',
  'power_of_attorney',
  'vehicle_registration',
  'pet_vaccination',
  'other'
);
```

Use timestamp-based migration filename format: YYYYMMDDHHMMSS_crm_enums.sql

Apply using mcp__supabase__apply_migration tool.
  </action>
  <verify>
Use mcp__supabase__execute_sql to verify enums exist:
```sql
SELECT typname FROM pg_type
WHERE typname IN ('onboarding_status', 'pet_species', 'document_type');
```
Should return 3 rows.
  </verify>
  <done>Three new enum types (onboarding_status, pet_species, document_type) exist in database and migration file is committed</done>
</task>

<task type="auto">
  <name>Task 2: Create units table with coefficient and RLS</name>
  <files>supabase/migrations/*_units_table.sql</files>
  <action>
Create the units table following Phase 1 patterns and research specifications:

```sql
-- Units table: properties within a community
CREATE TABLE units (
  id UUID PRIMARY KEY DEFAULT generate_uuid_v7(),
  community_id UUID NOT NULL REFERENCES communities(id) ON DELETE RESTRICT,

  -- Identification
  unit_number TEXT NOT NULL,           -- "A-101", "Casa 5", etc.
  unit_type unit_type NOT NULL,        -- casa, departamento, local, bodega, estacionamiento, otro

  -- Physical characteristics
  area_m2 NUMERIC(10,2),               -- Square meters
  floor_number INTEGER,                -- NULL for houses
  building TEXT,                       -- Building/tower name if applicable

  -- Coefficient for fee calculation (Mexican indiviso)
  -- Sum of all coefficients in a community should equal 100
  coefficient NUMERIC(7,4) NOT NULL DEFAULT 0,

  -- Status
  status general_status NOT NULL DEFAULT 'active',

  -- Address details (for houses, may differ from community address)
  address_line TEXT,

  -- Parking spaces included (separate from estacionamiento unit type)
  parking_spaces INTEGER NOT NULL DEFAULT 0,

  -- Audit columns
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at TIMESTAMPTZ,
  created_by UUID REFERENCES auth.users(id),

  -- Unique unit number within community
  CONSTRAINT units_community_number_unique
    UNIQUE (community_id, unit_number)
);

-- Enable RLS
ALTER TABLE units ENABLE ROW LEVEL SECURITY;

-- Audit trigger (from Phase 1)
CREATE TRIGGER set_units_audit
  BEFORE INSERT OR UPDATE ON units
  FOR EACH ROW
  EXECUTE FUNCTION set_audit_fields();

-- Indexes for performance
CREATE INDEX idx_units_community ON units(community_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_units_type ON units(community_id, unit_type) WHERE deleted_at IS NULL;

-- RLS Policies (following Phase 1 patterns)

-- Super admins can do everything
CREATE POLICY "super_admins_full_access_units"
  ON units
  FOR ALL
  TO authenticated
  USING ((SELECT is_super_admin()));

-- Users can view units in their community
CREATE POLICY "users_view_own_community_units"
  ON units
  FOR SELECT
  TO authenticated
  USING (
    community_id = (SELECT get_current_community_id())
    AND deleted_at IS NULL
  );

-- Admins and managers can insert/update units
CREATE POLICY "admins_manage_units"
  ON units
  FOR ALL
  TO authenticated
  USING (
    community_id = (SELECT get_current_community_id())
    AND (SELECT get_current_user_role()) IN ('admin', 'manager')
  )
  WITH CHECK (
    community_id = (SELECT get_current_community_id())
    AND (SELECT get_current_user_role()) IN ('admin', 'manager')
  );

-- Comment for documentation
COMMENT ON TABLE units IS 'Properties within a community: apartments, houses, commercial spaces, storage units';
COMMENT ON COLUMN units.coefficient IS 'Mexican indiviso - percentage for fee calculation, sum should equal 100 per community';
COMMENT ON COLUMN units.unit_type IS 'Property type from unit_type enum: casa, departamento, local, bodega, estacionamiento, otro';
```

Apply using mcp__supabase__apply_migration tool.
  </action>
  <verify>
Use mcp__supabase__execute_sql to verify:
1. Table exists: `SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'units' ORDER BY ordinal_position;`
2. RLS enabled: `SELECT relname, relrowsecurity FROM pg_class WHERE relname = 'units';`
3. Policies exist: `SELECT policyname FROM pg_policies WHERE tablename = 'units';`
  </verify>
  <done>Units table exists with all columns (id, community_id, unit_number, unit_type, area_m2, coefficient, status), RLS enabled with 3 policies, audit trigger attached</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Verify all new types:
```sql
SELECT typname FROM pg_type WHERE typname IN ('onboarding_status', 'pet_species', 'document_type');
```

2. Verify units table structure:
```sql
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'units'
ORDER BY ordinal_position;
```

3. Verify RLS and policies:
```sql
SELECT tablename, policyname FROM pg_policies WHERE tablename = 'units';
```

4. Verify FK constraint:
```sql
SELECT conname, contype FROM pg_constraint WHERE conrelid = 'units'::regclass;
```
</verification>

<success_criteria>
- 3 new enum types exist (onboarding_status, pet_species, document_type)
- units table has: id (UUID), community_id (FK), unit_number, unit_type, area_m2, coefficient, status, audit columns
- RLS enabled with 3 policies (super_admin, users_view, admins_manage)
- Unique constraint on (community_id, unit_number)
- Audit trigger attached
- Migration files committed
</success_criteria>

<output>
After completion, create `.planning/phases/02-identity-crm/02-01-SUMMARY.md` following the summary template.
</output>
