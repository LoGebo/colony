---
phase: 14-guard-advanced-admin-providers
plan: 04
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - packages/mobile/src/hooks/useEmergency.ts
  - packages/mobile/src/components/guard/PanicButton.tsx
  - packages/mobile/src/components/guard/EmergencyTypeSheet.tsx
  - packages/mobile/src/components/guard/ProviderVerification.tsx
  - packages/mobile/app/(guard)/_layout.tsx
autonomous: true

must_haves:
  truths:
    - "Guard sees persistent panic button on every screen (floating above tab content)"
    - "Long-pressing the panic button triggers emergency type selection (panic, medical, fire, intrusion)"
    - "Selecting emergency type creates an emergency_alerts record and shows confirmation"
    - "Guard can verify provider access authorization from the gate screen"
  artifacts:
    - path: "packages/mobile/src/components/guard/PanicButton.tsx"
      provides: "Persistent floating panic button with long-press activation"
      contains: "onLongPress"
    - path: "packages/mobile/src/components/guard/EmergencyTypeSheet.tsx"
      provides: "Emergency type selection overlay"
      contains: "emergency_type"
    - path: "packages/mobile/src/hooks/useEmergency.ts"
      provides: "Emergency hooks: useTriggerEmergency, useActiveEmergencies, useProviderAccessCheck"
      contains: "useTriggerEmergency"
  key_links:
    - from: "packages/mobile/src/components/guard/PanicButton.tsx"
      to: "packages/mobile/src/components/guard/EmergencyTypeSheet.tsx"
      via: "Long-press opens type selection sheet"
      pattern: "EmergencyTypeSheet"
    - from: "packages/mobile/src/components/guard/EmergencyTypeSheet.tsx"
      to: "packages/mobile/src/hooks/useEmergency.ts"
      via: "Type selection triggers useTriggerEmergency mutation"
      pattern: "useTriggerEmergency"
    - from: "packages/mobile/src/hooks/useEmergency.ts"
      to: "emergency_alerts"
      via: "Supabase insert for creating emergency alert"
      pattern: "from\\('emergency_alerts'\\)"
    - from: "packages/mobile/app/(guard)/_layout.tsx"
      to: "packages/mobile/src/components/guard/PanicButton.tsx"
      via: "PanicButton rendered outside Tabs in layout"
      pattern: "<PanicButton"
---

<objective>
Build the guard emergency system: persistent panic button with long-press activation, emergency type selection, alert creation, and provider access verification.

Purpose: Guards need instant emergency alert capability from any screen, plus the ability to verify if service providers are authorized to enter. The database has a full emergency_alerts state machine with auto-priority and SLA metrics, plus is_provider_access_allowed() RPC for access verification.
Output: PanicButton component, EmergencyTypeSheet, ProviderVerification component, emergency hooks, updated guard layout.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-guard-advanced-admin-providers/14-RESEARCH.md
@.planning/phases/14-guard-advanced-admin-providers/14-01-SUMMARY.md
@packages/mobile/app/(guard)/_layout.tsx
@packages/mobile/src/hooks/useGateOps.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Emergency hooks and panic button components</name>
  <files>
    packages/mobile/src/hooks/useEmergency.ts
    packages/mobile/src/components/guard/PanicButton.tsx
    packages/mobile/src/components/guard/EmergencyTypeSheet.tsx
    packages/mobile/src/components/guard/ProviderVerification.tsx
  </files>
  <action>
    Create `packages/mobile/src/hooks/useEmergency.ts` following established patterns:

    1. **useTriggerEmergency()**: Mutation that inserts into emergency_alerts with: community_id, emergency_type (string: panic/medical/fire/intrusion/natural_disaster), triggered_by (userId), location_description (optional), location_lat, location_lng. Cast as never. Also captures GPS coordinates via expo-location getCurrentPositionAsync at trigger time. Invalidates emergencies keys. Returns the created alert.

    2. **useActiveEmergencies(communityId)**: Query fetching emergency_alerts where status NOT IN ('resolved', 'false_alarm'), ordered by created_at DESC. Select: id, emergency_type, status, priority_level, triggered_by, triggered_at, location_description. Use queryKeys.emergencies.active(communityId).

    3. **useProviderAccessCheck()**: Mutation that calls RPC `is_provider_access_allowed` with params: p_provider_id, p_check_time (current ISO timestamp). Returns boolean.

    4. **useProviderPersonnelSearch(query, communityId)**: Query that searches provider_personnel by first_name or last_name ilike, with join to providers(company_name, status). Only active providers (status='active'). Debounce-friendly (enabled when query.length >= 2). Use queryKeys.providers.list(communityId) with extra key segment.

    Create `packages/mobile/src/components/guard/PanicButton.tsx`:
    - Floating button positioned absolute at bottom-right corner (bottom: 90 to clear tab bar, right: 16)
    - Large red circular button (w-16 h-16, bg-red-600, rounded-full, shadow-lg)
    - Shows white "SOS" text or alert icon inside
    - **Long-press activation** (2000ms via onLongPress with delayLongPress={2000}):
      - During long-press: show visual countdown (border animation or opacity pulse). Use Animated API for a pulsing scale/opacity animation during the press.
      - On press (not long-press): show tooltip/toast "Manten presionado 2 segundos para activar"
      - On successful long-press: trigger haptic feedback via expo-haptics (Haptics.impactAsync(ImpactFeedbackStyle.Heavy)), then open EmergencyTypeSheet
    - Manages visible/sheet state internally
    - Uses React.memo

    Create `packages/mobile/src/components/guard/EmergencyTypeSheet.tsx`:
    - Modal overlay (semi-transparent black background, absolute positioned, covers full screen)
    - White card at bottom with emergency type options as large pressable tiles:
      - Panico (red, shield icon) -> emergency_type: 'panic'
      - Medica (blue, medical icon) -> emergency_type: 'medical'
      - Incendio (orange, fire icon) -> emergency_type: 'fire'
      - Intrusion (purple, alert icon) -> emergency_type: 'intrusion'
    - Takes props: { visible: boolean, onClose: () => void, onSelectType: (type: string) => void }
    - On type selection:
      1. Call useTriggerEmergency (passed via callback prop, parent wires it)
      2. Show confirmation: green checkmark + "Alerta enviada" for 2 seconds
      3. Auto-close sheet after confirmation
    - Cancel button to dismiss without triggering

    Create `packages/mobile/src/components/guard/ProviderVerification.tsx`:
    - Takes no props (self-contained search component)
    - Search input for provider personnel name
    - Results list: show personnel name, provider company name, photo placeholder
    - "Verificar Acceso" button per result that calls useProviderAccessCheck with the provider_id
    - Result display: green "Acceso Autorizado" or red "Acceso Denegado" badge
    - Shows provider's authorized schedule info if available
    - This component will be used as a modal/sheet from the gate index screen
  </action>
  <verify>
    - `npx tsc --noEmit` passes for all 4 files
    - useEmergency.ts exports 4 hooks
    - PanicButton has onLongPress with 2000ms delay and haptic feedback import
    - EmergencyTypeSheet shows 4 emergency type tiles
    - ProviderVerification has search input and access check result display
  </verify>
  <done>
    - 4 emergency hooks (trigger, active list, provider access check, personnel search)
    - PanicButton with long-press activation, haptic feedback, countdown animation
    - EmergencyTypeSheet with 4 type options and confirmation flow
    - ProviderVerification with personnel search and is_provider_access_allowed RPC check
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire PanicButton into guard layout and add provider verification to gate</name>
  <files>
    packages/mobile/app/(guard)/_layout.tsx
  </files>
  <action>
    Update `packages/mobile/app/(guard)/_layout.tsx`:

    1. Read the current file (updated by Plan 14-01 with patrol/incidents tabs and PanicButton comment placeholder)
    2. Import PanicButton from '../../src/components/guard/PanicButton'
    3. Replace the `{/* <PanicButton /> will be added by plan 14-04 */}` comment with the actual `<PanicButton />` component
    4. The layout should now have:
       - View wrapper with flex: 1
       - Tabs with 5 visible tabs + hidden gate tab
       - PanicButton rendered AFTER Tabs but inside the View wrapper (absolute positioned, floats above all content)

    The guard index.tsx (gate screen) should already exist from Phase 10. The ProviderVerification component is built but will be used as an import by the existing gate screen or accessed via a button. Do NOT modify the gate index screen in this plan -- just build the component. A future integration or the guard can navigate to it.

    However, if you can add a simple "Verificar Proveedor" button to the existing gate/caseta index screen that opens a modal with ProviderVerification, do so. Read the existing guard index.tsx first to understand its structure. If modification is straightforward (adding a button and modal), include it. If the file is complex, skip and just build the component.
  </action>
  <verify>
    - `npx tsc --noEmit` passes for the updated _layout.tsx
    - Guard layout imports and renders PanicButton
    - PanicButton is rendered outside the Tabs component
    - No regression in existing tab structure
  </verify>
  <done>
    - PanicButton is persistently visible on all guard screens via absolute positioning in the layout
    - GEMRG-01 (persistent panic button), GEMRG-02 (alert triggers), GEMRG-03 (emergency type selection), GEMRG-04 (provider verification) all covered
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for all new and modified files
2. PanicButton renders as floating red circle on guard screens
3. Long-press (2s) opens EmergencyTypeSheet with 4 type options
4. Type selection calls useTriggerEmergency and shows confirmation
5. ProviderVerification searches personnel and checks access authorization
6. PanicButton is in guard _layout.tsx outside Tabs
</verification>

<success_criteria>
Guard has persistent panic button on all screens, can trigger typed emergency alerts with GPS, and can verify provider access. GEMRG-01 (panic button), GEMRG-02 (alert dispatch), GEMRG-03 (type selection), GEMRG-04 (provider verification) all satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/14-guard-advanced-admin-providers/14-04-SUMMARY.md`
</output>
