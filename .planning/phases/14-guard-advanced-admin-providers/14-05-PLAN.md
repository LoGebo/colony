---
phase: 14-guard-advanced-admin-providers
plan: 05
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - packages/admin/src/hooks/useProviders.ts
  - packages/admin/src/hooks/useWorkOrders.ts
  - packages/admin/src/app/(dashboard)/providers/page.tsx
  - packages/admin/src/app/(dashboard)/providers/[id]/page.tsx
  - packages/admin/src/app/(dashboard)/providers/work-orders/page.tsx
  - packages/admin/src/app/(dashboard)/providers/work-orders/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view list of provider companies with status filters"
    - "Admin can create, edit, and deactivate providers with contact info and specialties"
    - "Admin can manage provider documentation (insurance, certifications) with expiry tracking"
    - "Admin can manage provider personnel (authorized employees)"
    - "Admin can configure provider access schedules (allowed days/hours)"
    - "Admin can create, view, and manage work orders with status workflow and cost tracking"
  artifacts:
    - path: "packages/admin/src/hooks/useProviders.ts"
      provides: "Provider CRUD hooks, document/personnel/schedule management hooks"
      contains: "useProviderList"
    - path: "packages/admin/src/hooks/useWorkOrders.ts"
      provides: "Work order CRUD hooks with status workflow"
      contains: "useWorkOrderList"
    - path: "packages/admin/src/app/(dashboard)/providers/page.tsx"
      provides: "Provider list page with create form and status filters"
      contains: "providers"
    - path: "packages/admin/src/app/(dashboard)/providers/[id]/page.tsx"
      provides: "Provider detail page with tabs for info, docs, personnel, schedules"
      contains: "provider_documents"
  key_links:
    - from: "packages/admin/src/hooks/useProviders.ts"
      to: "providers"
      via: "Supabase CRUD on providers table"
      pattern: "from\\('providers'\\)"
    - from: "packages/admin/src/hooks/useWorkOrders.ts"
      to: "provider_work_orders"
      via: "Supabase CRUD on work orders table"
      pattern: "from\\('provider_work_orders'\\)"
    - from: "packages/admin/src/app/(dashboard)/providers/[id]/page.tsx"
      to: "packages/admin/src/hooks/useProviders.ts"
      via: "Uses provider detail + document/personnel/schedule hooks"
      pattern: "useProviderDetail"
---

<objective>
Build admin provider management (company CRUD, documentation tracking, personnel, access schedules) and work order management (creation, status workflow, cost tracking, rating).

Purpose: Administrators need to manage external service providers who access the community, track their documentation compliance, authorize personnel, and manage work orders. The database has a complete provider schema plus the new provider_work_orders table from the migration.
Output: Provider hooks, work order hooks, 4 admin pages (provider list, provider detail with tabs, work order list, work order detail).
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-guard-advanced-admin-providers/14-RESEARCH.md
@.planning/phases/14-guard-advanced-admin-providers/14-01-SUMMARY.md
@packages/admin/src/app/(dashboard)/layout.tsx
@packages/admin/src/hooks/useTickets.ts
@packages/admin/src/hooks/useResidents.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Provider and work order data hooks</name>
  <files>
    packages/admin/src/hooks/useProviders.ts
    packages/admin/src/hooks/useWorkOrders.ts
  </files>
  <action>
    Create `packages/admin/src/hooks/useProviders.ts` following established admin patterns (lazy Supabase client from createBrowserClient in queryFn, 'as never' casts, queryKeys from @upoe/shared, user!.id for mutations):

    1. **useProviderList(communityId, statusFilter?)**: Query fetching providers for the community with optional status filter (pending_approval/active/suspended/inactive). Select: id, company_name, contact_name, contact_email, contact_phone, specialty, status, total_work_orders, average_rating, created_at. Ordered by company_name. Use queryKeys.providers.list(communityId).

    2. **useProviderDetail(id)**: Query fetching single provider with all fields. Enabled when id is truthy. Use queryKeys.providers.detail(id).

    3. **useCreateProvider()**: Mutation inserting into providers with: community_id, company_name, contact_name, contact_email, contact_phone, specialty, tax_id, address, notes, status='pending_approval'. Cast as never. Invalidates providers keys.

    4. **useUpdateProvider()**: Mutation updating provider by id. Cast as never. Invalidates providers keys.

    5. **useProviderDocuments(providerId)**: Query fetching provider_documents for a provider. Select: id, document_type, document_number, issued_by, issue_date, expiry_date, status, file_url, notes, created_at. Ordered by expiry_date ASC. Use queryKeys.providers.documents(providerId).

    6. **useCreateProviderDocument()**: Mutation inserting into provider_documents with: provider_id, community_id, document_type, document_number, issued_by, issue_date, expiry_date, status='pending_verification', notes. Cast as never. Invalidates providers.documents.

    7. **useUpdateProviderDocument()**: Mutation updating provider_documents by id (e.g., status change to verified/expired/rejected). Cast as never.

    8. **useProviderPersonnel(providerId)**: Query fetching provider_personnel for a provider. Select: id, first_name, last_name, document_type, document_number, phone, photo_url, is_active, created_at. Use queryKeys.providers.personnel(providerId).

    9. **useCreateProviderPersonnel()**: Mutation inserting into provider_personnel with: provider_id, community_id, first_name, last_name, document_type, document_number, phone. Cast as never. Invalidates providers.personnel.

    10. **useTogglePersonnelActive()**: Mutation updating provider_personnel set is_active=!current. Invalidates providers.personnel.

    11. **useProviderSchedules(providerId)**: Query fetching provider_access_schedules for a provider. Select: id, day_of_week, start_time, end_time, effective_from, effective_until, is_active, notes. Ordered by day_of_week, start_time. Use queryKeys.providers.schedules(providerId).

    12. **useCreateProviderSchedule()**: Mutation inserting into provider_access_schedules with: provider_id, community_id, day_of_week, start_time, end_time, effective_from, effective_until. Cast as never. Invalidates providers.schedules.

    13. **useDeleteProviderSchedule()**: Mutation deleting provider_access_schedules by id. Invalidates providers.schedules.

    14. **useExpiringDocuments(communityId)**: Query selecting from provider_documents_expiring view (if exists) or provider_documents where expiry_date is within next 30 days, ordered by expiry_date ASC. Use queryKeys.providers.expiringDocs(communityId).

    Create `packages/admin/src/hooks/useWorkOrders.ts`:

    1. **useWorkOrderList(communityId, statusFilter?)**: Query fetching provider_work_orders for the community with optional status filter, joined to providers(company_name) and units(unit_number). Select: id, work_order_number, title, status, provider_id, unit_id, scheduled_date, estimated_cost, actual_cost, created_at, plus joined company_name and unit_number. Ordered by created_at DESC. Use queryKeys.workOrders.list(communityId). Filter deleted_at IS NULL.

    2. **useWorkOrderDetail(id)**: Query fetching single work order with all fields, joined to providers(company_name) and units(unit_number). Enabled when id is truthy. Use queryKeys.workOrders.detail(id).

    3. **useCreateWorkOrder()**: Mutation inserting into provider_work_orders with: community_id, provider_id, title, description, category, unit_id (optional), location_description, requested_date, estimated_cost, status='draft'. Leave work_order_number NULL (auto-generated by trigger). Cast as never. Invalidates workOrders keys.

    4. **useUpdateWorkOrder()**: Mutation updating by id (status transitions, scheduling, cost updates, completion). Cast as never. Invalidates workOrders keys.

    5. **useRateWorkOrder()**: Mutation updating rating and rating_notes for a completed work order. Invalidates workOrders keys.

    6. **useWorkOrdersByProvider(providerId)**: Query fetching work orders for a specific provider. Use queryKeys.workOrders.byProvider(providerId).
  </action>
  <verify>
    - `npx tsc --noEmit` passes for both hook files
    - useProviders.ts exports 14 hooks
    - useWorkOrders.ts exports 6 hooks
    - All hooks use queryKeys from @upoe/shared
    - All mutations use 'as never' cast pattern
  </verify>
  <done>
    - 14 provider hooks covering CRUD, documents, personnel, schedules, expiring docs
    - 6 work order hooks covering list, detail, create, update, rate, by-provider
    - All hooks follow established admin dashboard patterns
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin provider list, provider detail, work order list, and work order detail pages</name>
  <files>
    packages/admin/src/app/(dashboard)/providers/page.tsx
    packages/admin/src/app/(dashboard)/providers/[id]/page.tsx
    packages/admin/src/app/(dashboard)/providers/work-orders/page.tsx
    packages/admin/src/app/(dashboard)/providers/work-orders/[id]/page.tsx
  </files>
  <action>
    All pages use 'use client' directive, force-dynamic export, and follow the established admin dashboard page patterns (from Phase 11-12). Use @tanstack/react-table for data tables, sonner for toasts, Tailwind CSS v4.

    Create `packages/admin/src/app/(dashboard)/providers/page.tsx` (APROV-01):
    - Page title: "Proveedores"
    - Status filter dropdown (All, Pendiente, Activo, Suspendido, Inactivo) mapping to provider_status enum values
    - DataTable with columns: company_name, contact_name, contact_email, specialty, status badge (color-coded), total_work_orders, average_rating (stars), actions (View link)
    - Create provider form (expandable section or modal):
      - Fields: company_name (required), contact_name, contact_email, contact_phone, specialty, tax_id, address, notes
      - Submit calls useCreateProvider
    - Rows link to /providers/[id]
    - Expiring documents alert banner at top (from useExpiringDocuments) -- show count of documents expiring within 30 days, link to filtered view

    Create `packages/admin/src/app/(dashboard)/providers/[id]/page.tsx` (APROV-01 + APROV-02 + APROV-03 + APROV-04):
    - Tabbed detail page with 4 tabs: Informacion, Documentos, Personal, Horarios
    - Use URL hash or simple state for tab switching (no routing needed)

    **Info tab (APROV-01):**
    - Provider details card with inline edit (company_name, contact info, specialty, status dropdown, tax_id, address, notes)
    - Status change dropdown (pending_approval -> active -> suspended, etc.) calls useUpdateProvider
    - Work orders summary: total count, average rating, link to filtered work orders list

    **Documents tab (APROV-02):**
    - DataTable of provider_documents: document_type, document_number, issued_by, issue_date, expiry_date, status badge (pending_verification=yellow, verified=green, expired=red, rejected=gray)
    - Status indicator: expired docs highlighted in red
    - Add document form: document_type (text), document_number, issued_by, issue_date (date picker), expiry_date (date picker), notes
    - Status action buttons: Verify (set verified), Reject (set rejected) for pending docs
    - No file upload in this phase (document metadata only; file_url column exists but file upload can be added later)

    **Personnel tab (APROV-03):**
    - Card grid of provider_personnel: first_name + last_name, document (type + number), phone, photo placeholder, active badge
    - Add personnel form: first_name, last_name, document_type (INE/passport/etc), document_number, phone
    - Toggle active/inactive button per card (calls useTogglePersonnelActive)

    **Schedules tab (APROV-04):**
    - Weekly schedule grid/table: rows per day of week (Lunes-Domingo), columns: start_time, end_time, effective period, status
    - Add schedule form: day_of_week (0-6 dropdown with Spanish day names), start_time, end_time, effective_from (date), effective_until (date, optional)
    - Delete schedule button (with confirmation)

    Create `packages/admin/src/app/(dashboard)/providers/work-orders/page.tsx` (APROV-05):
    - Page title: "Ordenes de Trabajo"
    - Status filter dropdown (All, Borrador, Enviada, Aprobada, Programada, En Progreso, Completada, Cancelada)
    - DataTable with columns: work_order_number, title, provider (company_name), unit (unit_number), status badge, scheduled_date, estimated_cost, actual_cost, rating
    - Create work order button -> links to detail page in create mode, OR inline create form:
      - Fields: provider (dropdown from useProviderList with status=active), title, description, category (text), unit (dropdown from useUnitList), requested_date, estimated_cost
      - Submit calls useCreateWorkOrder

    Create `packages/admin/src/app/(dashboard)/providers/work-orders/[id]/page.tsx` (APROV-05):
    - Work order detail with status workflow
    - Top section: work_order_number, title, status badge, provider link, unit link
    - Detail fields: description, category, location_description, scheduling dates, cost comparison (estimated vs actual)
    - Status transition buttons: Draft->Submitted, Submitted->Approved, Approved->Scheduled (set date), Scheduled->In Progress, In Progress->Completed (set actual_cost + completion notes), any->Cancelled
    - Rating section (visible only when status=completed): 1-5 star selector, rating_notes textarea, calls useRateWorkOrder
    - Admin notes and provider notes (editable textareas)
  </action>
  <verify>
    - `npx tsc --noEmit` passes for all 4 page files
    - providers/page.tsx shows DataTable with status filter and create form
    - providers/[id]/page.tsx has 4 tabs (info, docs, personnel, schedules)
    - work-orders/page.tsx shows DataTable with status filter
    - work-orders/[id]/page.tsx has status workflow buttons and rating section
  </verify>
  <done>
    - Provider list page with status filters, DataTable, create form, expiring docs alert
    - Provider detail page with 4 tabs: info edit, document management with verification, personnel CRUD with active toggle, access schedule management
    - Work order list with status filters and creation
    - Work order detail with full status workflow, cost tracking, and post-completion rating
    - APROV-01 through APROV-05 all covered
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for all new files
2. useProviders.ts exports 14 hooks covering all provider sub-resources
3. useWorkOrders.ts exports 6 hooks covering work order lifecycle
4. Provider list page shows filterable table with create form
5. Provider detail has 4 working tabs with CRUD for each sub-resource
6. Work order pages support full status workflow from draft to completed with rating
</verification>

<success_criteria>
Admin can manage providers end-to-end (companies, documents, personnel, schedules) and work orders (create, approve, schedule, complete, rate). APROV-01 through APROV-05 all satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/14-guard-advanced-admin-providers/14-05-SUMMARY.md`
</output>
