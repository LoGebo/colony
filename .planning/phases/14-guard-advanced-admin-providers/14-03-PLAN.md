---
phase: 14-guard-advanced-admin-providers
plan: 03
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - packages/mobile/src/hooks/useIncidents.ts
  - packages/mobile/src/hooks/useHandovers.ts
  - packages/mobile/src/components/guard/IncidentTimelineItem.tsx
  - packages/mobile/src/components/guard/HandoverNoteCard.tsx
  - packages/mobile/app/(guard)/incidents/_layout.tsx
  - packages/mobile/app/(guard)/incidents/index.tsx
  - packages/mobile/app/(guard)/incidents/create.tsx
  - packages/mobile/app/(guard)/incidents/[id].tsx
  - packages/mobile/app/(guard)/incidents/handover.tsx
autonomous: true

must_haves:
  truths:
    - "Guard can view list of recent incidents for their community"
    - "Guard can create a new incident report with type, severity, description, and photos"
    - "Guard can view incident detail with full timeline and add follow-up comments"
    - "Guard can write shift handover notes with priority and pending items"
    - "Guard can view recent handover notes and acknowledge unread ones"
  artifacts:
    - path: "packages/mobile/src/hooks/useIncidents.ts"
      provides: "Incident hooks: useIncidentList, useIncidentDetail, useCreateIncident, useAddIncidentComment, useUploadIncidentMedia, useIncidentTypes"
      contains: "useCreateIncident"
    - path: "packages/mobile/src/hooks/useHandovers.ts"
      provides: "Handover hooks: useRecentHandovers, useCreateHandover, useAcknowledgeHandover"
      contains: "useCreateHandover"
    - path: "packages/mobile/app/(guard)/incidents/create.tsx"
      provides: "Incident creation form with photo upload"
      contains: "incident_type"
    - path: "packages/mobile/app/(guard)/incidents/[id].tsx"
      provides: "Incident detail with timeline and comment form"
      contains: "timeline"
    - path: "packages/mobile/app/(guard)/incidents/handover.tsx"
      provides: "Handover notes screen with create and acknowledge"
      contains: "shift_handovers"
  key_links:
    - from: "packages/mobile/src/hooks/useIncidents.ts"
      to: "incidents"
      via: "Supabase insert for creating incidents"
      pattern: "from\\('incidents'\\)"
    - from: "packages/mobile/src/hooks/useIncidents.ts"
      to: "add_incident_comment"
      via: "RPC call for timeline comments"
      pattern: "rpc\\('add_incident_comment'"
    - from: "packages/mobile/src/hooks/useHandovers.ts"
      to: "shift_handovers"
      via: "Supabase insert/update for handover notes"
      pattern: "from\\('shift_handovers'\\)"
---

<objective>
Build guard incident reporting (create, view timeline, add follow-ups) and shift handover notes (create, view, acknowledge).

Purpose: Guards need to document incidents with evidence and timeline tracking, and leave notes for incoming guards during shift changes. The database has a rich incident system with JSONB timeline and helper RPCs (add_incident_event, add_incident_comment), plus the new shift_handovers table from the migration.
Output: Incident hooks, handover hooks, timeline component, handover card, and 5 screens (incident list, create, detail, handover).
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-guard-advanced-admin-providers/14-RESEARCH.md
@.planning/phases/14-guard-advanced-admin-providers/14-01-SUMMARY.md
@packages/shared/src/queries/keys.ts
@packages/mobile/src/hooks/useGateOps.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Incident and handover data hooks plus timeline components</name>
  <files>
    packages/mobile/src/hooks/useIncidents.ts
    packages/mobile/src/hooks/useHandovers.ts
    packages/mobile/src/components/guard/IncidentTimelineItem.tsx
    packages/mobile/src/components/guard/HandoverNoteCard.tsx
  </files>
  <action>
    Create `packages/mobile/src/hooks/useIncidents.ts` following established patterns (lazy Supabase client in queryFn, 'as never' casts, queryKeys from @upoe/shared):

    1. **useIncidentTypes(communityId)**: Query fetching incident_types for the community (id, name, description, severity_default, requires_photo). Use queryKeys.incidents.types(communityId).

    2. **useIncidentList(communityId)**: Query fetching incidents for the community, ordered by created_at DESC, limit 50. Select: id, incident_number, title, severity, status, created_at, location_description. Use queryKeys.incidents.list(communityId).

    3. **useIncidentDetail(id)**: Query fetching single incident with all fields including timeline JSONB array. Also fetch related incident_media (id, media_type, storage_path, caption, created_at). Use queryKeys.incidents.detail(id). Enabled only when id is truthy.

    4. **useCreateIncident()**: Mutation that inserts into incidents with: community_id, reported_by_guard (guardId), title, description, incident_type_id (optional), severity, location_type, location_description, gps_latitude, gps_longitude. Cast as never. Invalidates incidents keys.

    5. **useAddIncidentComment()**: Mutation that calls RPC `add_incident_comment` with params: p_incident_id, p_comment_text, p_is_internal (boolean, default false), p_actor_id (userId). Invalidates incidents.detail for the specific incident.

    6. **useUploadIncidentMedia()**: Mutation that:
       - Takes { incidentId, imageUri, mediaType: 'photo'|'video', caption? }
       - Uploads to Supabase Storage bucket 'incident-evidence' with path `{communityId}/{incidentId}/{uuid}.jpg`
       - Inserts into incident_media with: incident_id, community_id, media_type, storage_path, storage_bucket='incident-evidence', caption. Cast as never.
       - Invalidates incidents.detail and incidents.media keys
       - Use the same file upload approach as pickAndUploadImage from Phase 9 (read file, upload bytes to Storage)

    Create `packages/mobile/src/hooks/useHandovers.ts`:

    1. **useRecentHandovers(communityId)**: Query fetching recent shift_handovers (last 20) ordered by created_at DESC. Select: id, guard_id, notes, priority, pending_items, shift_started_at, shift_ended_at, acknowledged_by, acknowledged_at, created_at. Join guards(first_name, last_name). Use queryKeys.handovers.recent(communityId).

    2. **useUnacknowledgedHandovers(communityId)**: Query fetching shift_handovers where acknowledged_at IS NULL, ordered by created_at DESC. Use queryKeys.handovers.unacknowledged(communityId).

    3. **useCreateHandover()**: Mutation that inserts into shift_handovers with: community_id, guard_id, notes, priority, pending_items (JSONB array of {description, completed} objects), access_point_id (optional), shift_id (optional). Cast as never. Invalidates handovers keys.

    4. **useAcknowledgeHandover()**: Mutation that updates shift_handovers set acknowledged_by=guardId, acknowledged_at=new Date().toISOString() where id=handoverId. Invalidates handovers keys.

    Create `packages/mobile/src/components/guard/IncidentTimelineItem.tsx`:
    - Takes props matching the JSONB timeline event shape: { type: string, timestamp: string, actor_name: string, data: Record<string, unknown> }
    - React.memo wrapped
    - Renders differently based on type:
      - 'created': blue dot, "Incidente reportado por {actor_name}"
      - 'status_changed': orange dot, "Estado cambiado a {data.new_status}" with old status
      - 'assigned': purple dot, "{actor_name} asignado"
      - 'comment': gray dot, "{actor_name}: {data.text}" (show full comment text)
      - 'media_added': green dot, "Evidencia agregada por {actor_name}"
      - 'escalated': red dot, "Escalado a {data.new_priority} por {actor_name}: {data.reason}"
      - default: gray dot with type label
    - Show formatted timestamp using date-fns format with Spanish locale
    - Vertical timeline line connecting items (left border or absolute positioned line)

    Create `packages/mobile/src/components/guard/HandoverNoteCard.tsx`:
    - Takes props: { guardName: string, notes: string, priority: string, pendingItems: Array<{description: string, completed: boolean}>, createdAt: string, acknowledged: boolean, onAcknowledge?: () => void }
    - React.memo wrapped
    - Card with priority color accent (normal=gray, important=yellow, urgent=red)
    - Guard name and relative time
    - Notes text
    - Pending items as checklist (checkbox icon + text, strike-through if completed)
    - If not acknowledged and onAcknowledge provided: "Confirmar Lectura" button
  </action>
  <verify>
    - `npx tsc --noEmit` passes for all 4 files
    - useIncidents.ts exports 6 hooks
    - useHandovers.ts exports 4 hooks
    - IncidentTimelineItem handles all 6 event types with colored dots
    - HandoverNoteCard renders priority colors and pending items checklist
  </verify>
  <done>
    - 6 incident hooks covering types, list, detail, create, comment (via RPC), media upload
    - 4 handover hooks covering recent list, unacknowledged list, create, acknowledge
    - IncidentTimelineItem renders timeline events with type-specific styling
    - HandoverNoteCard renders handover notes with priority, pending items, acknowledgment button
  </done>
</task>

<task type="auto">
  <name>Task 2: Incident screens (list, create, detail) and handover screen</name>
  <files>
    packages/mobile/app/(guard)/incidents/_layout.tsx
    packages/mobile/app/(guard)/incidents/index.tsx
    packages/mobile/app/(guard)/incidents/create.tsx
    packages/mobile/app/(guard)/incidents/[id].tsx
    packages/mobile/app/(guard)/incidents/handover.tsx
  </files>
  <action>
    Create `packages/mobile/app/(guard)/incidents/_layout.tsx`:
    - Stack layout with headerShown: false
    - Screens: index (title "Incidentes"), create (title "Reportar Incidente", presentation "modal"), [id] (title "Detalle"), handover (title "Notas de Turno")

    Create `packages/mobile/app/(guard)/incidents/index.tsx` (GINC-01, GINC-02):
    - Two-section screen: top section shows unacknowledged handover count badge linking to handover screen, bottom section shows incident list
    - Use useIncidentList for the incident FlatList
    - Each incident row: incident_number, title, severity badge (low=green, medium=yellow, high=orange, critical=red), status badge, relative time
    - Pressable rows navigate to /incidents/[id]
    - Floating action button "+" to navigate to /incidents/create
    - Header bar with "Notas de Turno" button in top-right corner (navigates to handover screen)
    - Pull-to-refresh, empty state ("No hay incidentes registrados"), loading state

    Create `packages/mobile/app/(guard)/incidents/create.tsx` (GINC-01):
    - Form fields:
      - Title (TextInput, required)
      - Description (TextInput multiline, required)
      - Incident Type (picker/select from useIncidentTypes, optional)
      - Severity (4-option radio group: low/medium/high/critical, default from selected type's severity_default or 'medium')
      - Location description (TextInput, optional)
    - Photo section: "Agregar Fotos" button using expo-image-picker (launchImageLibraryAsync or launchCameraAsync). Show thumbnails of selected photos. Support up to 5 photos.
    - On submit:
      1. Get current GPS via expo-location (if permission granted)
      2. Call useCreateIncident with form data + GPS coords
      3. For each photo: call useUploadIncidentMedia with the incident ID
      4. Show success toast, navigate back to incident list
    - Loading state during submission, disable button
    - Cancel button in header

    Create `packages/mobile/app/(guard)/incidents/[id].tsx` (GINC-02):
    - Receive incident ID from route params
    - Use useIncidentDetail to fetch incident + media
    - Top section: incident_number, title, severity badge, status badge, location, GPS coords if available
    - Timeline section: reverse chronological list of timeline events using IncidentTimelineItem
    - Media section: if incident_media exists, show photo thumbnails in a horizontal scroll. Pressing opens a full-screen preview.
    - Comment input at bottom: TextInput + Send button. Calls useAddIncidentComment on submit. Clear input on success.
    - Pull-to-refresh

    Create `packages/mobile/app/(guard)/incidents/handover.tsx` (GINC-03):
    - Two sections: "Crear Nota" form at top, "Notas Recientes" list below
    - Create form:
      - Notes (TextInput multiline, required)
      - Priority (3-option segmented control: normal/important/urgent)
      - Pending items: dynamic list with "Agregar Pendiente" button. Each item has a TextInput for description and a delete (X) button.
      - "Guardar Nota" button calls useCreateHandover
    - Recent list: FlatList of HandoverNoteCards using useRecentHandovers
    - Unacknowledged handovers show the acknowledge button; pressing it calls useAcknowledgeHandover
    - Pull-to-refresh on the list
  </action>
  <verify>
    - `npx tsc --noEmit` passes for all 5 screen files
    - incidents/_layout.tsx defines Stack with 4 screens
    - incidents/index.tsx shows incident list with severity/status badges and handover badge
    - incidents/create.tsx has form with photo picker and GPS capture
    - incidents/[id].tsx shows timeline via IncidentTimelineItem and comment input
    - incidents/handover.tsx has create form with pending items and recent notes list
  </verify>
  <done>
    - Incident list screen with severity badges, status badges, FAB to create
    - Incident create form with type picker, severity radio, photo upload, GPS capture
    - Incident detail with full timeline rendering and follow-up comment input
    - Handover screen with note creation (priority, pending items) and recent notes with acknowledgment
    - GINC-01 (create incident), GINC-02 (view timeline + follow-ups), GINC-03 (shift handover notes) all covered
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for all new files
2. useIncidents.ts exports 6 hooks (types, list, detail, create, comment, media)
3. useHandovers.ts exports 4 hooks (recent, unacknowledged, create, acknowledge)
4. Incident list screen shows incidents with badges
5. Incident create screen has form with photo upload and GPS
6. Incident detail screen renders JSONB timeline via IncidentTimelineItem
7. Handover screen has create form and acknowledgment flow
</verification>

<success_criteria>
Guard can create incident reports with type/severity/photos, view incident timelines with follow-up comments, and write/read/acknowledge shift handover notes. GINC-01, GINC-02, GINC-03 all satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/14-guard-advanced-admin-providers/14-03-SUMMARY.md`
</output>
