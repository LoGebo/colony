---
phase: 14-guard-advanced-admin-providers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .pending_migrations/20260208220000_shift_handovers.sql
  - .pending_migrations/20260208220100_provider_work_orders.sql
  - packages/mobile/package.json
  - packages/mobile/app.json
  - packages/shared/src/queries/keys.ts
  - packages/mobile/app/(guard)/_layout.tsx
  - packages/admin/src/app/(dashboard)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "shift_handovers and provider_work_orders migration SQL files exist with correct schema"
    - "react-native-nfc-manager, expo-location, expo-haptics are installed in mobile package"
    - "Guard tab layout shows Patrol and Incidents tabs plus persistent PanicButton wrapper"
    - "Admin sidebar has Providers, Parking, Moves, and Marketplace sections"
    - "All Phase 14 query key factories are registered in shared keys.ts"
  artifacts:
    - path: ".pending_migrations/20260208220000_shift_handovers.sql"
      provides: "shift_handovers table migration"
      contains: "CREATE TABLE shift_handovers"
    - path: ".pending_migrations/20260208220100_provider_work_orders.sql"
      provides: "provider_work_orders table migration"
      contains: "CREATE TABLE provider_work_orders"
    - path: "packages/shared/src/queries/keys.ts"
      provides: "Query key factories for patrols, incidents, emergencies, handovers, providers, workOrders, parking, moves, moderation"
      contains: "patrols"
    - path: "packages/mobile/app/(guard)/_layout.tsx"
      provides: "Updated guard layout with Patrol tab, Incidents tab, and PanicButton wrapper"
      contains: "patrol"
  key_links:
    - from: "packages/shared/src/queries/keys.ts"
      to: "mergeQueryKeys"
      via: "All new factories added to mergeQueryKeys call"
      pattern: "mergeQueryKeys.*patrols.*incidents.*emergencies"
    - from: "packages/mobile/app/(guard)/_layout.tsx"
      to: "PanicButton"
      via: "PanicButton rendered outside Tabs"
      pattern: "PanicButton"
---

<objective>
Set up all foundational infrastructure for Phase 14: database migrations for the two missing tables (shift_handovers, provider_work_orders), install new native dependencies for NFC and GPS, add query key factories for all Phase 14 domains, update guard tab layout with new tabs and persistent panic button wrapper, and update admin sidebar with new navigation sections.

Purpose: Every other plan in Phase 14 depends on these foundations -- query keys, layout structure, migrations, and native modules.
Output: Migration SQL files, updated package.json, updated shared keys.ts, updated guard and admin layouts.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-guard-advanced-admin-providers/14-RESEARCH.md
@packages/shared/src/queries/keys.ts
@packages/mobile/app/(guard)/_layout.tsx
@packages/admin/src/app/(dashboard)/layout.tsx
@packages/mobile/package.json
@packages/mobile/app.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migrations and install native dependencies</name>
  <files>
    .pending_migrations/20260208220000_shift_handovers.sql
    .pending_migrations/20260208220100_provider_work_orders.sql
    packages/mobile/package.json
    packages/mobile/app.json
  </files>
  <action>
    1. Create `.pending_migrations/20260208220000_shift_handovers.sql` with the shift_handovers table as specified in 14-RESEARCH.md Migration 1 section. Include: table creation with UUID PK (generate_uuid_v7), community_id FK, guard_id FK to guards, access_point_id FK, shift_id FK, notes TEXT NOT NULL, priority TEXT CHECK (normal/important/urgent), pending_items JSONB, shift timing fields, acknowledged_by/acknowledged_at, audit fields. Add indexes (community+created_at DESC, guard+created_at DESC, unacknowledged). Add RLS with 3 policies: SELECT for community members, INSERT for guards in their community, UPDATE for guards and admin/manager. Add set_audit_fields trigger.

    2. Create `.pending_migrations/20260208220100_provider_work_orders.sql` with the provider_work_orders table as specified in 14-RESEARCH.md Migration 2 section. Include: table creation with UUID PK, community_id, provider_id FK, work_order_number TEXT UNIQUE per community, title, description, category, unit_id FK, location_description, scheduling fields (requested/scheduled/completed dates, time range), status CHECK (draft/submitted/approved/scheduled/in_progress/completed/cancelled), cost tracking (estimated/actual NUMERIC(15,4), currency MXN), ticket_id FK, rating 1-5, assigned_personnel_ids UUID[], notes fields, completion fields, audit columns. Add auto-number generation function+trigger (WO-YYYY-NNNNN format), provider stats update trigger on completion, indexes, RLS (admin/manager full access, guard SELECT), audit+soft-delete triggers.

    3. Run `cd packages/mobile && pnpm add react-native-nfc-manager expo-location expo-haptics` to install native dependencies.

    4. Update `packages/mobile/app.json` to add plugins:
       - Add `"react-native-nfc-manager"` to the plugins array
       - Add `["expo-location", { "locationWhenInUsePermission": "Necesitamos tu ubicacion para validar los puntos de control de ronda" }]` to the plugins array
       - Preserve all existing plugins

    NOTE: Do NOT use `npx expo install` for react-native-nfc-manager as it is not an Expo package. Use `pnpm add` directly.
  </action>
  <verify>
    - Both migration SQL files exist in .pending_migrations/ and contain valid SQL (CREATE TABLE, indexes, RLS policies, triggers)
    - `pnpm ls react-native-nfc-manager expo-location expo-haptics --filter @upoe/mobile` shows all three installed
    - app.json contains react-native-nfc-manager and expo-location in plugins array
  </verify>
  <done>
    - shift_handovers migration creates table with guard FK, community FK, notes, priority, pending_items JSONB, acknowledgment tracking, RLS, indexes
    - provider_work_orders migration creates table with auto-numbering, cost tracking, status workflow, rating, RLS, triggers
    - Three native dependencies installed in mobile package
    - app.json plugins updated for NFC and location
  </done>
</task>

<task type="auto">
  <name>Task 2: Add query key factories and update navigation layouts</name>
  <files>
    packages/shared/src/queries/keys.ts
    packages/mobile/app/(guard)/_layout.tsx
    packages/admin/src/app/(dashboard)/layout.tsx
  </files>
  <action>
    1. Add the following query key factories to `packages/shared/src/queries/keys.ts` (before the mergeQueryKeys call):

    ```typescript
    export const patrols = createQueryKeys('patrols', {
      all: null,
      routes: (communityId: string) => [{ communityId }],
      routeDetail: (id: string) => [id],
      activeLogs: (guardId: string) => [{ guardId }],
      logDetail: (id: string) => [id],
      checkpoints: (communityId: string) => [{ communityId }],
    });

    export const incidents = createQueryKeys('incidents', {
      all: null,
      list: (communityId: string) => [{ communityId }],
      detail: (id: string) => [id],
      types: (communityId: string) => [{ communityId }],
      media: (incidentId: string) => [{ incidentId }],
    });

    export const emergencies = createQueryKeys('emergencies', {
      all: null,
      active: (communityId: string) => [{ communityId }],
      detail: (id: string) => [id],
    });

    export const handovers = createQueryKeys('handovers', {
      all: null,
      recent: (communityId: string) => [{ communityId }],
      unacknowledged: (communityId: string) => [{ communityId }],
    });

    export const providers = createQueryKeys('providers', {
      all: null,
      list: (communityId: string) => [{ communityId }],
      detail: (id: string) => [id],
      documents: (providerId: string) => [{ providerId }],
      personnel: (providerId: string) => [{ providerId }],
      schedules: (providerId: string) => [{ providerId }],
      expiringDocs: (communityId: string) => [{ communityId }],
    });

    export const workOrders = createQueryKeys('work-orders', {
      all: null,
      list: (communityId: string) => [{ communityId }],
      detail: (id: string) => [id],
      byProvider: (providerId: string) => [{ providerId }],
    });

    export const parking = createQueryKeys('parking', {
      all: null,
      spots: (communityId: string) => [{ communityId }],
      assignments: (communityId: string) => [{ communityId }],
      reservations: (communityId: string) => [{ communityId }],
      violations: (communityId: string) => [{ communityId }],
    });

    export const moves = createQueryKeys('moves', {
      all: null,
      list: (communityId: string) => [{ communityId }],
      detail: (id: string) => [id],
      validations: (moveId: string) => [{ moveId }],
      deposits: (communityId: string) => [{ communityId }],
    });

    export const moderation = createQueryKeys('moderation', {
      all: null,
      queue: (communityId: string) => [{ communityId }],
      stats: (communityId: string) => [{ communityId }],
    });
    ```

    Add ALL nine new factories to the `mergeQueryKeys(...)` call at the bottom, preserving existing entries.

    2. Update `packages/mobile/app/(guard)/_layout.tsx`:
    - Wrap the Tabs component in a `<View style={{ flex: 1 }}>` container
    - Add two new visible tab screens BEFORE the hidden gate tab:
      - `patrol` tab: label "Ronda", icon character (use a simple text emoji or unicode)
      - `incidents` tab: label "Incidentes", icon character
    - After the `</Tabs>` closing tag but inside the wrapper View, add a placeholder comment `{/* <PanicButton /> will be added by plan 14-04 */}`
    - Import `View` from react-native (already has Text imported)

    3. Update `packages/admin/src/app/(dashboard)/layout.tsx`:
    - Read the existing file first to understand the current navItems structure
    - Add four new navigation sections to the sidebar navItems array:
      - Providers section: href '/providers', label 'Proveedores', with child 'Ordenes de Trabajo' ('/providers/work-orders')
      - Parking section: href '/parking', label 'Estacionamiento', with child 'Infracciones' ('/parking/violations')
      - Moves section: href '/moves', label 'Mudanzas' (no children)
      - Marketplace section: href '/marketplace', label 'Marketplace', with child 'Categorias' ('/marketplace/categories')
    - Use the same NavItem pattern and SVG icon style as existing items. Use inline SVG icons matching the existing style (Heroicons outline). Appropriate icons: truck for providers, car/rectangle for parking, archive-box for moves, shopping-bag for marketplace.
  </action>
  <verify>
    - `npx tsc --noEmit --project packages/shared/tsconfig.json` passes (query keys compile)
    - keys.ts contains all 9 new createQueryKeys calls and mergeQueryKeys includes them
    - Guard _layout.tsx has 5 tab screens (Caseta, Directorio, Paquetes, Ronda, Incidentes) + hidden gate + PanicButton comment
    - Admin layout.tsx has Proveedores, Estacionamiento, Mudanzas, Marketplace in sidebar navItems
  </verify>
  <done>
    - 9 new query key factories (patrols, incidents, emergencies, handovers, providers, workOrders, parking, moves, moderation) added and registered in mergeQueryKeys
    - Guard layout shows 5 tabs with patrol and incidents visible, gate hidden, PanicButton placeholder present
    - Admin sidebar has 4 new navigation sections with children where applicable
  </done>
</task>

</tasks>

<verification>
1. Both migration SQL files exist and contain valid CREATE TABLE statements with RLS
2. `pnpm ls react-native-nfc-manager expo-location expo-haptics --filter @upoe/mobile` shows packages installed
3. app.json plugins array includes react-native-nfc-manager and expo-location
4. `npx tsc --noEmit --project packages/shared/tsconfig.json` passes
5. Guard layout has patrol and incidents tabs visible
6. Admin layout has 4 new sidebar sections
</verification>

<success_criteria>
All Phase 14 foundations are in place: migration files ready for deployment, native dependencies installed, query key factories registered, guard tab navigation extended, admin sidebar extended. No downstream plan is blocked.
</success_criteria>

<output>
After completion, create `.planning/phases/14-guard-advanced-admin-providers/14-01-SUMMARY.md`
</output>
