---
phase: 14-guard-advanced-admin-providers
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - packages/mobile/src/hooks/usePatrol.ts
  - packages/mobile/src/components/guard/PatrolProgress.tsx
  - packages/mobile/src/components/guard/CheckpointCard.tsx
  - packages/mobile/app/(guard)/patrol/_layout.tsx
  - packages/mobile/app/(guard)/patrol/index.tsx
  - packages/mobile/app/(guard)/patrol/[id].tsx
  - packages/mobile/app/(guard)/patrol/scan.tsx
autonomous: true

must_haves:
  truths:
    - "Guard can view list of active patrol routes for their community"
    - "Guard can start a patrol session and see checkpoint progress (X of Y scanned)"
    - "Guard can scan an NFC checkpoint tag and see confirmation with GPS validation status"
    - "Guard can view patrol route detail showing which checkpoints are scanned vs remaining"
  artifacts:
    - path: "packages/mobile/src/hooks/usePatrol.ts"
      provides: "Patrol data hooks: usePatrolRoutes, usePatrolDetail, useStartPatrol, useScanCheckpoint, useAbandonPatrol"
      contains: "useStartPatrol"
    - path: "packages/mobile/app/(guard)/patrol/index.tsx"
      provides: "Patrol routes list screen"
      contains: "patrol_routes"
    - path: "packages/mobile/app/(guard)/patrol/[id].tsx"
      provides: "Active patrol detail with checkpoint progress"
      contains: "checkpoints_visited"
    - path: "packages/mobile/app/(guard)/patrol/scan.tsx"
      provides: "NFC scan screen with GPS capture"
      contains: "NfcManager"
  key_links:
    - from: "packages/mobile/src/hooks/usePatrol.ts"
      to: "patrol_logs"
      via: "Supabase insert for starting patrol"
      pattern: "from\\('patrol_logs'\\)"
    - from: "packages/mobile/app/(guard)/patrol/scan.tsx"
      to: "packages/mobile/src/hooks/usePatrol.ts"
      via: "useScanCheckpoint mutation"
      pattern: "useScanCheckpoint"
    - from: "packages/mobile/app/(guard)/patrol/scan.tsx"
      to: "react-native-nfc-manager"
      via: "NFC tag read for checkpoint serial"
      pattern: "NfcManager.*requestTechnology"
---

<objective>
Build the guard patrol feature: route listing, patrol session management, NFC checkpoint scanning with GPS validation, and patrol progress tracking.

Purpose: Guards need to conduct patrol rounds, scanning NFC tags at physical checkpoints. The database already has the full patrol schema (patrol_routes, patrol_checkpoints, patrol_logs, patrol_checkpoint_logs) with auto-progress triggers. This plan wires the mobile UI to that backend.
Output: Patrol hooks, progress components, and 3 patrol screens (route list, active patrol detail, NFC scan).
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-guard-advanced-admin-providers/14-RESEARCH.md
@.planning/phases/14-guard-advanced-admin-providers/14-01-SUMMARY.md
@packages/shared/src/queries/keys.ts
@packages/mobile/src/hooks/useGateOps.ts
@packages/mobile/app/(guard)/_layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Patrol data hooks and progress components</name>
  <files>
    packages/mobile/src/hooks/usePatrol.ts
    packages/mobile/src/components/guard/PatrolProgress.tsx
    packages/mobile/src/components/guard/CheckpointCard.tsx
  </files>
  <action>
    Create `packages/mobile/src/hooks/usePatrol.ts` with the following hooks. Follow the exact patterns from useGateOps.ts (lazy Supabase client in queryFn, 'as never' casts for inserts, queryKeys from @upoe/shared):

    1. **usePatrolRoutes(communityId)**: Query fetching active patrol_routes for the community. Select: id, name, description, checkpoint_sequence (UUID[]), estimated_duration_minutes, is_active. Filter: is_active=true, community_id match. Use queryKeys.patrols.routes(communityId).

    2. **usePatrolCheckpoints(communityId)**: Query fetching all patrol_checkpoints for the community. Select: id, name, nfc_serial, gps_latitude, gps_longitude, gps_tolerance_meters, description, location_description. Use queryKeys.patrols.checkpoints(communityId).

    3. **useActivePatrolLog(guardId)**: Query fetching the guard's active patrol_logs entry (status='in_progress'). Select: *, join patrol_checkpoint_logs. Use queryKeys.patrols.activeLogs(guardId).

    4. **usePatrolLogDetail(logId)**: Query fetching a specific patrol_log with its checkpoint_logs. Select: id, route_id, guard_id, status, started_at, completed_at, checkpoints_total, checkpoints_visited, observations. Also fetch related patrol_checkpoint_logs ordered by scanned_at ASC. Use queryKeys.patrols.logDetail(logId).

    5. **useStartPatrol()**: Mutation that:
       - Takes { routeId, guardId, communityId } as input
       - Fetches the route to get checkpoint_sequence length
       - Inserts into patrol_logs with community_id, route_id, guard_id, checkpoints_total, status='in_progress' (cast as never)
       - Invalidates patrols query keys on success
       - Returns the created patrol_log

    6. **useScanCheckpoint()**: Mutation that:
       - Takes { patrolLogId, checkpointId, nfcSerialScanned, gpsLat, gpsLng, gpsAccuracyMeters, sequenceOrder } as input
       - Inserts into patrol_checkpoint_logs with all fields (cast as never)
       - The database trigger `update_patrol_progress` auto-increments checkpoints_visited and auto-completes when all done
       - Invalidates patrols query keys on success

    7. **useAbandonPatrol()**: Mutation that updates patrol_logs set status='abandoned' where id=patrolLogId, invalidates patrols keys.

    Create `packages/mobile/src/components/guard/PatrolProgress.tsx`:
    - Takes props: { checkpointsVisited: number, checkpointsTotal: number, status: string }
    - Shows a horizontal progress bar (NativeWind: bg-gray-200 rounded-full, inner bg-blue-600 rounded-full, width based on percentage)
    - Text below: "{visited}/{total} puntos de control" and percentage
    - If status is 'completed', bar is green (bg-green-600) with "Ronda completada" label
    - If status is 'abandoned', bar is red (bg-red-600) with "Ronda abandonada" label

    Create `packages/mobile/src/components/guard/CheckpointCard.tsx`:
    - Takes props: { name: string, description?: string, scanned: boolean, scannedAt?: string, gpsWithinTolerance?: boolean | null }
    - React.memo wrapped
    - Shows checkpoint name, description, status indicator (green check if scanned, gray circle if pending)
    - If scanned: shows scanned time (date-fns formatDistanceToNow with locale es), GPS badge (green "GPS OK" if gpsWithinTolerance=true, yellow "Sin GPS" if null, red "Fuera de rango" if false)
  </action>
  <verify>
    - `npx tsc --noEmit` passes for all three files
    - usePatrol.ts exports all 7 hooks
    - PatrolProgress renders progress bar with percentage
    - CheckpointCard renders scanned/pending states with GPS indicator
  </verify>
  <done>
    - 7 patrol hooks covering route listing, checkpoint listing, active log tracking, patrol start/scan/abandon mutations
    - PatrolProgress component shows visual progress bar with status-colored fills
    - CheckpointCard component shows checkpoint status with GPS validation badge
  </done>
</task>

<task type="auto">
  <name>Task 2: Patrol route list, active patrol detail, and NFC scan screens</name>
  <files>
    packages/mobile/app/(guard)/patrol/_layout.tsx
    packages/mobile/app/(guard)/patrol/index.tsx
    packages/mobile/app/(guard)/patrol/[id].tsx
    packages/mobile/app/(guard)/patrol/scan.tsx
  </files>
  <action>
    Create `packages/mobile/app/(guard)/patrol/_layout.tsx`:
    - Stack layout with headerShown: false (tabs already provide header context)
    - Screens: index (title "Rondas"), [id] (title "Ronda Activa"), scan (title "Escanear Punto", presentation "modal")

    Create `packages/mobile/app/(guard)/patrol/index.tsx` (GPATR-01):
    - Use usePatrolRoutes to fetch active routes
    - Show FlatList of routes as pressable cards: route name, description, estimated duration, checkpoint count (checkpoint_sequence.length)
    - Check for active patrol via useActivePatrolLog -- if guard has in-progress patrol, show prominent banner at top linking to the active patrol detail
    - "Iniciar Ronda" button on each route card. On press: call useStartPatrol, then router.push to /patrol/[id] with the new log ID
    - Empty state: "No hay rutas de ronda configuradas"
    - Loading and error states

    Create `packages/mobile/app/(guard)/patrol/[id].tsx` (GPATR-01 + GPATR-03):
    - Receive patrol log ID via route params
    - Use usePatrolLogDetail to fetch the patrol log and its checkpoint_logs
    - Use usePatrolCheckpoints to get all checkpoint details
    - Show PatrolProgress component at top
    - Show FlatList of checkpoints in route sequence order (match checkpoint_sequence UUIDs from patrol_routes with patrol_checkpoints data)
    - For each checkpoint, render CheckpointCard with scanned=true if a matching patrol_checkpoint_log exists
    - "Escanear Siguiente" button at bottom that navigates to scan screen, passing the next unscanned checkpoint's expected ID and the patrolLogId
    - If all checkpoints scanned (status='completed'), show completion banner with total time
    - "Abandonar Ronda" button (red, bottom) calls useAbandonPatrol and navigates back
    - Pull-to-refresh to refetch patrol status

    Create `packages/mobile/app/(guard)/patrol/scan.tsx` (GPATR-02):
    - Receive patrolLogId, expectedCheckpointId, sequenceOrder via route params
    - On mount: request location permission via expo-location (requestForegroundPermissionsAsync). If denied, show warning but allow scan without GPS.
    - Show instruction text: "Acerca el telefono al punto de control NFC"
    - On "Escanear" button press:
      1. Start NFC read: `NfcManager.requestTechnology(NfcTech.Ndef)` then `NfcManager.getTag()` to get tag.id (NFC serial)
      2. Normalize the NFC serial (strip colons, uppercase) for comparison
      3. Get current GPS: `Location.getCurrentPositionAsync({ accuracy: Location.Accuracy.High })`
      4. Look up the checkpoint by matching the normalized NFC serial against patrol_checkpoints.nfc_serial (query from usePatrolCheckpoints, normalize both sides)
      5. If no checkpoint matches the NFC serial: show error "Punto de control no reconocido"
      6. If checkpoint matches: call useScanCheckpoint with { patrolLogId, checkpointId: matched.id, nfcSerialScanned: rawSerial, gpsLat, gpsLng, gpsAccuracyMeters, sequenceOrder }
      7. Show success feedback (green checkmark, checkpoint name, GPS status)
      8. Call `NfcManager.cancelTechnologyRequest()` in cleanup/finally
      9. After 1.5 second delay, router.back() to return to patrol detail
    - Cancel button to go back without scanning
    - Error handling: NFC not available, NFC read timeout, location error
    - Cleanup NFC on unmount via useEffect return
  </action>
  <verify>
    - `npx tsc --noEmit` passes for all patrol screen files
    - patrol/_layout.tsx defines Stack with 3 screens
    - patrol/index.tsx shows route list with start button and active patrol banner
    - patrol/[id].tsx shows checkpoint list with PatrolProgress and scan/abandon buttons
    - patrol/scan.tsx imports NfcManager and Location, handles NFC read + GPS capture
  </verify>
  <done>
    - Patrol route list screen shows active routes with "Iniciar Ronda" and active patrol banner
    - Active patrol detail shows checkpoint-by-checkpoint progress with PatrolProgress bar
    - NFC scan screen reads tag serial, captures GPS, submits checkpoint log, shows success/error feedback
    - GPATR-01 (view active patrol route), GPATR-02 (scan NFC checkpoints), GPATR-03 (patrol progress) all covered
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for all new files
2. usePatrol.ts exports 7 hooks (routes, checkpoints, activeLog, logDetail, start, scan, abandon)
3. Patrol route list renders with start button
4. Active patrol detail shows checkpoint progress via PatrolProgress component
5. NFC scan screen imports and uses NfcManager + expo-location
6. CheckpointCard shows GPS validation badge
</verification>

<success_criteria>
Guard can view patrol routes, start a patrol, see checkpoint progress, scan NFC tags with GPS capture, and abandon a patrol. All three GPATR requirements (01, 02, 03) are satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/14-guard-advanced-admin-providers/14-02-SUMMARY.md`
</output>
