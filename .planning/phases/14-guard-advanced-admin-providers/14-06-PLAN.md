---
phase: 14-guard-advanced-admin-providers
plan: 06
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - packages/admin/src/hooks/useParking.ts
  - packages/admin/src/hooks/useMoves.ts
  - packages/admin/src/hooks/useModeration.ts
  - packages/admin/src/app/(dashboard)/parking/page.tsx
  - packages/admin/src/app/(dashboard)/parking/violations/page.tsx
  - packages/admin/src/app/(dashboard)/moves/page.tsx
  - packages/admin/src/app/(dashboard)/moves/[id]/page.tsx
  - packages/admin/src/app/(dashboard)/marketplace/page.tsx
  - packages/admin/src/app/(dashboard)/marketplace/categories/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view parking spot inventory with type and status filters"
    - "Admin can assign and unassign parking spots to units"
    - "Admin can view visitor parking reservations and parking violations"
    - "Admin can create and manage move requests with type, date, and moving company"
    - "Admin can track move validation checklist and manage damage deposits"
    - "Admin can view marketplace moderation queue and approve/reject listings"
    - "Admin can manage marketplace category visibility per community"
  artifacts:
    - path: "packages/admin/src/hooks/useParking.ts"
      provides: "Parking hooks: spot list, assign/unassign, reservations, violations"
      contains: "useParkingSpots"
    - path: "packages/admin/src/hooks/useMoves.ts"
      provides: "Move hooks: list, detail, create, validations, deposits with refund RPCs"
      contains: "useMoveList"
    - path: "packages/admin/src/hooks/useModeration.ts"
      provides: "Moderation hooks: queue, claim, resolve RPCs"
      contains: "useClaimModerationItem"
    - path: "packages/admin/src/app/(dashboard)/parking/page.tsx"
      provides: "Parking inventory page with assignment"
      contains: "parking_spots"
    - path: "packages/admin/src/app/(dashboard)/moves/[id]/page.tsx"
      provides: "Move detail with validation checklist and deposit management"
      contains: "move_validations"
    - path: "packages/admin/src/app/(dashboard)/marketplace/page.tsx"
      provides: "Moderation queue page with claim/resolve workflow"
      contains: "claim_moderation_item"
  key_links:
    - from: "packages/admin/src/hooks/useParking.ts"
      to: "parking_spots"
      via: "Supabase CRUD on parking tables"
      pattern: "from\\('parking_spots'\\)"
    - from: "packages/admin/src/hooks/useMoves.ts"
      to: "process_deposit_refund"
      via: "RPC calls for deposit lifecycle"
      pattern: "rpc\\('process_deposit_refund'"
    - from: "packages/admin/src/hooks/useModeration.ts"
      to: "claim_moderation_item"
      via: "RPC for claiming moderation queue items"
      pattern: "rpc\\('claim_moderation_item'"
---

<objective>
Build admin parking management (inventory, assignments, reservations, violations), move management (requests, validation checklists, deposits), and marketplace moderation (queue, claim/resolve, category settings).

Purpose: Administrators need to manage physical parking infrastructure, coordinate move-in/move-out processes with validation checklists and deposits, and moderate marketplace content. The database has complete schemas for all three domains with RPCs for deposits and moderation.
Output: Parking hooks + 2 pages, move hooks + 2 pages, moderation hooks + 2 pages.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-guard-advanced-admin-providers/14-RESEARCH.md
@.planning/phases/14-guard-advanced-admin-providers/14-01-SUMMARY.md
@packages/admin/src/app/(dashboard)/layout.tsx
@packages/admin/src/hooks/useAmenities.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Parking, move, and moderation data hooks</name>
  <files>
    packages/admin/src/hooks/useParking.ts
    packages/admin/src/hooks/useMoves.ts
    packages/admin/src/hooks/useModeration.ts
  </files>
  <action>
    Create `packages/admin/src/hooks/useParking.ts` following established admin patterns:

    1. **useParkingSpots(communityId, typeFilter?, statusFilter?)**: Query fetching parking_spots with optional filters by parking_spot_type and parking_spot_status. Select: id, spot_number, spot_type, status, floor_level, zone, is_covered, is_handicap, monthly_rate. Join parking_assignments(unit_id, assignment_type, start_date, end_date) via parking_assignments!parking_spot_id with units(unit_number). Ordered by spot_number. Use queryKeys.parking.spots(communityId). Filter where deleted_at IS NULL (if soft-delete exists) or all.

    2. **useCreateParkingSpot()**: Mutation inserting into parking_spots with: community_id, spot_number, spot_type, floor_level, zone, is_covered, is_handicap, monthly_rate. Status defaults to 'available'. Cast as never. Invalidates parking keys.

    3. **useUpdateParkingSpot()**: Mutation updating parking_spots by id. Cast as never. Invalidates parking keys.

    4. **useAssignParkingSpot()**: Mutation inserting into parking_assignments with: parking_spot_id, unit_id, community_id, assignment_type (ownership/rental/temporary), start_date, end_date (optional for permanent). Cast as never. Also updates parking_spots status to 'occupied'. Invalidates parking keys.

    5. **useUnassignParkingSpot()**: Mutation that deletes the parking_assignment by id (or sets end_date to now) and updates parking_spots status back to 'available'. Invalidates parking keys.

    6. **useParkingReservations(communityId)**: Query fetching parking_reservations for the community. Select: id, spot_id, visitor_name, vehicle_plate, status, reserved_from, reserved_until, checked_in_at, checked_out_at. Join parking_spots(spot_number). Ordered by reserved_from DESC. Use queryKeys.parking.reservations(communityId).

    7. **useParkingViolations(communityId)**: Query fetching parking_violations for the community. Select: id, violation_type, description, spot_id, vehicle_plate, reported_by, status, fine_amount, reported_at. Join parking_spots(spot_number). Ordered by reported_at DESC. Use queryKeys.parking.violations(communityId).

    8. **useUpdateParkingViolation()**: Mutation updating parking_violations by id (status change to warned/fined/resolved/dismissed, fine_amount update). Cast as never. Invalidates parking.violations.

    Create `packages/admin/src/hooks/useMoves.ts`:

    1. **useMoveList(communityId, statusFilter?)**: Query fetching move_requests for the community with optional status filter. Select: id, move_type, status, scheduled_date, unit_id, resident_id, moving_company, notes, all_validations_passed, created_at. Join units(unit_number), residents(first_name, last_name). Ordered by created_at DESC. Use queryKeys.moves.list(communityId).

    2. **useMoveDetail(id)**: Query fetching single move_request with all fields, joined to units + residents. Enabled when id truthy. Use queryKeys.moves.detail(id).

    3. **useCreateMove()**: Mutation inserting into move_requests with: community_id, unit_id, resident_id, move_type (move_in/move_out), scheduled_date, moving_company, contact_phone, notes, status='requested'. Cast as never. Invalidates moves keys.

    4. **useUpdateMoveStatus()**: Mutation updating move_requests status by id. Validates transitions: requested->validating->approved/validation_failed, approved->scheduled->in_progress->completed, any->cancelled. Cast as never.

    5. **useMoveValidations(moveId)**: Query fetching move_validations for a move request. Select: id, validation_type, description, status, validated_by, validated_at, notes, is_required. Ordered by is_required DESC, validation_type. Use queryKeys.moves.validations(moveId).

    6. **useUpdateValidation()**: Mutation updating move_validations by id (status to passed/failed/waived, validated_by, notes). Cast as never. Invalidates moves.validations. The DB trigger auto-updates all_validations_passed on the parent move_request.

    7. **useMoveDeposits(communityId)**: Query fetching move_deposits for the community. Select: id, move_request_id, amount, currency, status, collection_date, refund_amount, deduction_amount, deduction_reason. Ordered by created_at DESC. Use queryKeys.moves.deposits(communityId).

    8. **useCreateDeposit()**: Mutation inserting into move_deposits with: move_request_id, community_id, amount, currency='MXN', status='collected', collection_date. Cast as never. Invalidates moves.deposits.

    9. **useProcessDepositRefund()**: Mutation calling RPC `process_deposit_refund` with p_deposit_id, p_deduction_amount, p_deduction_reason. Invalidates moves.deposits.

    10. **useApproveDepositRefund()**: Mutation calling RPC `approve_deposit_refund` with p_deposit_id. Invalidates moves.deposits.

    11. **useCompleteDepositRefund()**: Mutation calling RPC `complete_deposit_refund` with p_deposit_id, p_method, p_reference. Invalidates moves.deposits.

    12. **useForfeitDeposit()**: Mutation calling RPC `forfeit_deposit` with p_deposit_id, p_reason. Invalidates moves.deposits.

    Create `packages/admin/src/hooks/useModeration.ts`:

    1. **useModerationQueue(communityId)**: Query fetching from moderation_queue where resolved_at IS NULL, ordered by priority DESC then queued_at ASC. Select: id, item_type, item_id, priority, status, queued_at, assigned_to, assigned_at. Use queryKeys.moderation.queue(communityId).

    2. **useModerationItemDetail(itemId, itemType)**: Query that fetches the source content based on item_type. If 'listing': fetch from marketplace_listings by item_id. If 'post': fetch from posts by item_id. If 'comment': fetch from post_comments by item_id. Enabled when itemId truthy.

    3. **useClaimModerationItem()**: Mutation calling RPC `claim_moderation_item` with p_community_id. Invalidates moderation keys. Returns the claimed item.

    4. **useResolveModeration()**: Mutation calling RPC `resolve_moderation` with p_queue_id, p_resolution ('approved'/'rejected'), p_notes. Invalidates moderation keys AND marketplace keys (since listing status may change).

    5. **useModerationStats(communityId)**: Query fetching counts: total pending (resolved_at IS NULL), in-review (status='in_review'), resolved today. Use queryKeys.moderation.stats(communityId).
  </action>
  <verify>
    - `npx tsc --noEmit` passes for all 3 hook files
    - useParking.ts exports 8 hooks
    - useMoves.ts exports 12 hooks
    - useModeration.ts exports 5 hooks
    - All RPC calls match function signatures from 14-RESEARCH.md
  </verify>
  <done>
    - 8 parking hooks covering spots CRUD, assignment/unassignment, reservations, violations
    - 12 move hooks covering requests, validations, deposits with full refund lifecycle RPCs
    - 5 moderation hooks covering queue, item detail, claim/resolve RPCs, stats
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin parking, moves, and marketplace moderation pages</name>
  <files>
    packages/admin/src/app/(dashboard)/parking/page.tsx
    packages/admin/src/app/(dashboard)/parking/violations/page.tsx
    packages/admin/src/app/(dashboard)/moves/page.tsx
    packages/admin/src/app/(dashboard)/moves/[id]/page.tsx
    packages/admin/src/app/(dashboard)/marketplace/page.tsx
    packages/admin/src/app/(dashboard)/marketplace/categories/page.tsx
  </files>
  <action>
    All pages use 'use client' directive, force-dynamic export, follow admin dashboard patterns.

    Create `packages/admin/src/app/(dashboard)/parking/page.tsx` (APARK-01, APARK-02, APARK-03):
    - Page title: "Estacionamiento"
    - Two filters: spot_type dropdown (all + enum values), status dropdown (all + enum values)
    - DataTable of parking spots: spot_number, type badge (color-coded by type), status badge, zone, floor, covered/handicap icons, assigned unit (from join), monthly_rate
    - Create spot form (expandable): spot_number, type (dropdown), zone, floor_level, is_covered checkbox, is_handicap checkbox, monthly_rate
    - Assignment actions per row:
      - If unassigned (available): "Asignar" button opens inline form with unit dropdown + assignment_type dropdown + dates. Calls useAssignParkingSpot.
      - If assigned: shows assigned unit + "Desasignar" button (with confirmation). Calls useUnassignParkingSpot.
    - Visitor reservations section below the main table: small summary table of today's/upcoming parking_reservations (spot, visitor, vehicle, dates, status)

    Create `packages/admin/src/app/(dashboard)/parking/violations/page.tsx` (APARK-04):
    - Page title: "Infracciones de Estacionamiento"
    - Status filter (all + enum values)
    - DataTable: violation_type, description, spot (number), vehicle_plate, status badge, fine_amount, reported_at
    - Row actions: status change dropdown (warned, fined, resolved, dismissed) calls useUpdateParkingViolation
    - Fine amount edit (inline number input when status is fined)

    Create `packages/admin/src/app/(dashboard)/moves/page.tsx` (AMOVE-01):
    - Page title: "Mudanzas"
    - Status filter dropdown (all + enum values), move_type filter (all/move_in/move_out)
    - DataTable: move_type badge (Entrada/Salida), unit, resident, status badge, scheduled_date, moving_company, all_validations_passed (green check/red X), created_at
    - Create move form (expandable):
      - move_type (move_in/move_out radio)
      - unit dropdown (from useUnitList -- reuse from Phase 11)
      - resident dropdown (from useResidentList -- reuse from Phase 11)
      - scheduled_date (date picker)
      - moving_company (text)
      - contact_phone (text)
      - notes (textarea)
    - Row click navigates to /moves/[id]

    Create `packages/admin/src/app/(dashboard)/moves/[id]/page.tsx` (AMOVE-02, AMOVE-03, AMOVE-04):
    - Two-column layout:

    **Left column: Move details + validation checklist (AMOVE-02)**
    - Move info card: type, unit, resident, scheduled_date, moving_company, status, notes
    - Status workflow buttons at top: transition buttons based on current status (same pattern as work order detail)
    - Validation checklist (from useMoveValidations):
      - Each validation as a card/row: validation_type label, description, status badge (pending=gray, passed=green, failed=red, waived=yellow)
      - Action buttons per validation: "Aprobar" (set passed), "Rechazar" (set failed), "Eximir" (set waived) -- each opens a small confirmation with optional notes
      - Auto-refresh: when all required validations pass, the DB trigger sets all_validations_passed=true on the move
      - If all_validations_passed: show green "Todas las validaciones aprobadas" banner
    - Sign-off section (AMOVE-04): when status is 'in_progress', show "Completar Mudanza" button that sets status='completed'

    **Right column: Deposit management (AMOVE-03)**
    - Deposit card (from useMoveDeposits filtered by this move):
      - If no deposit: "Registrar Deposito" form with amount, collection_date
      - If deposit exists: show amount, status badge, deduction/refund info
      - Deposit lifecycle buttons based on status:
        - collected: "Inspeccionar" (transition to inspection_pending happens implicitly)
        - inspection_pending/deductions_pending: "Procesar Deducciones" form (deduction_amount, reason) calls useProcessDepositRefund. OR "Sin Deducciones" calls process with 0 deduction.
        - refund_pending: "Aprobar Reembolso" calls useApproveDepositRefund
        - After approval: "Completar Reembolso" form (method, reference) calls useCompleteDepositRefund
        - Any non-refunded: "Retener Deposito" button (reason required) calls useForfeitDeposit
      - Show refund amount calculation: original - deductions

    Create `packages/admin/src/app/(dashboard)/marketplace/page.tsx` (AMRKT-01, AMRKT-02):
    - Page title: "Moderacion Marketplace"
    - Stats bar at top (from useModerationStats): pending count, in-review count, resolved today count
    - Two sections:
      1. "Cola de Moderacion" -- moderation queue items (unresolved)
         - Each item as a card showing: item_type badge (listing/post/comment), priority, queued_at, status
         - "Reclamar Siguiente" button calls useClaimModerationItem. On success, show the claimed item's content (fetch via useModerationItemDetail)
         - For claimed items (assigned to current admin): show content preview (listing title, description, photos if available), then "Aprobar" and "Rechazar" buttons with optional notes textarea. Calls useResolveModeration.
      2. "Resueltas Recientes" -- last 20 resolved items as a simple list

    Create `packages/admin/src/app/(dashboard)/marketplace/categories/page.tsx` (AMRKT-03):
    - Page title: "Categorias Marketplace"
    - Since listing_category is a PostgreSQL enum (sale, service, rental, wanted), NOT a table, this page displays the fixed categories with community-level enable/disable toggles.
    - Show 4 category cards: Venta, Servicio, Renta, Buscado
    - Each card has a toggle switch. Toggling saves to community_settings JSONB (field: marketplace_disabled_categories array). Use the existing community settings hooks from Phase 11.
    - NOTE: If community_settings does not have a marketplace_disabled_categories field, initialize it as an empty array. A category is enabled if NOT in the disabled array.
    - This is a simple settings page, not full CRUD.
  </action>
  <verify>
    - `npx tsc --noEmit` passes for all 6 page files
    - parking/page.tsx has spot table with assignment actions and reservations section
    - parking/violations/page.tsx has violation table with status actions
    - moves/page.tsx has move list with create form and type/status filters
    - moves/[id]/page.tsx has validation checklist and deposit management
    - marketplace/page.tsx has moderation queue with claim/resolve workflow
    - marketplace/categories/page.tsx has 4 category toggle cards
  </verify>
  <done>
    - Parking inventory page with CRUD, assignment/unassignment, visitor reservations, type/status filters
    - Parking violations page with status management and fine tracking
    - Move list page with creation form and filters
    - Move detail page with validation checklist, status workflow, and deposit lifecycle management
    - Marketplace moderation queue with claim-then-resolve workflow using database RPCs
    - Marketplace categories page with community-level enable/disable toggles
    - APARK-01 through APARK-04, AMOVE-01 through AMOVE-04, AMRKT-01 through AMRKT-03 all covered
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for all new files
2. Parking page shows spots with assignment workflow
3. Violations page shows filterable table with status actions
4. Move pages support full workflow from creation to completion with validation checklist
5. Deposit management covers full lifecycle (collect, inspect, deductions, refund/forfeit)
6. Moderation queue uses claim_moderation_item and resolve_moderation RPCs
7. Categories page shows 4 toggleable category cards
</verification>

<success_criteria>
Admin can manage parking inventory and assignments, handle move requests with validation checklists and deposits, and moderate marketplace content. All APARK (01-04), AMOVE (01-04), and AMRKT (01-03) requirements satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/14-guard-advanced-admin-providers/14-06-SUMMARY.md`
</output>
