---
phase: 04-financial-engine
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - supabase/migrations/TIMESTAMP_interest_enums.sql
  - supabase/migrations/TIMESTAMP_interest_rules.sql
  - supabase/migrations/TIMESTAMP_delinquency_triggers.sql
  - supabase/migrations/TIMESTAMP_budgets.sql
autonomous: true

must_haves:
  truths:
    - "Interest rules are configurable per community (no hardcoded rates)"
    - "Interest calculation supports simple, compound_monthly, compound_daily, flat_fee methods"
    - "calculate_interest() function computes interest based on principal and days overdue"
    - "Delinquency triggers map days overdue to automated actions"
    - "Delinquency actions log all enforcement activities for audit"
    - "Budgets track planned vs actual by account and period"
  artifacts:
    - path: "supabase/migrations/*_interest_enums.sql"
      provides: "interest_calculation_method enum"
      contains: "CREATE TYPE interest_calculation_method"
    - path: "supabase/migrations/*_interest_rules.sql"
      provides: "interest_rules table and calculate_interest function"
      contains: "CREATE FUNCTION calculate_interest"
    - path: "supabase/migrations/*_delinquency_triggers.sql"
      provides: "delinquency_triggers and delinquency_actions tables"
      contains: "CREATE TYPE delinquency_action_type"
    - path: "supabase/migrations/*_budgets.sql"
      provides: "budgets and budget_lines tables"
      contains: "CREATE TABLE budgets"
  key_links:
    - from: "interest_rules"
      to: "communities"
      via: "community_id FK - each community has own rates"
    - from: "delinquency_triggers"
      to: "communities"
      via: "community_id FK - each community configures escalation"
    - from: "delinquency_actions"
      to: "transactions"
      via: "related_transaction_id FK when action creates fee"
    - from: "budget_lines"
      to: "accounts"
      via: "account_id FK for GL integration"
---

<objective>
Create interest rules, delinquency management, and budget tracking for UPOE financial engine.

Purpose: Enable communities to configure their own moratorium (late payment interest) rates per Mexican law, automate delinquency escalation (reminders, fees, restrictions), and track budgets against actual spending.

Output:
- interest_calculation_method enum
- interest_rules table with configurable rates per community
- calculate_interest() function for overdue amounts
- delinquency_action_type enum
- delinquency_triggers table mapping days overdue to actions
- delinquency_actions log table for audit trail
- budgets and budget_lines tables for financial planning
</objective>

<execution_context>
@C:\Users\PC\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\PC\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-financial-engine/04-RESEARCH.md
@.planning/phases/04-financial-engine/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create interest rules and calculate_interest function</name>
  <files>
    supabase/migrations/TIMESTAMP_interest_enums.sql
    supabase/migrations/TIMESTAMP_interest_rules.sql
  </files>
  <action>
Create interest_calculation_method enum with 4 values:
- simple (principal * rate * time)
- compound_monthly
- compound_daily
- flat_fee (fixed fee per period)

Create interest_rules table:
- id UUID PK (generate_uuid_v7)
- community_id UUID FK to communities(id) ON DELETE RESTRICT
- name TEXT NOT NULL (e.g., "Moratorio 2% Mensual")
- description TEXT
- grace_period_days INTEGER DEFAULT 0 (days after due before interest starts)
- applies_after_days INTEGER DEFAULT 1 (days overdue to trigger this rule)
- calculation_method interest_calculation_method DEFAULT 'simple'
- rate_percentage NUMERIC(5,2) NOT NULL (e.g., 2.00 for 2%)
- rate_period TEXT DEFAULT 'monthly' CHECK (rate_period IN ('daily', 'monthly', 'annual'))
- max_rate_percentage NUMERIC(5,2) (cap on cumulative percentage)
- max_amount money_amount (cap on interest amount)
- flat_fee_amount money_amount (for flat_fee method)
- priority INTEGER DEFAULT 1 (lower = applied first)
- is_active BOOLEAN DEFAULT TRUE
- effective_from DATE DEFAULT CURRENT_DATE
- effective_until DATE
- approved_at TIMESTAMPTZ (assembly must approve rates)
- approved_by UUID FK to auth.users(id)
- assembly_minute_reference TEXT (link to assembly minutes)
- Standard audit columns

Create calculate_interest() function:
- Parameters: p_community_id UUID, p_principal money_amount, p_days_overdue INTEGER, p_as_of_date DATE DEFAULT CURRENT_DATE
- RETURNS money_amount
- LANGUAGE plpgsql, STABLE
- Finds applicable interest_rule (active, within effective dates, applies_after_days <= days_overdue, ordered by priority)
- Calculates applicable_days = MAX(0, days_overdue - grace_period_days)
- Calculates interest based on method:
  - flat_fee: return flat_fee_amount
  - simple: principal * (rate/100) * (days / period_days)
  - compound_monthly: principal * (POWER(1 + rate/100, days/30) - 1)
  - compound_daily: principal * (POWER(1 + rate/100/365, days) - 1)
- Applies caps (max_rate_percentage, max_amount)
- Returns ROUND(interest, 4)

Add RLS policies:
- super_admin_all_interest_rules
- users_view_interest_rules
- admins_manage_interest_rules

Add comment: "Moratorium (late payment interest) rules configurable per community. Mexico has no federal limit on condominium moratorium rates. Rates must be approved by the General Assembly."
  </action>
  <verify>
Run migration. Test calculate_interest() with known inputs: 1000 MXN principal, 30 days overdue, 2% monthly simple interest should return ~20 MXN.
  </verify>
  <done>
interest_calculation_method enum exists, interest_rules table with assembly approval tracking, calculate_interest() function correctly computes interest with caps.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create delinquency triggers and actions tables</name>
  <files>
    supabase/migrations/TIMESTAMP_delinquency_enums.sql
    supabase/migrations/TIMESTAMP_delinquency_triggers.sql
  </files>
  <action>
Create delinquency_action_type enum with 9 values:
- reminder_email, reminder_sms
- late_fee, interest_charge
- service_restriction (e.g., no amenity access)
- payment_plan_offer
- legal_warning
- collection_referral
- service_suspension

Create delinquency_triggers table:
- id UUID PK (generate_uuid_v7)
- community_id UUID FK to communities(id)
- days_overdue INTEGER NOT NULL (trigger at this threshold)
- min_amount money_amount DEFAULT 0 (only trigger if balance >= this)
- action_type delinquency_action_type NOT NULL
- action_config JSONB DEFAULT '{}' (action-specific config)
- notification_template_id UUID (for email/SMS actions, FK to future templates table)
- fee_amount money_amount (for late_fee actions)
- fee_percentage NUMERIC(5,2) (for percentage-based fees)
- fee_description TEXT
- is_one_time BOOLEAN DEFAULT TRUE
- repeat_interval_days INTEGER (if not one-time)
- is_active BOOLEAN DEFAULT TRUE
- priority INTEGER DEFAULT 1
- Standard audit columns
- UNIQUE (community_id, days_overdue, action_type)

Create delinquency_actions table (audit log):
- id UUID PK (generate_uuid_v7)
- community_id UUID FK to communities(id)
- trigger_id UUID FK to delinquency_triggers(id)
- unit_id UUID FK to units(id) NOT NULL
- action_type delinquency_action_type NOT NULL
- action_description TEXT NOT NULL
- related_transaction_id UUID FK to transactions(id) (if fee was charged)
- related_notification_id UUID (if notification sent)
- balance_at_action money_amount NOT NULL
- days_overdue_at_action INTEGER NOT NULL
- status TEXT DEFAULT 'executed' CHECK (status IN ('executed', 'failed', 'skipped'))
- failure_reason TEXT
- executed_at TIMESTAMPTZ DEFAULT now()
- executed_by UUID FK to auth.users(id)

No deleted_at on delinquency_actions - this is an audit table.

Add RLS policies:
- super_admin_all (both tables)
- admins_view_triggers, admins_manage_triggers
- users_view_own_actions (residents see actions on their units)

Add indexes:
- delinquency_triggers: community_id + days_overdue + is_active
- delinquency_actions: unit_id + executed_at DESC
- delinquency_actions: community_id + executed_at DESC

Add comment documenting typical escalation: 1 day (reminder), 15 days (late fee), 30 days (interest), 60 days (restriction), 90 days (legal warning), 180 days (collection).
  </action>
  <verify>
Run migration. Query tables. Verify unique constraint on triggers. Verify delinquency_actions has no deleted_at column.
  </verify>
  <done>
delinquency_action_type enum exists, delinquency_triggers configures escalation rules, delinquency_actions logs all enforcement for audit.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create budgets and budget_lines tables</name>
  <files>
    supabase/migrations/TIMESTAMP_budgets.sql
  </files>
  <action>
Create budget_status enum with 4 values: draft, approved, active, closed

Create budgets table:
- id UUID PK (generate_uuid_v7)
- community_id UUID FK to communities(id)
- name TEXT NOT NULL (e.g., "Presupuesto 2026")
- description TEXT
- fiscal_year INTEGER NOT NULL
- period_start DATE NOT NULL
- period_end DATE NOT NULL
- status budget_status DEFAULT 'draft'
- total_income money_amount DEFAULT 0
- total_expense money_amount DEFAULT 0
- approved_at TIMESTAMPTZ
- approved_by UUID FK to auth.users(id)
- assembly_minute_reference TEXT
- Standard audit columns
- UNIQUE (community_id, fiscal_year)

Create budget_lines table:
- id UUID PK (generate_uuid_v7)
- community_id UUID FK to communities(id)
- budget_id UUID FK to budgets(id) ON DELETE CASCADE
- account_id UUID FK to accounts(id)
- line_description TEXT
- budgeted_amount money_amount NOT NULL
- actual_amount money_amount DEFAULT 0 (updated by trigger or batch)
- variance money_amount GENERATED ALWAYS AS (actual_amount - budgeted_amount) STORED
- notes TEXT
- Standard audit columns
- UNIQUE (budget_id, account_id)

Create update_budget_totals() trigger:
- AFTER INSERT OR UPDATE OR DELETE on budget_lines
- Updates budgets.total_income (sum of income account lines)
- Updates budgets.total_expense (sum of expense account lines)

Add RLS policies:
- super_admin_all_budgets, super_admin_all_budget_lines
- users_view_budgets (residents can see approved budgets)
- admins_manage_budgets, admins_manage_budget_lines

Add indexes:
- budgets: community_id + fiscal_year
- budget_lines: budget_id (for budget detail queries)
- budget_lines: account_id (for account budget lookup)
  </action>
  <verify>
Run migration. Create a budget, add budget_lines, verify totals auto-update. Verify variance column is computed.
  </verify>
  <done>
budget_status enum exists, budgets table tracks fiscal periods with approval, budget_lines links to accounts with auto-computed variance, totals trigger works.
  </done>
</task>

</tasks>

<verification>
1. Query: SELECT * FROM pg_type WHERE typname IN ('interest_calculation_method', 'delinquency_action_type', 'budget_status')
2. Query: SELECT table_name FROM information_schema.tables WHERE table_name IN ('interest_rules', 'delinquency_triggers', 'delinquency_actions', 'budgets', 'budget_lines')
3. Test: calculate_interest(community_id, 1000.00, 30) with 2% monthly simple rule - should return ~20
4. Test: Insert delinquency_action, verify no deleted_at column exists
5. Test: Insert budget_lines, verify budgets.total_income/expense auto-updates
</verification>

<success_criteria>
- interest_calculation_method enum with 4 calculation types
- interest_rules table with per-community configurable rates
- calculate_interest() function handles all calculation methods with caps
- delinquency_action_type enum with 9 action types
- delinquency_triggers maps days overdue to actions
- delinquency_actions logs enforcement (no soft delete - audit trail)
- budgets and budget_lines for financial planning with variance tracking
- All tables have RLS with community isolation
</success_criteria>

<output>
After completion, create `.planning/phases/04-financial-engine/04-03-SUMMARY.md`
</output>
