---
phase: 04-financial-engine
plan: 04
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
files_modified:
  - supabase/migrations/TIMESTAMP_bank_accounts.sql
  - supabase/migrations/TIMESTAMP_bank_statements.sql
  - supabase/migrations/TIMESTAMP_reconciliation.sql
  - supabase/migrations/TIMESTAMP_payment_proofs.sql
  - supabase/migrations/TIMESTAMP_unit_balances_view.sql
autonomous: true

must_haves:
  truths:
    - "Bank accounts store last 4 digits only, full number is hashed"
    - "Bank statements can be imported with line-level detail"
    - "Statement lines can be matched to transactions (auto or manual)"
    - "Payment proofs flow through pending -> approved/rejected workflow"
    - "Approved payment proofs auto-create payment transactions"
    - "Unit balances view provides real-time receivable status"
  artifacts:
    - path: "supabase/migrations/*_bank_accounts.sql"
      provides: "bank_accounts table with hashed account numbers"
      contains: "CREATE TABLE bank_accounts"
    - path: "supabase/migrations/*_bank_statements.sql"
      provides: "bank_statements and bank_statement_lines tables"
      contains: "CREATE TABLE bank_statement_lines"
    - path: "supabase/migrations/*_reconciliation.sql"
      provides: "reconciliation_rules and matching workflow"
      contains: "CREATE TYPE statement_line_status"
    - path: "supabase/migrations/*_payment_proofs.sql"
      provides: "payment_proofs table with approval trigger"
      contains: "CREATE FUNCTION on_payment_proof_approved"
    - path: "supabase/migrations/*_unit_balances_view.sql"
      provides: "unit_balances view aggregating financial position"
      contains: "CREATE VIEW unit_balances"
  key_links:
    - from: "bank_accounts"
      to: "accounts"
      via: "gl_account_id FK linking to chart of accounts"
    - from: "bank_statement_lines"
      to: "transactions"
      via: "matched_transaction_id FK when reconciled"
    - from: "payment_proofs"
      to: "transactions"
      via: "on_payment_proof_approved trigger creates payment"
    - from: "unit_balances"
      to: "ledger_entries"
      via: "aggregates receivable entries per unit"
---

<objective>
Create bank reconciliation and payment proof workflows for UPOE financial engine.

Purpose: Enable treasury operations including bank account management (with security best practices), statement import and reconciliation, and payment proof validation. Also create the unit_balances view for real-time account status.

Output:
- bank_accounts table with secure storage (hashed full number, display last 4)
- bank_statements and bank_statement_lines for imports
- statement_line_status enum and reconciliation workflow
- reconciliation_rules for automatic matching
- payment_proofs table with approval workflow trigger
- unit_balances view aggregating financial position per unit
</objective>

<execution_context>
@C:\Users\PC\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\PC\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-financial-engine/04-RESEARCH.md
@.planning/phases/04-financial-engine/04-01-SUMMARY.md
@.planning/phases/04-financial-engine/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bank accounts and statement tables</name>
  <files>
    supabase/migrations/TIMESTAMP_bank_accounts.sql
    supabase/migrations/TIMESTAMP_bank_statements.sql
  </files>
  <action>
Create bank_accounts table:
- id UUID PK (generate_uuid_v7)
- community_id UUID FK to communities(id)
- bank_name TEXT NOT NULL
- account_number TEXT NOT NULL (last 4 digits only for display)
- account_number_hash TEXT NOT NULL (SHA-256 of full number for matching)
- clabe TEXT (Mexican CLABE 18-digit interbank code, also last 4 + hash)
- account_type TEXT DEFAULT 'checking' CHECK (IN 'checking', 'savings')
- currency currency_code DEFAULT 'MXN'
- gl_account_id UUID FK to accounts(id) NOT NULL (link to chart of accounts)
- last_statement_balance money_amount
- last_statement_date DATE
- is_active BOOLEAN DEFAULT TRUE
- is_primary BOOLEAN DEFAULT FALSE
- Standard audit columns

Create bank_statements table:
- id UUID PK (generate_uuid_v7)
- community_id UUID FK to communities(id)
- bank_account_id UUID FK to bank_accounts(id)
- statement_date DATE NOT NULL
- period_start DATE NOT NULL
- period_end DATE NOT NULL
- opening_balance money_amount NOT NULL
- closing_balance money_amount NOT NULL
- total_credits money_amount DEFAULT 0
- total_debits money_amount DEFAULT 0
- line_count INTEGER DEFAULT 0
- import_format TEXT (csv, ofx, mt940)
- original_filename TEXT
- imported_at TIMESTAMPTZ DEFAULT now()
- imported_by UUID FK to auth.users(id)
- is_reconciled BOOLEAN DEFAULT FALSE
- reconciled_at TIMESTAMPTZ
- reconciled_by UUID FK to auth.users(id)
- lines_matched INTEGER DEFAULT 0
- lines_unmatched INTEGER DEFAULT 0
- Standard audit columns

Create statement_line_status enum: unmatched, matched, manually_matched, excluded, disputed

Create bank_statement_lines table:
- id UUID PK (generate_uuid_v7)
- community_id UUID FK to communities(id)
- statement_id UUID FK to bank_statements(id) ON DELETE CASCADE
- line_number INTEGER NOT NULL
- transaction_date DATE NOT NULL
- value_date DATE (settlement date)
- description TEXT NOT NULL
- reference TEXT (bank reference number)
- amount money_amount_signed NOT NULL (positive=credit, negative=debit)
- status statement_line_status DEFAULT 'unmatched'
- matched_transaction_id UUID FK to transactions(id)
- matched_at TIMESTAMPTZ
- matched_by UUID FK to auth.users(id)
- match_confidence NUMERIC(3,2) (0.00 to 1.00)
- notes TEXT
- UNIQUE (statement_id, line_number)

Add RLS policies (all three tables):
- super_admin full access
- users_view community data
- admins_manage

Add indexes:
- bank_accounts: community_id + is_active
- bank_statements: bank_account_id + statement_date DESC
- bank_statement_lines: statement_id + status (for unmatched queries)
- bank_statement_lines: transaction_date (for date range queries)
  </action>
  <verify>
Run migration. Query tables. Verify statement_line_status enum. Verify CASCADE delete from statements to lines.
  </verify>
  <done>
bank_accounts with secure storage pattern, bank_statements for imports, bank_statement_lines with matching status, statement_line_status enum created.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create reconciliation rules and payment proofs</name>
  <files>
    supabase/migrations/TIMESTAMP_reconciliation_rules.sql
    supabase/migrations/TIMESTAMP_payment_proofs.sql
  </files>
  <action>
Create reconciliation_rules table:
- id UUID PK (generate_uuid_v7)
- community_id UUID FK to communities(id)
- name TEXT NOT NULL
- description TEXT
- criteria JSONB NOT NULL (e.g., {"description_contains": "SPEI", "amount_tolerance": 0.01})
- priority INTEGER DEFAULT 100 (lower = checked first)
- is_active BOOLEAN DEFAULT TRUE
- Standard audit columns

Create payment_proofs table:
- id UUID PK (generate_uuid_v7)
- community_id UUID FK to communities(id)
- payment_id UUID FK to transactions(id) (nullable - created after approval)
- unit_id UUID FK to units(id) NOT NULL
- proof_type TEXT NOT NULL CHECK (IN 'transfer_receipt', 'deposit_slip', 'spei_confirmation', 'other')
- amount money_amount NOT NULL
- payment_date DATE NOT NULL
- reference_number TEXT
- bank_name TEXT
- document_url TEXT NOT NULL (Supabase Storage path)
- document_filename TEXT
- document_size_bytes INTEGER
- status approval_status DEFAULT 'pending' (uses existing enum)
- submitted_by UUID FK to auth.users(id) NOT NULL
- submitted_at TIMESTAMPTZ DEFAULT now()
- reviewed_by UUID FK to auth.users(id)
- reviewed_at TIMESTAMPTZ
- rejection_reason TEXT
- submitter_notes TEXT
- reviewer_notes TEXT
- Standard audit columns

Create on_payment_proof_approved() trigger function:
- BEFORE UPDATE on payment_proofs
- WHEN (NEW.status = 'approved' AND OLD.status = 'pending')
- Generates reference: PAY-{YYYY}-{NNNNN}
- Creates transaction (type=payment, status=pending) for the proof amount
- Links proof to transaction (NEW.payment_id := transaction_id)
- Returns NEW

Create payment_proof_approved trigger.

Add RLS policies:
- reconciliation_rules: admins only
- payment_proofs: residents can INSERT and view own, admins can manage all

Add indexes:
- payment_proofs: community_id + status WHERE status='pending' (for review queue)
- payment_proofs: unit_id + submitted_at DESC
- payment_proofs: submitted_by (for user's submissions)
  </action>
  <verify>
Run migration. Submit a payment_proof. Update status to 'approved'. Verify transaction was auto-created and linked.
  </verify>
  <done>
reconciliation_rules for matching configuration, payment_proofs with approval workflow, trigger auto-creates payment transaction on approval.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create unit_balances view and helper functions</name>
  <files>
    supabase/migrations/TIMESTAMP_unit_balances_view.sql
  </files>
  <action>
Create unit_balances view:
- Joins units with transactions and ledger_entries
- Aggregates per unit:
  - total_receivable: SUM of receivable account entries (balance owed)
  - total_charges: SUM of charge transactions (posted)
  - total_payments: SUM of payment transactions (posted)
  - total_interest: SUM of interest transactions (posted)
  - last_payment_date: MAX effective_date of payment transactions
  - last_charge_date: MAX effective_date of charge transactions
  - oldest_unpaid_date: earliest charge not fully paid (for delinquency calculation)
  - days_overdue: CURRENT_DATE - oldest_unpaid_date (when balance > 0)
- Filter: WHERE units.deleted_at IS NULL
- Group by: unit_id, community_id, unit_number

Create get_unit_balance(p_unit_id UUID) function:
- Returns RECORD with current_balance, days_overdue, last_payment_date
- STABLE, SECURITY DEFINER
- More efficient than querying view for single unit

Create get_delinquent_units(p_community_id UUID, p_min_days INTEGER DEFAULT 1, p_min_amount money_amount DEFAULT 0) function:
- Returns TABLE of units with balance > min_amount AND days_overdue >= min_days
- For delinquency processing

Add RLS policy on view (via underlying tables).

Add COMMENT on view explaining:
- total_receivable is the current balance owed (positive = owes money)
- Used for statements, delinquency checks, and dashboard
  </action>
  <verify>
Query unit_balances view. Create some test transactions (charges, payments). Verify aggregations are correct. Test get_unit_balance() and get_delinquent_units() functions.
  </verify>
  <done>
unit_balances view aggregates financial position per unit, get_unit_balance() for efficient single-unit lookup, get_delinquent_units() for batch processing.
  </done>
</task>

</tasks>

<verification>
1. Query: SELECT * FROM pg_type WHERE typname = 'statement_line_status'
2. Query: SELECT table_name FROM information_schema.tables WHERE table_name IN ('bank_accounts', 'bank_statements', 'bank_statement_lines', 'reconciliation_rules', 'payment_proofs')
3. Query: SELECT viewname FROM pg_views WHERE viewname = 'unit_balances'
4. Test: Insert payment_proof with status='pending', update to 'approved', verify payment transaction created
5. Test: Query unit_balances for a unit with charges and payments, verify totals
6. Test: get_delinquent_units() returns units with overdue balances
</verification>

<success_criteria>
- bank_accounts stores only last 4 digits with hashed full number
- bank_statements and bank_statement_lines support import workflow
- statement_line_status enum tracks reconciliation state
- reconciliation_rules configures automatic matching
- payment_proofs supports pending -> approved/rejected workflow
- Approved payment proofs auto-create payment transactions via trigger
- unit_balances view provides real-time financial position per unit
- get_unit_balance() and get_delinquent_units() functions work correctly
- All tables have RLS with community isolation
</success_criteria>

<output>
After completion, create `.planning/phases/04-financial-engine/04-04-SUMMARY.md`
</output>
