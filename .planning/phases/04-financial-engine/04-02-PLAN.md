---
phase: 04-financial-engine
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - supabase/migrations/TIMESTAMP_fee_enums.sql
  - supabase/migrations/TIMESTAMP_fee_structures.sql
  - supabase/migrations/TIMESTAMP_fee_schedules.sql
  - supabase/migrations/TIMESTAMP_payments.sql
autonomous: true

must_haves:
  truths:
    - "Fee structures support fixed, coefficient-based, and hybrid calculation types"
    - "Fee schedules link fee structures to specific units"
    - "calculate_fee_amount() uses unit coefficient for proportional fees"
    - "Payment methods include SPEI, transfer, cash, card"
    - "Payments create double-entry ledger entries (debit bank, credit receivable)"
    - "Charges create double-entry ledger entries (debit receivable, credit income)"
  artifacts:
    - path: "supabase/migrations/*_fee_enums.sql"
      provides: "fee_calculation_type, fee_frequency enums"
      contains: "CREATE TYPE fee_calculation_type"
    - path: "supabase/migrations/*_fee_structures.sql"
      provides: "fee_structures table with calculation formulas"
      contains: "CREATE TABLE fee_structures"
    - path: "supabase/migrations/*_fee_schedules.sql"
      provides: "fee_schedules junction and calculate_fee_amount function"
      contains: "CREATE FUNCTION calculate_fee_amount"
    - path: "supabase/migrations/*_payments.sql"
      provides: "payment_methods, record_payment, record_charge functions"
      contains: "CREATE FUNCTION record_payment"
  key_links:
    - from: "fee_structures"
      to: "accounts"
      via: "income_account_id and receivable_account_id FKs"
    - from: "fee_schedules"
      to: "fee_structures"
      via: "fee_structure_id FK"
    - from: "fee_schedules"
      to: "units"
      via: "unit_id FK"
    - from: "record_payment"
      to: "transactions + ledger_entries"
      via: "creates transaction and balanced ledger entries"
---

<objective>
Create fee structures, schedules, and payment recording for UPOE financial engine.

Purpose: Enable communities to define fee templates (maintenance, special assessments) using fixed, coefficient-based, or hybrid formulas. Link fees to units via schedules. Provide functions to record payments and charges with proper double-entry accounting.

Output:
- fee_calculation_type and fee_frequency enums
- fee_structures table with formula configuration
- fee_schedules table linking fees to units
- calculate_fee_amount() function using unit coefficient
- payment_methods table
- record_payment() and record_charge() helper functions
</objective>

<execution_context>
@C:\Users\PC\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\PC\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-financial-engine/04-RESEARCH.md
@.planning/phases/04-financial-engine/04-01-SUMMARY.md
@.planning/phases/02-identity-crm/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create fee enums and fee_structures table</name>
  <files>
    supabase/migrations/TIMESTAMP_fee_enums.sql
    supabase/migrations/TIMESTAMP_fee_structures.sql
  </files>
  <action>
Create fee_calculation_type enum with 5 values:
- fixed (same amount for all units)
- coefficient (proportional to unit coefficient/indiviso)
- hybrid (fixed base + coefficient portion)
- tiered (based on unit type or size)
- custom (formula stored in JSONB)

Create fee_frequency enum with 6 values:
- monthly, bimonthly, quarterly, semiannual, annual, one_time

Create fee_structures table:
- id UUID PK (generate_uuid_v7)
- community_id UUID FK to communities(id) ON DELETE RESTRICT
- name TEXT NOT NULL (e.g., "Cuota de Mantenimiento Ordinaria")
- description TEXT
- code TEXT (e.g., "MAINT-ORD")
- calculation_type fee_calculation_type NOT NULL
- base_amount money_amount NOT NULL
- coefficient_amount money_amount DEFAULT 0 (for hybrid)
- custom_formula JSONB (for custom calculations)
- frequency fee_frequency NOT NULL
- day_of_month INTEGER CHECK (day_of_month BETWEEN 1 AND 28)
- income_account_id UUID FK to accounts(id) NOT NULL
- receivable_account_id UUID FK to accounts(id) NOT NULL
- applicable_unit_types unit_type[] DEFAULT ARRAY['casa', 'departamento']::unit_type[]
- is_active BOOLEAN DEFAULT TRUE
- effective_from DATE DEFAULT CURRENT_DATE
- effective_until DATE
- Standard audit columns
- UNIQUE (community_id, code) WHERE code IS NOT NULL

Add RLS policies:
- super_admin_all_fee_structures
- users_view_fee_structures
- admins_manage_fee_structures

Add indexes:
- community_id + is_active (for active fee lookup)
- income_account_id, receivable_account_id

Add comments explaining coefficient calculation and Mexican indiviso pattern.
  </action>
  <verify>
Run migration. Query fee_structures table definition. Verify FK constraints to accounts table.
  </verify>
  <done>
fee_calculation_type and fee_frequency enums exist, fee_structures table with account links and calculation configuration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create fee_schedules and calculate_fee_amount function</name>
  <files>
    supabase/migrations/TIMESTAMP_fee_schedules.sql
  </files>
  <action>
Create fee_schedules table:
- id UUID PK (generate_uuid_v7)
- community_id UUID FK to communities(id)
- fee_structure_id UUID FK to fee_structures(id) ON DELETE RESTRICT
- unit_id UUID FK to units(id) ON DELETE RESTRICT
- override_amount money_amount (null = use calculated)
- override_reason TEXT
- effective_from DATE DEFAULT CURRENT_DATE
- effective_until DATE
- is_active BOOLEAN DEFAULT TRUE
- Standard audit columns
- UNIQUE (fee_structure_id, unit_id, effective_from)

Create calculate_fee_amount(p_fee_structure_id UUID, p_unit_id UUID) function:
- RETURNS money_amount
- LANGUAGE plpgsql, STABLE, SECURITY DEFINER
- Gets fee_structure and unit records
- Calculates based on calculation_type:
  - fixed: return base_amount
  - coefficient: return base_amount * (unit.coefficient / 100.0)
  - hybrid: return base_amount + (coefficient_amount * (unit.coefficient / 100.0))
  - tiered: return base_amount (simplified)
  - custom: return base_amount (simplified)
- Returns ROUND(calculated_amount, 2)

Create get_unit_fee_amount(p_unit_id UUID, p_fee_structure_id UUID) wrapper:
- Checks fee_schedules for override_amount first
- Falls back to calculate_fee_amount() if no override

Add RLS policies:
- super_admin_all_fee_schedules
- users_view_fee_schedules
- admins_manage_fee_schedules

Add indexes:
- unit_id + is_active (for unit fee lookup)
- fee_structure_id (for fee structure queries)
  </action>
  <verify>
Run migration. Test calculate_fee_amount() with a test fee structure and unit with known coefficient. Verify coefficient calculation produces expected result.
  </verify>
  <done>
fee_schedules table exists, calculate_fee_amount() correctly applies coefficient formula, get_unit_fee_amount() checks overrides.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create payment_methods and payment/charge recording functions</name>
  <files>
    supabase/migrations/TIMESTAMP_payment_methods.sql
    supabase/migrations/TIMESTAMP_record_payment_charge.sql
  </files>
  <action>
Create payment_methods table:
- id UUID PK (generate_uuid_v7)
- community_id UUID FK to communities(id)
- name TEXT NOT NULL (e.g., "SPEI Transfer", "Cash", "Credit Card")
- code TEXT NOT NULL (spei, transfer, cash, card, check)
- is_electronic BOOLEAN DEFAULT TRUE
- requires_proof BOOLEAN DEFAULT TRUE (SPEI needs proof upload)
- bank_account_id UUID FK to bank_accounts(id) (nullable, for later)
- is_active BOOLEAN DEFAULT TRUE
- display_order INTEGER DEFAULT 0
- Standard audit columns
- UNIQUE (community_id, code)

Insert default payment methods for each community or create seed function.

Create record_payment() function:
- Parameters: p_community_id, p_unit_id, p_amount, p_payment_date, p_description, p_payment_method_id, p_created_by
- RETURNS UUID (transaction_id)
- Generates reference: PAY-{YYYY}-{NNNNN}
- Creates transaction (type=payment, status=pending)
- Creates ledger entries:
  - Debit: Operating Bank Account (1010) +amount
  - Credit: Accounts Receivable (1100) -amount
- Posts the transaction (status=posted)
- Returns transaction_id

Create record_charge() function:
- Parameters: p_community_id, p_unit_id, p_amount, p_charge_date, p_description, p_fee_structure_id, p_created_by
- RETURNS UUID (transaction_id)
- Generates reference: CHG-{YYYY}-{NNNNN}
- Creates transaction (type=charge, status=pending)
- Creates ledger entries:
  - Debit: Accounts Receivable (1100) +amount
  - Credit: Maintenance Fee Income (4010) or fee_structure.income_account_id -amount
- Posts the transaction
- Returns transaction_id

Add comments explaining double-entry patterns.
  </action>
  <verify>
Run migration. Execute record_payment() and verify transaction and ledger entries created. Check ledger entries sum to zero. Execute record_charge() similarly.
  </verify>
  <done>
payment_methods table exists, record_payment() creates balanced double-entry, record_charge() creates balanced double-entry, both properly post transactions.
  </done>
</task>

</tasks>

<verification>
1. Query: SELECT * FROM pg_type WHERE typname IN ('fee_calculation_type', 'fee_frequency')
2. Query: SELECT table_name FROM information_schema.tables WHERE table_name IN ('fee_structures', 'fee_schedules', 'payment_methods')
3. Test: Create fee_structure with coefficient type, create unit with coefficient=1.5, verify calculate_fee_amount() returns base_amount * 0.015
4. Test: Call record_payment(), verify transaction created with status=posted, verify SUM(ledger_entries.amount)=0
5. Test: Call record_charge(), verify same double-entry balance
</verification>

<success_criteria>
- fee_calculation_type and fee_frequency enums created
- fee_structures table with formula configuration and account links
- fee_schedules junction table with override support
- calculate_fee_amount() correctly applies coefficient formula
- payment_methods table with common Mexican payment types
- record_payment() creates transaction + balanced ledger entries
- record_charge() creates transaction + balanced ledger entries
- All tables have RLS with community isolation
</success_criteria>

<output>
After completion, create `.planning/phases/04-financial-engine/04-02-SUMMARY.md`
</output>
