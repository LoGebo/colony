---
phase: 04-financial-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/TIMESTAMP_account_enums.sql
  - supabase/migrations/TIMESTAMP_accounts_table.sql
  - supabase/migrations/TIMESTAMP_transaction_enums.sql
  - supabase/migrations/TIMESTAMP_transactions_ledger.sql
autonomous: true

must_haves:
  truths:
    - "Account categories support asset, liability, equity, income, expense"
    - "Accounts are hierarchical with parent_account_id"
    - "Operating vs reserve fund accounts are tagged separately"
    - "Transactions have pending/posted states with immutability on posted"
    - "Ledger entries sum to zero per transaction (debit/credit balance)"
    - "Ledger entries are append-only (no UPDATE or DELETE allowed)"
  artifacts:
    - path: "supabase/migrations/*_account_enums.sql"
      provides: "account_category, account_subtype enums"
      contains: "CREATE TYPE account_category"
    - path: "supabase/migrations/*_accounts_table.sql"
      provides: "accounts table with hierarchy and fund flags"
      contains: "CREATE TABLE accounts"
    - path: "supabase/migrations/*_transaction_enums.sql"
      provides: "transaction_type, transaction_status enums"
      contains: "CREATE TYPE transaction_type"
    - path: "supabase/migrations/*_transactions_ledger.sql"
      provides: "transactions and ledger_entries tables"
      contains: "CREATE TABLE ledger_entries"
  key_links:
    - from: "ledger_entries"
      to: "transactions"
      via: "transaction_id FK with ON DELETE RESTRICT"
    - from: "ledger_entries"
      to: "accounts"
      via: "account_id FK"
    - from: "accounts"
      to: "communities"
      via: "community_id FK with RLS"
---

<objective>
Create the chart of accounts and double-entry ledger foundation for UPOE financial engine.

Purpose: Establish the accounting infrastructure that all financial operations (fees, payments, reconciliation) will build upon. The chart of accounts enables proper categorization (HOA standard 1000s-5000s numbering), and the immutable ledger guarantees audit integrity.

Output:
- account_category and account_subtype enums for classification
- accounts table with hierarchical structure, operating/reserve fund separation
- transaction_type and transaction_status enums
- transactions table with pending/posted state machine
- ledger_entries table with trigger-enforced immutability
- Validation trigger ensuring ledger entries sum to zero before posting
</objective>

<execution_context>
@C:\Users\PC\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\PC\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-financial-engine/04-RESEARCH.md
@.planning/phases/01-foundation-multi-tenant-security/01-01-SUMMARY.md
@.planning/phases/01-foundation-multi-tenant-security/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create account enums and accounts table</name>
  <files>
    supabase/migrations/TIMESTAMP_account_enums.sql
    supabase/migrations/TIMESTAMP_accounts_table.sql
  </files>
  <action>
Create account_category enum with 5 values: asset, liability, equity, income, expense

Create account_subtype enum with 16 values grouped by category:
- Assets: cash, accounts_receivable, prepaid, fixed_asset
- Liabilities: accounts_payable, security_deposits, loans, deferred_income
- Equity: retained_earnings, reserves
- Income: maintenance_fees, special_assessments, late_fees, other_income
- Expenses: utilities, maintenance, administrative, insurance, taxes, reserve_contribution

Create accounts table:
- id UUID PK (generate_uuid_v7)
- community_id UUID FK to communities(id) ON DELETE RESTRICT
- account_number TEXT NOT NULL (e.g., "1010", "4100")
- name TEXT NOT NULL
- description TEXT
- category account_category NOT NULL
- subtype account_subtype NOT NULL
- parent_account_id UUID FK to accounts(id) for hierarchy
- depth INTEGER DEFAULT 0
- is_operating_fund BOOLEAN DEFAULT TRUE
- is_reserve_fund BOOLEAN DEFAULT FALSE
- current_balance money_amount_signed DEFAULT 0
- balance_as_of TIMESTAMPTZ DEFAULT now()
- normal_balance TEXT NOT NULL CHECK (normal_balance IN ('debit', 'credit'))
- is_active BOOLEAN DEFAULT TRUE
- is_system_account BOOLEAN DEFAULT FALSE
- Standard audit columns (created_at, updated_at, deleted_at, created_by)
- UNIQUE (community_id, account_number)
- CHECK: NOT (is_operating_fund AND is_reserve_fund)

Add RLS policies:
- super_admin_all_accounts: Platform admins full access
- users_view_accounts: Users can view their community's accounts
- admins_manage_accounts: Admins can INSERT/UPDATE/DELETE

Add indexes:
- community_id + account_number (covered by unique constraint)
- parent_account_id for hierarchy queries
- category + is_active for reporting queries

Attach set_audit_fields trigger.

Create create_standard_chart_of_accounts(p_community_id) function that inserts the standard HOA accounts (1010-7020 as documented in research).
  </action>
  <verify>
Run migration via Supabase MCP. Query pg_type for account_category and account_subtype enums. Query accounts table definition. Execute create_standard_chart_of_accounts() for a test community and verify accounts created.
  </verify>
  <done>
account_category enum exists with 5 values, account_subtype enum exists with 16+ values, accounts table exists with all columns, RLS policies active, create_standard_chart_of_accounts() function works.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create transaction enums and transactions table</name>
  <files>
    supabase/migrations/TIMESTAMP_transaction_enums.sql
    supabase/migrations/TIMESTAMP_transactions_table.sql
  </files>
  <action>
Create transaction_type enum with 6 values: charge, payment, adjustment, interest, reversal, transfer

Create transaction_status enum with 3 values: pending, posted, voided

Create transactions table:
- id UUID PK (generate_uuid_v7)
- community_id UUID FK to communities(id) ON DELETE RESTRICT
- transaction_type transaction_type NOT NULL
- reference_number TEXT NOT NULL (format: PAY-2026-00001, CHG-2026-00001)
- description TEXT NOT NULL
- unit_id UUID FK to units(id) (nullable - some transactions are community-level)
- resident_id UUID FK to residents(id) (nullable)
- amount money_amount NOT NULL
- currency currency_code DEFAULT 'MXN'
- status transaction_status DEFAULT 'pending'
- posted_at TIMESTAMPTZ (set when status changes to posted)
- posted_by UUID FK to auth.users(id)
- reverses_transaction_id UUID FK to transactions(id) (for reversals)
- reversed_by_transaction_id UUID FK to transactions(id) (back-link)
- effective_date DATE DEFAULT CURRENT_DATE
- Standard audit columns
- UNIQUE (community_id, reference_number)

Create prevent_posted_transaction_modification() trigger function:
- On UPDATE: If OLD.status = 'posted', only allow updating reversed_by_transaction_id
- On DELETE: If status = 'posted', raise exception
- Attach BEFORE UPDATE OR DELETE trigger

Create validate_posted_transaction() trigger function:
- On status change from pending to posted:
  - Check SUM(ledger_entries.amount) = 0 for this transaction
  - If not zero, raise exception with sum value
  - Set posted_at = now()
- Attach BEFORE UPDATE trigger

Add RLS policies:
- super_admin_all_transactions
- users_view_community_transactions
- admins_manage_transactions

Add indexes:
- community_id + transaction_type + status (for queries)
- unit_id + effective_date (for unit statements)
- effective_date (for period queries)
- status partial index WHERE status = 'pending' (for processing queues)
  </action>
  <verify>
Run migration. Query transactions table definition. Verify trigger functions exist. Test that UPDATE on a posted transaction raises exception.
  </verify>
  <done>
transaction_type and transaction_status enums exist, transactions table exists with immutability triggers, RLS active, cannot modify posted transactions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create ledger_entries table with immutability</name>
  <files>
    supabase/migrations/TIMESTAMP_ledger_entries.sql
  </files>
  <action>
Create ledger_entries table:
- id UUID PK (generate_uuid_v7)
- community_id UUID FK to communities(id) ON DELETE RESTRICT
- transaction_id UUID FK to transactions(id) ON DELETE RESTRICT
- account_id UUID FK to accounts(id) ON DELETE RESTRICT
- amount money_amount_signed NOT NULL (positive=debit, negative=credit)
- balance_after money_amount_signed (running balance after this entry)
- entry_sequence INTEGER NOT NULL (order within transaction)
- created_at TIMESTAMPTZ DEFAULT now() (NO updated_at - immutable)
- CHECK (amount != 0) - no zero-amount entries

Create prevent_ledger_entry_modification() trigger function:
- Raises exception on ANY UPDATE or DELETE: "ledger_entries is append-only"
- Attach BEFORE UPDATE trigger
- Attach BEFORE DELETE trigger

Create update_account_balance() trigger function:
- AFTER INSERT on ledger_entries
- Updates accounts.current_balance by adding entry amount
- Updates accounts.balance_as_of to now()

Add RLS policies (similar to access_logs - immutable audit trail):
- super_admin_all_ledger_entries: View and INSERT
- users_view_community_ledger: View only
- admins_insert_ledger: INSERT only (no UPDATE/DELETE)

Add indexes:
- transaction_id (for transaction detail queries)
- account_id + created_at DESC (for account history)
- community_id + created_at DESC (for audit queries)
- BRIN index on created_at (time-series queries)

Add comments documenting the immutability pattern and double-entry requirement.
  </action>
  <verify>
Run migration. Attempt UPDATE on ledger_entries - must fail with "append-only" message. Attempt DELETE - must fail. Test INSERT works. Verify balance_after trigger works.
  </verify>
  <done>
ledger_entries table exists with immutability triggers that block UPDATE and DELETE, balance propagation trigger updates account balances, BRIN index for time-series queries.
  </done>
</task>

</tasks>

<verification>
1. Query: SELECT * FROM pg_type WHERE typname IN ('account_category', 'account_subtype', 'transaction_type', 'transaction_status')
2. Query: SELECT table_name FROM information_schema.tables WHERE table_name IN ('accounts', 'transactions', 'ledger_entries')
3. Query: SELECT tgname FROM pg_trigger WHERE tgrelid = 'ledger_entries'::regclass - should show immutability triggers
4. Test: INSERT a transaction, add ledger entries (debit/credit), attempt to post - should validate sum=0
5. Test: Attempt UPDATE on posted transaction - should fail
6. Test: Attempt DELETE on ledger_entries - should fail with "append-only" message
</verification>

<success_criteria>
- 4 new enum types created (account_category, account_subtype, transaction_type, transaction_status)
- accounts table with hierarchy, fund separation, and standard chart function
- transactions table with pending/posted state machine and immutability on posted
- ledger_entries table is append-only (triggers block UPDATE/DELETE)
- Posting a transaction validates entries sum to zero
- All tables have RLS with community isolation
</success_criteria>

<output>
After completion, create `.planning/phases/04-financial-engine/04-01-SUMMARY.md`
</output>
