---
phase: 04-oxxo-payments
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mobile/src/hooks/usePayments.ts
  - packages/mobile/app/(resident)/payments/checkout.tsx
autonomous: true

must_haves:
  truths:
    - "Resident can navigate to checkout with paymentMethodType=oxxo param"
    - "OXXO checkout calls confirmPayment() with paymentMethodType 'Oxxo' (capital O) and billingDetails"
    - "After OXXO confirmPayment resolves without error, screen shows voucher_generated state (NOT processing)"
    - "Voucher generated screen shows success message and navigates back to dashboard"
    - "Card checkout flow remains unchanged when paymentMethodType is 'card' or absent"
    - "usePendingOxxoVoucher hook queries payment_intents for OXXO vouchers with status requires_action"
  artifacts:
    - path: "packages/mobile/src/hooks/usePayments.ts"
      provides: "CreatePaymentIntentInput type with 'card' | 'oxxo', PendingOxxoVoucher interface, usePendingOxxoVoucher hook"
      contains: "usePendingOxxoVoucher"
    - path: "packages/mobile/app/(resident)/payments/checkout.tsx"
      provides: "OXXO branch in checkout screen using confirmPayment, voucher_generated state"
      contains: "confirmPayment"
  key_links:
    - from: "checkout.tsx"
      to: "useStripe().confirmPayment"
      via: "OXXO branch in handlePay"
      pattern: "confirmPayment.*Oxxo"
    - from: "checkout.tsx"
      to: "useResidentProfile"
      via: "billingDetails for OXXO (name + email)"
      pattern: "billingDetails.*first_name.*paternal_surname"
    - from: "usePayments.ts usePendingOxxoVoucher"
      to: "supabase payment_intents table"
      via: "query with payment_method_type=oxxo AND status=requires_action"
      pattern: "payment_method_type.*oxxo.*requires_action"
---

<objective>
Add OXXO payment flow to the checkout screen and create the pending voucher query hook.

Purpose: The checkout screen currently only supports card payments via PaymentSheet. This plan adds an OXXO branch that uses `confirmPayment()` from the Stripe SDK to open the native WebView voucher display. It also adds the `usePendingOxxoVoucher` hook needed by the dashboard (Plan 03).

Output: Modified checkout.tsx with OXXO branch + modified usePayments.ts with type fix and new hook.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-oxxo-payments/04-CONTEXT.md
@.planning/phases/04-oxxo-payments/04-RESEARCH.md
@packages/mobile/app/(resident)/payments/checkout.tsx
@packages/mobile/src/hooks/usePayments.ts
@packages/mobile/src/hooks/useProfile.ts
@packages/mobile/src/hooks/useAuth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend usePayments.ts with OXXO type and pending voucher hook</name>
  <files>packages/mobile/src/hooks/usePayments.ts</files>
  <action>
Make 2 changes to usePayments.ts:

**Change 1: Fix CreatePaymentIntentInput type to accept 'oxxo'**
Change the `payment_method_type` field from `'card'` to `'card' | 'oxxo'`:
```typescript
export interface CreatePaymentIntentInput {
  unit_id: string;
  amount: number;
  description: string;
  idempotency_key: string;
  payment_method_type: 'card' | 'oxxo';  // was 'card' only
}
```

**Change 2: Add PendingOxxoVoucher interface and usePendingOxxoVoucher hook**
Add at the end of the file, before the closing:

```typescript
// ---------- PendingOxxoVoucher Types ----------

export interface PendingOxxoVoucher {
  id: string;
  stripe_payment_intent_id: string;
  amount: number;
  expires_at: string;
  metadata: { hosted_voucher_url?: string } | null;
}

// ---------- usePendingOxxoVoucher ----------

/**
 * Queries for an active (non-expired) OXXO voucher for the given unit.
 * Returns null if no pending voucher exists.
 * Used by the dashboard to show pending voucher card and disable OXXO button.
 */
export function usePendingOxxoVoucher(unitId?: string) {
  return useQuery({
    queryKey: ['pending-oxxo-voucher', unitId],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('payment_intents')
        .select('id, stripe_payment_intent_id, amount, expires_at, metadata')
        .eq('unit_id', unitId!)
        .eq('payment_method_type', 'oxxo')
        .eq('status', 'requires_action')
        .is('deleted_at', null)
        .gt('expires_at', new Date().toISOString())
        .order('created_at', { ascending: false })
        .limit(1)
        .maybeSingle();

      if (error) throw error;
      return data as PendingOxxoVoucher | null;
    },
    enabled: !!unitId,
  });
}
```

Do NOT modify any existing hooks (useUnitBalance, useTransactions, usePaymentProofs, useUploadPaymentProof, useCreatePaymentIntent). Only change the type and add the new hook.
  </action>
  <verify>
    1. Read the file and confirm CreatePaymentIntentInput has `payment_method_type: 'card' | 'oxxo'`
    2. Confirm PendingOxxoVoucher interface exists with id, stripe_payment_intent_id, amount, expires_at, metadata
    3. Confirm usePendingOxxoVoucher function exists and queries payment_intents with correct filters
    4. Run `npx tsc --noEmit --project packages/mobile/tsconfig.json 2>&1 | head -30` to check for TypeScript errors (may have unrelated errors, focus on usePayments.ts)
  </verify>
  <done>
    CreatePaymentIntentInput accepts 'card' | 'oxxo'. usePendingOxxoVoucher hook queries non-expired OXXO vouchers with status 'requires_action'.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add OXXO branch to checkout screen</name>
  <files>packages/mobile/app/(resident)/payments/checkout.tsx</files>
  <action>
Extend checkout.tsx with an OXXO flow branch. The card flow must remain completely unchanged. All OXXO-specific logic is gated behind `isOxxo` checks.

**Step 1: Add imports**
Add to existing imports:
```typescript
import { useLocalSearchParams } from 'expo-router';  // ADD (useRouter already imported from expo-router)
import { Linking } from 'react-native';  // ADD to the react-native import
```
Add new hook imports:
```typescript
import { useResidentProfile } from '@/hooks/useProfile';
import { useAuth } from '@/hooks/useAuth';
```

**Step 2: Read route param and add confirmPayment**
At the top of CheckoutScreen:
```typescript
const { paymentMethodType } = useLocalSearchParams<{ paymentMethodType?: string }>();
const isOxxo = paymentMethodType === 'oxxo';
```

Change the useStripe destructure to include confirmPayment:
```typescript
const { initPaymentSheet, presentPaymentSheet, confirmPayment } = useStripe();
```

Add profile and auth hooks (needed for OXXO billing details):
```typescript
const { data: profile } = useResidentProfile();
const { user } = useAuth();
```

**Step 3: Update PaymentState type**
Add 'voucher_generated' to the PaymentState union type:
```typescript
type PaymentState = 'idle' | 'creating' | 'presenting' | 'processing' | 'success' | 'failed' | 'timeout' | 'voucher_generated';
```

**Step 4: Add OXXO branch to handlePay**
Inside handlePay, AFTER the createPaymentIntent.mutateAsync call succeeds and setStripePaymentIntentId is called, add the OXXO branch BEFORE the card PaymentSheet logic:

```typescript
// --- OXXO Flow ---
if (isOxxo) {
  // Build billing details from resident profile
  const fullName = profile?.first_name && profile?.paternal_surname
    ? `${profile.first_name} ${profile.paternal_surname}`
    : (user?.email ?? 'Residente');
  const email = user?.email ?? profile?.email ?? '';

  setPaymentState('presenting');

  const { error: confirmError } = await confirmPayment(
    result.clientSecret,
    {
      paymentMethodType: 'Oxxo',  // Capital O - verified from SDK source
      paymentMethodData: {
        billingDetails: {
          name: fullName,
          email: email,
        },
      },
    },
  );

  if (confirmError) {
    setPaymentState('failed');
    setErrorMessage(confirmError.message);
    return;
  }

  // SDK opened WebView and user dismissed it. Status is now requires_action.
  // Do NOT start Realtime subscription or 10-second timeout - OXXO settles hours/days later.
  setPaymentState('voucher_generated');
  Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success);
  return;
}
// --- End OXXO Flow ---

// ... existing card PaymentSheet flow below (unchanged) ...
```

Also update the payment_method_type in the createPaymentIntent.mutateAsync call:
```typescript
payment_method_type: isOxxo ? 'oxxo' : 'card',
```

And update the description:
```typescript
description: isOxxo
  ? `Pago OXXO - ${unitNumber}`
  : `Pago de mantenimiento - ${unitNumber}`,
```

**Step 5: Add voucher_generated render state**
After the success/timeout render block, add a voucher_generated render:

```typescript
// ---------- Render: Voucher Generated ----------

if (paymentState === 'voucher_generated') {
  return (
    <View style={styles.container}>
      <AmbientBackground />
      <View style={styles.successContainer}>
        <Animated.View entering={BounceIn.delay(200)} style={[styles.successIconCircle, { backgroundColor: colors.primary }]}>
          <Ionicons name="receipt-outline" size={40} color={colors.textOnDark} />
        </Animated.View>
        <Animated.Text entering={FadeInDown.delay(400)} style={styles.successTitle}>
          Voucher Generado
        </Animated.Text>
        <Animated.Text entering={FadeInDown.delay(500)} style={styles.successAmount}>
          {formatCurrency(paidAmount)}
        </Animated.Text>
        <Animated.Text entering={FadeIn.delay(600)} style={styles.successSubtitle}>
          Presenta el voucher en cualquier OXXO para completar tu pago. El voucher expira en 48 horas.
        </Animated.Text>
        <Animated.View entering={FadeIn.delay(700)}>
          <TouchableOpacity style={styles.successButton} onPress={() => router.back()}>
            <Text style={styles.successButtonText}>Volver a Pagos</Text>
          </TouchableOpacity>
        </Animated.View>
      </View>
    </View>
  );
}
```

**Step 6: Update header title and button text**
In the main checkout render, update the header title to be dynamic:
```typescript
<Text style={styles.headerTitle}>{isOxxo ? 'Pay with OXXO' : 'Pay with Card'}</Text>
```
Also in the loading skeleton header.

Update the Pay button text when OXXO:
```typescript
<Text style={styles.payButtonText}>
  {isValidAmount
    ? (isOxxo ? `Generar Voucher ${formatCurrency(activeAmount!)}` : `Pay ${formatCurrency(activeAmount!)}`)
    : 'Select an amount'}
</Text>
```

**CRITICAL anti-patterns to avoid:**
- Do NOT start the 10-second timeout after OXXO confirmPayment (OXXO settles hours later, not seconds)
- Do NOT start a Realtime subscription during OXXO checkout
- Do NOT use PaymentSheet for OXXO (it does not support it)
- Do NOT use `oxxoDisplayDetails.hostedVoucherUrl` (wrong SDK path)
- Keep the card flow 100% unchanged - all OXXO logic is gated behind `if (isOxxo)`
  </action>
  <verify>
    1. Read the modified checkout.tsx and confirm:
       - useLocalSearchParams reads paymentMethodType
       - confirmPayment is destructured from useStripe()
       - useResidentProfile and useAuth are imported and called
       - PaymentState includes 'voucher_generated'
       - handlePay has OXXO branch with confirmPayment('Oxxo') before card PaymentSheet
       - payment_method_type is dynamic (isOxxo ? 'oxxo' : 'card')
       - voucher_generated render shows "Voucher Generado" and "Volver a Pagos"
       - Header title is dynamic based on isOxxo
       - Pay button text shows "Generar Voucher" for OXXO
    2. Confirm the card flow is untouched (initPaymentSheet, presentPaymentSheet, processing state, Realtime subscription all remain)
    3. Run `npx tsc --noEmit --project packages/mobile/tsconfig.json 2>&1 | head -40` to check for TypeScript errors
  </verify>
  <done>
    Checkout screen supports both card (PaymentSheet) and OXXO (confirmPayment + WebView) flows via paymentMethodType route param. Card flow unchanged. OXXO flow ends in voucher_generated state with "Voucher Generado" screen.
  </done>
</task>

</tasks>

<verification>
1. The usePayments.ts type change does not break the existing card checkout (which already passes 'card')
2. checkout.tsx correctly branches: isOxxo leads to confirmPayment, else PaymentSheet
3. OXXO does NOT trigger Realtime subscription or 10-second timeout
4. Billing details come from useResidentProfile (first_name + paternal_surname) and useAuth (email)
5. PaymentState includes voucher_generated and renders a distinct screen
6. confirmPayment uses 'Oxxo' (capital O) as verified from SDK source
</verification>

<success_criteria>
- checkout.tsx has two distinct flows: card (PaymentSheet) and OXXO (confirmPayment)
- OXXO flow sets payment_method_type: 'oxxo' in createPaymentIntent call
- OXXO flow calls confirmPayment with paymentMethodType: 'Oxxo' and billingDetails
- After OXXO confirmPayment, state is 'voucher_generated' (not 'processing')
- Voucher generated screen shows amount, message about presenting at OXXO, and "Volver a Pagos" button
- usePendingOxxoVoucher hook exists and queries pending OXXO vouchers
- Card flow is completely unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/04-oxxo-payments/04-02-SUMMARY.md`
</output>
