---
phase: 04-oxxo-payments
plan: 03
type: execute
wave: 2
depends_on: ["04-02"]
files_modified:
  - packages/mobile/app/(resident)/payments/index.tsx
autonomous: false

must_haves:
  truths:
    - "Resident sees 'Pay with OXXO' action card on the payments dashboard"
    - "Tapping 'Pay with OXXO' navigates to checkout with paymentMethodType=oxxo param"
    - "Pending OXXO voucher card appears on dashboard when a non-expired requires_action voucher exists"
    - "Pending voucher card shows amount, expiry date, and 'Ver Voucher' button"
    - "Tapping 'Ver Voucher' opens the hosted_voucher_url via Linking.openURL"
    - "OXXO action card is disabled with 'Voucher pendiente' text when a pending voucher exists"
    - "Pay Now button navigates to checkout with paymentMethodType=card (preserving existing behavior)"
  artifacts:
    - path: "packages/mobile/app/(resident)/payments/index.tsx"
      provides: "OXXO action card, pending voucher section, disable logic"
      contains: "usePendingOxxoVoucher"
  key_links:
    - from: "index.tsx OXXO action card"
      to: "checkout.tsx"
      via: "router.push with params.paymentMethodType='oxxo'"
      pattern: "paymentMethodType.*oxxo"
    - from: "index.tsx pending voucher card"
      to: "usePendingOxxoVoucher hook"
      via: "query result drives UI visibility"
      pattern: "usePendingOxxoVoucher"
    - from: "index.tsx Ver Voucher button"
      to: "Linking.openURL"
      via: "hosted_voucher_url from metadata"
      pattern: "Linking.openURL.*hosted_voucher_url"
---

<objective>
Add OXXO action card and pending voucher section to the payments dashboard.

Purpose: Residents need a visible entry point to generate OXXO vouchers and must be able to track/re-access pending vouchers. This completes the OXXO user experience by connecting the checkout flow (Plan 02) to the dashboard.

Output: Modified payments/index.tsx with OXXO action card, pending voucher card, and single-voucher guard.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-oxxo-payments/04-CONTEXT.md
@.planning/phases/04-oxxo-payments/04-RESEARCH.md
@.planning/phases/04-oxxo-payments/04-02-SUMMARY.md
@packages/mobile/app/(resident)/payments/index.tsx
@packages/mobile/src/hooks/usePayments.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OXXO action card, pending voucher section, and disable logic to dashboard</name>
  <files>packages/mobile/app/(resident)/payments/index.tsx</files>
  <action>
Modify the payments dashboard (index.tsx) with 4 additions:

**Step 1: Add imports**
Add to existing imports:
```typescript
import { Linking } from 'react-native';
import { usePendingOxxoVoucher } from '@/hooks/usePayments';
```

**Step 2: Add pending voucher hook**
Inside PaymentDashboardScreen, after the existing hooks:
```typescript
const { data: pendingOxxo, refetch: refetchOxxo } = usePendingOxxoVoucher(unitId ?? undefined);
const hasOxxoPending = !!pendingOxxo;
```

Add `refetchOxxo()` to the `onRefresh` Promise.all.

**Step 3: Update "Pay Now" button to pass paymentMethodType=card**
Change the "Pay Now" button's onPress from:
```typescript
onPress={() => router.push('/(resident)/payments/checkout')}
```
to:
```typescript
onPress={() => router.push({ pathname: '/(resident)/payments/checkout', params: { paymentMethodType: 'card' } })}
```

**Step 4: Add "Pay with OXXO" action card**
In the PAYMENT ACTIONS section, after the "Pay with Card" action card and its spacer, add a new OXXO action card BEFORE the "Upload Transfer Receipt" card:

```tsx
{/* Pay with OXXO */}
<TouchableOpacity
  onPress={() => router.push({ pathname: '/(resident)/payments/checkout', params: { paymentMethodType: 'oxxo' } })}
  disabled={hasOxxoPending || currentBalance <= 0}
>
  <GlassCard style={[styles.actionCard, (hasOxxoPending || currentBalance <= 0) && { opacity: 0.5 }]}>
    <View style={[styles.actionIconBox, { backgroundColor: colors.warningBgLight }]}>
      <Ionicons name="storefront-outline" size={20} color={colors.warningText} />
    </View>
    <View style={styles.actionTextContainer}>
      <Text style={styles.actionTitle}>
        {hasOxxoPending ? 'Voucher pendiente' : 'Pay with OXXO'}
      </Text>
      <Text style={styles.actionSubtitle}>
        {hasOxxoPending ? 'Ya tienes un voucher activo' : 'Generate voucher, pay at any OXXO'}
      </Text>
    </View>
    <Ionicons name="chevron-forward" size={16} color={colors.textCaption} />
  </GlassCard>
</TouchableOpacity>

<View style={{ height: spacing.lg }} />
```

Also update the "Pay with Card" action card to pass paymentMethodType:
```typescript
onPress={() => router.push({ pathname: '/(resident)/payments/checkout', params: { paymentMethodType: 'card' } })}
```

**Step 5: Add pending OXXO voucher card**
Add a new section AFTER the balance card and BEFORE the PAYMENT ACTIONS section. This card only shows when `pendingOxxo` is not null:

```tsx
{/* Pending OXXO Voucher */}
{pendingOxxo && (
  <View style={styles.pendingOxxoCard}>
    <View style={styles.pendingOxxoHeader}>
      <View style={[styles.pendingProofIconBox, { backgroundColor: colors.primaryLight }]}>
        <Ionicons name="storefront-outline" size={20} color={colors.primary} />
      </View>
      <View style={styles.pendingProofInfo}>
        <Text style={styles.pendingProofTitle}>OXXO Voucher Pending</Text>
        <Text style={styles.pendingProofSubtitle}>
          Expira: {new Date(pendingOxxo.expires_at).toLocaleDateString('es-MX', {
            day: 'numeric',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
          })}
        </Text>
      </View>
      <View style={styles.pendingProofAmount}>
        <Text style={[styles.pendingProofAmountText, { color: colors.primary }]}>
          {formatCurrency(pendingOxxo.amount)}
        </Text>
      </View>
    </View>
    {pendingOxxo.metadata?.hosted_voucher_url && (
      <TouchableOpacity
        style={styles.viewVoucherButton}
        onPress={() => Linking.openURL(pendingOxxo.metadata!.hosted_voucher_url!)}
      >
        <Ionicons name="open-outline" size={16} color={colors.textOnDark} />
        <Text style={styles.viewVoucherButtonText}>Ver Voucher</Text>
      </TouchableOpacity>
    )}
  </View>
)}
```

**Step 6: Add new styles**
Add these styles to the StyleSheet:

```typescript
// Pending OXXO
pendingOxxoCard: {
  backgroundColor: colors.surface,
  borderRadius: borderRadius.xl,
  borderWidth: 1,
  borderColor: colors.border,
  borderLeftWidth: 4,
  borderLeftColor: colors.primary,
  padding: spacing.xl,
  marginBottom: spacing['3xl'],
  ...shadows.sm,
},
pendingOxxoHeader: {
  flexDirection: 'row',
  alignItems: 'center',
  gap: spacing.lg,
},
viewVoucherButton: {
  flexDirection: 'row',
  alignItems: 'center',
  justifyContent: 'center',
  gap: spacing.md,
  marginTop: spacing.xl,
  height: spacing.smallButtonHeight,
  backgroundColor: colors.primary,
  borderRadius: borderRadius.md,
},
viewVoucherButtonText: {
  fontFamily: fonts.bold,
  fontSize: 13,
  color: colors.textOnDark,
},
```

**Design consistency notes:**
- Use `storefront-outline` icon for OXXO (represents convenience store)
- Use warning tint (`colors.warningBgLight`, `colors.warningText`) for the OXXO icon box — visually distinct from card (primary blue) and upload (primary blue)
- Pending OXXO card uses same layout pattern as the existing pendingProof card but with primary blue accent (not amber) to distinguish from receipt pending
- Reuse existing style names where possible (pendingProofIconBox, pendingProofInfo, etc.)
  </action>
  <verify>
    1. Read the modified index.tsx and confirm:
       - usePendingOxxoVoucher is imported and called
       - Linking is imported from react-native
       - "Pay with OXXO" action card exists with storefront-outline icon
       - OXXO action card is disabled + opacity 0.5 when hasOxxoPending is true
       - OXXO action card shows "Voucher pendiente" text when pending
       - Pending OXXO voucher card renders when pendingOxxo is not null
       - Pending card shows formatted expiry date, amount, and "Ver Voucher" button
       - "Ver Voucher" calls Linking.openURL with hosted_voucher_url
       - "Pay with Card" navigates with paymentMethodType: 'card'
       - "Pay Now" navigates with paymentMethodType: 'card'
       - refetchOxxo is in the onRefresh Promise.all
    2. Run `npx tsc --noEmit --project packages/mobile/tsconfig.json 2>&1 | head -40` to check for TypeScript errors
  </verify>
  <done>
    Dashboard shows OXXO action card, pending voucher section with "Ver Voucher" button, and disables OXXO when pending voucher exists. All navigation passes paymentMethodType param.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete OXXO payment flow:
    1. "Pay with OXXO" action card on payments dashboard
    2. Checkout screen OXXO branch (generates voucher via Stripe WebView)
    3. Pending OXXO voucher card on dashboard with "Ver Voucher" button
    4. OXXO button disabled when pending voucher exists
    5. Backend webhook upgrades (processing handler, voucher URL storage, expiry push, description differentiation)
  </what-built>
  <how-to-verify>
    Visual verification (without Stripe keys — structural only):
    1. Open the mobile app and navigate to the Billing/Payments tab
    2. Confirm "Pay with OXXO" card appears below "Pay with Card" with storefront icon
    3. Confirm "Upload Transfer Receipt" card still appears below OXXO
    4. Tap "Pay with OXXO" — should navigate to checkout with header "Pay with OXXO"
    5. On checkout, confirm button text says "Generar Voucher" instead of "Pay"
    6. Tap back, confirm dashboard looks correct
    7. Tap "Pay with Card" — should navigate to checkout with header "Pay with Card"

    To test the full OXXO flow end-to-end:
    - Requires STRIPE_SECRET_KEY and STRIPE_PUBLISHABLE_KEY configured
    - Requires OXXO enabled in Stripe Dashboard (Payment methods section)
    - Requires webhook endpoint configured with payment_intent.processing event
    - Test with Stripe test mode: use email "succeed_immediately@stripe.com" for instant OXXO success
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Dashboard has 3 action cards in correct order: Pay with Card, Pay with OXXO, Upload Transfer Receipt
2. OXXO card uses storefront-outline icon with warning color scheme
3. OXXO card is disabled (opacity 0.5, "Voucher pendiente") when pending voucher exists
4. Pending voucher card shows between balance card and actions section
5. Pending voucher card shows formatted expiry, amount, and "Ver Voucher" button
6. "Ver Voucher" opens hosted_voucher_url in system browser
7. All navigation passes paymentMethodType param
8. Pull-to-refresh includes pending OXXO refetch
</verification>

<success_criteria>
- "Pay with OXXO" action card visible on dashboard with storefront icon
- Tapping OXXO card navigates to checkout with paymentMethodType=oxxo
- OXXO card disabled + "Voucher pendiente" when pending voucher exists for this unit
- Pending OXXO card shows amount, expiry date, "Ver Voucher" button
- "Ver Voucher" opens URL in system browser
- "Pay with Card" and "Pay Now" pass paymentMethodType=card
- Existing dashboard layout and functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/04-oxxo-payments/04-03-SUMMARY.md`
</output>
