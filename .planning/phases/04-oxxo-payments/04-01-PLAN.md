---
phase: 04-oxxo-payments
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/payment-webhook/index.ts
  - supabase/functions/create-payment-intent/index.ts
autonomous: true

must_haves:
  truths:
    - "Webhook correctly handles payment_intent.processing by updating status to processing"
    - "Webhook stores hosted_voucher_url in payment_intents.metadata on requires_action (JSONB merge, not overwrite)"
    - "Webhook sends OXXO expiry push notification on payment_failed when payment_method_type is oxxo"
    - "Webhook uses OXXO-specific description when recording payment on succeeded"
  artifacts:
    - path: "supabase/functions/payment-webhook/index.ts"
      provides: "handlePaymentIntentProcessing handler, upgraded requires_action and failed handlers, OXXO description in succeeded"
      contains: "handlePaymentIntentProcessing"
    - path: "supabase/functions/create-payment-intent/index.ts"
      provides: "OXXO description differentiation (minor)"
      contains: "Pago OXXO"
  key_links:
    - from: "payment-webhook handlePaymentIntentRequiresAction"
      to: "payment_intents.metadata"
      via: "JSONB merge with hosted_voucher_url"
      pattern: "hosted_voucher_url"
    - from: "payment-webhook handlePaymentIntentFailed"
      to: "send-push edge function"
      via: "supabase.functions.invoke for OXXO expiry notification"
      pattern: "payment_method_type.*oxxo.*send-push"
    - from: "payment-webhook handlePaymentIntentSucceeded"
      to: "record_payment RPC"
      via: "OXXO vs card description differentiation"
      pattern: "Pago OXXO via Stripe"
---

<objective>
Upgrade the payment-webhook and create-payment-intent edge functions to fully support OXXO payment lifecycle events.

Purpose: The webhook must handle OXXO-specific events (processing status, voucher URL storage, expiry notifications) and differentiate OXXO from card payments in ledger descriptions. Without these backend changes, OXXO voucher data would not persist and expiry notifications would not fire.

Output: Updated payment-webhook/index.ts with 4 changes + updated create-payment-intent/index.ts with description differentiation.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-oxxo-payments/04-CONTEXT.md
@.planning/phases/04-oxxo-payments/04-RESEARCH.md
@supabase/functions/payment-webhook/index.ts
@supabase/functions/create-payment-intent/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade payment-webhook for OXXO lifecycle</name>
  <files>supabase/functions/payment-webhook/index.ts</files>
  <action>
Make 4 specific changes to payment-webhook/index.ts:

**Change 1: New handlePaymentIntentProcessing handler**
Add a new handler function after handlePaymentIntentFailed:
```typescript
async function handlePaymentIntentProcessing(
  event: Record<string, unknown>,
): Promise<HandlerResult> {
  const pi = (event.data as Record<string, unknown>)?.object as Record<string, unknown>;
  const piId = pi.id as string;

  const { error } = await supabase
    .from("payment_intents")
    .update({ status: "processing" })
    .eq("stripe_payment_intent_id", piId);

  if (error) {
    console.error(`Failed to update payment_intent to processing for ${piId}:`, error);
    return { success: false, error: error.message };
  }

  return { success: true };
}
```
Add to the switch statement: `case "payment_intent.processing": result = await handlePaymentIntentProcessing(event); break;`

**Change 2: Upgrade handlePaymentIntentRequiresAction to store hosted_voucher_url**
In the existing handlePaymentIntentRequiresAction function, BEFORE the status update:
1. Extract the hosted_voucher_url from the Stripe event payload using the REST API path (server-side uses snake_case):
   ```typescript
   const nextAction = pi.next_action as Record<string, unknown> | undefined;
   const oxxoDetails = nextAction?.oxxo_display_details as Record<string, unknown> | undefined;
   const hostedVoucherUrl = oxxoDetails?.hosted_voucher_url as string | undefined;
   ```
2. IMPORTANT: Fetch existing metadata first and MERGE (do NOT overwrite). This is critical because metadata already contains `stripe_created` and `payment_method_types` from create-payment-intent:
   ```typescript
   const { data: existingRecord } = await supabase
     .from("payment_intents")
     .select("metadata")
     .eq("stripe_payment_intent_id", piId)
     .single();

   const mergedMetadata = {
     ...((existingRecord?.metadata as Record<string, unknown>) ?? {}),
     ...(hostedVoucherUrl ? { hosted_voucher_url: hostedVoucherUrl } : {}),
   };
   ```
3. Update the existing `.update({ status: "requires_action" })` call to also include `metadata: mergedMetadata`.

**Change 3: Upgrade handlePaymentIntentFailed for OXXO expiry push notification**
After the existing status update to 'failed', add OXXO expiry push notification logic:
1. Look up the local payment_intent record to get payment_method_type and resident_id:
   ```typescript
   const { data: piRecord } = await supabase
     .from("payment_intents")
     .select("payment_method_type, resident_id")
     .eq("stripe_payment_intent_id", piId)
     .single();
   ```
2. If payment_method_type is 'oxxo' AND resident_id exists, look up the resident's user_id and send a push notification:
   ```typescript
   if (piRecord?.payment_method_type === "oxxo" && piRecord?.resident_id) {
     try {
       const { data: resident } = await supabase
         .from("residents")
         .select("user_id")
         .eq("id", piRecord.resident_id)
         .maybeSingle();

       if (resident?.user_id) {
         await supabase.functions.invoke("send-push", {
           body: {
             user_id: resident.user_id,
             title: "Voucher OXXO expirado",
             body: "Tu voucher OXXO ha expirado. Genera uno nuevo para pagar.",
           },
         });
       }
     } catch (pushErr) {
       console.warn(`OXXO expiry push notification error for ${piId}:`, pushErr);
     }
   }
   ```
   Wrap in try/catch like the existing push in handlePaymentIntentSucceeded (non-critical).

**Change 4: Differentiate OXXO vs card description in handlePaymentIntentSucceeded**
In handlePaymentIntentSucceeded, before the record_payment RPC call, look up the local payment_intent record's payment_method_type:
```typescript
const { data: localPi } = await supabase
  .from("payment_intents")
  .select("payment_method_type")
  .eq("stripe_payment_intent_id", piId)
  .single();

const paymentDescription = localPi?.payment_method_type === "oxxo"
  ? `Pago OXXO via Stripe - ${piId}`
  : `Pago con tarjeta via Stripe - ${piId}`;
```
Replace the hardcoded `p_description: \`Pago con tarjeta via Stripe - ${piId}\`` with `p_description: paymentDescription`.
  </action>
  <verify>
    Read the updated file and confirm:
    1. handlePaymentIntentProcessing function exists and is wired into the switch
    2. handlePaymentIntentRequiresAction fetches existing metadata and merges hosted_voucher_url
    3. handlePaymentIntentFailed checks payment_method_type === 'oxxo' before sending expiry push
    4. handlePaymentIntentSucceeded uses dynamic description based on payment_method_type
    5. No syntax errors (the file is TypeScript for Deno, cannot run locally, but structure should be valid)
  </verify>
  <done>
    All 4 webhook changes implemented: processing handler, requires_action metadata merge, failed OXXO push, succeeded description differentiation. Switch statement routes payment_intent.processing to new handler.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add OXXO description in create-payment-intent</name>
  <files>supabase/functions/create-payment-intent/index.ts</files>
  <action>
This is a minor change. In create-payment-intent/index.ts, the `description` field comes from the client request body and is stored in both the Stripe PI and the local payment_intents record. No change is needed here because the description is passed from the mobile client.

However, verify that the edge function already handles OXXO correctly:
- `payment_method_types: ['oxxo']` when payment_method_type is 'oxxo' (line ~290) - ALREADY DONE
- `expires_after_days: 2` for OXXO (line ~301-303) - ALREADY DONE
- `expires_at` calculation for OXXO (line ~313-316) - ALREADY DONE

The only change: The webhook's handlePaymentIntentSucceeded generates its own description for record_payment (addressed in Task 1). The create-payment-intent edge function description is for Stripe's dashboard display only and the mobile client already sends the appropriate description.

If the edge function is fully correct as-is for OXXO, simply confirm this in the SUMMARY. No code changes needed to this file.
  </action>
  <verify>
    Read create-payment-intent/index.ts and confirm:
    1. OXXO payment_method_type is validated (line ~110)
    2. payment_method_types array correctly set for OXXO (line ~290)
    3. OXXO-specific payment_method_options with expires_after_days (line ~300-304)
    4. expires_at calculated for OXXO (line ~313-316)
    All OXXO-specific backend logic already exists.
  </verify>
  <done>
    create-payment-intent edge function confirmed to already support OXXO fully. No code changes needed. Description differentiation is handled in the webhook (Task 1).
  </done>
</task>

</tasks>

<verification>
1. Read payment-webhook/index.ts end-to-end and confirm all 4 changes are present
2. Verify handlePaymentIntentProcessing is in the switch statement
3. Verify JSONB merge pattern in handlePaymentIntentRequiresAction (must fetch existing metadata first)
4. Verify OXXO expiry push is wrapped in try/catch and only fires for payment_method_type === 'oxxo'
5. Verify description in handlePaymentIntentSucceeded uses conditional based on payment_method_type
6. Confirm create-payment-intent already supports OXXO (no changes needed)
</verification>

<success_criteria>
- payment-webhook has 6 event handlers (succeeded, failed, canceled, requires_action, processing, charge.refunded)
- requires_action handler stores hosted_voucher_url via JSONB merge
- failed handler sends OXXO-specific expiry push notification
- succeeded handler uses "Pago OXXO via Stripe" for OXXO payments, "Pago con tarjeta via Stripe" for card
- processing handler updates status to 'processing'
</success_criteria>

<output>
After completion, create `.planning/phases/04-oxxo-payments/04-01-SUMMARY.md`
</output>
