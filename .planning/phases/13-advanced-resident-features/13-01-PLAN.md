---
phase: 13-advanced-resident-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/NEW_fix_resident_rls_policies.sql
  - packages/shared/src/queries/keys.ts
  - packages/mobile/app/(resident)/community/_layout.tsx
  - packages/mobile/app/(resident)/community/index.tsx
  - packages/mobile/app/(resident)/community/post/create.tsx
  - packages/mobile/app/(resident)/community/post/[id].tsx
  - packages/mobile/src/hooks/usePosts.ts
  - packages/mobile/src/components/posts/PostCard.tsx
  - packages/mobile/src/components/posts/CommentItem.tsx
  - packages/mobile/src/components/posts/ReactionBar.tsx
autonomous: true

must_haves:
  truths:
    - "Resident can see the community social wall feed with posts from all channels"
    - "Resident can create a new post in a selected channel with text and optional media"
    - "Resident can react to a post (toggle like) and see reaction counts"
    - "Resident can view a post's comments and add a new comment"
    - "Resident can vote in inline polls on poll-type posts"
    - "RLS policies correctly resolve resident_id for all Phase 13 tables"
  artifacts:
    - path: "packages/shared/src/queries/keys.ts"
      provides: "posts, marketplace, vehicles, elections query key factories"
      contains: "createQueryKeys('posts'"
    - path: "packages/mobile/app/(resident)/community/index.tsx"
      provides: "Social wall feed with channel tabs and post list"
      min_lines: 60
    - path: "packages/mobile/src/hooks/usePosts.ts"
      provides: "useChannels, usePosts, usePostDetail, useCreatePost, useToggleReaction, useCreateComment hooks"
      min_lines: 100
    - path: "packages/mobile/src/components/posts/PostCard.tsx"
      provides: "Post card with author, content, media, reactions, comment count"
      min_lines: 40
  key_links:
    - from: "community/index.tsx"
      to: "usePosts.ts"
      via: "useChannels() and usePosts(channelId)"
      pattern: "useChannels|usePosts"
    - from: "usePosts.ts"
      to: "supabase"
      via: "supabase.from('posts') and supabase.from('channels')"
      pattern: "from\\('posts'\\)|from\\('channels'\\)"
    - from: "PostCard.tsx"
      to: "ReactionBar.tsx"
      via: "ReactionBar component rendered per post"
      pattern: "ReactionBar"
---

<objective>
Fix the critical RLS identity mismatch affecting all Phase 13 tables, add missing query key factories, create the community tab route group, and build the social wall feature with posts, reactions, comments, and inline polls.

Purpose: This plan unblocks all other Phase 13 plans by fixing the resident_id RLS mismatch and adding query keys. It also delivers the social wall -- the primary community engagement feature.
Output: Working social wall feed under the Community tab, with post creation, reactions, comments, and poll voting.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-advanced-resident-features/13-RESEARCH.md

Key references:
- @packages/shared/src/queries/keys.ts (add posts, marketplace, vehicles, elections factories)
- @packages/mobile/app/(resident)/_layout.tsx (community tab already declared)
- @packages/mobile/app/(resident)/visitors/_layout.tsx (Stack layout pattern to follow)
- @packages/mobile/src/hooks/useAuth.ts (residentId from JWT app_metadata)
- @packages/mobile/src/hooks/useOccupancy.ts (useResidentUnit for unitId)
- @packages/mobile/src/lib/upload.ts (pickAndUploadImage for post media)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix RLS policies + add query key factories</name>
  <files>
    packages/shared/src/queries/keys.ts
  </files>
  <action>
**Part A: Fix RLS policies via Supabase MCP migration.**

Apply a migration named `fix_resident_rls_identity_mismatch` that fixes all RLS policies using `resident_id = auth.uid()` (or `seller_id = auth.uid()`, `voted_by = auth.uid()`, `author_id = ...auth.uid()`) to use the correct subquery pattern. The fix for each policy: replace `auth.uid()` comparisons on resident/seller/author/voted_by columns with `(SELECT r.id FROM public.residents r WHERE r.user_id = auth.uid() AND r.deleted_at IS NULL LIMIT 1)`.

Policies to fix (from research Pitfall 1):
- `post_reactions.users_manage_own_reactions`: `resident_id = auth.uid()` -> subquery
- `vehicles.users_manage_own_vehicles`: `resident_id = auth.uid()` -> subquery
- `emergency_contacts.emergency_contacts_*_own`: `resident_id = auth.uid()` -> subquery (check exact policy names by inspecting table)
- `marketplace_listings.sellers_*_own_listings`: `seller_id = auth.uid()` -> subquery
- `marketplace_listings.users_create_listings`: `seller_id = auth.uid()` -> subquery
- `reservations.users_view_own_reservations`: `resident_id = auth.uid()` -> subquery
- `reservations.residents_cancel_own_reservations`: `resident_id = auth.uid()` -> subquery
- `regulation_signatures.residents_view_own_signatures`: `resident_id = auth.uid()` -> subquery
- `packages.residents_view_unit_packages`: `occupancies.resident_id = auth.uid()` -> subquery
- `package_pickup_codes.residents_view_own_pickup_codes`: `occupancies.resident_id = auth.uid()` -> subquery
- `reservation_waitlist.residents_manage_own_waitlist`: `resident_id = auth.uid()` -> subquery
- `ballots.voters_insert_own_ballot`: `voted_by = auth.uid()` -> subquery
- `ballots.voters_see_own_ballots`: `voted_by = auth.uid()` -> subquery
- `posts.authors_manage_own_posts`: fix the broken `residents.id = auth.uid()` subquery
- `post_comments.authors_manage_comments`: fix the broken pattern

For each policy: DROP POLICY IF EXISTS ... ON table; CREATE POLICY ... ON table using the corrected WHERE clause. Inspect each table's current policies via MCP before writing the migration to get exact policy names and FOR clauses (SELECT, INSERT, UPDATE, DELETE).

**Part B: Add query key factories to shared/queries/keys.ts.**

Add four new query key factories (posts, marketplace, vehicles, elections) and update the mergeQueryKeys call:

```typescript
export const posts = createQueryKeys('posts', {
  all: null,
  list: (communityId: string) => [{ communityId }],
  detail: (id: string) => [id],
  comments: (postId: string) => [{ postId }],
});

export const marketplace = createQueryKeys('marketplace', {
  all: null,
  list: (communityId: string) => [{ communityId }],
  detail: (id: string) => [id],
  myListings: (residentId: string) => [{ residentId }],
});

export const vehicles = createQueryKeys('vehicles', {
  all: null,
  list: (residentId: string) => [{ residentId }],
  detail: (id: string) => [id],
});

export const elections = createQueryKeys('elections', {
  all: null,
  list: (communityId: string) => [{ communityId }],
  detail: (id: string) => [id],
  results: (id: string) => [{ id }],
});
```

Update `mergeQueryKeys(...)` to include `posts, marketplace, vehicles, elections`.
  </action>
  <verify>
Run `npx tsc --noEmit` in packages/shared to verify types compile. Verify the migration was applied via Supabase MCP by querying one of the fixed policies (e.g., `SELECT polname, polqual FROM pg_policy WHERE polrelid = 'public.post_reactions'::regclass`).
  </verify>
  <done>All 15+ broken RLS policies fixed with correct resident subquery pattern. Query key factories for posts, marketplace, vehicles, and elections added and exported from shared package.</done>
</task>

<task type="auto">
  <name>Task 2: Community tab layout + social wall feed with channel tabs</name>
  <files>
    packages/mobile/app/(resident)/community/_layout.tsx
    packages/mobile/app/(resident)/community/index.tsx
    packages/mobile/app/(resident)/community/post/create.tsx
    packages/mobile/app/(resident)/community/post/[id].tsx
    packages/mobile/src/hooks/usePosts.ts
    packages/mobile/src/components/posts/PostCard.tsx
    packages/mobile/src/components/posts/CommentItem.tsx
    packages/mobile/src/components/posts/ReactionBar.tsx
  </files>
  <action>
**Create community tab Stack layout** following the visitors/_layout.tsx pattern:
- `community/_layout.tsx`: Stack with screens for index, post/create, post/[id], amenities/index, amenities/[id], amenities/reserve, reservations/index, reservations/[id]. Set `headerShown: false` in screenOptions.

**Create usePosts.ts hooks file** with these hooks:
1. `useChannels()` - Fetch active channels for the community. Query `channels` table filtered by `community_id`, `status = 'active'`, `deleted_at IS NULL`, ordered by `sort_order`.
2. `usePosts(channelId?: string | null)` - Fetch posts feed. Query `posts` with join to `channels` and `residents` (via `posts_author_id_fkey`). Filter by `community_id`, `deleted_at IS NULL`, `is_hidden = false`. If channelId provided, filter by it. Order by `is_pinned DESC, created_at DESC`. Limit 50.
3. `usePostDetail(postId: string)` - Fetch single post with comments. Query `posts` by id with join to author resident. Then separate query for `post_comments` where `post_id = postId`, `deleted_at IS NULL`, `is_hidden = false`, ordered by `created_at ASC`, with join to author resident.
4. `useCreatePost()` - Mutation to insert into `posts`. Use `residentId` from `useAuth()` as `author_id`, `communityId` as `community_id`. Accepts `channel_id`, `post_type`, `title`, `content`, `media_urls`, `poll_options`, `poll_ends_at`. Invalidate posts queries on success.
5. `useToggleReaction()` - Toggle reaction using the check-delete-or-insert pattern from research. Check `post_reactions` for existing reaction by `post_id + resident_id`, delete if exists, insert if not. The reaction_counts jsonb on the post is auto-updated by the `update_reaction_counts` trigger. Use `residentId` from useAuth. Invalidate posts on success.
6. `useCreateComment()` - Mutation to insert into `post_comments`. Use `residentId` as `author_id`. Accepts `post_id`, `content`, `parent_comment_id` (optional for threading). Invalidate post detail queries on success.
7. `useVotePoll(postId: string)` - Mutation to update `posts.poll_results` by incrementing the selected option count. This is a simple client-side poll on the posts table (NOT the elections/cast_vote system). Use `.rpc()` or direct update as appropriate.

All hooks: import `supabase` from `@/lib/supabase`, `queryKeys` from `@upoe/shared`, `useAuth` from `@/hooks/useAuth`.

**Create PostCard.tsx component:**
- Display: author avatar (photo_url) + name, relative timestamp (date-fns formatDistanceToNow with `{ locale: es }`), channel badge (icon + name), post content (text), media gallery (if media_urls), poll widget (if post_type = 'poll'), ReactionBar, comment count with tap to navigate to detail.
- Tap on post navigates to `community/post/[id]`.
- For polls: show options with vote counts, highlight user's vote if any, allow voting if poll_ends_at > now.

**Create ReactionBar.tsx component:**
- Show reaction counts from `reaction_counts` jsonb (keys are emoji types, values are counts).
- Heart/like toggle button that calls `useToggleReaction`.
- Show total reaction count.

**Create CommentItem.tsx component:**
- Display author name, avatar, relative time, comment content.
- Indent threaded comments based on `depth` field.
- Reply button that opens comment creation with `parent_comment_id` set.

**Create community/index.tsx (social wall feed):**
- Horizontal ScrollView with channel filter chips (pattern from research Pattern 3). "Todos" chip for all channels, then one chip per channel with icon.
- FlatList of PostCard items below the channel tabs.
- FAB (floating action button) to navigate to `community/post/create`.
- RefreshControl for pull-to-refresh.
- EmptyState when no posts.

**Create community/post/create.tsx:**
- Channel selection (dropdown or horizontal chips from channels list).
- Post type selector (discussion, question, event, poll).
- Title input (optional for discussion, required for event).
- Content TextInput (multiline).
- Media picker button (uses pickAndUploadImage from `@/lib/upload` to upload to `community-assets` bucket with path `{communityId}/posts/{filename}`).
- Poll options builder (if post_type = 'poll'): add/remove option inputs, poll end date picker.
- Submit button calling useCreatePost, navigate back on success.

**Create community/post/[id].tsx (post detail):**
- Full post content at top (expanded, not truncated).
- Poll widget (if poll type) with vote interaction.
- ReactionBar.
- Comment list (FlatList of CommentItem).
- Comment input at bottom (TextInput + send button), calls useCreateComment.
- Support reply-to-comment (sets parent_comment_id).
  </action>
  <verify>
Run `npx tsc --noEmit` in packages/mobile. Verify community tab appears in resident navigation. Verify `community/index.tsx` renders without crash by checking for compilation errors. Verify files exist: `community/_layout.tsx`, `community/index.tsx`, `community/post/create.tsx`, `community/post/[id].tsx`, `usePosts.ts`, `PostCard.tsx`, `CommentItem.tsx`, `ReactionBar.tsx`.
  </verify>
  <done>Community tab shows social wall feed with channel tabs. Resident can browse posts, create new posts with media and polls, react to posts, view comments, and add comments. All post hooks wired to Supabase via PostgREST with correct resident_id from JWT.</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes in both packages/shared and packages/mobile
2. Community tab visible in resident tab bar
3. Social wall feed loads posts from the community with channel filtering
4. Post creation flow works (channel selection, content, media upload, poll options)
5. Reaction toggle updates the reaction count on the post card
6. Post detail shows comments and allows adding new comments
7. RLS policies correctly resolve resident identity for direct table queries
</verification>

<success_criteria>
- Social wall feed renders posts with author info, content, media, reactions, and comment counts
- Channel filter tabs work to filter posts by channel
- Post creation inserts a new post visible in the feed
- Reaction toggle correctly adds/removes reactions per user
- Comments can be viewed and created on post detail screen
- All 15+ broken RLS policies fixed and verified
- Query key factories for posts, marketplace, vehicles, elections available in shared package
</success_criteria>

<output>
After completion, create `.planning/phases/13-advanced-resident-features/13-01-SUMMARY.md`
</output>
