---
phase: 13-advanced-resident-features
plan: 04
type: execute
wave: 3
depends_on: ["13-03"]
files_modified:
  - packages/mobile/app/(resident)/more/marketplace/index.tsx
  - packages/mobile/app/(resident)/more/marketplace/create.tsx
  - packages/mobile/app/(resident)/more/marketplace/[id].tsx
  - packages/mobile/src/hooks/useMarketplace.ts
  - packages/mobile/src/components/marketplace/ListingCard.tsx
  - packages/mobile/src/components/marketplace/CategoryFilter.tsx
autonomous: true

must_haves:
  truths:
    - "Resident can browse approved marketplace listings filtered by category"
    - "Resident can create a new listing with photos, description, price, and category"
    - "Resident can view listing details and contact the seller via WhatsApp/SMS"
    - "Resident can view their own listings including pending-moderation ones"
    - "Resident can mark their own listing as sold"
  artifacts:
    - path: "packages/mobile/app/(resident)/more/marketplace/index.tsx"
      provides: "Marketplace browse screen with category tabs and listing grid"
      min_lines: 50
    - path: "packages/mobile/app/(resident)/more/marketplace/create.tsx"
      provides: "Listing creation form with photo upload and category selection"
      min_lines: 60
    - path: "packages/mobile/src/hooks/useMarketplace.ts"
      provides: "useMarketplaceListings, useMyListings, useCreateListing, useMarkAsSold, useListingDetail hooks"
      min_lines: 80
    - path: "packages/mobile/src/components/marketplace/ListingCard.tsx"
      provides: "Listing card with image, title, price, seller info"
      min_lines: 30
  key_links:
    - from: "marketplace/index.tsx"
      to: "useMarketplace.ts"
      via: "useMarketplaceListings(category) and useMyListings()"
      pattern: "useMarketplaceListings|useMyListings"
    - from: "marketplace/[id].tsx"
      to: "Linking.openURL"
      via: "WhatsApp/SMS deep link for seller contact"
      pattern: "whatsapp://|Linking\\.openURL"
    - from: "useMarketplace.ts"
      to: "supabase.rpc"
      via: "increment_listing_view_count and increment_listing_inquiry_count RPCs"
      pattern: "rpc\\('increment_listing_view_count'\\)|rpc\\('increment_listing_inquiry_count'\\)"
---

<objective>
Build the marketplace feature: listing creation with photo upload, community listing browsing with category filters, listing details with seller contact via WhatsApp/SMS, and listing management (mark as sold).

Purpose: The marketplace lets residents buy, sell, and trade within their community -- driving engagement and providing practical value. It uses the moderation flow (listings start as pending).
Output: Marketplace browse, create listing, listing detail with contact seller, and my listings management.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-advanced-resident-features/13-RESEARCH.md
@.planning/phases/13-advanced-resident-features/13-01-SUMMARY.md
@.planning/phases/13-advanced-resident-features/13-03-SUMMARY.md

Key references:
- @packages/mobile/app/(resident)/more/_layout.tsx (marketplace screens already declared by 13-03)
- @packages/shared/src/queries/keys.ts (marketplace key factory from 13-01)
- @packages/mobile/src/hooks/useAuth.ts (residentId, communityId)
- @packages/mobile/src/hooks/useOccupancy.ts (useResidentUnit for unitId)
- @packages/mobile/src/lib/upload.ts (pickAndUploadImage for listing photos)

Critical pitfalls from research:
- INSERT policy enforces moderation_status = 'pending' -- always set this on insert
- SELECT policy users_view_approved_listings only shows approved+not-sold listings
- sellers_view_own_listings lets resident see their own regardless of status
- Use 'as never' cast for enum values (category, moderation_status)
- Contact seller via Linking.openURL with WhatsApp/SMS (no in-app messaging)
- queue_listing_for_moderation trigger auto-creates moderation_queue entry on INSERT
- increment_listing_view_count and increment_listing_inquiry_count are fire-and-forget RPCs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Marketplace hooks and components</name>
  <files>
    packages/mobile/src/hooks/useMarketplace.ts
    packages/mobile/src/components/marketplace/ListingCard.tsx
    packages/mobile/src/components/marketplace/CategoryFilter.tsx
  </files>
  <action>
**Create useMarketplace.ts** with these hooks:

1. `useMarketplaceListings(category?: string)` - Query `marketplace_listings` for the community. Select: id, category, title, description, price, price_negotiable, image_urls, view_count, inquiry_count, created_at, expires_at, plus seller join via `residents!marketplace_listings_seller_id_fkey(first_name, paternal_surname, photo_url, phone)`. Filter: community_id, `moderation_status = 'approved' as never`, `is_sold = false`, `deleted_at IS NULL`, `expires_at > now`. If category provided, filter by `category = category as never`. Order by created_at DESC. Query key: `[...queryKeys.marketplace.list(communityId!).queryKey, category]`.

2. `useMyListings()` - Query `marketplace_listings` where `seller_id = residentId`. This uses the `sellers_view_own_listings` RLS policy which shows all statuses. Select same fields as above. Order by created_at DESC. Query key: `queryKeys.marketplace.myListings(residentId!)`.

3. `useListingDetail(listingId: string)` - Query single listing by id with seller join (including phone for contact). Fire-and-forget `supabase.rpc('increment_listing_view_count', { p_listing_id: listingId })` on fetch. Query key: `queryKeys.marketplace.detail(listingId)`.

4. `useCreateListing()` - Mutation to insert into `marketplace_listings`. Fields: community_id (communityId!), seller_id (residentId!), unit_id (unitId from useResidentUnit, optional), category (as never), title, description, price (optional), price_negotiable (default false), image_urls (array of uploaded paths), moderation_status ('pending' as never -- REQUIRED by RLS). Invalidate marketplace queries on success.

5. `useMarkAsSold(listingId: string)` - Mutation to update `marketplace_listings` set `is_sold = true`, `sold_at = new Date().toISOString()` where `id = listingId`. Invalidate marketplace queries on success.

6. `useDeleteListing()` - Mutation to soft-delete: update `marketplace_listings` set `deleted_at = new Date().toISOString()` by id. Invalidate marketplace queries.

**Helper function** `handleContactSeller(sellerPhone: string, listingTitle: string, listingId: string)`:
- Construct WhatsApp URL: `whatsapp://send?phone=${sellerPhone}&text=${encodeURIComponent(message)}`
- Message: `Hola! Me interesa tu publicacion: "${listingTitle}" en UPOE Marketplace`
- Fall back to SMS: `sms:${sellerPhone}?body=${encodeURIComponent(message)}`
- Fire-and-forget: `supabase.rpc('increment_listing_inquiry_count', { p_listing_id: listingId })`
- Use `Linking.canOpenURL` for WhatsApp check, fallback to SMS.

**Create ListingCard.tsx component:**
- Card with listing image (first from image_urls or placeholder), title, price (formatted as currency or "Gratis" if no price), category badge (sale, service, rental, wanted), seller name, relative time (date-fns formatDistanceToNow with locale es), price_negotiable indicator.
- Tap navigates to `more/marketplace/[id]`.
- If resident is the seller (compare seller_id === residentId), show moderation_status badge: pending=orange, approved=green, rejected=red.

**Create CategoryFilter.tsx component:**
- Horizontal ScrollView of category chips: "Todos", "Venta", "Servicio", "Renta", "Buscado".
- Mapped values: null, 'sale', 'service', 'rental', 'wanted'.
- Active chip highlighted in blue, inactive in gray border.
- Props: `selectedCategory`, `onCategoryChange(category: string | null)`.
  </action>
  <verify>
Run `npx tsc --noEmit` in packages/mobile. Verify useMarketplace.ts exports all 6 hooks + handleContactSeller. Verify ListingCard.tsx and CategoryFilter.tsx exist and compile.
  </verify>
  <done>All marketplace hooks created with correct RLS awareness (pending on insert, approved for browse, own listings for seller). ListingCard and CategoryFilter components ready for screens. Contact seller helper uses WhatsApp/SMS deep links.</done>
</task>

<task type="auto">
  <name>Task 2: Marketplace screens (browse, create, detail)</name>
  <files>
    packages/mobile/app/(resident)/more/marketplace/index.tsx
    packages/mobile/app/(resident)/more/marketplace/create.tsx
    packages/mobile/app/(resident)/more/marketplace/[id].tsx
  </files>
  <action>
**Create marketplace/index.tsx (Browse + My listings):**
- Two tabs at the top: "Comunidad" (approved community listings) and "Mis Publicaciones" (seller's own listings).
- CategoryFilter component below tabs (only shown for "Comunidad" tab).
- FlatList of ListingCard items in a 2-column grid layout.
- Uses `useMarketplaceListings(selectedCategory)` for community tab, `useMyListings()` for my tab.
- FAB button to navigate to `more/marketplace/create`.
- RefreshControl for pull-to-refresh.
- EmptyState: "No hay publicaciones en esta categoria" for community, "No has publicado nada aun" for my listings.
- For "Mis Publicaciones" tab, show moderation_status badge on each listing (pending=orange "En revision", approved=green "Aprobado", rejected=red "Rechazado").

**Create marketplace/create.tsx (Create listing):**
- Form fields:
  - Category picker (required): Pressable chips for sale, service, rental, wanted. Use `as never` cast on selected value.
  - Title (required): TextInput, max 100 chars.
  - Description (required): TextInput multiline, max 500 chars.
  - Price (optional): TextInput numeric. Show "Gratis" toggle if no price.
  - Price negotiable: Switch toggle.
  - Photos (optional, up to 5): Image picker grid. Each slot is tappable to add photo via `pickAndUploadImage` from `@/lib/upload`. Upload to `community-assets` bucket with path `{communityId}/marketplace/{filename}`. Show thumbnails of selected photos with X to remove.
- Submit button: "Publicar" calls `useCreateListing()`.
- On success: Alert "Tu publicacion esta en revision. Sera visible cuando un administrador la apruebe." Navigate back to marketplace index.
- Validate: category required, title required (min 3 chars), description required (min 10 chars).

**Create marketplace/[id].tsx (Listing detail):**
- Uses `useListingDetail(id)`.
- Photo gallery: horizontal ScrollView of full-width images (from image_urls), with page indicator dots.
- Title (large), price (prominent, currency formatted), category badge, price_negotiable tag.
- Seller section: avatar, name, "Contactar vendedor" button.
- Description section.
- Details: view_count, inquiry_count, created_at (relative time), expires_at.
- **Contact seller button:**
  - Calls `handleContactSeller()` from useMarketplace.ts.
  - Button text: "Contactar por WhatsApp" with WhatsApp icon.
  - Only shown if current user is NOT the seller.
- **Seller's own listing actions** (shown if seller_id === residentId):
  - "Marcar como vendido" button -> confirmation Alert -> calls `useMarkAsSold()`.
  - "Eliminar publicacion" button -> confirmation Alert -> calls `useDeleteListing()`.
  - Moderation status badge shown prominently.
- If listing is sold: show "VENDIDO" overlay/banner on the detail page.
  </action>
  <verify>
Run `npx tsc --noEmit` in packages/mobile. Verify all 3 route files exist under more/marketplace/. Check that imports from useMarketplace.ts resolve correctly. Verify Linking import from react-native is present in [id].tsx.
  </verify>
  <done>Marketplace browse shows community listings filtered by category in a grid. My listings tab shows seller's own with moderation status. Create listing form supports photo upload, category selection, and pricing. Listing detail shows full info with WhatsApp contact button for buyers and sell/delete actions for sellers. Moderation status clearly communicated to sellers.</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes in packages/mobile
2. Marketplace accessible from More tab menu
3. Community listings display in grid with category filter
4. My listings show all statuses including pending moderation
5. Listing creation uploads photos and inserts with pending status
6. Success message explains moderation review process
7. Listing detail shows photos, price, description, seller
8. Contact seller opens WhatsApp (or SMS fallback) with pre-filled message
9. Seller can mark own listing as sold
10. View and inquiry counts increment via RPCs
</verification>

<success_criteria>
- Marketplace browse shows approved community listings with category filtering
- Listing creation form validates, uploads photos, and creates with pending moderation status
- Clear user messaging about moderation review after listing creation
- Listing detail displays all info with photo gallery and seller contact
- Contact seller via WhatsApp/SMS with pre-filled message works
- Seller can mark as sold and delete own listings
- My listings tab shows all seller's listings with moderation status badges
</success_criteria>

<output>
After completion, create `.planning/phases/13-advanced-resident-features/13-04-SUMMARY.md`
</output>
