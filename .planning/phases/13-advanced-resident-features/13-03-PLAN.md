---
phase: 13-advanced-resident-features
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - packages/mobile/app/(resident)/more/_layout.tsx
  - packages/mobile/app/(resident)/more/index.tsx
  - packages/mobile/app/(resident)/more/profile/index.tsx
  - packages/mobile/app/(resident)/more/profile/unit.tsx
  - packages/mobile/app/(resident)/more/vehicles/index.tsx
  - packages/mobile/app/(resident)/more/vehicles/create.tsx
  - packages/mobile/app/(resident)/more/documents/index.tsx
  - packages/mobile/app/(resident)/more/documents/[id].tsx
  - packages/mobile/app/(resident)/more/packages/index.tsx
  - packages/mobile/src/hooks/useDocuments.ts
  - packages/mobile/src/hooks/useProfile.ts
  - packages/mobile/src/hooks/useVehicles.ts
  - packages/mobile/src/hooks/useMyPackages.ts
  - packages/mobile/src/components/documents/DocumentCard.tsx
  - packages/mobile/src/components/documents/SignatureModal.tsx
autonomous: true

must_haves:
  truths:
    - "Resident can view accessible documents organized by category"
    - "Resident can view a document and sign regulations via capture_signature() RPC"
    - "Resident can edit their profile (phone, photo) and view emergency contacts"
    - "Resident can view their unit assignment and occupancy details"
    - "Resident can manage vehicles (list, add, edit, delete)"
    - "Resident can view their packages with pickup codes"
  artifacts:
    - path: "packages/mobile/app/(resident)/more/_layout.tsx"
      provides: "Stack layout for more tab with all sub-screens"
      min_lines: 15
    - path: "packages/mobile/app/(resident)/more/index.tsx"
      provides: "Menu screen linking to profile, vehicles, documents, marketplace, packages"
      min_lines: 30
    - path: "packages/mobile/src/hooks/useDocuments.ts"
      provides: "useMyDocuments, usePendingSignatures, useSignDocument hooks"
      min_lines: 60
    - path: "packages/mobile/src/hooks/useVehicles.ts"
      provides: "useMyVehicles, useCreateVehicle, useUpdateVehicle, useDeleteVehicle hooks"
      min_lines: 60
    - path: "packages/mobile/src/components/documents/SignatureModal.tsx"
      provides: "Modal with consent text and sign button calling capture_signature RPC"
      min_lines: 40
  key_links:
    - from: "documents/[id].tsx"
      to: "SignatureModal.tsx"
      via: "SignatureModal rendered for regulation documents"
      pattern: "SignatureModal"
    - from: "useDocuments.ts"
      to: "supabase.rpc"
      via: "get_accessible_documents and capture_signature RPCs"
      pattern: "rpc\\('get_accessible_documents'\\)|rpc\\('capture_signature'\\)"
    - from: "useVehicles.ts"
      to: "supabase.from('vehicles')"
      via: "Direct table CRUD queries"
      pattern: "from\\('vehicles'\\)"
---

<objective>
Build the "More" tab with profile management, document viewing with regulation signing, vehicle CRUD, unit details, and package notification viewing.

Purpose: Residents need to manage their personal information, review community documents, sign required regulations, manage vehicles registered for access control, and track their packages -- all core resident self-service features.
Output: More tab menu with profile editor, unit viewer, vehicle list with add/edit, document browser with signing, and package list with pickup codes.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-advanced-resident-features/13-RESEARCH.md
@.planning/phases/13-advanced-resident-features/13-01-SUMMARY.md

Key references:
- @packages/mobile/app/(resident)/_layout.tsx (more tab already declared)
- @packages/mobile/app/(resident)/visitors/_layout.tsx (Stack layout pattern)
- @packages/shared/src/queries/keys.ts (vehicles, documents key factories from 13-01)
- @packages/mobile/src/hooks/useAuth.ts (residentId, communityId)
- @packages/mobile/src/hooks/useOccupancy.ts (useResidentOccupancy for unit details)
- @packages/mobile/src/hooks/usePackages.ts (existing hook - check if already covers resident needs)
- @packages/mobile/src/lib/upload.ts (pickAndUploadImage for profile photo)

Critical pitfalls from research:
- capture_signature() requires 7+ params including ip_address, user_agent, consent_text
- regulation_signatures are immutable (prevent_signature_modification trigger)
- Use get_accessible_documents() RPC for document listing (handles permissions)
- Use get_pending_signatures() RPC for documents needing signature
- Document schema uses name/is_public/category (enum), NOT title/visibility/free-text
</context>

<tasks>

<task type="auto">
  <name>Task 1: More tab layout + hooks (documents, profile, vehicles, packages)</name>
  <files>
    packages/mobile/app/(resident)/more/_layout.tsx
    packages/mobile/src/hooks/useDocuments.ts
    packages/mobile/src/hooks/useProfile.ts
    packages/mobile/src/hooks/useVehicles.ts
    packages/mobile/src/hooks/useMyPackages.ts
  </files>
  <action>
**Create more/_layout.tsx** following visitors/_layout.tsx pattern:
Stack with screens for: index, profile/index, profile/unit, vehicles/index, vehicles/create, documents/index, documents/[id], marketplace/index, marketplace/create, marketplace/[id], packages/index. Set `headerShown: false`.

**Create useDocuments.ts** with these hooks:

1. `useMyDocuments()` - Call `supabase.rpc('get_accessible_documents', { p_user_id: residentId })` where `residentId` is from useAuth(). NOTE: verify parameter name -- the RPC might use a different param name. Inspect via Supabase MCP if needed. Returns documents the resident can access. Query key: `queryKeys.documents.list(communityId!)`.

2. `usePendingSignatures()` - Call `supabase.rpc('get_pending_signatures')`. No params needed -- it resolves the resident from auth context. Returns documents requiring signature that the current resident hasn't signed.

3. `useDocumentDetail(documentId: string)` - Query `community_documents` by id with join to latest `document_versions` (order by version_number DESC, limit 1). Also check if current resident has signed: query `regulation_signatures` where `document_id = documentId` and `resident_id = residentId`.

4. `useSignDocument()` - Mutation calling `supabase.rpc('capture_signature', {...})`. Parameters:
   - `p_document_id`: from input
   - `p_document_version_id`: from input
   - `p_signature_type`: 'click'
   - `p_signature_data`: null
   - `p_ip_address`: '0.0.0.0' (mobile doesn't easily get public IP)
   - `p_user_agent`: `UPOE-Mobile/${Platform.OS}`
   - `p_consent_text`: from input (the consent text shown in the modal)
   - `p_device_type`: use Platform to determine 'phone' or 'tablet'
   - `p_os`: `${Platform.OS} ${Platform.Version}`
   - `p_screen_resolution`: `${width}x${height}` from Dimensions.get('window')
   - `p_device_model`: null (avoid expo-device dependency -- use Platform if available)

   Import Platform and Dimensions from 'react-native'. Invalidate documents queries on success.

**Create useProfile.ts** with these hooks:

1. `useResidentProfile()` - Query `residents` by id (residentId from useAuth). Select: first_name, paternal_surname, maternal_surname, email, phone, phone_secondary, photo_url, resident_type, status. Also fetch `emergency_contacts` where `resident_id = residentId`, `deleted_at IS NULL`.

2. `useUpdateProfile()` - Mutation to update `residents` by id. Accepts partial: phone, phone_secondary, photo_url. Invalidate residents queries on success.

3. `useUpdateEmergencyContact()` - Mutation to upsert `emergency_contacts`. Insert or update based on whether contact exists. Fields: resident_id, name, phone, relationship, is_primary. Invalidate residents queries.

**Create useVehicles.ts** with these hooks:

1. `useMyVehicles()` - Query `vehicles` where `resident_id = residentId`, `deleted_at IS NULL`. Select: id, plate_number, make, model, color, vehicle_type, year, is_primary, status. Order by is_primary DESC, created_at DESC. Query key: `queryKeys.vehicles.list(residentId!)`.

2. `useCreateVehicle()` - Mutation to insert into `vehicles`. Fields: community_id, resident_id (residentId!), plate_number, make, model, color, vehicle_type, year, is_primary. Invalidate vehicles queries.

3. `useUpdateVehicle()` - Mutation to update `vehicles` by id. Partial fields: make, model, color, vehicle_type, year, is_primary. Invalidate vehicles queries.

4. `useDeleteVehicle()` - Mutation to soft-delete: update `vehicles` set `deleted_at = new Date().toISOString()` by id. Invalidate vehicles queries.

**Create/update useMyPackages.ts** (check if existing usePackages.ts covers this):
- If usePackages.ts already has hooks for resident-facing package queries, skip this file and use existing hooks.
- Otherwise, create `useMyPackages()` - Query `packages` for the resident's unit(s). Join through `occupancies` where `resident_id = residentId`, then packages where `unit_id IN (resident's units)`. Select: id, tracking_number, carrier, description, status, received_at, picked_up_at, photo_url, plus `package_pickup_codes` join (code, expires_at, is_used). Filter: community_id, deleted_at IS NULL. Order by received_at DESC.

All hooks: import supabase from `@/lib/supabase`, queryKeys from `@upoe/shared`, useAuth from `@/hooks/useAuth`.
  </action>
  <verify>
Run `npx tsc --noEmit` in packages/mobile. Verify all 4 hook files exist and export the expected hooks. Verify more/_layout.tsx exists with all screen declarations.
  </verify>
  <done>More tab Stack layout created with all screen routes. Document hooks use get_accessible_documents and capture_signature RPCs. Profile hooks support read and update. Vehicle hooks provide full CRUD. Package hooks fetch unit packages with pickup codes.</done>
</task>

<task type="auto">
  <name>Task 2: More menu, profile, vehicles, documents, and packages screens</name>
  <files>
    packages/mobile/app/(resident)/more/index.tsx
    packages/mobile/app/(resident)/more/profile/index.tsx
    packages/mobile/app/(resident)/more/profile/unit.tsx
    packages/mobile/app/(resident)/more/vehicles/index.tsx
    packages/mobile/app/(resident)/more/vehicles/create.tsx
    packages/mobile/app/(resident)/more/documents/index.tsx
    packages/mobile/app/(resident)/more/documents/[id].tsx
    packages/mobile/app/(resident)/more/packages/index.tsx
    packages/mobile/src/components/documents/DocumentCard.tsx
    packages/mobile/src/components/documents/SignatureModal.tsx
  </files>
  <action>
**Create more/index.tsx (Menu screen):**
- Section list with menu items, each navigating to a sub-screen:
  - "Mi Perfil" (icon: person) -> `more/profile`
  - "Mi Unidad" (icon: home) -> `more/profile/unit`
  - "Mis Vehiculos" (icon: car) -> `more/vehicles`
  - "Documentos" (icon: document) -> `more/documents`
  - "Marketplace" (icon: shopping) -> `more/marketplace` (will be created in 13-04)
  - "Mis Paquetes" (icon: package) -> `more/packages`
- Show pending signature badge count next to "Documentos" if there are pending signatures (from `usePendingSignatures()`).
- Show resident name and unit at the top (from useAuth + useResidentUnit).
- "Cerrar Sesion" button at the bottom calling signOut from useAuth.

**Create more/profile/index.tsx (Profile editor):**
- Display current profile info: name (read-only), email (read-only), phone (editable), phone_secondary (editable), photo (tappable for change via pickAndUploadImage to `avatars` bucket).
- Save button calls `useUpdateProfile()` for phone/phone_secondary changes.
- Emergency contacts section below: list of contacts with name, phone, relationship. Edit button per contact opens inline edit form. "Add contact" button.
- Uses `useResidentProfile()` and `useUpdateEmergencyContact()`.

**Create more/profile/unit.tsx (Unit details):**
- Show unit information: unit_number, building, floor_number from `useResidentUnit()`.
- Show all occupancies for this resident from `useResidentOccupancy()`: occupancy_type badge (owner/tenant/family), status, start_date.
- Read-only view -- unit assignments are managed by admin.

**Create more/vehicles/index.tsx (Vehicle list):**
- FlatList of vehicle cards: plate_number (large), make + model, color circle, vehicle_type badge, year, is_primary star.
- "Agregar Vehiculo" button navigates to `more/vehicles/create`.
- Swipe-to-delete or delete button on each vehicle (calls useDeleteVehicle with confirmation Alert).
- Tap on vehicle opens inline edit (or navigate to edit screen -- use inline for simplicity).
- Uses `useMyVehicles()`.

**Create more/vehicles/create.tsx (Add vehicle):**
- Form fields: plate_number (required, uppercase), make (required), model (required), color, vehicle_type (picker: sedan, suv, pickup, van, motorcycle, bicycle, other), year (number), is_primary (switch).
- Submit button calls `useCreateVehicle()`. Navigate back on success.
- Validate plate_number is not empty.

**Create DocumentCard.tsx component:**
- Card with document name, category badge (regulation, policy, guideline, form, template, report, other), is_public indicator.
- If document requires signature: show "Firma requerida" badge in orange if unsigned, "Firmado" in green if signed.
- Tap navigates to `more/documents/[id]`.

**Create SignatureModal.tsx component:**
- Modal with document title, version info, consent text (hardcoded: "He leido y acepto el contenido de este documento").
- Checkbox for consent confirmation.
- "Firmar Documento" button (disabled until checkbox checked).
- Calls `useSignDocument()` on press. Shows loading state during RPC call.
- On success: close modal, show success toast/Alert.
- On error: show error message.

**Create more/documents/index.tsx (Document list):**
- Uses `useMyDocuments()` to fetch accessible documents.
- Grouped by category (use SectionList with category headers).
- Pending signatures section at top (from `usePendingSignatures()`) with orange highlight.
- FlatList/SectionList of DocumentCard items.
- RefreshControl for pull-to-refresh.

**Create more/documents/[id].tsx (Document detail):**
- Uses `useDocumentDetail(id)`.
- Show document name, category, description/content, file URL (download link if available via `Linking.openURL`), version info, upload date.
- If document is a regulation requiring signature: show signature status.
  - If not signed: show "Firma Requerida" section with SignatureModal trigger button.
  - If signed: show "Firmado" with signature date and checkmark.
- Download button that opens the document file URL (from document_versions.file_url) using `Linking.openURL`.

**Create more/packages/index.tsx (Package list):**
- Uses `useMyPackages()`.
- FlatList of package cards: tracking_number, carrier, description, status badge (received=yellow, notified=blue, picked_up=green), received_at, photo thumbnail.
- If package has pickup code: show code prominently with expiry date.
- Segmented tabs: "Pendientes" (status != 'picked_up') and "Recogidos" (status = 'picked_up').
- RefreshControl for pull-to-refresh.
  </action>
  <verify>
Run `npx tsc --noEmit` in packages/mobile. Verify all 8 route files exist. Verify 2 component files exist (DocumentCard.tsx, SignatureModal.tsx). Check that the more tab renders the menu screen without crash.
  </verify>
  <done>More tab menu navigates to all sub-sections. Profile editor updates phone and photo. Unit details show assignment info. Vehicle list supports add and delete. Document browser shows categorized documents with pending signatures highlighted. Regulation signing works via capture_signature RPC through SignatureModal. Package list shows deliveries with pickup codes.</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes in packages/mobile
2. More tab visible in resident tab bar, menu screen renders
3. Profile editor shows and updates phone/photo
4. Unit details display correctly from occupancies
5. Vehicle CRUD (add, list, delete) works against Supabase
6. Document list shows accessible documents grouped by category
7. Pending signatures highlighted with correct badge
8. Regulation signing via SignatureModal calls capture_signature RPC
9. Package list shows resident's packages with status and pickup codes
</verification>

<success_criteria>
- More tab menu links to all sub-sections (profile, unit, vehicles, documents, marketplace, packages)
- Profile phone/photo updates persist to database
- Vehicle list shows resident's vehicles, new vehicles can be added, existing deleted
- Documents load via get_accessible_documents RPC grouped by category
- Pending signatures shown prominently, signing via capture_signature RPC works
- Packages display with status badges and pickup codes
</success_criteria>

<output>
After completion, create `.planning/phases/13-advanced-resident-features/13-03-SUMMARY.md`
</output>
