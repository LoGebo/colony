---
phase: 13-advanced-resident-features
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - packages/mobile/app/(resident)/community/amenities/index.tsx
  - packages/mobile/app/(resident)/community/amenities/[id].tsx
  - packages/mobile/app/(resident)/community/amenities/reserve.tsx
  - packages/mobile/app/(resident)/community/reservations/index.tsx
  - packages/mobile/app/(resident)/community/reservations/[id].tsx
  - packages/mobile/src/hooks/useReservations.ts
  - packages/mobile/src/components/amenities/AmenityCard.tsx
  - packages/mobile/src/components/amenities/AvailabilityCalendar.tsx
  - packages/mobile/src/components/amenities/TimeSlotPicker.tsx
autonomous: true

must_haves:
  truths:
    - "Resident can browse a catalog of community amenities with photos and descriptions"
    - "Resident can view an amenity's availability calendar showing booked vs open slots"
    - "Resident can make a reservation for an amenity via create_reservation() RPC"
    - "Resident can view their reservations list with status badges"
    - "Resident can cancel a future reservation"
  artifacts:
    - path: "packages/mobile/app/(resident)/community/amenities/index.tsx"
      provides: "Amenity catalog grid with cards"
      min_lines: 40
    - path: "packages/mobile/app/(resident)/community/amenities/[id].tsx"
      provides: "Amenity detail with availability calendar"
      min_lines: 60
    - path: "packages/mobile/src/hooks/useReservations.ts"
      provides: "useAmenities, useAmenityDetail, useAmenityReservations, useCreateReservation, useMyReservations, useCancelReservation hooks"
      min_lines: 100
    - path: "packages/mobile/src/components/amenities/AvailabilityCalendar.tsx"
      provides: "Calendar component with date marking for booked/available"
      min_lines: 40
  key_links:
    - from: "amenities/[id].tsx"
      to: "useReservations.ts"
      via: "useAmenityDetail(id) and useAmenityReservations(id, date)"
      pattern: "useAmenityDetail|useAmenityReservations"
    - from: "amenities/reserve.tsx"
      to: "useReservations.ts"
      via: "useCreateReservation() calling create_reservation RPC"
      pattern: "useCreateReservation|create_reservation"
    - from: "AvailabilityCalendar.tsx"
      to: "react-native-calendars"
      via: "Calendar component import"
      pattern: "import.*Calendar.*react-native-calendars"
---

<objective>
Build the amenity reservation system: catalog browsing, availability calendar with react-native-calendars, reservation creation via create_reservation() RPC, reservation list, and cancellation.

Purpose: Residents can discover and reserve community amenities (pool, gym, event hall, BBQ area) with a visual calendar showing availability -- a high-value community feature.
Output: Amenity catalog, detail with calendar, reservation form, my reservations list, and reservation detail with cancel.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-advanced-resident-features/13-RESEARCH.md
@.planning/phases/13-advanced-resident-features/13-01-SUMMARY.md

Key references:
- @packages/mobile/app/(resident)/community/_layout.tsx (already has amenity screens declared by 13-01)
- @packages/shared/src/queries/keys.ts (amenities key factory already exists)
- @packages/mobile/src/hooks/useAuth.ts (residentId, communityId)
- @packages/mobile/src/hooks/useOccupancy.ts (useResidentUnit for unitId needed by create_reservation)

Critical pitfalls from research:
- Reservations use `reserved_range` (tstzrange), NOT separate start/end columns
- `create_reservation()` RPC accepts p_start_time and p_end_time as separate params
- Amenity schedule is opaque JSONB -- query existing reservations for calendar, don't parse schedule
- RAMEN-05 (push notifications for bookings) DEFERRED to Phase 16
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-native-calendars + create reservation hooks</name>
  <files>
    packages/mobile/src/hooks/useReservations.ts
  </files>
  <action>
**Install react-native-calendars** in the mobile package:
```bash
cd packages/mobile && pnpm add react-native-calendars
```

**Create useReservations.ts** with these hooks:

1. `useAmenities()` - Query `amenities` table for the community. Select: id, name, description, amenity_type, location, capacity, photo_urls, requires_reservation, hourly_rate, deposit_amount, rules_document_url, schedule, status. Filter: `community_id`, `status = 'active'`, `deleted_at IS NULL`. Order by name.

2. `useAmenityDetail(amenityId: string)` - Query single amenity by id with all fields.

3. `useAmenityReservations(amenityId: string, month?: string)` - Query `reservations` for a given amenity and month. Select: id, reserved_range, status, resident_id, plus resident join (first_name, paternal_surname). Filter: amenity_id, community_id, status IN ('confirmed', 'pending'), deleted_at IS NULL. For date range filtering, use `.gte('reserved_range', '[${startOfMonth},')` and appropriate PostgREST range filter syntax. If range filtering doesn't work via PostgREST, fall back to fetching all reservations for the amenity and filtering client-side by month. Parse `reserved_range` tstzrange string on the client to extract start/end bounds (format: `["2026-02-08 10:00:00+00","2026-02-08 12:00:00+00")`).

4. `useCreateReservation()` - Mutation calling `supabase.rpc('create_reservation', {...})`. Get `residentId` from `useAuth()`, `unitId` from `useResidentUnit()`. Parameters: `p_amenity_id`, `p_unit_id` (unitId!), `p_resident_id` (residentId!), `p_start_time` (ISO string), `p_end_time` (ISO string), `p_notes` (optional). Invalidate amenities queries on success. Handle RPC errors gracefully -- the function returns error messages for booking rule violations (overlap, blackout, max bookings, etc.).

5. `useMyReservations()` - Query `reservations` where `resident_id = residentId` (from useAuth). Select: id, reserved_range, status, cancelled_at, cancellation_reason, notes, plus amenity join (name, amenity_type, location, photo_urls). Filter: community_id, deleted_at IS NULL. Order by reserved_range descending.

6. `useCancelReservation()` - Mutation to update reservation status to 'cancelled'. Set `cancelled_at` to now, `cancelled_by` to user.id (from `supabase.auth.getUser()`), `cancellation_reason` from input. Use `'cancelled' as never` for the enum cast. Invalidate amenities + reservations queries on success.

**Helper function** `parseTstzrange(range: string): { start: Date; end: Date }` - Parse PostgreSQL tstzrange format `["2026-02-08 10:00:00+00","2026-02-08 12:00:00+00")` into start/end Date objects. Strip brackets, split by comma, parse each timestamp.

All hooks import supabase from `@/lib/supabase`, queryKeys from `@upoe/shared`, useAuth from `@/hooks/useAuth`.
  </action>
  <verify>
Run `npx tsc --noEmit` in packages/mobile. Verify react-native-calendars is in package.json dependencies. Verify useReservations.ts exports all 6 hooks + parseTstzrange helper.
  </verify>
  <done>react-native-calendars installed. All 6 reservation hooks created and type-checked. parseTstzrange helper correctly extracts start/end from PostgreSQL range format.</done>
</task>

<task type="auto">
  <name>Task 2: Amenity catalog, calendar detail, reservation form, and my reservations screens</name>
  <files>
    packages/mobile/app/(resident)/community/amenities/index.tsx
    packages/mobile/app/(resident)/community/amenities/[id].tsx
    packages/mobile/app/(resident)/community/amenities/reserve.tsx
    packages/mobile/app/(resident)/community/reservations/index.tsx
    packages/mobile/app/(resident)/community/reservations/[id].tsx
    packages/mobile/src/components/amenities/AmenityCard.tsx
    packages/mobile/src/components/amenities/AvailabilityCalendar.tsx
    packages/mobile/src/components/amenities/TimeSlotPicker.tsx
  </files>
  <action>
**Create AmenityCard.tsx component:**
- Card with amenity photo (first from photo_urls or placeholder), name, amenity_type badge, location, capacity, hourly_rate (if any).
- Tap navigates to `community/amenities/[id]`.

**Create AvailabilityCalendar.tsx component:**
- Uses `Calendar` from `react-native-calendars`.
- Props: `amenityId`, `onDateSelect(date: string)`, `selectedDate`.
- Fetches reservations for the displayed month using `useAmenityReservations(amenityId, currentMonth)`.
- Marks dates with reservations using `markedDates` prop. Use dot markers: booked dates get a red dot, partially booked get an orange dot.
- Month navigation via Calendar's built-in arrows. On month change, update the month parameter.
- Selected date highlighted in blue.

**Create TimeSlotPicker.tsx component:**
- Shows available time slots for the selected date.
- Props: `amenityId`, `date`, `onSlotSelect({ start, end })`.
- Generates hourly slots (e.g., 8:00-9:00, 9:00-10:00, ... 20:00-21:00) based on standard operating hours (8am-9pm default).
- Cross-references existing reservations for that date (from AvailabilityCalendar data or separate query) to mark slots as booked/available.
- Booked slots shown grayed out and not selectable. Available slots shown as tappable chips.
- User can select start and end times (minimum 1 hour, spans consecutive available slots).

**Create amenities/index.tsx (Amenity catalog):**
- Header: "Amenidades"
- FlatList with AmenityCard items in a 2-column grid layout.
- RefreshControl for pull-to-refresh.
- Link to "Mis Reservaciones" at the top (navigates to `community/reservations`).
- EmptyState when no amenities.
- Uses `useAmenities()` hook.

**Create amenities/[id].tsx (Amenity detail with calendar):**
- Header with amenity photo (full width), name, description, location, capacity, hourly_rate, deposit_amount, rules.
- AvailabilityCalendar component below the details.
- When a date is selected, show TimeSlotPicker below the calendar.
- "Reservar" button (enabled only when a valid time slot is selected) navigates to `community/amenities/reserve?amenity_id={id}&date={date}&start={start}&end={end}`.
- If `requires_reservation` is false, show "Uso libre - sin reservacion necesaria" message.

**Create amenities/reserve.tsx (Reservation creation):**
- Read amenity_id, date, start, end from route params.
- Show reservation summary: amenity name, date, start-end time, estimated cost (hours * hourly_rate).
- Notes TextInput (optional).
- Deposit notice if amenity has deposit_amount > 0.
- "Confirmar Reservacion" button calls `useCreateReservation()`.
- On success: show success Alert and navigate back to amenity detail.
- On error: show the error message from the RPC (e.g., "Horario no disponible", "Maximo de reservaciones alcanzado").

**Create reservations/index.tsx (My reservations list):**
- Header: "Mis Reservaciones"
- FlatList of reservation cards showing: amenity name, date/time range (parsed from reserved_range), status badge (confirmed=green, pending=yellow, cancelled=red, completed=gray).
- Tap navigates to `community/reservations/[id]`.
- Segmented control or tabs: "Proximas" (upcoming: confirmed/pending, start > now) and "Pasadas" (past + cancelled).
- Uses `useMyReservations()`.

**Create reservations/[id].tsx (Reservation detail with cancel):**
- Full reservation details: amenity name + photo, date, time range, status, notes, created_at.
- If status = 'confirmed' and start time is in the future: "Cancelar Reservacion" button.
- Cancel button shows confirmation Alert, then TextInput for cancellation reason, then calls `useCancelReservation()`.
- On cancel success: navigate back to reservations list.
- If status = 'cancelled': show cancelled_at and cancellation_reason.
  </action>
  <verify>
Run `npx tsc --noEmit` in packages/mobile. Verify all 5 route files exist under community/amenities/ and community/reservations/. Verify 3 component files exist under components/amenities/. Check that Calendar import from react-native-calendars compiles.
  </verify>
  <done>Amenity catalog shows community amenities in grid. Amenity detail shows availability calendar with booked dates marked. Time slot picker lets user select available hours. Reservation creation calls create_reservation RPC with proper validation. My reservations list shows upcoming and past bookings with status. Reservation detail allows cancellation of future bookings.</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes in packages/mobile
2. react-native-calendars installed and importable
3. Amenity catalog grid renders with amenity cards
4. Amenity detail shows calendar with date-based reservation markers
5. Time slot picker shows available vs booked slots for selected date
6. Reservation creation calls create_reservation RPC and handles success/error
7. My reservations list shows the resident's reservations with correct status
8. Reservation cancellation updates status and shows reason
</verification>

<success_criteria>
- Amenity catalog displays all active amenities with photos, names, and details
- Calendar view shows booked dates with visual markers
- Resident can select a date and time slot, then confirm a reservation
- Booking rule violations surface meaningful error messages from the RPC
- My reservations list shows upcoming and past reservations with status badges
- Future confirmed reservations can be cancelled with reason
</success_criteria>

<output>
After completion, create `.planning/phases/13-advanced-resident-features/13-02-SUMMARY.md`
</output>
