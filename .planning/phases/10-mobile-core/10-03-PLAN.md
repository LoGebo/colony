---
phase: 10-mobile-core
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - packages/mobile/src/hooks/usePayments.ts
  - packages/mobile/src/components/payments/BalanceCard.tsx
  - packages/mobile/src/components/payments/TransactionRow.tsx
  - packages/mobile/src/components/payments/PaymentProofCard.tsx
  - packages/mobile/app/(resident)/payments/index.tsx
  - packages/mobile/app/(resident)/payments/history.tsx
  - packages/mobile/app/(resident)/payments/upload-proof.tsx
autonomous: true

must_haves:
  truths:
    - "Resident sees current account balance with breakdown (total charges, total payments, days overdue)"
    - "Resident sees recent transactions with type, amount, date, and status"
    - "Resident can view full payment history with infinite scroll pagination"
    - "Resident can upload a payment proof photo with amount, date, reference, and bank name"
    - "Resident can see proof approval status (pending, approved, rejected) on their submitted proofs"
  artifacts:
    - path: "packages/mobile/src/hooks/usePayments.ts"
      provides: "Payment and balance TanStack Query hooks"
      exports: ["useUnitBalance", "useTransactions", "usePaymentProofs", "useUploadPaymentProof"]
    - path: "packages/mobile/src/components/payments/BalanceCard.tsx"
      provides: "Balance summary card with breakdown"
      exports: ["BalanceCard"]
    - path: "packages/mobile/src/components/payments/TransactionRow.tsx"
      provides: "Transaction list item"
      exports: ["TransactionRow"]
    - path: "packages/mobile/src/components/payments/PaymentProofCard.tsx"
      provides: "Payment proof item with status"
      exports: ["PaymentProofCard"]
    - path: "packages/mobile/app/(resident)/payments/index.tsx"
      provides: "Payment overview with balance and recent activity"
    - path: "packages/mobile/app/(resident)/payments/upload-proof.tsx"
      provides: "Payment proof upload form"
  key_links:
    - from: "packages/mobile/app/(resident)/payments/index.tsx"
      to: "packages/mobile/src/hooks/usePayments.ts"
      via: "useUnitBalance and useTransactions hooks"
      pattern: "useUnitBalance|useTransactions"
    - from: "packages/mobile/app/(resident)/payments/upload-proof.tsx"
      to: "packages/mobile/src/lib/upload.ts"
      via: "pickAndUploadImage for proof photo"
      pattern: "pickAndUploadImage"
    - from: "packages/mobile/app/(resident)/payments/upload-proof.tsx"
      to: "packages/mobile/src/hooks/usePayments.ts"
      via: "useUploadPaymentProof mutation"
      pattern: "useUploadPaymentProof"
---

<objective>
Implement the resident payments flow: balance overview with charges breakdown, transaction history with infinite scroll, payment proof upload with photo capture, and proof status tracking (pending/approved/rejected).

Purpose: Financial transparency is critical for resident satisfaction. Residents need to see what they owe, understand the breakdown, upload proof of payment, and track whether their proof was approved.

Output: 3 payment screens (overview, history, upload) + payment data hooks + balance/transaction/proof UI components.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-mobile-core/10-RESEARCH.md
@.planning/phases/10-mobile-core/10-01-SUMMARY.md

# Phase 9 outputs
@packages/mobile/src/hooks/useAuth.ts
@packages/mobile/src/lib/supabase.ts
@packages/mobile/src/lib/upload.ts
@packages/shared/src/queries/keys.ts
@packages/shared/src/constants/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create payment data hooks and reusable payment components</name>
  <files>
    packages/mobile/src/hooks/usePayments.ts
    packages/mobile/src/components/payments/BalanceCard.tsx
    packages/mobile/src/components/payments/TransactionRow.tsx
    packages/mobile/src/components/payments/PaymentProofCard.tsx
  </files>
  <action>
    1. **Create `packages/mobile/src/hooks/usePayments.ts`** with these hooks:

       **`useUnitBalance(unitId?: string)`**: `useQuery` calling `supabase.rpc('get_unit_balance', { p_unit_id: unitId! })`. The RPC returns a table, so the result is an array -- extract `data?.[0] ?? null`. Expected shape: `{ current_balance, total_charges, total_payments, total_interest, days_overdue, last_payment_date, oldest_unpaid_date }` (from the `unit_balances` view). Query key: `queryKeys.payments.balance(unitId!)`. `enabled: !!unitId`. Note: `current_balance` is `total_receivable` from the view and represents the amount owed (positive = owes, negative = credit).

       **`useTransactions(unitId?: string, pageSize = 20)`**: `useInfiniteQuery` fetching from `transactions` table. Select: `id, transaction_type, amount, currency, description, reference_number, status, effective_date, posted_at`. Filter: `.eq('unit_id', unitId!)`, `.is('deleted_at', null)`, `.in('status', ['pending', 'posted'])`. Order: `effective_date DESC`. Use `.range(from, to)` with `{ count: 'exact' }`. `initialPageParam: 0`. `getNextPageParam` returns next page or undefined. Query key: `queryKeys.payments.byUnit(unitId!)`. `enabled: !!unitId`.

       **`usePaymentProofs(unitId?: string)`**: `useQuery` fetching from `payment_proofs` table. Select: `id, proof_type, amount, payment_date, reference_number, bank_name, document_url, status, submitted_at, reviewed_at, rejection_reason`. Filter: `.eq('unit_id', unitId!)`, `.is('deleted_at', null)`. Order: `submitted_at DESC`. Limit 50. Query key: `['payment-proofs', unitId]`. `enabled: !!unitId`.

       **`useUploadPaymentProof()`**: `useMutation` that inserts into `payment_proofs` table. The mutationFn accepts `{ amount: number, payment_date: string, reference_number?: string, bank_name?: string, document_url: string, proof_type: string }`. Adds `community_id` from `useAuth().communityId`, `unit_id` from param or hook, `submitted_by` as `user.id` (auth UID, NOT residentId -- `submitted_by` FKs to auth.users). Uses `.select().single()`. `onSuccess`: invalidates `queryKeys.payments._def` AND `['payment-proofs']`.

       Use `useAuth()` in each hook for `communityId` and `user.id`.

    2. **Create `packages/mobile/src/components/payments/BalanceCard.tsx`**:
       - Props: `balance: { current_balance: number; total_charges: number; total_payments: number; total_interest: number; days_overdue: number | null; last_payment_date: string | null } | null`, `isLoading: boolean`.
       - Large card (bg-white rounded-2xl p-6 shadow-sm).
       - Main balance display: "Saldo actual" label (text-sm text-gray-500), balance amount in text-3xl font-bold (green if <= 0 meaning paid up/credit, red if > 0 meaning owes). Use `formatCurrency` from `@/lib/dates`.
       - Status line: if `days_overdue > 0`, show "Vencido {days_overdue} dias" in text-red-500. Else "Al corriente" in text-green-600.
       - Breakdown section (3 columns): "Cargos" showing total_charges, "Pagos" showing total_payments, "Intereses" showing total_interest. Each in text-sm with amount below.
       - Last payment date if available: "Ultimo pago: {formatDate(last_payment_date)}".
       - Show `LoadingSpinner` centered if `isLoading`.

    3. **Create `packages/mobile/src/components/payments/TransactionRow.tsx`**:
       - Props: `transaction` object with fields from the query.
       - Pressable row (bg-white px-4 py-3 border-b border-gray-100).
       - Left side: transaction type icon/label: "Cargo" (text-red-600 for charges), "Pago" (text-green-600 for payments), "Ajuste" (text-blue-600), "Interes" (text-orange-600), "Reverso" (text-purple-600). Show description below in text-sm text-gray-500.
       - Right side: amount (formatted with `formatCurrency`), colored based on type (red for charges, green for payments). Date below in text-xs text-gray-400 using `formatDate(effective_date)`.
       - Wrap with `React.memo`.

    4. **Create `packages/mobile/src/components/payments/PaymentProofCard.tsx`**:
       - Props: `proof` object with fields from the query.
       - Card (bg-white rounded-xl p-4 mb-3 shadow-sm).
       - Row: "Comprobante" title + StatusBadge (pending/approved/rejected using the same variant pattern from Badge.tsx). Labels: pending="En revision", approved="Aprobado", rejected="Rechazado".
       - Amount and payment_date formatted.
       - Reference number and bank name if present.
       - If rejected: show rejection_reason in text-sm text-red-600 with bg-red-50 p-2 rounded.
       - Submitted date: `formatRelative(submitted_at)`.
  </action>
  <verify>
    Run `cd packages/mobile && npx tsc --noEmit` -- no type errors. Verify file existence: `ls src/hooks/usePayments.ts src/components/payments/BalanceCard.tsx src/components/payments/TransactionRow.tsx src/components/payments/PaymentProofCard.tsx`.
  </verify>
  <done>
    4 payment hooks exported (useUnitBalance, useTransactions, usePaymentProofs, useUploadPaymentProof). BalanceCard shows amount with overdue indicator and breakdown. TransactionRow shows type-colored transaction with amount and date. PaymentProofCard shows proof status with rejection reason.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement payment overview, history, and proof upload screens</name>
  <files>
    packages/mobile/app/(resident)/payments/index.tsx
    packages/mobile/app/(resident)/payments/history.tsx
    packages/mobile/app/(resident)/payments/upload-proof.tsx
  </files>
  <action>
    1. **Create `packages/mobile/app/(resident)/payments/index.tsx`** -- Payment overview:
       - Use `useAuth()` for `residentId`, `communityId`, `user`.
       - Use `useResidentUnit()` from 10-01 to get `unitId`.
       - Use `useUnitBalance(unitId)` for balance data.
       - Use `usePaymentProofs(unitId)` for recent proof submissions.
       - Use `useTransactions(unitId)` but only show the first page of results as "Movimientos recientes" -- flatten the first page: `transactions.data?.pages[0]?.data ?? []`.
       - Layout (ScrollView with RefreshControl):
         - `BalanceCard` at the top showing full balance data.
         - "Subir Comprobante" button (bg-blue-600 rounded-lg p-4 w-full items-center mt-4) navigates to `/(resident)/payments/upload-proof`.
         - "Mis Comprobantes" section: If `proofs.data` has items, show the most recent 3 as `PaymentProofCard`. If more exist, show "Ver todos" link.
         - "Movimientos recientes" section: Show first 5 transactions as `TransactionRow`. "Ver historial completo" link navigates to `/(resident)/payments/history`.
       - Pull-to-refresh refetches all 3 queries.

    2. **Create `packages/mobile/app/(resident)/payments/history.tsx`** -- Full transaction history:
       - Use `useResidentUnit()` to get `unitId`.
       - Use `useTransactions(unitId)` with infinite scroll.
       - Flatten all pages: `const allItems = data?.pages.flatMap((p) => p.data) ?? []`.
       - FlatList with `TransactionRow` for each item.
       - `onEndReached`: if `hasNextPage && !isFetchingNextPage`, call `fetchNextPage()`. `onEndReachedThreshold={0.5}`.
       - Pull-to-refresh.
       - `ListEmptyComponent`: `EmptyState` with "Sin movimientos registrados".
       - `ListFooterComponent`: `LoadingSpinner` when `isFetchingNextPage`.
       - Header: "Historial de Pagos" title (text-xl font-bold).

    3. **Create `packages/mobile/app/(resident)/payments/upload-proof.tsx`** -- Upload payment proof:
       - Form state: `amount` (string), `paymentDate` (string), `referenceNumber` (string), `bankName` (string), `imageUrl` (string | null), `uploading` (boolean).
       - Use `useAuth()` for `communityId` and `user.id`.
       - Use `useResidentUnit()` for `unitId`.
       - Use `useUploadPaymentProof()` mutation.
       - Image picker section: Pressable dashed border area (border-2 border-dashed border-gray-300 rounded-xl p-8 items-center). On press: call `pickAndUploadImage(STORAGE_BUCKETS.PAYMENT_PROOFS, communityId!, 'receipts')` from `@/lib/upload`. If result is not null, set `imageUrl`. Show uploading state, selected state, or prompt text.
       - Form fields (all TextInput with NativeWind styling):
         - "Monto *" (keyboardType="decimal-pad", placeholder "0.00", required)
         - "Fecha de pago *" (placeholder "YYYY-MM-DD", required)
         - "Numero de referencia" (optional)
         - "Banco" (optional)
       - Submit button "Enviar Comprobante" (bg-blue-600 rounded-lg p-4 items-center):
         - Validate: imageUrl and amount and paymentDate must be present. If not, `Alert.alert('Error', 'Completa los campos requeridos: imagen, monto y fecha')`.
         - Call mutation with `{ amount: parseFloat(amount), payment_date: paymentDate, reference_number: referenceNumber || undefined, bank_name: bankName || undefined, document_url: imageUrl!, proof_type: 'bank_transfer' }`. Note: pass `unit_id` from `useResidentUnit()`.
         - `onSuccess`: `Alert.alert('Enviado', 'Tu comprobante ha sido enviado para revision')` then `router.back()`.
         - `onError`: `Alert.alert('Error', error.message)`.
       - Disable submit while `isPending` or `uploading`.
       - Wrap in `KeyboardAvoidingView` (behavior padding on iOS) and `ScrollView`.
       - Import `STORAGE_BUCKETS` from `@upoe/shared`.
  </action>
  <verify>
    Run `cd packages/mobile && npx tsc --noEmit` -- no type errors. Verify all 3 screen files exist: `ls app/(resident)/payments/index.tsx app/(resident)/payments/history.tsx app/(resident)/payments/upload-proof.tsx`.
  </verify>
  <done>
    Payment overview shows balance card with breakdown, upload button, recent proofs with status, and recent transactions. History screen shows infinite-scroll transaction list. Upload screen provides image picker + form fields for payment proof submission. Proof status (pending/approved/rejected) is visible on the overview screen's proof cards.
  </done>
</task>

</tasks>

<verification>
1. `cd packages/mobile && npx tsc --noEmit` passes with zero errors
2. useUnitBalance calls get_unit_balance RPC and returns balance data
3. useTransactions returns paginated transactions with infinite scroll support
4. usePaymentProofs returns recent proof submissions
5. useUploadPaymentProof inserts into payment_proofs with correct field mappings (submitted_by = auth UID)
6. Payment overview screen shows BalanceCard, recent proofs, and recent transactions
7. Upload screen uses pickAndUploadImage to upload to payment-proofs bucket
8. Upload form validates required fields (image, amount, date) before submission
9. After successful upload, query cache is invalidated and user navigates back
10. Transaction history uses useInfiniteQuery with FlatList onEndReached
</verification>

<success_criteria>
- Resident sees current balance with charges/payments/interest breakdown and overdue indicator
- Resident sees recent transactions colored by type (charges red, payments green)
- Resident can scroll through full transaction history with infinite pagination
- Resident can upload payment proof photo from device library
- Resident can fill in amount, date, reference, bank and submit proof
- Submitted proofs show pending/approved/rejected status with rejection reason if applicable
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-mobile-core/10-03-SUMMARY.md`
</output>
