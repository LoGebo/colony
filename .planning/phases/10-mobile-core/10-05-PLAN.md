---
phase: 10-mobile-core
plan: 05
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - packages/mobile/src/hooks/useDirectory.ts
  - packages/mobile/src/hooks/usePackages.ts
  - packages/mobile/src/components/guard/PackageCard.tsx
  - packages/mobile/app/(guard)/directory/index.tsx
  - packages/mobile/app/(guard)/directory/vehicles.tsx
  - packages/mobile/app/(guard)/packages/index.tsx
  - packages/mobile/app/(guard)/packages/log.tsx
  - packages/mobile/app/(guard)/packages/[id].tsx
autonomous: true

must_haves:
  truths:
    - "Guard can search residents by name or unit number and see matching results"
    - "Guard can search vehicles by license plate and see owner details"
    - "Guard sees blacklist alert inline when searching if a name or plate matches"
    - "Guard can log an incoming package with carrier, recipient unit, and photo of label"
    - "Guard can view pending packages list sorted by unit"
    - "Guard can verify pickup code and confirm package delivery"
  artifacts:
    - path: "packages/mobile/src/hooks/useDirectory.ts"
      provides: "Resident and vehicle search hooks"
      exports: ["useResidentSearch", "useUnitSearch", "useVehicleSearch"]
    - path: "packages/mobile/src/hooks/usePackages.ts"
      provides: "Package management hooks"
      exports: ["usePendingPackages", "useLogPackage", "useConfirmPickup", "usePackageDetail"]
    - path: "packages/mobile/app/(guard)/directory/index.tsx"
      provides: "Resident directory search screen"
    - path: "packages/mobile/app/(guard)/directory/vehicles.tsx"
      provides: "Vehicle plate search screen"
    - path: "packages/mobile/app/(guard)/packages/index.tsx"
      provides: "Pending packages list"
    - path: "packages/mobile/app/(guard)/packages/log.tsx"
      provides: "Log new package form"
    - path: "packages/mobile/app/(guard)/packages/[id].tsx"
      provides: "Package detail and pickup verification"
  key_links:
    - from: "packages/mobile/app/(guard)/directory/index.tsx"
      to: "packages/mobile/src/hooks/useDirectory.ts"
      via: "useResidentSearch and useUnitSearch hooks"
      pattern: "useResidentSearch|useUnitSearch"
    - from: "packages/mobile/app/(guard)/directory/vehicles.tsx"
      to: "packages/mobile/src/hooks/useDirectory.ts"
      via: "useVehicleSearch hook"
      pattern: "useVehicleSearch"
    - from: "packages/mobile/app/(guard)/packages/log.tsx"
      to: "packages/mobile/src/hooks/usePackages.ts"
      via: "useLogPackage mutation"
      pattern: "useLogPackage"
    - from: "packages/mobile/app/(guard)/packages/[id].tsx"
      to: "packages/mobile/src/hooks/usePackages.ts"
      via: "useConfirmPickup mutation"
      pattern: "useConfirmPickup"
---

<objective>
Implement the guard directory (resident search by name/unit, vehicle search by plate with blacklist indicators) and package management (pending packages list, log new package with photo, pickup verification with code).

Purpose: Guards need fast resident lookup for confirming identities and handling calls, vehicle plate search for parking/access, and package tracking for accountability.

Output: 2 directory screens (resident search, vehicle search) + 3 package screens (pending list, log, detail/pickup) + directory and package data hooks.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-mobile-core/10-RESEARCH.md
@.planning/phases/10-mobile-core/10-01-SUMMARY.md

# Phase 9 outputs
@packages/mobile/src/hooks/useAuth.ts
@packages/mobile/src/lib/supabase.ts
@packages/mobile/src/lib/upload.ts
@packages/shared/src/queries/keys.ts
@packages/shared/src/constants/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create directory and package data hooks and PackageCard component</name>
  <files>
    packages/mobile/src/hooks/useDirectory.ts
    packages/mobile/src/hooks/usePackages.ts
    packages/mobile/src/components/guard/PackageCard.tsx
  </files>
  <action>
    1. **Create `packages/mobile/src/hooks/useDirectory.ts`** with these hooks:

       **`useResidentSearch(query: string)`**: `useQuery` searching `residents` table. Select: `id, first_name, paternal_surname, maternal_surname, email, phone, occupancies(unit_id, units(unit_number, building))`. Filter: `community_id`, `deleted_at IS NULL`. If `query.trim()`, use `.or('first_name.ilike.%${query}%,paternal_surname.ilike.%${query}%')`. Order by `paternal_surname`. Limit 50. Query key: `queryKeys.residents.list(communityId).queryKey.concat([{ search: query }])`. `enabled: !!communityId && query.length >= 2`. Use debounced query value (the screen should debounce before passing to the hook).

       **`useUnitSearch(unitNumber: string)`**: `useQuery` searching `units` table. Select: `id, unit_number, building, floor_number, occupancies(resident_id, residents(id, first_name, paternal_surname, phone))`. Filter: `community_id`, `.ilike('unit_number', '%${unitNumber}%')`, `deleted_at IS NULL`. Limit 20. Query key: `queryKeys.units.list(communityId!).queryKey.concat([{ search: unitNumber }])`. `enabled: !!communityId && unitNumber.length >= 1`.

       **`useVehicleSearch(plate: string)`**: `useQuery` searching `vehicles` table. Select: `id, plate_number, plate_normalized, plate_state, make, model, year, color, access_enabled, residents(id, first_name, paternal_surname, occupancies(units(unit_number)))`. Filter: `community_id`, `.ilike('plate_normalized', '%${plate.replace(/[^A-Z0-9]/gi, '').toUpperCase()}%')`, `deleted_at IS NULL`. Limit 20. Query key: `['vehicles', communityId, { search: plate }]`. `enabled: !!communityId && plate.length >= 3`.

       All hooks use `useAuth()` for `communityId`.

    2. **Create `packages/mobile/src/hooks/usePackages.ts`** with these hooks:

       **`usePendingPackages()`**: `useQuery` fetching packages in `received`, `stored`, `notified`, `pending_pickup` statuses. Select: `id, carrier, carrier_other, tracking_number, recipient_name, recipient_unit_id, description, package_count, is_oversized, photo_url, label_photo_url, status, received_at, units:recipient_unit_id(unit_number, building)`. Filter: `community_id`, `.in('status', ['received', 'stored', 'notified', 'pending_pickup'])`, `deleted_at IS NULL`. Order: `units.unit_number ASC, received_at DESC` (sort by unit for guard efficiency). Query key: `queryKeys.packages.pending(communityId!)`. `enabled: !!communityId`.

       **`usePackageDetail(id: string)`**: `useQuery` fetching single package by id with `units:recipient_unit_id(unit_number, building), residents:recipient_resident_id(first_name, paternal_surname, phone), package_pickup_codes(id, code_type, code_value, status, valid_until)`. Query key: `queryKeys.packages.detail(id)`. `enabled: !!id`.

       **`useLogPackage()`**: `useMutation` inserting into `packages` table. mutationFn accepts `{ carrier: string, carrier_other?: string, tracking_number?: string, recipient_unit_id: string, recipient_name: string, description?: string, package_count?: number, is_oversized?: boolean, label_photo_url?: string }`. Adds `community_id`, `received_by` from `useAuth().guardId`, `received_at: new Date().toISOString()`, `status: 'received'`. Uses `.select().single()`. `onSuccess`: invalidates `queryKeys.packages._def`.

       **`useConfirmPickup()`**: `useMutation` that updates a package to `picked_up` status. mutationFn accepts `{ packageId: string, pickupCode?: string }`. Steps:
       1. If `pickupCode` is provided, verify it: query `package_pickup_codes` where `package_id = packageId`, `code_value = pickupCode`, `status = 'active'`. If not found or expired, throw error "Codigo de recoleccion invalido".
       2. Update the package: `.update({ status: 'picked_up', picked_up_at: new Date().toISOString(), picked_up_by: guardId })`.
       3. If pickup code was verified, update the code: `.update({ status: 'used', used_at: new Date().toISOString(), used_by: guardId })`.
       `onSuccess`: invalidates `queryKeys.packages._def`.

    3. **Create `packages/mobile/src/components/guard/PackageCard.tsx`**:
       - Props: `pkg` (package object from query with units relation), `onPress: () => void`.
       - Pressable card (bg-white rounded-xl p-4 mb-3 shadow-sm).
       - Row: carrier label (font-semibold), StatusBadge on right with package statuses: received="Recibido" (blue), stored="Almacenado" (purple), notified="Notificado" (yellow), pending_pickup="Pendiente recoleccion" (orange), picked_up="Entregado" (green).
       - Below: recipient_name, unit_number, package_count (if > 1: "{n} paquetes"), is_oversized indicator ("Sobredimensionado" badge if true).
       - Received time: `formatRelative(received_at)`.
       - Wrap with `React.memo`.
  </action>
  <verify>
    Run `cd packages/mobile && npx tsc --noEmit` -- no type errors. Verify: `ls src/hooks/useDirectory.ts src/hooks/usePackages.ts src/components/guard/PackageCard.tsx`.
  </verify>
  <done>
    3 directory hooks (useResidentSearch, useUnitSearch, useVehicleSearch) with PostgREST search patterns. 4 package hooks (usePendingPackages, usePackageDetail, useLogPackage, useConfirmPickup) with pickup code verification. PackageCard renders carrier, recipient, status, and received time.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement directory screens and package screens</name>
  <files>
    packages/mobile/app/(guard)/directory/index.tsx
    packages/mobile/app/(guard)/directory/vehicles.tsx
    packages/mobile/app/(guard)/packages/index.tsx
    packages/mobile/app/(guard)/packages/log.tsx
    packages/mobile/app/(guard)/packages/[id].tsx
  </files>
  <action>
    1. **Create `packages/mobile/app/(guard)/directory/index.tsx`** -- Resident directory:
       - State: `searchQuery` (string), `searchMode` ('name' | 'unit', default 'name'), `debouncedQuery` (string, updated 500ms after searchQuery changes).
       - Debounce implementation: `useEffect` with `setTimeout(500ms)` that sets `debouncedQuery` from `searchQuery`. Cleanup clears timeout.
       - Search mode toggle: Two buttons "Por nombre" and "Por unidad" as segmented control.
       - TextInput search bar (bg-gray-100 rounded-xl px-4 py-3) with placeholder depending on mode: "Buscar por nombre..." or "Buscar por unidad...".
       - If mode is 'name': use `useResidentSearch(debouncedQuery)`. Render FlatList of results. Each item shows: resident name (first_name + paternal_surname), phone, unit numbers from occupancies.
       - If mode is 'unit': use `useUnitSearch(debouncedQuery)`. Render FlatList. Each item shows: unit_number, building, residents in that unit (names and phones).
       - Use `useBlacklistCheck()` from useGateOps (import from `@/hooks/useGateOps`) with debouncedQuery as personName. If blacklist returns is_blocked, show `BlacklistAlert` above results.
       - "Buscar vehiculo" link at the top navigates to `/(guard)/directory/vehicles`.
       - Empty state when query is too short: "Ingresa al menos 2 caracteres para buscar" (name) or "Ingresa un numero de unidad" (unit).
       - Loading spinner while query is fetching.

    2. **Create `packages/mobile/app/(guard)/directory/vehicles.tsx`** -- Vehicle plate search:
       - State: `plateQuery` (string), `debouncedPlate` (string, 500ms debounce).
       - TextInput search bar with placeholder "Buscar por placa..." and `autoCapitalize="characters"`.
       - Use `useVehicleSearch(debouncedPlate)`.
       - Use `useBlacklistCheck()` with `plateNormalized: debouncedPlate.replace(/[^A-Z0-9]/gi, '').toUpperCase()`. Show `BlacklistAlert` if match found.
       - FlatList of results. Each item shows: plate_number (bold), make/model/year/color, access_enabled badge ("Acceso activo" green or "Sin acceso" gray), owner name (from residents relation), unit number (from residents.occupancies.units).
       - Empty state when plate query is too short: "Ingresa al menos 3 caracteres".
       - Loading spinner while fetching.

    3. **Create `packages/mobile/app/(guard)/packages/index.tsx`** -- Pending packages list:
       - Use `usePendingPackages()`.
       - FlatList rendering `PackageCard` for each package.
       - `onPress` navigates to `/(guard)/packages/${item.id}`.
       - Pull-to-refresh.
       - Header: "Paquetes Pendientes" title + "Registrar Paquete" button (bg-blue-600 rounded-lg px-4 py-2 text-white) navigating to `/(guard)/packages/log`.
       - `ListEmptyComponent`: `EmptyState` with "Sin paquetes pendientes".
       - Group visually by unit (since sorted by unit_number): Show unit_number as a section header before the first package of each unit. This can be done with a simple conditional in renderItem: if `item.units?.unit_number !== previousUnitNumber`, render a section header Text above the card.

    4. **Create `packages/mobile/app/(guard)/packages/log.tsx`** -- Log new package:
       - Form state: `carrier` (string, from picker), `carrierOther` (string, shown when carrier is 'other'), `trackingNumber` (string, optional), `recipientUnitId` (string, selected from unit search), `recipientName` (string, required), `description` (string, optional), `packageCount` (string, default '1'), `isOversized` (boolean, default false), `labelPhotoUrl` (string | null).
       - Carrier picker: List of pressable chips for each carrier enum value: fedex, dhl, ups, estafeta, redpack, mercado_libre, amazon, correos_mexico, other. Active chip = bg-blue-600 text-white, inactive = bg-gray-100. When 'other' selected, show TextInput for carrier_other.
       - Unit search: TextInput for searching units. Use `useUnitSearch(unitQuery)` with debounce. Show dropdown of matching units below the input. When a unit is selected, set `recipientUnitId` and auto-fill `recipientName` from the first resident in that unit.
       - Label photo: "Foto de etiqueta" button using `pickAndUploadImage(STORAGE_BUCKETS.DOCUMENT_FILES, communityId!, 'package-labels')`. Show thumbnail if taken.
       - Oversized toggle: Pressable toggle or checkbox.
       - Submit: "Registrar Paquete" button. Call `useLogPackage().mutate()` with all fields. On success: `Alert.alert('Registrado', 'Paquete registrado exitosamente')` then `router.back()`. On error: `Alert.alert('Error', error.message)`.
       - Wrap in KeyboardAvoidingView + ScrollView.

    5. **Create `packages/mobile/app/(guard)/packages/[id].tsx`** -- Package detail and pickup:
       - Get `id` from `useLocalSearchParams<{ id: string }>()`.
       - Use `usePackageDetail(id)`.
       - Use `useConfirmPickup()` mutation.
       - State: `pickupCode` (string).
       - Loading: `LoadingSpinner`. Error: `EmptyState`.
       - Layout (ScrollView):
         - Package info section (SectionCard): carrier, tracking_number, recipient_name, unit_number, description, package_count, is_oversized, status badge.
         - Photos: If label_photo_url or photo_url exist, show Image components (using Supabase storage public URL).
         - Timeline: received_at, stored_at, notified_at, picked_up_at -- show each as a timeline step with date if available.
         - Pickup section (only if status is NOT 'picked_up'):
           - If package has `package_pickup_codes` with an active code: Show "Codigo de recoleccion" label with TextInput for the pickup code. "Verificar y Entregar" button that calls `useConfirmPickup().mutate({ packageId: id, pickupCode })`.
           - If no active pickup code: Show "Confirmar Entrega" button (no code required) that calls `useConfirmPickup().mutate({ packageId: id })`.
           - On success: `Alert.alert('Entregado', 'Paquete marcado como entregado')` then `router.back()`.
           - On error: `Alert.alert('Error', error.message)`.
         - If already picked_up: Show "Entregado" status with picked_up_at date and picked_up_by info.
       - Disable confirm button while mutation isPending.
  </action>
  <verify>
    Run `cd packages/mobile && npx tsc --noEmit` -- no type errors. Verify all 5 screen files exist: `ls app/(guard)/directory/index.tsx app/(guard)/directory/vehicles.tsx app/(guard)/packages/index.tsx app/(guard)/packages/log.tsx app/(guard)/packages/\[id\].tsx`.
  </verify>
  <done>
    Resident directory searches by name or unit number with debounced input and blacklist alert. Vehicle search by plate with owner and access status display. Package list shows pending packages grouped by unit. Log screen has carrier picker, unit search, and label photo. Detail screen shows package info, timeline, and pickup verification with code validation.
  </done>
</task>

</tasks>

<verification>
1. `cd packages/mobile && npx tsc --noEmit` passes with zero errors
2. useResidentSearch returns residents with occupancies and unit details
3. useUnitSearch returns units with resident occupants
4. useVehicleSearch returns vehicles with owner and unit info
5. Directory search debounces input by 500ms before triggering query
6. BlacklistAlert appears inline when search name/plate matches blacklist
7. usePendingPackages returns packages sorted by unit_number
8. useLogPackage inserts package with received_by = guardId
9. useConfirmPickup validates pickup code before marking as picked_up
10. Package detail shows timeline and appropriate action buttons based on status
</verification>

<success_criteria>
- Guard can search residents by name (partial match, case-insensitive) and see unit assignments
- Guard can search residents by unit number and see occupants with phone numbers
- Guard can search vehicles by plate and see make/model/color/owner with access status
- Blacklist alerts appear during directory search when a match is found
- Guard can log a new package with carrier selection, unit search, and label photo
- Guard sees pending packages sorted by unit for efficient management
- Guard can verify pickup code and confirm package delivery
- Package detail shows full timeline and delivery status
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-mobile-core/10-05-SUMMARY.md`
</output>
