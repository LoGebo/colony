---
phase: 10-mobile-core
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - packages/mobile/src/hooks/useVisitors.ts
  - packages/mobile/src/components/visitors/InvitationCard.tsx
  - packages/mobile/src/components/visitors/QRCodeDisplay.tsx
  - packages/mobile/src/components/visitors/VisitorStatusBadge.tsx
  - packages/mobile/app/(resident)/visitors/index.tsx
  - packages/mobile/app/(resident)/visitors/create.tsx
  - packages/mobile/app/(resident)/visitors/[id].tsx
  - packages/mobile/app/(resident)/visitors/history.tsx
autonomous: true

must_haves:
  truths:
    - "Resident sees list of active/pending invitations with visitor name, time window, and status badge"
    - "Resident can create a single-use invitation with name, date, and time window"
    - "Resident can create a recurring invitation with selected days of the week"
    - "After creating an invitation, a QR code is displayed for the visitor"
    - "Resident can share the QR invitation via the native share sheet (WhatsApp accessible)"
    - "Resident can cancel a pending invitation from the detail screen"
    - "Resident can view past visitor history with infinite scroll pagination"
  artifacts:
    - path: "packages/mobile/src/hooks/useVisitors.ts"
      provides: "All visitor/invitation TanStack Query hooks"
      exports: ["useActiveInvitations", "useCreateInvitation", "useCancelInvitation", "useVisitorHistory", "useInvitationDetail"]
    - path: "packages/mobile/src/components/visitors/QRCodeDisplay.tsx"
      provides: "QR code rendering with share button"
      exports: ["QRCodeDisplay"]
    - path: "packages/mobile/src/components/visitors/InvitationCard.tsx"
      provides: "Invitation list item card"
      exports: ["InvitationCard"]
    - path: "packages/mobile/app/(resident)/visitors/index.tsx"
      provides: "Active visitors list screen"
    - path: "packages/mobile/app/(resident)/visitors/create.tsx"
      provides: "Create invitation form screen"
    - path: "packages/mobile/app/(resident)/visitors/[id].tsx"
      provides: "Invitation detail with QR code"
    - path: "packages/mobile/app/(resident)/visitors/history.tsx"
      provides: "Paginated visitor history"
  key_links:
    - from: "packages/mobile/app/(resident)/visitors/create.tsx"
      to: "packages/mobile/src/hooks/useVisitors.ts"
      via: "useCreateInvitation mutation"
      pattern: "useCreateInvitation"
    - from: "packages/mobile/app/(resident)/visitors/[id].tsx"
      to: "packages/mobile/src/components/visitors/QRCodeDisplay.tsx"
      via: "QR code rendering from invitation's qr_codes data"
      pattern: "QRCodeDisplay"
    - from: "packages/mobile/src/components/visitors/QRCodeDisplay.tsx"
      to: "expo-sharing"
      via: "Share QR code image via native share sheet"
      pattern: "Sharing\\.shareAsync"
    - from: "packages/mobile/src/hooks/useVisitors.ts"
      to: "packages/shared/src/queries/keys.ts"
      via: "Query key factory for cache invalidation"
      pattern: "queryKeys\\.visitors"
---

<objective>
Implement the complete resident visitor management flow: listing active invitations, creating single-use and recurring invitations, viewing invitation details with QR codes, sharing QR codes via WhatsApp/share sheet, cancelling invitations, and browsing visitor history with infinite scroll pagination.

Purpose: Visitor management is the #1 daily-use resident feature. Residents need to invite visitors, share QR codes for gate verification, and manage their invitation list.

Output: 4 visitor screens (list, create, detail, history) + visitor data hooks + QR code display/share component.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-mobile-core/10-RESEARCH.md
@.planning/phases/10-mobile-core/10-01-SUMMARY.md

# Phase 9 outputs
@packages/mobile/src/hooks/useAuth.ts
@packages/mobile/src/lib/supabase.ts
@packages/shared/src/queries/keys.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create visitor data hooks and reusable visitor components</name>
  <files>
    packages/mobile/src/hooks/useVisitors.ts
    packages/mobile/src/components/visitors/InvitationCard.tsx
    packages/mobile/src/components/visitors/QRCodeDisplay.tsx
    packages/mobile/src/components/visitors/VisitorStatusBadge.tsx
  </files>
  <action>
    1. **Create `packages/mobile/src/hooks/useVisitors.ts`** with these hooks:

       **`useActiveInvitations()`**: `useQuery` fetching invitations where `created_by_resident_id = residentId`, `community_id = communityId`, status IN ('approved', 'pending'), `cancelled_at IS NULL`, `deleted_at IS NULL`, `valid_until >= now()`. Select with `qr_codes(id, payload, status), units(unit_number)`. Order by `valid_from ASC`. Query key: `queryKeys.visitors.active(communityId!)`. `enabled: !!residentId && !!communityId`.

       **`useInvitationDetail(id: string)`**: `useQuery` fetching single invitation by id with `qr_codes(*), units(unit_number)`. Query key: `queryKeys.visitors.detail(id)`. `enabled: !!id`.

       **`useCreateInvitation()`**: `useMutation` that inserts into `invitations` table. The mutationFn accepts `{ visitor_name, invitation_type, valid_from, valid_until?, visitor_phone?, vehicle_plate?, recurring_days?, recurring_start_time?, recurring_end_time?, unit_id }`. Adds `community_id` and `created_by_resident_id` from `useAuth()`. Uses `.select().single()` to return the created invitation. `onSuccess`: invalidates `queryKeys.visitors._def` (all visitor queries). After insertion, check if a QR code was auto-generated by the trigger; if not, call `supabase.rpc('generate_qr_payload', ...)` -- but first check if there's a DB trigger that auto-creates qr_codes rows on invitation insert. If the qr_codes row exists (re-fetch with `.select('*, qr_codes(*)')`), return it. Otherwise, insert a qr_codes row manually with `is_single_use: invitation_type === 'single_use'`, `valid_from`, `valid_until` matching the invitation, and `status: 'active'`.

       **IMPORTANT**: The `generate_qr_payload` RPC requires a `secret_key` parameter. Since we don't have the QR HMAC secret configured yet, the QR code `payload` field on `qr_codes` rows may be empty. For now, generate a **fallback client-side QR payload** as `JSON.stringify({ invitation_id: data.id, community_id: communityId, created_at: Date.now() })`. This will be replaced when the QR HMAC infrastructure is configured. Add a `// TODO: Replace with server-side HMAC-signed payload when QR_HMAC_SECRET is configured` comment.

       **`useCancelInvitation()`**: `useMutation` that updates the invitation: set `status = 'cancelled'`, `cancelled_at = new Date().toISOString()`. Filter by `.eq('id', invitationId)`. `onSuccess`: invalidates `queryKeys.visitors._def`.

       **`useVisitorHistory(pageSize = 20)`**: `useInfiniteQuery` fetching paginated invitations for the resident. Select `*, qr_codes(id, status), units(unit_number)`. Filter: `created_by_resident_id = residentId`, `community_id = communityId`, `deleted_at IS NULL`. Order by `created_at DESC`. Use `.range(from, to)` with `{ count: 'exact' }`. `initialPageParam: 0`. `getNextPageParam` returns next page number if more pages exist, else `undefined`. `enabled: !!residentId && !!communityId`.

       Use `useAuth()` at the top of each hook to get `residentId` and `communityId`.

    2. **Create `packages/mobile/src/components/visitors/VisitorStatusBadge.tsx`**:
       - Wrapper around `StatusBadge` from `@/components/ui/Badge` with invitation-specific status variants:
         - `pending`: bg-yellow-100, text-yellow-800, label "Pendiente"
         - `approved`: bg-green-100, text-green-800, label "Aprobada"
         - `cancelled`: bg-gray-100, text-gray-600, label "Cancelada"
         - `expired`: bg-gray-100, text-gray-500, label "Expirada"
         - `rejected`: bg-red-100, text-red-800, label "Rechazada"
       - Props: `status: string`.

    3. **Create `packages/mobile/src/components/visitors/InvitationCard.tsx`**:
       - Props: `invitation` (the invitation object with qr_codes and units relations), `onPress: () => void`.
       - Pressable card (bg-white rounded-xl p-4 mb-3 shadow-sm).
       - Layout: Row with visitor_name (font-semibold text-gray-900) and VisitorStatusBadge on the right. Below: time window using `formatDateTime(valid_from)` if valid_from exists, and invitation_type label. Unit number from `units.unit_number` in text-sm text-gray-500.
       - Show invitation type: "Unica vez" for single_use, "Recurrente" for recurring, "Evento" for event, "Vehiculo" for vehicle_preauth.
       - Wrap with `React.memo` for FlatList performance.

    4. **Create `packages/mobile/src/components/visitors/QRCodeDisplay.tsx`**:
       - Props: `payload: string`, `visitorName: string`, `communityName: string`, `validUntil?: string`.
       - Render `QRCode` from `react-native-qrcode-svg` with `value={payload}`, `size={220}`, `getRef` to capture the ref for base64 export.
       - Below QR: visitor name (text-lg font-semibold), valid_until formatted (text-sm text-gray-500).
       - "Compartir" button (bg-green-500 rounded-lg px-6 py-3 text-white font-semibold):
         - On press: Extract base64 from QR ref via `toDataURL()`.
         - Strip newlines from base64 (react-native-qrcode-svg quirk).
         - Write to temp file using `FileSystem.writeAsStringAsync(FileSystem.cacheDirectory + 'qr-invitation.png', cleanBase64, { encoding: FileSystem.EncodingType.Base64 })`.
         - Build message text: `"Te invito a ${communityName}. Visitante: ${visitorName}"`.
         - Check `Sharing.isAvailableAsync()`. If yes, use `Sharing.shareAsync(fileUri, { mimeType: 'image/png', dialogTitle: 'Compartir invitacion' })`.
         - Fallback: try `Linking.openURL('whatsapp://send?text=...')`. Final fallback: `Share.share({ message })`.
       - Handle errors with `Alert.alert('Error', 'No se pudo compartir la invitacion')`.
  </action>
  <verify>
    Run `cd packages/mobile && npx tsc --noEmit` -- no type errors. Verify file existence: `ls src/hooks/useVisitors.ts src/components/visitors/InvitationCard.tsx src/components/visitors/QRCodeDisplay.tsx src/components/visitors/VisitorStatusBadge.tsx`.
  </verify>
  <done>
    5 visitor hooks exported (useActiveInvitations, useInvitationDetail, useCreateInvitation, useCancelInvitation, useVisitorHistory). InvitationCard renders visitor name, status badge, time window, and invitation type. QRCodeDisplay renders QR from payload with share-to-WhatsApp functionality via expo-sharing. VisitorStatusBadge renders colored pill for each invitation status.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement all 4 visitor screens (list, create, detail, history)</name>
  <files>
    packages/mobile/app/(resident)/visitors/index.tsx
    packages/mobile/app/(resident)/visitors/create.tsx
    packages/mobile/app/(resident)/visitors/[id].tsx
    packages/mobile/app/(resident)/visitors/history.tsx
  </files>
  <action>
    1. **Create `packages/mobile/app/(resident)/visitors/index.tsx`** -- Active visitors list:
       - Use `useActiveInvitations()` hook.
       - FlatList rendering `InvitationCard` for each invitation.
       - `onPress` on each card navigates to `/(resident)/visitors/${item.id}` via `router.push`.
       - Pull-to-refresh via `refreshing={isRefetching}` and `onRefresh={refetch}`.
       - `ListEmptyComponent`: `EmptyState` with message "No tienes visitantes activos".
       - Header area with title "Visitantes" (text-xl font-bold) and two buttons:
         - "Nueva Invitacion" (bg-blue-600 rounded-lg px-4 py-2 text-white) navigates to `/(resident)/visitors/create`.
         - "Historial" (text-blue-600 underline) navigates to `/(resident)/visitors/history`.
       - Loading state: `LoadingSpinner` while `isLoading` is true.

    2. **Create `packages/mobile/app/(resident)/visitors/create.tsx`** -- Create invitation form:
       - Form state: `visitorName` (string, required), `visitorPhone` (string, optional), `vehiclePlate` (string, optional), `invitationType` ('single_use' | 'recurring', default 'single_use'), `validFrom` (string, required), `validUntil` (string, optional), `recurringDays` (number[], for recurring), `recurringStartTime` (string), `recurringEndTime` (string).
       - Invitation type selector: Two Pressable buttons styled as segmented control. "Una vez" (single_use) and "Recurrente" (recurring). Active button has bg-blue-600 text-white, inactive has bg-gray-100 text-gray-700.
       - For **single_use**: Show visitor name (required), visitor phone, vehicle plate, valid_from (date/time input as TextInput with placeholder "YYYY-MM-DD HH:mm"), valid_until (optional date/time).
       - For **recurring**: Show visitor name (required), visitor phone, vehicle plate, day-of-week multi-selector (7 Pressable chips for Lun-Dom, toggling `recurringDays` array with values 1-5 for weekdays, 0 and 6 for weekend), recurring start time, recurring end time. Set `valid_from` to today's date and `valid_until` to null (open-ended).
       - All form fields use TextInput with NativeWind styling: `border border-gray-300 rounded-lg p-3 mb-4`. Labels use `text-sm font-medium text-gray-700 mb-1`.
       - Submit button ("Crear Invitacion", bg-blue-600 rounded-lg p-4): calls `useCreateInvitation().mutate()`. On success: navigate to `/(resident)/visitors/${data.id}` to show the QR code. On error: `Alert.alert('Error', error.message)`.
       - Disable submit while `isPending`.
       - Wrap in `KeyboardAvoidingView` with `behavior={Platform.OS === 'ios' ? 'padding' : undefined}` and `ScrollView`.
       - Use `useResidentUnit()` from 10-01 to get `unitId` and pass it in the mutation payload.

    3. **Create `packages/mobile/app/(resident)/visitors/[id].tsx`** -- Invitation detail with QR:
       - Get `id` from `useLocalSearchParams<{ id: string }>()`.
       - Use `useInvitationDetail(id)` hook.
       - Loading state: `LoadingSpinner`.
       - Error/not found: `EmptyState` with message "Invitacion no encontrada".
       - Layout (ScrollView, bg-gray-50):
         - QR code section: If invitation has associated `qr_codes[0]`, render `QRCodeDisplay` with `payload={qr.payload || fallbackPayload}`, `visitorName={invitation.visitor_name}`, `communityName` from `useCommunityBranding`. If no qr_codes, show a "QR no disponible" message.
         - Invitation details section (SectionCard): visitor_name, visitor_phone, vehicle_plate, invitation_type label, valid_from/valid_until formatted, status badge.
         - If recurring: show recurring days as day-name chips and time window.
         - Cancel button: Only show if status is 'pending' or 'approved'. Red outline button "Cancelar Invitacion". On press: `Alert.alert` confirmation dialog. On confirm: call `useCancelInvitation().mutate(id)`. On success: `router.back()`.

    4. **Create `packages/mobile/app/(resident)/visitors/history.tsx`** -- Visitor history with infinite scroll:
       - Use `useVisitorHistory()` hook.
       - Flatten pages: `const allItems = data?.pages.flatMap((p) => p.data) ?? []`.
       - FlatList with `InvitationCard` for each item. `onPress` navigates to detail screen.
       - `onEndReached`: if `hasNextPage && !isFetchingNextPage`, call `fetchNextPage()`. `onEndReachedThreshold={0.5}`.
       - Pull-to-refresh via `refreshing={isRefetching}` and `onRefresh={refetch}`.
       - `ListEmptyComponent`: `EmptyState` with "Sin historial de visitantes".
       - `ListFooterComponent`: `LoadingSpinner` when `isFetchingNextPage`.
       - Header: "Historial de Visitantes" title.
  </action>
  <verify>
    Run `cd packages/mobile && npx tsc --noEmit` -- no type errors. Verify all 4 screen files exist: `ls app/(resident)/visitors/index.tsx app/(resident)/visitors/create.tsx app/(resident)/visitors/\[id\].tsx app/(resident)/visitors/history.tsx`.
  </verify>
  <done>
    Active visitors list shows FlatList with InvitationCard items linking to detail screen. Create screen has form for single-use and recurring invitations with type toggle. Detail screen shows QR code with share button and cancel functionality. History screen shows paginated infinite-scroll list of all past invitations. All screens handle loading, empty, and error states.
  </done>
</task>

</tasks>

<verification>
1. `cd packages/mobile && npx tsc --noEmit` passes with zero errors
2. useActiveInvitations returns invitations with qr_codes and units relations
3. useCreateInvitation inserts invitation and invalidates visitor query cache
4. useCancelInvitation updates status to cancelled and invalidates cache
5. useVisitorHistory returns paginated data with getNextPageParam logic
6. QRCodeDisplay renders QR code SVG and sharing works via expo-sharing
7. Active visitors list renders InvitationCard items with pull-to-refresh
8. Create form supports both single_use and recurring types with validation
9. Detail screen shows QR code, invitation details, and cancel button for active invitations
10. History screen uses useInfiniteQuery with FlatList onEndReached pagination
</verification>

<success_criteria>
- Resident can view active invitations list with status badges and time windows
- Resident can create single-use invitation (name + date + time) and see QR code immediately
- Resident can create recurring invitation with day-of-week selection
- Resident can share QR code via native share sheet
- Resident can cancel a pending/approved invitation with confirmation dialog
- Resident can browse visitor history with infinite scroll (loads next page on scroll)
- All screens handle loading, empty, and error states gracefully
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-mobile-core/10-02-SUMMARY.md`
</output>
