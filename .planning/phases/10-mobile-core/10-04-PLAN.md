---
phase: 10-mobile-core
plan: 04
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - packages/mobile/src/hooks/useGateOps.ts
  - packages/mobile/src/components/guard/VisitorQueueCard.tsx
  - packages/mobile/src/components/guard/BlacklistAlert.tsx
  - packages/mobile/src/components/guard/AccessLogRow.tsx
  - packages/mobile/app/(guard)/gate/scan.tsx
  - packages/mobile/app/(guard)/gate/manual-checkin.tsx
  - packages/mobile/app/(guard)/gate/visitor-result.tsx
autonomous: true

must_haves:
  truths:
    - "Guard can scan a QR code using the device camera and see instant verification result"
    - "Guard can manually check in a walk-in visitor with name, unit, and vehicle info"
    - "Guard sees blacklist alert if a visitor name or vehicle plate matches an active blacklist entry"
    - "Guard can log entry and exit with timestamp, method, and direction"
    - "Guard can capture a visitor photo during check-in"
    - "Guard sees verification result with visitor details, invitation info, and allow/deny decision"
  artifacts:
    - path: "packages/mobile/src/hooks/useGateOps.ts"
      provides: "Gate operation TanStack Query hooks"
      exports: ["useVerifyQR", "useManualCheckIn", "useLogAccess", "useBlacklistCheck", "useTodayAccessLogs"]
    - path: "packages/mobile/src/components/guard/BlacklistAlert.tsx"
      provides: "Blacklist warning banner"
      exports: ["BlacklistAlert"]
    - path: "packages/mobile/app/(guard)/gate/scan.tsx"
      provides: "QR scanner screen using expo-camera"
    - path: "packages/mobile/app/(guard)/gate/manual-checkin.tsx"
      provides: "Manual visitor check-in form"
    - path: "packages/mobile/app/(guard)/gate/visitor-result.tsx"
      provides: "Verification result display"
  key_links:
    - from: "packages/mobile/app/(guard)/gate/scan.tsx"
      to: "packages/mobile/src/hooks/useGateOps.ts"
      via: "useVerifyQR mutation after barcode scan"
      pattern: "useVerifyQR"
    - from: "packages/mobile/app/(guard)/gate/scan.tsx"
      to: "expo-camera"
      via: "CameraView with onBarcodeScanned"
      pattern: "CameraView.*onBarcodeScanned"
    - from: "packages/mobile/app/(guard)/gate/manual-checkin.tsx"
      to: "packages/mobile/src/hooks/useGateOps.ts"
      via: "useManualCheckIn and useBlacklistCheck hooks"
      pattern: "useManualCheckIn|useBlacklistCheck"
    - from: "packages/mobile/app/(guard)/gate/visitor-result.tsx"
      to: "packages/mobile/src/hooks/useGateOps.ts"
      via: "useLogAccess mutation to record entry"
      pattern: "useLogAccess"
---

<objective>
Implement guard gate operations: QR code scanning with expo-camera for instant verification, manual walk-in visitor check-in with blacklist checking, verification result display with allow/deny decision, and entry/exit logging with photo capture.

Purpose: Gate operations are the core guard workflow. Guards need fast, reliable QR scanning for pre-authorized visitors and a manual check-in flow for walk-ins, both with blacklist alerts for security.

Output: 3 gate screens (QR scanner, manual check-in, verification result) + gate operation data hooks + guard UI components.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-mobile-core/10-RESEARCH.md
@.planning/phases/10-mobile-core/10-01-SUMMARY.md

# Phase 9 outputs
@packages/mobile/src/hooks/useAuth.ts
@packages/mobile/src/lib/supabase.ts
@packages/mobile/src/lib/upload.ts
@packages/shared/src/queries/keys.ts
@packages/shared/src/constants/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gate operation hooks and guard UI components</name>
  <files>
    packages/mobile/src/hooks/useGateOps.ts
    packages/mobile/src/components/guard/VisitorQueueCard.tsx
    packages/mobile/src/components/guard/BlacklistAlert.tsx
    packages/mobile/src/components/guard/AccessLogRow.tsx
  </files>
  <action>
    1. **Create `packages/mobile/src/hooks/useGateOps.ts`** with these hooks:

       **`useVerifyQR()`**: `useMutation` that calls `supabase.functions.invoke('verify-qr', { body: { qr_payload: payload } })`. The mutationFn accepts a `payload: string`. Returns the edge function response which should contain `{ valid: boolean, data?: [...], error?: string }`. Handle network errors gracefully.

       **NOTE on QR infrastructure**: The `verify-qr` edge function may not have the QR_HMAC_SECRET configured yet. If verification returns an error about invalid signature, the mutation should still return the error to the caller so the UI can display it. Add a comment: `// TODO: QR_HMAC_SECRET must be configured in edge function env vars for production use`.

       **`useBlacklistCheck(params: { communityId: string; personName?: string; personDocument?: string; plateNormalized?: string })`**: `useQuery` calling `supabase.rpc('is_blacklisted', { p_community_id: params.communityId, p_person_name: params.personName ?? undefined, p_person_document: params.personDocument ?? undefined, p_plate_normalized: params.plateNormalized ?? undefined })`. Extract `data?.[0] ?? { is_blocked: false }`. Query key: `['blacklist-check', params]`. `enabled: !!(params.personName || params.personDocument || params.plateNormalized)`. **IMPORTANT**: Use `undefined` (not `null`) for optional RPC params per project convention.

       **`useManualCheckIn()`**: `useMutation` that inserts into `access_logs` table. The mutationFn accepts `{ person_name: string, person_type?: string, person_document?: string, vehicle_plate?: string, plate_detected?: string, direction: string, method: string, decision: string, photo_url?: string, photo_vehicle_url?: string, guard_notes?: string, unit_id?: string }`. Adds `community_id` from `useAuth().communityId`, `processed_by` from `useAuth().guardId` (guardId is the business ID from app_metadata). Uses `.select().single()`. `onSuccess`: invalidates `queryKeys.accessLogs._def`.

       **`useLogAccess()`**: `useMutation` that inserts into `access_logs` table for QR-verified visitors. The mutationFn accepts `{ invitation_id?: string, qr_code_id?: string, person_name: string, person_type?: string, direction: string, method: string, decision: string, photo_url?: string, guard_notes?: string }`. Adds `community_id`, `processed_by` from auth. Also calls `supabase.rpc('burn_qr_code', { p_qr_id: qrCodeId, p_guard_id: guardId })` if qr_code_id is provided and direction is 'entry' (to mark single-use QR as used). `onSuccess`: invalidates `queryKeys.accessLogs._def` and `queryKeys.visitors._def`.

       **`useTodayAccessLogs()`**: `useQuery` fetching today's access logs for the current community. Select: `id, person_name, person_type, direction, method, decision, logged_at, plate_number, guard_notes, photo_url`. Filter: `community_id`, `logged_at >= today start (midnight)`. Order: `logged_at DESC`. Limit 50. Query key: `queryKeys.accessLogs.today(communityId!)`. `enabled: !!communityId`.

    2. **Create `packages/mobile/src/components/guard/VisitorQueueCard.tsx`**:
       - Props: `visitor` (invitation object with units relation), `onPress?: () => void`.
       - Pressable card (bg-white rounded-lg p-4 mb-2).
       - Row: visitor_name (font-semibold text-gray-900), unit_number on the right (text-sm text-gray-400).
       - Below: time window using `formatTime(valid_from)` - `formatTime(valid_until)` or "Todo el dia". Invitation type badge (text-xs).
       - Wrap with `React.memo`.

    3. **Create `packages/mobile/src/components/guard/BlacklistAlert.tsx`**:
       - Props: `blacklistResult: { is_blocked: boolean; blacklist_id?: string; reason?: string; protocol?: string }`.
       - Only render if `is_blocked === true`.
       - Red warning banner: bg-red-600 rounded-xl p-4. Icon/emoji warning, "ALERTA DE LISTA NEGRA" in text-white font-bold text-lg. Reason in text-white text-sm below. Protocol instruction (e.g., "Protocolo: Denegar entrada") in text-red-100 text-sm.
       - Animate: Consider a simple pulse or border effect for visibility. At minimum, use a prominent red background.

    4. **Create `packages/mobile/src/components/guard/AccessLogRow.tsx`**:
       - Props: `log` (access_log object from the query).
       - Row (bg-white px-4 py-3 border-b border-gray-100).
       - Left: direction arrow (text for "Entrada" in green, "Salida" in blue), person_name, method label.
       - Right: time using `formatTime` from logged_at, decision badge (allowed=green, denied=red, blocked=red bold).
       - Wrap with `React.memo`.
  </action>
  <verify>
    Run `cd packages/mobile && npx tsc --noEmit` -- no type errors. Verify: `ls src/hooks/useGateOps.ts src/components/guard/VisitorQueueCard.tsx src/components/guard/BlacklistAlert.tsx src/components/guard/AccessLogRow.tsx`.
  </verify>
  <done>
    5 gate operation hooks exported (useVerifyQR, useBlacklistCheck, useManualCheckIn, useLogAccess, useTodayAccessLogs). VisitorQueueCard renders expected visitor with time window and unit. BlacklistAlert renders prominent red warning when match found. AccessLogRow renders entry/exit log with direction, decision, and time.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement QR scanner, manual check-in, and verification result screens</name>
  <files>
    packages/mobile/app/(guard)/gate/scan.tsx
    packages/mobile/app/(guard)/gate/manual-checkin.tsx
    packages/mobile/app/(guard)/gate/visitor-result.tsx
  </files>
  <action>
    1. **Create `packages/mobile/app/(guard)/gate/scan.tsx`** -- QR Scanner:
       - Use `useCameraPermissions()` from `expo-camera` for permission handling.
       - State: `scanned` (boolean, prevents double-scan), `processing` (boolean).
       - Permission denied view: Message "Se necesita permiso de camara para escanear codigos QR" + "Permitir Camara" button calling `requestPermission()`.
       - Camera view: `CameraView` with `className="flex-1"`, `barcodeScannerSettings={{ barcodeTypes: ['qr'] }}`, `onBarcodeScanned={scanned ? undefined : handleBarcodeScanned}`.
       - `handleBarcodeScanned({ data })`: Set `scanned=true`, `processing=true`. Call `verifyQR.mutateAsync(data)`. On success: if result is valid, navigate to `/(guard)/gate/visitor-result` with params `{ qrId, communityId, invitationId, visitorName, valid: 'true' }`. On invalid/error: `Alert.alert('Codigo Invalido', errorMessage, [{ text: 'Escanear otro', onPress: () => setScanned(false) }])`. Set `processing=false` in finally block.
       - Overlay: Semi-transparent viewfinder frame centered on camera (a View with transparent center and dark edges). Optional: text instruction "Apunta al codigo QR".
       - "Escanear otro" floating button at bottom when `scanned=true`.
       - Use `useVerifyQR()` hook.

    2. **Create `packages/mobile/app/(guard)/gate/manual-checkin.tsx`** -- Manual check-in form:
       - Form state: `visitorName` (required), `personDocument` (optional), `vehiclePlate` (optional), `direction` ('entry' | 'exit', default 'entry'), `guardNotes` (optional), `photoUrl` (string | null).
       - Use `useAuth()` for `guardId`, `communityId`.
       - Use `useBlacklistCheck()` with debounced inputs: trigger when `visitorName.length >= 3` or `vehiclePlate.length >= 3`. Debounce by only enabling the query when the user hasn't typed for 500ms (use a `debouncedName`/`debouncedPlate` state updated via `setTimeout`).
       - Blacklist alert: If `blacklistCheck.data?.is_blocked`, render `BlacklistAlert` component prominently above the form.
       - Direction toggle: Two buttons "Entrada" (entry) and "Salida" (exit) as segmented control. Active = bg-blue-600 text-white, inactive = bg-gray-100 text-gray-700.
       - Photo capture: "Tomar foto" button that calls `pickAndUploadImage(STORAGE_BUCKETS.INCIDENT_EVIDENCE, communityId!, 'visitor-photos')` -- reuse the image picker utility. Show thumbnail preview if photo taken. Note: using incident-evidence bucket for visitor photos since there's no dedicated visitor-photos bucket.
       - Form fields: visitorName (required), personDocument, vehiclePlate, guardNotes (multiline TextInput with numberOfLines={3}).
       - Submit: "Registrar {direction === 'entry' ? 'Entrada' : 'Salida'}" button.
         - Call `useManualCheckIn().mutate()` with: `person_name`, `person_type: 'visitor'`, `person_document`, `vehicle_plate` (normalize: strip non-alphanumeric, uppercase), `plate_detected` (raw input), `direction`, `method: 'manual'`, `decision: blacklistCheck.data?.is_blocked ? 'denied' : 'allowed'`, `photo_url`, `guard_notes`.
         - On success: `Alert.alert('Registrado', 'Acceso registrado exitosamente')` then `router.back()`.
         - On error: `Alert.alert('Error', error.message)`.
       - Disable submit while mutation isPending.
       - Wrap in KeyboardAvoidingView + ScrollView.

    3. **Create `packages/mobile/app/(guard)/gate/visitor-result.tsx`** -- Verification result:
       - Get params from `useLocalSearchParams`: `{ qrId, communityId, invitationId, visitorName, valid }`.
       - Use `useQuery` to fetch invitation details if `invitationId` is present: `supabase.from('invitations').select('*, units(unit_number), residents:created_by_resident_id(first_name, paternal_surname)').eq('id', invitationId).single()`. Query key: `['gate-verification', invitationId]`. `enabled: !!invitationId`.
       - Use `useBlacklistCheck()` with the visitor name from params.
       - Use `useLogAccess()` mutation.
       - Layout (ScrollView):
         - Result banner at top: If `valid === 'true'`: green banner (bg-green-500 rounded-xl p-6) with checkmark and "ACCESO PERMITIDO" in text-white text-xl font-bold. If not valid: red banner (bg-red-500 rounded-xl p-6) with X and "ACCESO DENEGADO".
         - BlacklistAlert if blacklist check returns positive.
         - Visitor details section (SectionCard): visitor_name, unit_number, invitation_type, time window, resident who created it (first_name + paternal_surname).
         - Action buttons:
           - "Registrar Entrada" (bg-green-600 rounded-lg p-4): calls `useLogAccess().mutate()` with `invitation_id, qr_code_id, person_name, direction: 'entry', method: 'qr_scan', decision: 'allowed'`. On success: `Alert.alert('Registrado', 'Entrada registrada')` then `router.back()` twice (back to gate dashboard).
           - "Registrar Salida" (bg-blue-600 rounded-lg p-4): same but `direction: 'exit'`.
           - "Denegar" (bg-red-600 rounded-lg p-4): Only show if blacklist detected or guard decides to deny. Calls `useLogAccess().mutate()` with `decision: 'denied'`.
         - Photo capture button: "Tomar foto visitante" using `pickAndUploadImage`. Store URL and include in `useLogAccess` call as `photo_url`.
       - Disable action buttons after one is pressed (prevent double-log).
  </action>
  <verify>
    Run `cd packages/mobile && npx tsc --noEmit` -- no type errors. Verify all 3 screen files exist: `ls app/(guard)/gate/scan.tsx app/(guard)/gate/manual-checkin.tsx app/(guard)/gate/visitor-result.tsx`.
  </verify>
  <done>
    QR scanner screen uses CameraView with barcode scanning, shows permission request when needed, and navigates to result on scan. Manual check-in form has visitor fields, direction toggle, blacklist auto-check, and photo capture. Verification result shows allow/deny banner, visitor details, blacklist alert, and entry/exit logging buttons. All screens handle loading, error, and disabled states.
  </done>
</task>

</tasks>

<verification>
1. `cd packages/mobile && npx tsc --noEmit` passes with zero errors
2. useVerifyQR calls supabase.functions.invoke('verify-qr') with qr_payload
3. useBlacklistCheck calls is_blacklisted RPC with correct param names (undefined not null)
4. useManualCheckIn inserts into access_logs with processed_by = guardId
5. useLogAccess inserts access log and calls burn_qr_code RPC for single-use QR entries
6. QR scanner screen uses CameraView with barcodeTypes: ['qr'] and handles permission
7. Manual check-in form debounces blacklist check on visitor name and vehicle plate
8. BlacklistAlert renders red warning banner when is_blocked is true
9. Verification result screen shows green/red banner and provides entry/exit/deny buttons
10. Photo capture uses pickAndUploadImage utility from Phase 9
</verification>

<success_criteria>
- Guard can open QR scanner, grant camera permission, and scan a QR code
- QR scan result shows verified/denied status with visitor details
- Guard can register entry or exit after QR verification
- Guard can manually check in walk-in visitors with name, document, vehicle info
- Blacklist auto-check fires when guard types visitor name or plate (debounced)
- Blacklist alert is prominently displayed when match found
- Guard can capture visitor photo during both QR and manual check-in
- Guard can add notes to access log entries
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-mobile-core/10-04-SUMMARY.md`
</output>
