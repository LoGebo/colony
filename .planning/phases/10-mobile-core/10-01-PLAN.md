---
phase: 10-mobile-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mobile/package.json
  - packages/mobile/app.json
  - packages/mobile/src/lib/dates.ts
  - packages/mobile/src/hooks/useCommunity.ts
  - packages/mobile/src/hooks/useOccupancy.ts
  - packages/mobile/src/components/ui/Card.tsx
  - packages/mobile/src/components/ui/Badge.tsx
  - packages/mobile/src/components/ui/EmptyState.tsx
  - packages/mobile/src/components/ui/LoadingSpinner.tsx
  - packages/mobile/app/(resident)/index.tsx
  - packages/mobile/app/(resident)/visitors/_layout.tsx
  - packages/mobile/app/(resident)/payments/_layout.tsx
  - packages/mobile/app/(guard)/_layout.tsx
  - packages/mobile/app/(guard)/index.tsx
  - packages/mobile/app/(guard)/gate/_layout.tsx
  - packages/mobile/app/(guard)/directory/_layout.tsx
  - packages/mobile/app/(guard)/packages/_layout.tsx
  - packages/shared/src/queries/keys.ts
autonomous: true

must_haves:
  truths:
    - "Resident sees home dashboard with community name, balance card, and active visitors count"
    - "Dashboard balance card navigates to payments tab on press"
    - "Dashboard visitors card navigates to visitors tab on press"
    - "Guard sees gate dashboard with Scan QR and Manual Check-in action buttons"
    - "Guard tabs show Caseta, Directorio, and Paquetes navigation"
    - "New npm dependencies install without errors and app compiles"
  artifacts:
    - path: "packages/mobile/src/lib/dates.ts"
      provides: "Date formatting utilities with Spanish locale"
      contains: "formatDate, formatDateTime, formatTime, formatRelative"
    - path: "packages/mobile/src/hooks/useCommunity.ts"
      provides: "Community branding data hook"
      exports: ["useCommunityBranding"]
    - path: "packages/mobile/src/hooks/useOccupancy.ts"
      provides: "Resident occupancy resolution hook"
      exports: ["useResidentOccupancy"]
    - path: "packages/mobile/src/components/ui/Card.tsx"
      provides: "Reusable dashboard summary card"
      exports: ["DashboardCard"]
    - path: "packages/mobile/src/components/ui/EmptyState.tsx"
      provides: "Empty list state component"
      exports: ["EmptyState"]
    - path: "packages/mobile/src/components/ui/LoadingSpinner.tsx"
      provides: "Loading indicator component"
      exports: ["LoadingSpinner"]
    - path: "packages/mobile/app/(resident)/index.tsx"
      provides: "Resident home dashboard with summary cards"
    - path: "packages/mobile/app/(guard)/index.tsx"
      provides: "Guard gate dashboard with action buttons"
  key_links:
    - from: "packages/mobile/app/(resident)/index.tsx"
      to: "packages/mobile/src/hooks/useCommunity.ts"
      via: "useCommunityBranding hook call"
      pattern: "useCommunityBranding"
    - from: "packages/mobile/app/(resident)/index.tsx"
      to: "packages/mobile/src/hooks/useOccupancy.ts"
      via: "useResidentOccupancy hook call"
      pattern: "useResidentOccupancy"
    - from: "packages/mobile/app/(resident)/index.tsx"
      to: "expo-router"
      via: "router.push to visitor and payment tabs"
      pattern: "router\\.push"
---

<objective>
Install Phase 10 dependencies, create shared UI primitives, date utilities, community/occupancy data hooks, and implement the resident home dashboard with summary cards and the guard gate dashboard with action buttons. Update navigation layouts for both resident (add stack navigators for visitors/payments sub-routes) and guard (restructure tabs for gate, directory, packages).

Purpose: Establish the shared foundation (components, hooks, utilities) that all other Phase 10 plans depend on, plus deliver the two dashboard home screens that serve as the entry points for both user roles.

Output: Working resident dashboard with live data cards + working guard dashboard with action buttons + all shared infrastructure for Phase 10.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-mobile-core/10-RESEARCH.md

# Phase 9 outputs (existing infrastructure)
@packages/mobile/src/hooks/useAuth.ts
@packages/mobile/src/hooks/useRole.ts
@packages/mobile/src/lib/supabase.ts
@packages/mobile/src/lib/upload.ts
@packages/mobile/src/providers/SessionProvider.tsx
@packages/mobile/src/providers/QueryProvider.tsx
@packages/shared/src/queries/keys.ts
@packages/shared/src/constants/storage.ts

# Existing layouts and placeholders
@packages/mobile/app/(resident)/_layout.tsx
@packages/mobile/app/(resident)/index.tsx
@packages/mobile/app/(guard)/_layout.tsx
@packages/mobile/app/(guard)/index.tsx
@packages/mobile/app.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, configure plugins, create shared utilities and UI components</name>
  <files>
    packages/mobile/package.json
    packages/mobile/app.json
    packages/mobile/src/lib/dates.ts
    packages/mobile/src/components/ui/Card.tsx
    packages/mobile/src/components/ui/Badge.tsx
    packages/mobile/src/components/ui/EmptyState.tsx
    packages/mobile/src/components/ui/LoadingSpinner.tsx
    packages/shared/src/queries/keys.ts
  </files>
  <action>
    1. **Install new npm dependencies** (run from `packages/mobile`):
       ```bash
       npx expo install expo-camera expo-sharing expo-file-system
       npm install react-native-qrcode-svg date-fns
       ```

    2. **Update app.json** -- Add expo-camera plugin with Spanish permission message:
       ```json
       "plugins": [
         "expo-router",
         "expo-sqlite",
         ["expo-camera", { "cameraPermission": "La app necesita acceso a la camara para escanear codigos QR" }]
       ]
       ```

    3. **Create `packages/mobile/src/lib/dates.ts`** -- Date formatting utilities using date-fns with Spanish locale:
       - `formatDate(dateStr: string): string` -- "dd MMM yyyy" (e.g., "08 feb 2026")
       - `formatDateTime(dateStr: string): string` -- "dd MMM yyyy, HH:mm"
       - `formatTime(timeStr: string): string` -- Extracts HH:mm from "HH:mm:ss"
       - `formatRelative(dateStr: string): string` -- "hace 5 minutos" etc.
       - `formatCurrency(amount: number, currency?: string): string` -- "$1,234.56 MXN"
       - `isExpired(dateStr: string | null): boolean`
       - `isUpcoming(dateStr: string): boolean`
       - `DAY_LABELS: Record<number, string>` -- Spanish day names (0=Domingo through 6=Sabado)
       All date functions use `parseISO` from date-fns and `es` locale.

    4. **Create shared UI components** (all use NativeWind className styling):

       **`packages/mobile/src/components/ui/Card.tsx`**:
       - `DashboardCard` component: Pressable card with `title` (string), `value` (string), `subtitle?` (string), `onPress` (function), `color?` (NativeWind bg class, default 'bg-blue-50'). Layout: title in text-sm text-gray-600, value in text-2xl font-bold text-gray-900, optional subtitle in text-xs text-gray-500. Rounded-xl with p-4 and mb-3.
       - `SectionCard` component: Simple View wrapper with bg-white rounded-xl p-4 shadow-sm for section grouping.

       **`packages/mobile/src/components/ui/Badge.tsx`**:
       - `StatusBadge` component: Takes `status` string and `variant` map (Record<string, { bg: string; text: string; label: string }>). Renders a small rounded-full pill with px-2 py-0.5 and the mapped colors/label. Default variants for common statuses: pending (yellow), approved (green), rejected (red), active (blue), expired (gray), cancelled (gray).

       **`packages/mobile/src/components/ui/EmptyState.tsx`**:
       - `EmptyState` component: Takes `message` (string), optional `icon` (string emoji). Centered view with py-12, icon in text-4xl, message in text-gray-400 text-center.

       **`packages/mobile/src/components/ui/LoadingSpinner.tsx`**:
       - `LoadingSpinner` component: Centered View with ActivityIndicator (color="#2563eb") and optional `message` prop in text-sm text-gray-500.

    5. **Update query key factories** (`packages/shared/src/queries/keys.ts`):
       - Add `packages` key factory: `all`, `list: (communityId: string) => [{ communityId }]`, `detail: (id: string) => [id]`, `pending: (communityId: string) => [{ communityId }]`
       - Add `occupancies` key factory: `all`, `byResident: (residentId: string) => [{ residentId }]`
       - Add `shifts` key factory: `all`, `current: (guardId: string) => [{ guardId }]`
       - Merge all new factories into the exported `queryKeys`.
  </action>
  <verify>
    Run `cd packages/mobile && npx tsc --noEmit` -- no type errors. Run `cd packages/shared && npx tsc --noEmit` -- no type errors. Verify packages installed: `ls node_modules/react-native-qrcode-svg node_modules/date-fns`.
  </verify>
  <done>
    All Phase 10 dependencies installed, app.json updated with camera plugin, date utilities export 7+ functions with Spanish locale, 4 shared UI components exist with NativeWind styling, query key factories include packages/occupancies/shifts domains.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create data hooks, navigation layouts, and implement both dashboards</name>
  <files>
    packages/mobile/src/hooks/useCommunity.ts
    packages/mobile/src/hooks/useOccupancy.ts
    packages/mobile/app/(resident)/index.tsx
    packages/mobile/app/(resident)/visitors/_layout.tsx
    packages/mobile/app/(resident)/payments/_layout.tsx
    packages/mobile/app/(guard)/_layout.tsx
    packages/mobile/app/(guard)/index.tsx
    packages/mobile/app/(guard)/gate/_layout.tsx
    packages/mobile/app/(guard)/directory/_layout.tsx
    packages/mobile/app/(guard)/packages/_layout.tsx
  </files>
  <action>
    1. **Create `packages/mobile/src/hooks/useCommunity.ts`**:
       - `useCommunityBranding(communityId?: string)` -- `useQuery` that fetches from `communities` table: `select('id, name, logo_url, cover_image_url, primary_color, secondary_color')` filtered by `.eq('id', communityId)` and `.single()`. Query key: `queryKeys.communities.detail(communityId!)`. `enabled: !!communityId`. Returns typed community branding data.
       - Import `queryKeys` from `@upoe/shared`, `supabase` from `@/lib/supabase`, `useQuery` from `@tanstack/react-query`.

    2. **Create `packages/mobile/src/hooks/useOccupancy.ts`**:
       - `useResidentOccupancy(residentId?: string)` -- `useQuery` that fetches from `occupancies` table: `select('id, unit_id, is_primary, units(id, unit_number, building, floor_number)')` filtered by `.eq('resident_id', residentId!)` and `.eq('status', 'active')` and `.is('deleted_at', null)` and `.order('is_primary', { ascending: false })`. Query key: `queryKeys.occupancies.byResident(residentId!)`. `enabled: !!residentId`.
       - Export `useResidentUnit()` convenience hook that calls `useResidentOccupancy` and returns the first occupancy's unit data (the primary unit). Returns `{ unitId, unitNumber, building, floorNumber, isLoading }`.

    3. **Create Stack navigators for resident sub-routes**:

       **`packages/mobile/app/(resident)/visitors/_layout.tsx`**:
       Stack navigator with `headerShown: false` on the stack level. Screens: `index` (title "Visitantes"), `create` (title "Nueva Invitacion"), `[id]` (title "Detalle Invitacion"), `history` (title "Historial").

       **`packages/mobile/app/(resident)/payments/_layout.tsx`**:
       Stack navigator with `headerShown: false` on the stack level. Screens: `index` (title "Pagos"), `history` (title "Historial de Pagos"), `upload-proof` (title "Subir Comprobante").

    4. **Update guard tab layout** (`packages/mobile/app/(guard)/_layout.tsx`):
       - Change tabs to: `index` (label "Caseta", gate icon), `directory` (label "Directorio", search icon), `packages` (label "Paquetes", package icon).
       - Remove `visitors`, `patrol`, `incidents` tab screens (those will be added in Phase 14).
       - Gate operations (scan, manual check-in) will be navigated to from the index tab using router.push, not as separate tabs.

    5. **Create Stack navigators for guard sub-routes**:

       **`packages/mobile/app/(guard)/gate/_layout.tsx`**:
       Stack navigator. Screens: `scan` (title "Escanear QR"), `manual-checkin` (title "Registro Manual"), `visitor-result` (title "Resultado").

       **`packages/mobile/app/(guard)/directory/_layout.tsx`**:
       Stack navigator. Screens: `index` (title "Directorio"), `vehicles` (title "Vehiculos").

       **`packages/mobile/app/(guard)/packages/_layout.tsx`**:
       Stack navigator. Screens: `index` (title "Paquetes"), `log` (title "Registrar Paquete"), `[id]` (title "Detalle Paquete").

    6. **Implement resident dashboard** (`packages/mobile/app/(resident)/index.tsx`):
       - Replace placeholder with full dashboard screen.
       - Use `useAuth()` to get `residentId`, `communityId`.
       - Use `useCommunityBranding(communityId)` for community name/logo in the header.
       - Use `useResidentUnit()` to resolve the resident's primary unit and its `unitId`.
       - Use `useQuery` with `queryKeys.payments.balance(unitId)` to fetch balance via `supabase.rpc('get_unit_balance', { p_unit_id: unitId })` -- extract `current_balance` and `days_overdue`. Guard with `enabled: !!unitId`.
       - Use `useQuery` with `queryKeys.visitors.active(communityId)` to count active invitations via `supabase.from('invitations').select('id', { count: 'exact', head: true }).eq('created_by_resident_id', residentId).eq('community_id', communityId).in('status', ['approved', 'pending']).is('cancelled_at', null).is('deleted_at', null).gte('valid_until', new Date().toISOString())`. Use the `count` from the response.
       - Layout: ScrollView with RefreshControl. Header shows community name (bold text-2xl) and "Bienvenido" subtitle. Below: DashboardCard for balance (title "Saldo", value formatted with `formatCurrency`, subtitle shows days overdue or "Al corriente", color bg-red-50 if overdue else bg-green-50, onPress navigates to `/(resident)/payments`). DashboardCard for visitors (title "Visitantes activos", value is count, color bg-blue-50, onPress navigates to `/(resident)/visitors`).
       - Pull-to-refresh refetches all queries.
       - Use `router.push()` from `expo-router` for navigation.

    7. **Implement guard gate dashboard** (`packages/mobile/app/(guard)/index.tsx`):
       - Replace placeholder with gate operations dashboard.
       - Use `useAuth()` to get `guardId`, `communityId`.
       - Use `useCommunityBranding(communityId)` for community name.
       - Use `useQuery` to fetch today's expected visitors: `supabase.from('invitations').select('id, visitor_name, valid_from, valid_until, invitation_type, units(unit_number)').eq('community_id', communityId).in('status', ['approved', 'pending']).is('cancelled_at', null).is('deleted_at', null).gte('valid_until', new Date().toISOString()).lte('valid_from', new Date().toISOString()).order('valid_from', { ascending: true }).limit(20)`. Query key: `queryKeys.visitors.list({ communityId, type: 'expected-today' })`.
       - Layout: SafeAreaView wrapping a View. Header with community name and "Caseta" title. Two large action buttons side-by-side: "Escanear QR" (bg-blue-600, white text, onPress navigates to `/(guard)/gate/scan`) and "Registro Manual" (bg-gray-200, dark text, onPress navigates to `/(guard)/gate/manual-checkin`). Below: "Visitantes esperados hoy" section with FlatList of expected visitors showing visitor_name, time window (using `formatTime`), and unit_number. Use `EmptyState` when list is empty with message "Sin visitantes esperados".
       - Use `React.memo` on the visitor row component for FlatList performance.
  </action>
  <verify>
    Run `cd packages/mobile && npx tsc --noEmit` -- no type errors. Verify all new files exist: `ls app/(resident)/visitors/_layout.tsx app/(resident)/payments/_layout.tsx app/(guard)/gate/_layout.tsx app/(guard)/directory/_layout.tsx app/(guard)/packages/_layout.tsx src/hooks/useCommunity.ts src/hooks/useOccupancy.ts`.
  </verify>
  <done>
    Resident dashboard shows community branding header, balance card (with overdue indicator), and active visitors count card. Cards navigate to their respective tab stacks on press. Guard dashboard shows community name, two action buttons (QR scan + manual check-in), and today's expected visitors queue. Guard tabs are Caseta/Directorio/Paquetes. All sub-route stack navigators are in place for downstream plans.
  </done>
</task>

</tasks>

<verification>
1. `cd packages/mobile && npx tsc --noEmit` passes with zero errors
2. `cd packages/shared && npx tsc --noEmit` passes with zero errors
3. All shared UI components export correctly: Card (DashboardCard, SectionCard), Badge (StatusBadge), EmptyState, LoadingSpinner
4. Date utilities module exports: formatDate, formatDateTime, formatTime, formatRelative, formatCurrency, isExpired, isUpcoming, DAY_LABELS
5. useCommunityBranding hook queries communities table with enabled guard
6. useResidentOccupancy hook queries occupancies table with enabled guard
7. Resident dashboard imports and uses DashboardCard, useCommunityBranding, useResidentUnit, formatCurrency, router.push
8. Guard dashboard imports and uses EmptyState, router.push for gate operations, FlatList for expected visitors
9. Guard _layout.tsx has 3 tabs: index (Caseta), directory (Directorio), packages (Paquetes)
10. Stack navigators exist for: (resident)/visitors, (resident)/payments, (guard)/gate, (guard)/directory, (guard)/packages
</verification>

<success_criteria>
- Resident home screen displays community name and 2 summary cards with real data from Supabase
- Tapping balance card navigates to payments stack; tapping visitors card navigates to visitors stack
- Guard home screen displays action buttons and expected visitors list
- Guard tab bar shows Caseta, Directorio, Paquetes
- All shared UI components and hooks are importable by downstream plans
- TypeScript compiles without errors on both mobile and shared packages
</success_criteria>

<output>
After completion, create `.planning/phases/10-mobile-core/10-01-SUMMARY.md`
</output>
