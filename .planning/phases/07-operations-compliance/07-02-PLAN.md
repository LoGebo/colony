---
phase: 07-operations-compliance
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/TIMESTAMP_provider_enums.sql
  - supabase/migrations/TIMESTAMP_providers_table.sql
  - supabase/migrations/TIMESTAMP_provider_documents_personnel.sql
autonomous: true

must_haves:
  truths:
    - "Provider companies can be registered with contact and specialties"
    - "Provider documents track insurance/certifications with expiration alerts"
    - "Provider personnel are authorized with photo ID"
    - "Access schedules restrict provider entry to allowed days/hours"
  artifacts:
    - path: "supabase/migrations/*_provider_enums.sql"
      provides: "provider_status, document_status enums"
    - path: "supabase/migrations/*_providers_table.sql"
      provides: "providers table with status workflow and rating"
    - path: "supabase/migrations/*_provider_documents_personnel.sql"
      provides: "provider_documents, provider_personnel, provider_access_schedules tables"
  key_links:
    - from: "provider_documents.provider_id"
      to: "providers.id"
      via: "foreign key with CASCADE"
    - from: "provider_documents.is_expired"
      to: "expires_at column"
      via: "GENERATED ALWAYS computed column"
    - from: "is_provider_access_allowed function"
      to: "provider_access_schedules"
      via: "schedule lookup query"
---

<objective>
Create provider management schema for third-party service companies (cleaning, landscaping, security) with credential tracking, document expiration alerts, authorized personnel, and access schedule restrictions.

Purpose: Enable communities to manage provider relationships with compliance tracking for insurance, certifications, and controlled access hours.

Output: Provider tables with document expiration computed columns, personnel authorization, and time-based access control functions.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-operations-compliance/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create provider enum types</name>
  <files>supabase/migrations/TIMESTAMP_provider_enums.sql</files>
  <action>
Create migration with provider-related enum types:

```sql
-- Provider company status
CREATE TYPE provider_status AS ENUM (
  'pending_approval',  -- Awaiting admin review
  'active',            -- Approved and can work
  'suspended',         -- Temporarily blocked
  'inactive'           -- No longer working with community
);

-- Document verification status
CREATE TYPE document_status AS ENUM (
  'pending_verification',  -- Uploaded, not yet reviewed
  'verified',              -- Admin confirmed valid
  'expired',               -- Past expiration date
  'rejected'               -- Failed verification
);
```

Include standard header comment.
  </action>
  <verify>Run migration, verify enums with `\dT+ provider_status` and `\dT+ document_status`</verify>
  <done>Provider and document status enums created</done>
</task>

<task type="auto">
  <name>Task 2: Create providers table</name>
  <files>supabase/migrations/TIMESTAMP_providers_table.sql</files>
  <action>
Create migration for providers table:

**providers table:**
- id UUID PK DEFAULT generate_uuid_v7()
- community_id UUID NOT NULL REFERENCES communities(id)
- Company identification:
  - company_name TEXT NOT NULL
  - legal_name TEXT
  - rfc TEXT (Mexican tax ID)
- Contact:
  - contact_name TEXT NOT NULL
  - contact_email TEXT
  - contact_phone phone_number NOT NULL (reuse domain from Phase 2)
  - address TEXT
- Services:
  - specialties TEXT[] NOT NULL (e.g., ['plumbing', 'electrical', 'cleaning'])
- Status:
  - status provider_status NOT NULL DEFAULT 'pending_approval'
- Rating (computed from work orders):
  - average_rating NUMERIC(3,2)
  - total_work_orders INTEGER NOT NULL DEFAULT 0
- Approval:
  - approved_at TIMESTAMPTZ
  - approved_by UUID REFERENCES auth.users(id)
- notes TEXT
- Standard audit columns with soft delete

**Indexes:**
- idx_providers_community_status ON providers(community_id, status)
- idx_providers_specialties ON providers USING GIN(specialties)

**RLS policies:**
- Admins/managers can full CRUD
- Guards can SELECT active providers
- Providers themselves can SELECT their own record (via auth metadata)

**CHECK constraint:** approved_at and approved_by must both be NULL or both NOT NULL
  </action>
  <verify>Run migration. INSERT provider, check default status is 'pending_approval'. Update to 'active' with approved_at/approved_by.</verify>
  <done>providers table with status workflow, specialties array, and rating tracking</done>
</task>

<task type="auto">
  <name>Task 3: Create provider documents, personnel, and access schedules</name>
  <files>supabase/migrations/TIMESTAMP_provider_documents_personnel.sql</files>
  <action>
Create migration for provider-related tables:

**provider_documents table:**
- id UUID PK DEFAULT generate_uuid_v7()
- community_id UUID NOT NULL REFERENCES communities(id)
- provider_id UUID NOT NULL REFERENCES providers(id) ON DELETE CASCADE
- Document type:
  - document_type TEXT NOT NULL CHECK IN ('insurance_liability', 'insurance_workers_comp', 'business_license', 'tax_registration', 'certification', 'contract', 'background_check', 'other')
- Details:
  - document_name TEXT NOT NULL
  - document_number TEXT (policy/license number)
  - issuing_authority TEXT
- File:
  - storage_path TEXT NOT NULL
  - file_name TEXT NOT NULL
- Validity:
  - issued_at DATE
  - expires_at DATE
- Computed expiration columns:
  - is_expired BOOLEAN GENERATED ALWAYS AS (expires_at IS NOT NULL AND expires_at < CURRENT_DATE) STORED
  - days_until_expiry INTEGER GENERATED ALWAYS AS (CASE WHEN expires_at IS NULL THEN NULL ELSE expires_at - CURRENT_DATE END) STORED
- Verification:
  - status document_status NOT NULL DEFAULT 'pending_verification'
  - verified_at TIMESTAMPTZ
  - verified_by UUID REFERENCES auth.users(id)
  - rejection_reason TEXT
- Alert tracking:
  - expiry_alert_sent_30d BOOLEAN NOT NULL DEFAULT false
  - expiry_alert_sent_14d BOOLEAN NOT NULL DEFAULT false
  - expiry_alert_sent_7d BOOLEAN NOT NULL DEFAULT false
- Standard audit columns

**Indexes:**
- idx_provider_docs_expiring ON provider_documents(expires_at, status) WHERE expires_at IS NOT NULL AND status = 'verified' AND expires_at > CURRENT_DATE

**provider_documents_expiring view:**
- Joins documents with providers
- Filters to verified docs expiring within 30 days
- Adds urgency_level: 'expired', 'critical' (<=7d), 'warning' (<=14d), 'upcoming' (<=30d)
- Orders by expires_at

**provider_personnel table:**
- id UUID PK DEFAULT generate_uuid_v7()
- community_id UUID NOT NULL REFERENCES communities(id)
- provider_id UUID NOT NULL REFERENCES providers(id) ON DELETE CASCADE
- Personal info:
  - first_name TEXT NOT NULL
  - paternal_surname TEXT NOT NULL
  - maternal_surname TEXT
- Identification:
  - ine_number TEXT (Mexican ID)
  - photo_url TEXT
- Contact:
  - phone phone_number
- Authorization:
  - is_authorized BOOLEAN NOT NULL DEFAULT true
  - authorized_from DATE
  - authorized_until DATE
- Access restrictions:
  - allowed_access_points UUID[] (NULL = all access points)
- notes TEXT
- Standard audit columns with soft delete

**provider_access_schedules table:**
- id UUID PK DEFAULT generate_uuid_v7()
- community_id UUID NOT NULL REFERENCES communities(id)
- provider_id UUID NOT NULL REFERENCES providers(id) ON DELETE CASCADE
- name TEXT NOT NULL (e.g., "Regular Hours", "Emergency Access")
- allowed_days INTEGER[] NOT NULL DEFAULT ARRAY[1,2,3,4,5] (0=Sunday, 6=Saturday)
- start_time TIME NOT NULL DEFAULT '08:00'
- end_time TIME NOT NULL DEFAULT '18:00'
- effective_from DATE NOT NULL DEFAULT CURRENT_DATE
- effective_until DATE (NULL = ongoing)
- is_active BOOLEAN NOT NULL DEFAULT true
- Standard audit columns

**is_provider_access_allowed(p_provider_id, p_check_time DEFAULT now()) function:**
- Extracts day of week and time from check_time
- Looks for matching active schedule where:
  - provider_id matches
  - is_active = true
  - effective_from <= check_date
  - effective_until IS NULL OR >= check_date
  - day_of_week is in allowed_days
  - time is BETWEEN start_time AND end_time
- Returns BOOLEAN

RLS:
- provider_documents: Admins full CRUD, providers can SELECT own docs
- provider_personnel: Admins full CRUD, guards can SELECT authorized personnel
- provider_access_schedules: Admins full CRUD, guards can SELECT
  </action>
  <verify>
1. INSERT provider document with expires_at = CURRENT_DATE + 10
2. SELECT is_expired, days_until_expiry - should be false, 10
3. SELECT * FROM provider_documents_expiring - should show document with urgency_level = 'warning'
4. INSERT access schedule for Mon-Fri 9-17
5. SELECT is_provider_access_allowed(provider_id, '2026-01-29 10:00'::TIMESTAMPTZ) - should return true (Wednesday)
6. SELECT is_provider_access_allowed(provider_id, '2026-01-29 20:00'::TIMESTAMPTZ) - should return false (outside hours)
  </verify>
  <done>Provider documents with computed expiration, personnel authorization, and time-based access schedules</done>
</task>

</tasks>

<verification>
-- Verify computed expiration columns
INSERT INTO provider_documents (community_id, provider_id, document_type, document_name, storage_path, file_name, expires_at, status)
VALUES ('...', '...', 'insurance_liability', 'General Liability', '/docs/insurance.pdf', 'insurance.pdf', CURRENT_DATE + 5, 'verified');

SELECT is_expired, days_until_expiry FROM provider_documents WHERE id = '...';
-- Should return: false, 5

-- Test expiring view
SELECT * FROM provider_documents_expiring;
-- Should show document with urgency_level = 'critical'

-- Verify access schedule
SELECT is_provider_access_allowed('provider-id', '2026-01-29 10:00:00-06'::TIMESTAMPTZ);
-- Returns based on schedule configuration
</verification>

<success_criteria>
- Provider status enum supports approval workflow
- providers table tracks company details, specialties, and rating
- provider_documents has GENERATED ALWAYS computed is_expired and days_until_expiry
- provider_documents_expiring view provides urgency-sorted alert list
- provider_personnel tracks authorized workers with photo ID
- provider_access_schedules restricts access by day/time
- is_provider_access_allowed() function checks real-time access permission
- All tables have proper RLS policies
</success_criteria>

<output>
After completion, create `.planning/phases/07-operations-compliance/07-02-SUMMARY.md`
</output>
