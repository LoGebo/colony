---
phase: 07-operations-compliance
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/TIMESTAMP_move_enums.sql
  - supabase/migrations/TIMESTAMP_move_requests_validations.sql
  - supabase/migrations/TIMESTAMP_move_deposits.sql
autonomous: true

must_haves:
  truths:
    - "Move requests can be scheduled with date, time window, and moving company"
    - "Pre-move validations auto-generate based on move type"
    - "Validation checklist enforces debt-free and key return requirements"
    - "Damage deposits flow through collection to refund with deductions"
  artifacts:
    - path: "supabase/migrations/*_move_enums.sql"
      provides: "move_type, move_status, validation_status, deposit_status enums"
    - path: "supabase/migrations/*_move_requests_validations.sql"
      provides: "move_requests and move_validations tables with auto-generation trigger"
    - path: "supabase/migrations/*_move_deposits.sql"
      provides: "move_deposits table with computed refund_amount"
  key_links:
    - from: "move_validations.move_request_id"
      to: "move_requests.id"
      via: "foreign key with CASCADE"
    - from: "create_move_validations trigger"
      to: "move_requests table"
      via: "AFTER INSERT trigger"
    - from: "move_deposits.refund_amount"
      to: "amount - deduction_amount"
      via: "GENERATED ALWAYS computed column"
---

<objective>
Create move coordination schema for move-in/move-out requests with scheduling, pre-move validation checklists, and damage deposit workflows with refund calculation.

Purpose: Enable communities to coordinate resident moves with proper validation (debt-free, keys, vehicles) and manage damage deposits through collection, inspection, and refund.

Output: Move request tables with auto-generated validation checklists and deposit refund workflow.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-operations-compliance/07-RESEARCH.md

# Prior infrastructure for deposits
@.planning/phases/04-financial-engine/04-01-SUMMARY.md (ledger for future deposit accounting)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create move-related enum types</name>
  <files>supabase/migrations/TIMESTAMP_move_enums.sql</files>
  <action>
Create migration with move coordination enum types:

```sql
-- Move direction
CREATE TYPE move_type AS ENUM (
  'move_in',
  'move_out'
);

-- Move request status workflow
CREATE TYPE move_status AS ENUM (
  'requested',         -- Initial request submitted
  'validating',        -- Pre-move validations in progress
  'validation_failed', -- One or more validations failed
  'approved',          -- All validations passed
  'scheduled',         -- Date/time confirmed
  'in_progress',       -- Move happening now
  'completed',         -- Move finished
  'cancelled'          -- Cancelled by resident or admin
);

-- Validation item status
CREATE TYPE validation_status AS ENUM (
  'pending',   -- Not yet checked
  'passed',    -- Validation succeeded
  'failed',    -- Validation failed
  'waived'     -- Admin override
);

-- Damage deposit workflow status
CREATE TYPE deposit_status AS ENUM (
  'collected',           -- Payment received
  'held',                -- During residency
  'inspection_pending',  -- Move-out inspection needed
  'deductions_pending',  -- Calculating damages
  'refund_pending',      -- Approved for refund
  'refunded',            -- Refund processed
  'forfeited'            -- Deposit kept due to damages/violations
);
```

Include standard header comment.
  </action>
  <verify>Run migration, verify enums with `\dT+ move_*` and `\dT+ validation_status` and `\dT+ deposit_status`</verify>
  <done>Move-related enums created: move_type, move_status, validation_status, deposit_status</done>
</task>

<task type="auto">
  <name>Task 2: Create move requests and validations tables</name>
  <files>supabase/migrations/TIMESTAMP_move_requests_validations.sql</files>
  <action>
Create migration for move requests and validation checklist:

**move_requests table:**
- id UUID PK DEFAULT generate_uuid_v7()
- community_id UUID NOT NULL REFERENCES communities(id)
- Who is moving:
  - resident_id UUID NOT NULL REFERENCES residents(id)
  - unit_id UUID NOT NULL REFERENCES units(id)
- move_type move_type NOT NULL
- Scheduling:
  - requested_date DATE NOT NULL
  - requested_time_start TIME
  - requested_time_end TIME
  - confirmed_date DATE
  - confirmed_time_start TIME
  - confirmed_time_end TIME
- Moving company:
  - moving_company_name TEXT
  - moving_company_phone TEXT
  - moving_company_vehicle_plates TEXT[] (array for multiple trucks)
  - estimated_duration_hours INTEGER
- Reservations:
  - elevator_reserved BOOLEAN DEFAULT false
  - loading_dock_reserved BOOLEAN DEFAULT false
- Status:
  - status move_status NOT NULL DEFAULT 'requested'
  - status_changed_at TIMESTAMPTZ NOT NULL DEFAULT now()
- Validation summary:
  - all_validations_passed BOOLEAN (computed by trigger/function)
- Notes:
  - resident_notes TEXT
  - admin_notes TEXT
- Completion:
  - completed_at TIMESTAMPTZ
  - completed_by UUID REFERENCES auth.users(id)
- Standard audit columns with soft delete

**Indexes:**
- idx_move_requests_community_status ON move_requests(community_id, status)
- idx_move_requests_unit ON move_requests(unit_id, requested_date)
- idx_move_requests_date ON move_requests(requested_date) WHERE status NOT IN ('completed', 'cancelled')

**move_validations table:**
- id UUID PK DEFAULT generate_uuid_v7()
- move_request_id UUID NOT NULL REFERENCES move_requests(id) ON DELETE CASCADE
- validation_type TEXT NOT NULL CHECK IN (
    'debt_free',            -- No outstanding balance
    'keys_returned',        -- All keys/access devices returned
    'vehicles_updated',     -- Vehicle registry updated
    'pets_updated',         -- Pet registry updated
    'parking_cleared',      -- Parking spot vacated
    'utility_transfer',     -- Utilities transferred/cancelled
    'inspection_scheduled', -- Final inspection scheduled
    'deposit_review',       -- Damage deposit review complete
    'documentation_signed'  -- Required paperwork signed
  )
- status validation_status NOT NULL DEFAULT 'pending'
- checked_at TIMESTAMPTZ
- checked_by UUID REFERENCES auth.users(id)
- notes TEXT
- balance_at_check NUMERIC(12,2) (for debt_free validation)
- waiver_reason TEXT (if status = 'waived')
- waived_by UUID REFERENCES auth.users(id)
- Standard audit columns
- UNIQUE constraint on (move_request_id, validation_type)

**create_move_validations() trigger function:**
- AFTER INSERT on move_requests
- For move_out: Creates validations for debt_free, keys_returned, vehicles_updated, pets_updated, parking_cleared, inspection_scheduled, deposit_review
- For move_in: Creates validations for documentation_signed, deposit_review

**update_validation_summary() trigger function:**
- AFTER UPDATE on move_validations
- Checks if all validations for move_request are 'passed' or 'waived'
- Updates move_requests.all_validations_passed accordingly

**check_debt_free(p_unit_id) function:**
- Queries unit_balances view from Phase 4
- Returns BOOLEAN (true if balance <= 0)

RLS:
- move_requests: Admins full CRUD, residents can SELECT/INSERT/UPDATE own
- move_validations: Admins full CRUD, residents can SELECT own move's validations
  </action>
  <verify>
1. INSERT move_request with move_type = 'move_out'
2. SELECT * FROM move_validations WHERE move_request_id = '...' - should have 7 validation items
3. INSERT move_request with move_type = 'move_in'
4. SELECT * FROM move_validations WHERE move_request_id = '...' - should have 2 validation items
5. UPDATE all validations to 'passed', check move_requests.all_validations_passed = true
  </verify>
  <done>move_requests with auto-generated validation checklists based on move type</done>
</task>

<task type="auto">
  <name>Task 3: Create move deposits table</name>
  <files>supabase/migrations/TIMESTAMP_move_deposits.sql</files>
  <action>
Create migration for damage deposit tracking:

**move_deposits table:**
- id UUID PK DEFAULT generate_uuid_v7()
- community_id UUID NOT NULL REFERENCES communities(id)
- move_request_id UUID REFERENCES move_requests(id) (can be NULL if collected before move request)
- unit_id UUID NOT NULL REFERENCES units(id)
- resident_id UUID NOT NULL REFERENCES residents(id)
- Deposit details:
  - deposit_type TEXT NOT NULL DEFAULT 'damage' CHECK IN ('damage', 'move', 'key')
  - amount money_amount NOT NULL (reuse domain from Phase 4)
- Collection:
  - collected_at TIMESTAMPTZ NOT NULL DEFAULT now()
  - collected_by UUID REFERENCES auth.users(id)
  - payment_method TEXT
  - receipt_number TEXT
- status deposit_status NOT NULL DEFAULT 'collected'
- Inspection results:
  - inspection_date DATE
  - inspection_notes TEXT
  - inspection_photos TEXT[]
- Deductions:
  - deduction_amount money_amount DEFAULT 0
  - deduction_reason TEXT
- Refund (computed and tracking):
  - refund_amount money_amount GENERATED ALWAYS AS (amount - COALESCE(deduction_amount, 0)) STORED
  - refund_approved_at TIMESTAMPTZ
  - refund_approved_by UUID REFERENCES auth.users(id)
  - refund_processed_at TIMESTAMPTZ
  - refund_method TEXT
  - refund_reference TEXT
- Standard audit columns

**Indexes:**
- idx_move_deposits_community_status ON move_deposits(community_id, status)
- idx_move_deposits_unit ON move_deposits(unit_id)
- idx_move_deposits_resident ON move_deposits(resident_id)

**Workflow constraints:**
- CHECK: deduction_amount IS NULL OR deduction_amount <= amount
- CHECK: (refund_approved_at IS NULL) = (refund_approved_by IS NULL)
- CHECK: status = 'refunded' implies refund_processed_at IS NOT NULL

**process_deposit_refund(p_deposit_id, p_deduction_amount, p_reason) function:**
- Updates deduction_amount and deduction_reason
- Sets status to 'deductions_pending'
- Returns updated deposit record

**approve_deposit_refund(p_deposit_id) function:**
- Validates deposit is in 'deductions_pending' status
- Sets refund_approved_at, refund_approved_by
- Sets status to 'refund_pending'
- Returns deposit with computed refund_amount

RLS:
- Admins full CRUD
- Residents can SELECT own deposits
  </action>
  <verify>
1. INSERT deposit with amount = 5000
2. Call process_deposit_refund(id, 1500, 'Wall damage')
3. SELECT refund_amount - should be 3500 (computed)
4. Call approve_deposit_refund(id)
5. Check status = 'refund_pending' and refund_approved_at is set
  </verify>
  <done>Damage deposits with computed refund, inspection tracking, and approval workflow</done>
</task>

</tasks>

<verification>
-- Full move-out workflow test
INSERT INTO move_requests (community_id, resident_id, unit_id, move_type, requested_date)
VALUES ('...', '...', '...', 'move_out', '2026-02-15');

-- Check auto-generated validations
SELECT validation_type, status FROM move_validations WHERE move_request_id = '...';
-- Should have 7 items for move_out

-- Update all to passed
UPDATE move_validations SET status = 'passed', checked_at = now(), checked_by = auth.uid()
WHERE move_request_id = '...';

-- Check summary updated
SELECT all_validations_passed FROM move_requests WHERE id = '...';
-- Should be true

-- Deposit workflow
INSERT INTO move_deposits (community_id, unit_id, resident_id, amount, move_request_id)
VALUES ('...', '...', '...', 10000, '...');

SELECT process_deposit_refund('deposit-id', 2000, 'Carpet cleaning');
SELECT approve_deposit_refund('deposit-id');
SELECT status, refund_amount FROM move_deposits WHERE id = 'deposit-id';
-- status = 'refund_pending', refund_amount = 8000
</verification>

<success_criteria>
- Move enums support complete workflow (request -> validate -> schedule -> complete)
- move_requests tracks scheduling, moving company, and elevator/dock reservations
- move_validations auto-generated based on move type (7 for move_out, 2 for move_in)
- Validation summary auto-updates when all validations pass
- move_deposits has computed refund_amount column
- Deposit workflow functions handle deduction and approval
- All tables have proper RLS policies
</success_criteria>

<output>
After completion, create `.planning/phases/07-operations-compliance/07-03-SUMMARY.md`
</output>
