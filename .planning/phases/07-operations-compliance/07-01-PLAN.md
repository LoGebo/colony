---
phase: 07-operations-compliance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/TIMESTAMP_package_enums.sql
  - supabase/migrations/TIMESTAMP_packages_table.sql
  - supabase/migrations/TIMESTAMP_pickup_codes_signatures.sql
autonomous: true

must_haves:
  truths:
    - "Packages can be received and assigned storage locations"
    - "Package status transitions follow defined state machine"
    - "Pickup codes (PIN/QR) are generated with expiration"
    - "Package handoff is validated with signatures"
  artifacts:
    - path: "supabase/migrations/*_package_enums.sql"
      provides: "package_status, package_carrier, pickup_code_type, pickup_code_status enums"
    - path: "supabase/migrations/*_packages_table.sql"
      provides: "packages and package_storage_locations tables with state machine trigger"
    - path: "supabase/migrations/*_pickup_codes_signatures.sql"
      provides: "package_pickup_codes and package_signatures tables with HMAC functions"
  key_links:
    - from: "packages.storage_location_id"
      to: "package_storage_locations.id"
      via: "foreign key"
    - from: "package_pickup_codes.package_id"
      to: "packages.id"
      via: "foreign key with CASCADE"
    - from: "validate_package_transition trigger"
      to: "packages table"
      via: "BEFORE UPDATE trigger"
---

<objective>
Create the digital mailroom schema for package tracking with carrier information, storage locations, pickup code generation (PIN/QR with HMAC signatures), and signature capture for chain of custody.

Purpose: Enable communities to manage package receipt, storage, notification, and secure pickup with cryptographic verification reusing Phase 3's HMAC pattern.

Output: Package management tables with state machine, pickup codes with offline verification, and immutable signature records.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-operations-compliance/07-RESEARCH.md

# Prior infrastructure
@.planning/phases/03-access-control-security/03-04-SUMMARY.md (HMAC-SHA256 QR pattern)
@.planning/phases/06-maintenance-chat-documents-notifications/06-05-SUMMARY.md (notification integration)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create package enum types</name>
  <files>supabase/migrations/TIMESTAMP_package_enums.sql</files>
  <action>
Create migration with package-related enum types:

```sql
-- Package status state machine
CREATE TYPE package_status AS ENUM (
  'received',        -- Package checked in by guard/staff
  'stored',          -- Assigned to storage location
  'notified',        -- Recipient notified with pickup code
  'pending_pickup',  -- Pickup code sent, awaiting recipient
  'picked_up',       -- Successfully retrieved by recipient
  'forwarded',       -- Forwarded to another address
  'returned',        -- Returned to sender
  'abandoned'        -- Exceeded retention period
);

-- Common carriers in Mexico
CREATE TYPE package_carrier AS ENUM (
  'fedex',
  'dhl',
  'ups',
  'estafeta',
  'redpack',
  'mercado_libre',
  'amazon',
  'correos_mexico',
  'other'
);

-- Pickup code types
CREATE TYPE pickup_code_type AS ENUM (
  'pin',     -- 6-digit numeric code
  'qr'       -- QR code with signed payload
);

-- Pickup code status
CREATE TYPE pickup_code_status AS ENUM (
  'active',
  'used',
  'expired',
  'revoked'
);
```

Include standard header comment with phase reference.
  </action>
  <verify>Run `supabase db reset` and check enum types exist with `\dT+ package_*` and `\dT+ pickup_code_*`</verify>
  <done>Four package-related enums created: package_status, package_carrier, pickup_code_type, pickup_code_status</done>
</task>

<task type="auto">
  <name>Task 2: Create packages and storage locations tables</name>
  <files>supabase/migrations/TIMESTAMP_packages_table.sql</files>
  <action>
Create migration with packages and storage location tables:

**package_storage_locations table:**
- id UUID PK DEFAULT generate_uuid_v7()
- community_id UUID NOT NULL REFERENCES communities(id)
- name TEXT NOT NULL (e.g., "Shelf A-1", "Locker 5")
- location_type TEXT NOT NULL CHECK IN ('shelf', 'locker', 'floor', 'refrigerator')
- max_packages INTEGER (capacity)
- current_count INTEGER NOT NULL DEFAULT 0
- area TEXT (e.g., "Mailroom", "Guard Booth")
- row_number TEXT, shelf_number TEXT
- is_available BOOLEAN NOT NULL DEFAULT true
- Standard audit columns (created_at, updated_at)
- UNIQUE constraint on (community_id, name)
- RLS: community members can SELECT, staff can INSERT/UPDATE

**packages table:**
- id UUID PK DEFAULT generate_uuid_v7()
- community_id UUID NOT NULL REFERENCES communities(id)
- Carrier: carrier package_carrier NOT NULL, carrier_other TEXT (if 'other')
- tracking_number TEXT
- Recipient: recipient_resident_id UUID REFERENCES residents(id), recipient_unit_id UUID NOT NULL REFERENCES units(id), recipient_name TEXT NOT NULL
- Details: description TEXT, package_count INTEGER DEFAULT 1, is_oversized BOOLEAN DEFAULT false, requires_signature BOOLEAN DEFAULT false, is_perishable BOOLEAN DEFAULT false
- Photos: photo_url TEXT, label_photo_url TEXT
- Storage: storage_location_id UUID REFERENCES package_storage_locations(id)
- State machine: status package_status NOT NULL DEFAULT 'received', status_changed_at TIMESTAMPTZ DEFAULT now()
- Timestamps: received_at TIMESTAMPTZ DEFAULT now(), received_by UUID REFERENCES auth.users(id), stored_at TIMESTAMPTZ, notified_at TIMESTAMPTZ, picked_up_at TIMESTAMPTZ, picked_up_by UUID REFERENCES auth.users(id)
- Retention: retention_days INTEGER NOT NULL DEFAULT 14, abandonment_date DATE GENERATED ALWAYS AS ((received_at::DATE + retention_days)) STORED
- Notes: special_instructions TEXT, staff_notes TEXT
- Standard audit columns with soft delete

**validate_package_transition() trigger function:**
- Validates state transitions per state machine:
  - received -> stored, returned
  - stored -> notified, returned
  - notified -> pending_pickup, returned
  - pending_pickup -> picked_up, abandoned, returned, forwarded
  - picked_up, forwarded, returned -> terminal (no transitions)
  - abandoned -> returned
- Auto-sets status_changed_at and relevant timestamp columns (stored_at, notified_at, picked_up_at)

**Indexes:**
- idx_packages_community_status ON packages(community_id, status)
- idx_packages_recipient ON packages(recipient_unit_id, status)
- idx_packages_tracking ON packages(tracking_number) WHERE tracking_number IS NOT NULL
- idx_packages_abandonment ON packages(abandonment_date) WHERE status = 'pending_pickup'

RLS policies:
- Staff can full CRUD
- Residents can SELECT packages for their unit
  </action>
  <verify>Run migration. Test state machine: INSERT package, UPDATE to 'stored' (should work), UPDATE to 'picked_up' (should fail - invalid transition)</verify>
  <done>packages and package_storage_locations tables with state machine trigger validation</done>
</task>

<task type="auto">
  <name>Task 3: Create pickup codes and signatures tables with HMAC functions</name>
  <files>supabase/migrations/TIMESTAMP_pickup_codes_signatures.sql</files>
  <action>
Create migration for pickup code generation and signature capture:

**package_pickup_codes table:**
- id UUID PK DEFAULT generate_uuid_v7()
- community_id UUID NOT NULL REFERENCES communities(id)
- package_id UUID NOT NULL REFERENCES packages(id) ON DELETE CASCADE
- code_type pickup_code_type NOT NULL DEFAULT 'pin'
- code_value TEXT NOT NULL (PIN digits or QR payload)
- signature TEXT (for QR codes)
- valid_from TIMESTAMPTZ NOT NULL DEFAULT now()
- valid_until TIMESTAMPTZ NOT NULL
- status pickup_code_status NOT NULL DEFAULT 'active'
- used_at TIMESTAMPTZ, used_by UUID REFERENCES auth.users(id)
- sent_via TEXT[] (channels: sms, email, push)
- sent_at TIMESTAMPTZ
- created_at TIMESTAMPTZ NOT NULL DEFAULT now()
- Index on (package_id, status) for active code lookup

**generate_pickup_pin() function:**
- Returns 6-digit random PIN (100000-999999) as TEXT

**generate_pickup_qr_payload(p_package_id, p_expires_at, p_secret_key) function:**
- SECURITY DEFINER
- Creates payload: {package_id}|{expires_epoch}
- Signs with HMAC-SHA256 using pgcrypto (same pattern as Phase 3 QR codes)
- Returns: {payload}|{signature}

**verify_pickup_qr_payload(p_payload, p_secret_key) function:**
- Returns TABLE(is_valid BOOLEAN, package_id UUID, expires_at TIMESTAMPTZ, error_message TEXT)
- Validates signature and expiration
- Same verification pattern as Phase 3

**create_pickup_code(p_package_id, p_code_type DEFAULT 'pin', p_valid_hours DEFAULT 72) function:**
- Revokes existing active codes for package
- Generates new PIN or QR code
- Creates package_pickup_codes record
- Updates package status to 'pending_pickup'
- Returns code_id

**validate_pickup_code(p_package_id, p_code_value) function:**
- Looks up active code for package
- Validates PIN match or QR signature
- Checks expiration
- Returns success/failure with error message

**package_signatures table:**
- id UUID PK DEFAULT generate_uuid_v7()
- community_id UUID NOT NULL REFERENCES communities(id)
- package_id UUID NOT NULL REFERENCES packages(id) ON DELETE CASCADE
- signed_by_resident_id UUID REFERENCES residents(id)
- signed_by_name TEXT NOT NULL
- relationship_to_recipient TEXT ('self', 'family', 'neighbor', 'other')
- signature_type TEXT NOT NULL DEFAULT 'draw' CHECK IN ('draw', 'type', 'pin')
- signature_data TEXT (Base64 drawn signature or typed name)
- signed_at TIMESTAMPTZ NOT NULL DEFAULT now()
- ip_address INET NOT NULL
- user_agent TEXT NOT NULL
- device_type TEXT, device_id TEXT
- photo_url TEXT (optional photo verification)
- consent_text TEXT NOT NULL
- signature_hash TEXT NOT NULL (SHA-256 of all signature data for tamper detection)
- created_at TIMESTAMPTZ NOT NULL DEFAULT now()

**Immutability trigger on package_signatures:**
- prevent_signature_modification() - same pattern as Phase 6 regulation_signatures
- Blocks UPDATE and DELETE

RLS:
- pickup_codes: Staff can full CRUD, residents can SELECT their own
- signatures: Staff can INSERT/SELECT, no UPDATE/DELETE (enforced by trigger)
  </action>
  <verify>
Test flow:
1. Create package, SELECT create_pickup_code(package_id) - returns code_id
2. Check package status changed to 'pending_pickup'
3. SELECT validate_pickup_code(package_id, pin_value) - returns success
4. INSERT signature record, verify hash computed
5. Attempt UPDATE on signature - should raise exception
  </verify>
  <done>Pickup code system with PIN/QR generation, HMAC verification, and immutable signature capture</done>
</task>

</tasks>

<verification>
-- Verify package state machine
INSERT INTO packages (community_id, carrier, recipient_unit_id, recipient_name)
VALUES ('...', 'fedex', '...', 'Test Resident');

UPDATE packages SET status = 'stored', storage_location_id = '...' WHERE id = '...';
-- Should succeed

UPDATE packages SET status = 'picked_up' WHERE id = '...';
-- Should fail: invalid transition from stored

-- Verify pickup code generation
SELECT create_pickup_code('package-id', 'pin', 72);
-- Check code created and package status = 'pending_pickup'

-- Verify signature immutability
UPDATE package_signatures SET signed_by_name = 'Hacker' WHERE id = '...';
-- Should raise: "Package signatures cannot be modified"
</verification>

<success_criteria>
- Package enum types created (4 types)
- packages table with state machine trigger prevents invalid transitions
- package_storage_locations tracks mailroom organization
- pickup_codes support both PIN and HMAC-signed QR codes
- create_pickup_code() auto-revokes old codes and updates package status
- package_signatures are immutable (trigger-enforced)
- All tables have proper RLS policies
</success_criteria>

<output>
After completion, create `.planning/phases/07-operations-compliance/07-01-SUMMARY.md`
</output>
