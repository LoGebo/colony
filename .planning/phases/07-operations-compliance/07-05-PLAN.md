---
phase: 07-operations-compliance
plan: 05
type: execute
wave: 2
depends_on: [07-01, 07-02, 07-03]
files_modified:
  - supabase/migrations/TIMESTAMP_community_settings.sql
  - supabase/migrations/TIMESTAMP_roles_permissions.sql
autonomous: true

must_haves:
  truths:
    - "Community settings configure hours, rules, and branding"
    - "Feature flags enable/disable features per community via JSONB"
    - "Roles can be defined per community with custom names"
    - "Permissions matrix is configurable with role-permission assignments"
  artifacts:
    - path: "supabase/migrations/*_community_settings.sql"
      provides: "community_settings table with JSONB feature_flags and helper functions"
    - path: "supabase/migrations/*_roles_permissions.sql"
      provides: "roles, permissions, role_permissions, user_roles tables with has_permission function"
  key_links:
    - from: "community_settings.feature_flags"
      to: "is_feature_enabled function"
      via: "JSONB lookup"
    - from: "role_permissions.role_id"
      to: "roles.id"
      via: "foreign key"
    - from: "has_permission function"
      to: "user_roles, role_permissions, permissions tables"
      via: "join query"
---

<objective>
Create community configuration schema with JSONB feature flags for per-tenant feature control, and a configurable RBAC system with roles, permissions, and assignments that work alongside JWT claims.

Purpose: Enable communities to customize their experience with feature toggles, operating rules, and branding, while providing fine-grained permission control beyond basic JWT roles.

Output: Community settings with feature flag functions and hybrid RBAC with database-level permission checking.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-operations-compliance/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create community settings table with feature flags</name>
  <files>supabase/migrations/TIMESTAMP_community_settings.sql</files>
  <action>
Create migration for community settings with JSONB feature flags:

**community_settings table:**
- id UUID PK DEFAULT generate_uuid_v7()
- community_id UUID NOT NULL REFERENCES communities(id) ON DELETE CASCADE
- Operating hours:
  - office_hours_start TIME DEFAULT '08:00'
  - office_hours_end TIME DEFAULT '18:00'
  - office_days INTEGER[] DEFAULT ARRAY[1,2,3,4,5] (Mon-Fri)
- Contact information:
  - management_email TEXT
  - management_phone phone_number
  - emergency_phone phone_number
- Branding:
  - logo_url TEXT
  - primary_color TEXT (hex color)
  - secondary_color TEXT
- Locale:
  - timezone TEXT NOT NULL DEFAULT 'America/Mexico_City'
  - locale locale_code NOT NULL DEFAULT 'es-MX' (reuse domain if exists, else TEXT)
  - currency currency_code NOT NULL DEFAULT 'MXN' (reuse domain if exists, else TEXT)
- Feature flags (JSONB for flexibility):
  - feature_flags JSONB NOT NULL DEFAULT '{}'::JSONB
  - Schema: { "feature_name": { "enabled": true, "config": {...} } }
- Rules and policies:
  - guest_parking_allowed BOOLEAN DEFAULT true
  - max_vehicles_per_unit INTEGER DEFAULT 2
  - pet_policy TEXT
  - quiet_hours_start TIME DEFAULT '22:00'
  - quiet_hours_end TIME DEFAULT '08:00'
- Package settings:
  - package_retention_days INTEGER DEFAULT 14
  - package_notification_channels TEXT[] DEFAULT ARRAY['push', 'email']
- Custom rules:
  - custom_rules JSONB DEFAULT '[]'::JSONB
- Standard audit columns
- UNIQUE constraint on community_id

**GIN index for JSONB queries:**
- idx_community_settings_features USING GIN (feature_flags)

**Default feature flags documentation (comment in migration):**
```sql
-- Feature flags schema example:
-- {
--   "digital_mailroom": { "enabled": true, "config": { "qr_codes_enabled": true, "signature_required": false } },
--   "provider_management": { "enabled": true, "config": { "require_insurance": true } },
--   "move_coordination": { "enabled": true, "config": { "require_deposit": true, "deposit_amount": 5000 } },
--   "marketplace": { "enabled": false },
--   "voting": { "enabled": true, "config": { "weighted_voting": true } }
-- }
```

**is_feature_enabled(p_community_id, p_feature_name) function:**
- STABLE, returns BOOLEAN
- Looks up feature_flags->p_feature_name->>'enabled'
- Returns FALSE if feature not found or disabled

**get_feature_config(p_community_id, p_feature_name) function:**
- STABLE, returns JSONB
- Returns feature_flags->p_feature_name->'config'
- Returns NULL if feature not found

**create_default_community_settings(p_community_id) function:**
- Inserts community_settings with reasonable defaults
- Sets default feature flags for new communities:
  ```json
  {
    "digital_mailroom": { "enabled": true, "config": {} },
    "provider_management": { "enabled": true, "config": {} },
    "move_coordination": { "enabled": true, "config": {} },
    "marketplace": { "enabled": false, "config": {} },
    "voting": { "enabled": true, "config": {} },
    "chat": { "enabled": true, "config": {} }
  }
  ```
- Returns settings id

RLS:
- Members can SELECT their community's settings
- Admins can UPDATE their community's settings
  </action>
  <verify>
1. SELECT create_default_community_settings('community-id')
2. SELECT is_feature_enabled('community-id', 'digital_mailroom') - should return true
3. SELECT is_feature_enabled('community-id', 'marketplace') - should return false
4. UPDATE community_settings SET feature_flags = feature_flags || '{"marketplace": {"enabled": true}}'::JSONB
5. SELECT is_feature_enabled('community-id', 'marketplace') - should return true
6. SELECT get_feature_config('community-id', 'move_coordination') - should return config JSONB
  </verify>
  <done>Community settings with JSONB feature flags and helper functions</done>
</task>

<task type="auto">
  <name>Task 2: Create roles and permissions tables with RBAC functions</name>
  <files>supabase/migrations/TIMESTAMP_roles_permissions.sql</files>
  <action>
Create migration for configurable RBAC system:

**roles table:**
- id UUID PK DEFAULT generate_uuid_v7()
- community_id UUID REFERENCES communities(id) (NULL for system roles)
- name TEXT NOT NULL
- display_name TEXT NOT NULL
- description TEXT
- parent_role_id UUID REFERENCES roles(id) (for hierarchy, optional)
- is_system_role BOOLEAN NOT NULL DEFAULT false (cannot delete)
- is_default BOOLEAN NOT NULL DEFAULT false (assigned to new users)
- is_active BOOLEAN NOT NULL DEFAULT true
- Standard audit columns
- UNIQUE constraint on (community_id, name)

**Seed system roles (community_id = NULL):**
```sql
INSERT INTO roles (name, display_name, is_system_role, description) VALUES
  ('super_admin', 'Super Administrador', true, 'Platform-level administrator'),
  ('community_admin', 'Administrador', true, 'Community administrator'),
  ('manager', 'Gestor', true, 'Operations manager'),
  ('guard', 'Guardia', true, 'Security guard'),
  ('resident', 'Residente', true, 'Property owner or tenant'),
  ('provider', 'Proveedor', true, 'Service provider');
```

**permissions table:**
- id UUID PK DEFAULT generate_uuid_v7()
- name TEXT NOT NULL UNIQUE (e.g., 'packages.read')
- display_name TEXT NOT NULL
- description TEXT
- resource TEXT NOT NULL (e.g., 'packages', 'providers', 'residents')
- action TEXT NOT NULL (e.g., 'read', 'create', 'update', 'delete', 'approve')
- category TEXT (for UI grouping: 'operations', 'security', 'financial', 'configuration')
- created_at TIMESTAMPTZ NOT NULL DEFAULT now()
- UNIQUE constraint on (resource, action)

**Seed common permissions:**
```sql
INSERT INTO permissions (name, display_name, resource, action, category) VALUES
  -- Packages
  ('packages.read', 'Ver paquetes', 'packages', 'read', 'operations'),
  ('packages.create', 'Registrar paquetes', 'packages', 'create', 'operations'),
  ('packages.update', 'Actualizar paquetes', 'packages', 'update', 'operations'),
  ('packages.pickup', 'Procesar entregas', 'packages', 'pickup', 'operations'),
  -- Providers
  ('providers.read', 'Ver proveedores', 'providers', 'read', 'operations'),
  ('providers.create', 'Agregar proveedores', 'providers', 'create', 'operations'),
  ('providers.approve', 'Aprobar proveedores', 'providers', 'approve', 'operations'),
  -- Moves
  ('moves.read', 'Ver mudanzas', 'moves', 'read', 'operations'),
  ('moves.approve', 'Aprobar mudanzas', 'moves', 'approve', 'operations'),
  -- Audit
  ('audit.read', 'Ver auditoría', 'audit', 'read', 'security'),
  -- Settings
  ('settings.read', 'Ver configuración', 'settings', 'read', 'configuration'),
  ('settings.update', 'Actualizar configuración', 'settings', 'update', 'configuration'),
  -- Roles
  ('roles.manage', 'Gestionar roles', 'roles', 'manage', 'security');
```

**role_permissions table:**
- id UUID PK DEFAULT generate_uuid_v7()
- role_id UUID NOT NULL REFERENCES roles(id) ON DELETE CASCADE
- permission_id UUID NOT NULL REFERENCES permissions(id) ON DELETE CASCADE
- conditions JSONB (optional fine-grained control: {"own_unit_only": true})
- valid_from TIMESTAMPTZ
- valid_until TIMESTAMPTZ
- granted_by UUID REFERENCES auth.users(id)
- granted_at TIMESTAMPTZ NOT NULL DEFAULT now()
- UNIQUE constraint on (role_id, permission_id)

**user_roles table:**
- id UUID PK DEFAULT generate_uuid_v7()
- user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE
- role_id UUID NOT NULL REFERENCES roles(id) ON DELETE CASCADE
- community_id UUID NOT NULL REFERENCES communities(id)
- assigned_by UUID REFERENCES auth.users(id)
- assigned_at TIMESTAMPTZ NOT NULL DEFAULT now()
- valid_from TIMESTAMPTZ NOT NULL DEFAULT now()
- valid_until TIMESTAMPTZ
- is_active BOOLEAN NOT NULL DEFAULT true
- UNIQUE constraint on (user_id, role_id, community_id)

**Indexes:**
- idx_user_roles_user_community ON user_roles(user_id, community_id) WHERE is_active = true
- idx_role_permissions_role ON role_permissions(role_id)

**has_permission(p_user_id, p_community_id, p_permission_name) function:**
- STABLE, SECURITY DEFINER, returns BOOLEAN
- Checks if user has permission via any of their roles in the community
- Considers valid_until on both user_roles and role_permissions
- Returns true if found, false otherwise

**get_user_permissions(p_user_id DEFAULT auth.uid(), p_community_id DEFAULT NULL) function:**
- STABLE, SECURITY DEFINER
- Returns TABLE(permission_name TEXT, resource TEXT, action TEXT, conditions JSONB)
- If community_id not provided, tries to get from JWT app_metadata
- Lists all permissions user has in that community

**assign_role(p_user_id, p_role_id, p_community_id) function:**
- Assigns role to user in community
- Sets assigned_by to auth.uid()
- Returns user_roles id

**revoke_role(p_user_id, p_role_id, p_community_id) function:**
- Sets is_active = false
- Does not delete for audit purposes
- Returns boolean success

**Seed default role permissions (after seeding roles and permissions):**
```sql
-- Admin gets all permissions
INSERT INTO role_permissions (role_id, permission_id)
SELECT r.id, p.id
FROM roles r, permissions p
WHERE r.name = 'community_admin';

-- Guard gets package and provider read/pickup
INSERT INTO role_permissions (role_id, permission_id)
SELECT r.id, p.id
FROM roles r, permissions p
WHERE r.name = 'guard'
  AND p.name IN ('packages.read', 'packages.pickup', 'providers.read', 'moves.read');

-- Resident gets limited read access
INSERT INTO role_permissions (role_id, permission_id)
SELECT r.id, p.id
FROM roles r, permissions p
WHERE r.name = 'resident'
  AND p.name IN ('packages.read', 'moves.read', 'settings.read');
```

RLS:
- roles: All authenticated can SELECT, admins can INSERT/UPDATE custom roles
- permissions: All authenticated can SELECT (reference data)
- role_permissions: Admins can full CRUD
- user_roles: Admins can full CRUD, users can SELECT own roles
  </action>
  <verify>
1. SELECT * FROM roles WHERE is_system_role = true - should have 6 system roles
2. SELECT * FROM permissions - should have 13+ permissions
3. SELECT has_permission(auth.uid(), 'community-id', 'packages.read')
4. SELECT * FROM get_user_permissions(auth.uid(), 'community-id')
5. SELECT assign_role(user_id, guard_role_id, community_id)
6. SELECT has_permission(user_id, community_id, 'packages.pickup') - should return true
  </verify>
  <done>Configurable RBAC with roles, permissions, and has_permission() function</done>
</task>

</tasks>

<verification>
-- Test feature flags
SELECT is_feature_enabled('community-id', 'digital_mailroom');
-- Returns based on feature_flags JSONB

-- Update feature flag
UPDATE community_settings
SET feature_flags = jsonb_set(feature_flags, '{marketplace,enabled}', 'true')
WHERE community_id = 'community-id';

-- Test RBAC
SELECT has_permission(auth.uid(), 'community-id', 'packages.create');
-- Returns true if user has admin or appropriate role

-- List user permissions
SELECT * FROM get_user_permissions(auth.uid());
-- Returns all permissions for current user in their community
</verification>

<success_criteria>
- community_settings stores operating hours, branding, locale, and rules
- feature_flags JSONB with GIN index enables per-tenant feature control
- is_feature_enabled() and get_feature_config() provide clean API for feature checks
- System roles seeded for common user types (6 roles)
- Permissions seeded for Phase 7 resources (13+ permissions)
- role_permissions allows custom role-permission assignments
- user_roles tracks per-community role assignments with validity periods
- has_permission() function enables database-level permission checking
- get_user_permissions() returns user's complete permission set
- All tables have proper RLS policies
</success_criteria>

<output>
After completion, create `.planning/phases/07-operations-compliance/07-05-SUMMARY.md`
</output>
