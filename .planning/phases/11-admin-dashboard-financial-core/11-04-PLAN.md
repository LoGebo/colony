---
phase: 11-admin-dashboard-financial-core
plan: 04
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - packages/admin/src/hooks/useCommunitySettings.ts
  - packages/admin/src/app/(dashboard)/settings/page.tsx
  - packages/admin/src/app/(dashboard)/settings/features/page.tsx
  - packages/admin/src/app/(dashboard)/settings/roles/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view and edit community name, description, timezone, and contact info"
    - "Admin can upload or change community logo and set brand colors"
    - "Admin can toggle feature flags on/off for their community"
    - "Admin can view users with their roles and change role assignments"
  artifacts:
    - path: "packages/admin/src/hooks/useCommunitySettings.ts"
      provides: "Query + mutation hooks for community settings and feature flags"
      min_lines: 50
    - path: "packages/admin/src/app/(dashboard)/settings/page.tsx"
      provides: "Community settings editor page"
      min_lines: 80
    - path: "packages/admin/src/app/(dashboard)/settings/features/page.tsx"
      provides: "Feature flags management page"
      min_lines: 40
    - path: "packages/admin/src/app/(dashboard)/settings/roles/page.tsx"
      provides: "User role management page"
      min_lines: 50
  key_links:
    - from: "packages/admin/src/app/(dashboard)/settings/page.tsx"
      to: "packages/admin/src/hooks/useCommunitySettings.ts"
      via: "useCommunitySettings, useUpdateCommunitySettings"
      pattern: "useCommunitySettings|useUpdateCommunitySettings"
    - from: "packages/admin/src/hooks/useCommunitySettings.ts"
      to: "Supabase auto-API"
      via: "createClient().from('community_settings') and .from('communities')"
      pattern: "from\\('community_settings'\\)|from\\('communities'\\)"
---

<objective>
Build community configuration screens: settings editor for community info and branding, feature flags management, and user role management.

Purpose: Administrators need to configure their community's identity (name, logo, colors), operational settings (office hours, contact info), and control which features are enabled. Role management allows admins to view and adjust user permissions.

Output: Settings page at `/settings`, feature flags at `/settings/features`, and role management at `/settings/roles`.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-admin-dashboard-financial-core/11-RESEARCH.md
@.planning/phases/11-admin-dashboard-financial-core/11-01-SUMMARY.md
@packages/admin/src/hooks/useAuth.ts
@packages/admin/src/lib/supabase/client.ts
@packages/admin/src/lib/supabase/server.ts
@packages/admin/src/lib/supabase/admin.ts
@packages/admin/src/lib/formatters.ts
@packages/admin/src/components/ui/Card.tsx
@packages/admin/src/components/ui/Button.tsx
@packages/admin/src/components/ui/Badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Community settings editor and branding configuration</name>
  <files>
    packages/admin/src/hooks/useCommunitySettings.ts,
    packages/admin/src/app/(dashboard)/settings/page.tsx
  </files>
  <action>
**A. Create `packages/admin/src/hooks/useCommunitySettings.ts`:**

`'use client'` hook file with:

1. `useCommunity()` -- queries `communities` where `id = communityId` (from useAuth). Select: `id, name, slug, description, status, timezone, locale, currency, logo_url, cover_image_url, primary_color, secondary_color, settings`. Returns single community record.

2. `useCommunitySettings()` -- queries `community_settings` where `community_id` matches. Select all columns. Returns settings record (office hours, contact info, branding, feature_flags, quiet hours, etc.).

3. `useUpdateCommunity()` -- `useMutation` updating `communities` by id. Updateable: `name`, `description`, `timezone`, `locale`, `currency`, `logo_url`, `cover_image_url`, `primary_color`, `secondary_color`. On success: `toast.success('Comunidad actualizada')`, invalidate `['community']`.

4. `useUpdateCommunitySettings()` -- `useMutation` updating `community_settings` by `community_id`. On success: `toast.success('Configuracion guardada')`, invalidate `['community-settings']`.

5. `useUpdateFeatureFlags()` -- `useMutation` that updates only the `feature_flags` JSONB column in `community_settings`. Takes `Record<string, boolean>`. On success: toast, invalidate.

6. `useAdminUsers()` -- queries `residents` where `community_id` matches and `deleted_at IS NULL`, with `user_id` not null (i.e., users who have signed up). Also query `guards` in same community with `user_id` not null. Combine into a single list of users with their roles (from the resident/guard records or from their JWT metadata). This is a read-only list for display.

**B. Create `/settings/page.tsx` -- Community Settings:**

`'use client'` + `force-dynamic`. Page header "Configuracion de la Comunidad".

Organized in sections using Card components:

**Section 1: Informacion General**
- Nombre de la Comunidad (text input, required)
- Descripcion (textarea)
- Zona Horaria (select: America/Mexico_City, etc.)
- Moneda (select: MXN, USD)
- "Guardar Cambios" button

**Section 2: Marca e Identidad**
- Logo URL (text input -- for now, manual URL entry. File upload can be added in future phase)
- Color Primario (text input with color preview, e.g., hex input)
- Color Secundario (text input with color preview)
- Preview card showing how the colors look

**Section 3: Informacion de Contacto (from community_settings)**
- Telefono de oficina
- Email de administracion
- Direccion
- Horario de oficina (text, e.g., "Lun-Vie 9:00-18:00")

**Section 4: Reglas de la Comunidad (from community_settings)**
- Horario de silencio (quiet hours: start/end time inputs)
- Politica de mascotas (textarea)
- Reglas personalizadas (textarea for custom_rules)

Each section has its own "Guardar" button. Uses `useUpdateCommunity` for Section 1-2, `useUpdateCommunitySettings` for Section 3-4.

Form state managed with `useState`. Pre-populate from `useCommunity()` and `useCommunitySettings()`. Loading skeletons while data loads.
  </action>
  <verify>
1. `cd packages/admin && npx next build` -- succeeds.
2. Grep for `useCommunity` and `useUpdateCommunity` in settings/page.tsx.
3. Grep for `useCommunitySettings` in useCommunitySettings.ts.
4. Grep for `toast.success` in useCommunitySettings.ts.
  </verify>
  <done>
Admin can view and edit community name, description, timezone, currency, branding (logo URL, colors), contact info, office hours, quiet hours, pet policy, and custom rules. Changes saved with toast feedback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Feature flags management and role management</name>
  <files>
    packages/admin/src/app/(dashboard)/settings/features/page.tsx,
    packages/admin/src/app/(dashboard)/settings/roles/page.tsx
  </files>
  <action>
**A. Create `/settings/features/page.tsx` -- Feature Flags:**

`'use client'` + `force-dynamic`. Page header "Funcionalidades".

Define a TypeScript interface for known feature flags:
```typescript
interface FeatureFlags {
  enable_payments: boolean;
  enable_visitors: boolean;
  enable_packages: boolean;
  enable_amenities: boolean;
  enable_marketplace: boolean;
  enable_maintenance: boolean;
  enable_social_wall: boolean;
  enable_documents: boolean;
}
```

Default all flags to `true` if not set in the JSONB.

Features:
- List of toggleable features, each shown as a card with:
  - Feature name (Spanish): Pagos, Visitantes, Paquetes, Amenidades, Marketplace, Mantenimiento, Muro Social, Documentos
  - Short description of what the feature does
  - Toggle switch (styled checkbox or button) showing on/off state
- "Guardar Cambios" button at bottom calls `useUpdateFeatureFlags` with the current state
- Load current flags from `useCommunitySettings().data?.feature_flags`
- Merge loaded flags with defaults (so new flags show as enabled by default)
- Visual: green background when ON, gray when OFF. Toggle is a styled `<button>` with sliding dot (no library needed -- pure Tailwind CSS).

**B. Create `/settings/roles/page.tsx` -- Role Management:**

`'use client'` + `force-dynamic`. Page header "Gestion de Roles".

Features:
- Uses `useAdminUsers()` from `useCommunitySettings.ts` to get list of users with roles
- DataTable with columns: Nombre, Email, Rol Actual (Badge with color per role), Tipo (residente/guardia), Estado, Fecha Registro
- Role badges: community_admin=purple, manager=blue, guard=orange, resident=green
- For now, role changes are **read-only display** -- actually changing a user's JWT role requires modifying their `app_metadata` via the Admin API, which is a sensitive operation. Show an info banner: "Los cambios de rol requieren accion directa en el panel de Supabase por seguridad."
- Search filter for name/email
- Sort by role, name, or date

Note: Full role editing (ARES-05) is intentionally limited to read-only display with a note about Supabase dashboard. Implementing role changes via the Admin API can be added in a future iteration when proper safeguards (audit trail, confirmation workflow) are in place.
  </action>
  <verify>
1. `cd packages/admin && npx next build` -- succeeds.
2. Files exist: `ls packages/admin/src/app/(dashboard)/settings/features/page.tsx packages/admin/src/app/(dashboard)/settings/roles/page.tsx`.
3. Grep for `useUpdateFeatureFlags` in features/page.tsx.
4. Grep for `useAdminUsers` in roles/page.tsx.
5. Grep for `enable_payments` in features/page.tsx (known flag).
  </verify>
  <done>
Admin can toggle feature flags on/off for their community. Admin can view all users with their current roles. Role management page shows informational note about role changes requiring Supabase dashboard access.
  </done>
</task>

</tasks>

<verification>
1. Build: `cd packages/admin && npx next build` succeeds.
2. Settings page: sections for general info, branding, contact, rules with save buttons.
3. Feature flags page: toggle switches for 8 known flags with save.
4. Roles page: user list with role badges, search, sort.
5. All pages have `'use client'` and `force-dynamic`.
6. All mutations use Sonner toasts for feedback.
</verification>

<success_criteria>
- Settings page at `/settings` allows editing community info, branding, contact, and rules
- Feature flags page at `/settings/features` allows toggling 8 community features
- Roles page at `/settings/roles` shows user directory with role assignments
- Changes persist to database via Supabase auto-API
- `pnpm build` succeeds for `@upoe/admin`
</success_criteria>

<output>
After completion, create `.planning/phases/11-admin-dashboard-financial-core/11-04-SUMMARY.md`
</output>
