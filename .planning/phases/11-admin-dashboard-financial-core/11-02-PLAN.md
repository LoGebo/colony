---
phase: 11-admin-dashboard-financial-core
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - packages/admin/src/hooks/usePaymentProofs.ts
  - packages/admin/src/hooks/useCharges.ts
  - packages/admin/src/components/financial/PaymentProofCard.tsx
  - packages/admin/src/components/financial/ChargePreviewTable.tsx
  - packages/admin/src/components/financial/BalanceReportTable.tsx
  - packages/admin/src/app/(dashboard)/finances/page.tsx
  - packages/admin/src/app/(dashboard)/finances/approvals/page.tsx
  - packages/admin/src/app/(dashboard)/finances/charges/page.tsx
  - packages/admin/src/app/(dashboard)/finances/delinquency/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view pending payment proofs in an approval queue sorted by date"
    - "Admin can approve a payment proof individually and see success toast"
    - "Admin can reject a payment proof with a reason and see success toast"
    - "Admin can select multiple proofs and bulk approve/reject them"
    - "Admin can preview monthly charge amounts per unit before applying"
    - "Admin can generate monthly charges after confirming preview"
    - "Admin can view unit-by-unit balance report with sorting and filtering"
    - "Admin can export balance report to Excel file"
    - "Admin can view delinquency analytics with 30/60/90/120+ day aging buckets"
  artifacts:
    - path: "packages/admin/src/hooks/usePaymentProofs.ts"
      provides: "Query + mutation hooks for payment proof approval queue"
      min_lines: 60
    - path: "packages/admin/src/hooks/useCharges.ts"
      provides: "Charge preview and generation hooks"
      min_lines: 40
    - path: "packages/admin/src/app/(dashboard)/finances/approvals/page.tsx"
      provides: "Payment proof approval queue page"
      min_lines: 80
    - path: "packages/admin/src/app/(dashboard)/finances/charges/page.tsx"
      provides: "Charge generation with preview page"
      min_lines: 60
    - path: "packages/admin/src/app/(dashboard)/finances/page.tsx"
      provides: "Balance reports page with export"
      min_lines: 60
  key_links:
    - from: "packages/admin/src/app/(dashboard)/finances/approvals/page.tsx"
      to: "packages/admin/src/hooks/usePaymentProofs.ts"
      via: "usePendingProofs, useApprovePaymentProof, useRejectPaymentProof, useBulkApproveProofs"
      pattern: "usePendingProofs|useApprovePaymentProof"
    - from: "packages/admin/src/hooks/usePaymentProofs.ts"
      to: "Supabase auto-API"
      via: "createClient().from('payment_proofs').update()"
      pattern: "from\\('payment_proofs'\\)"
    - from: "packages/admin/src/app/(dashboard)/finances/charges/page.tsx"
      to: "packages/admin/src/hooks/useCharges.ts"
      via: "useChargePreview, useGenerateCharges"
      pattern: "useChargePreview|useGenerateCharges"
    - from: "packages/admin/src/app/(dashboard)/finances/page.tsx"
      to: "packages/admin/src/lib/export.ts"
      via: "exportToExcel for balance report download"
      pattern: "exportToExcel"
---

<objective>
Build the payment operations suite: payment proof approval queue with bulk operations, charge generation with preview confirmation, unit balance reports with Excel export, and delinquency analytics.

Purpose: These are the core daily financial workflows for administrators. Approving payment proofs triggers `record_payment` (deployed in 11-01) which creates double-entry ledger entries. Charge generation creates monthly maintenance fees. Balance reports and delinquency analytics give admins visibility into community financial health.

Output: Four new pages under `/finances/` -- approvals queue, charge generation, balance reports, and delinquency analytics.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-admin-dashboard-financial-core/11-RESEARCH.md
@.planning/phases/11-admin-dashboard-financial-core/11-01-SUMMARY.md
@packages/admin/src/hooks/useAuth.ts
@packages/admin/src/hooks/useFinancials.ts
@packages/admin/src/lib/supabase/client.ts
@packages/admin/src/lib/supabase/admin.ts
@packages/admin/src/lib/formatters.ts
@packages/admin/src/lib/export.ts
@packages/admin/src/components/ui/DataTable.tsx
@packages/admin/src/components/ui/Card.tsx
@packages/admin/src/components/ui/Button.tsx
@packages/admin/src/components/ui/Badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Payment proof approval queue with bulk operations</name>
  <files>
    packages/admin/src/hooks/usePaymentProofs.ts,
    packages/admin/src/components/financial/PaymentProofCard.tsx,
    packages/admin/src/app/(dashboard)/finances/approvals/page.tsx
  </files>
  <action>
**A. Create `packages/admin/src/hooks/usePaymentProofs.ts`:**

`'use client'` hook file with:

1. `usePendingProofs()` -- queries `payment_proofs` where `status = 'pending'` and `community_id` matches. Select: `id, proof_type, amount, payment_date, reference_number, bank_name, document_url, submitter_notes, submitted_at, status`, join with `units!inner(unit_number, building)` (FK hint via `unit_id`). Order by `submitted_at` ascending (oldest first). Uses TanStack Query `useQuery`.

2. `useApprovePaymentProof()` -- `useMutation` that updates `payment_proofs` set `status = 'approved'`, `reviewed_by = user.id`, `reviewed_at = new Date().toISOString()` where `id = proofId`. On success: `toast.success('Comprobante aprobado')`, invalidate `['payment-proofs']` and `['unit-balances']` query keys. On error: `toast.error('Error al aprobar: ' + error.message)`.

3. `useRejectPaymentProof()` -- `useMutation` that updates `payment_proofs` set `status = 'rejected'`, `reviewed_by = user.id`, `reviewed_at = now`, `rejection_reason = reason`. On success: `toast.success('Comprobante rechazado')`, invalidate queries. On error: toast error.

4. `useBulkApproveProofs()` -- `useMutation` that takes `proofIds: string[]`, uses `Promise.allSettled` to approve each one in parallel. On settlement: toast success with count of approved, toast error for any failures. Invalidate queries ONCE at end.

**B. Create `packages/admin/src/components/financial/PaymentProofCard.tsx`:**

`'use client'` component showing a single payment proof. Props: `proof` (with unit_number, amount, payment_date, proof_type, reference_number, bank_name, document_url, submitter_notes), `onApprove(id)`, `onReject(id, reason)`, `isSelected`, `onToggleSelect(id)`, `isLoading`.

Layout:
- Checkbox on left for bulk selection
- Unit number + amount (formatted with `formatCurrency`)
- Proof type, date (formatted), reference, bank
- "Ver comprobante" link opening document_url in new tab
- Approve button (green) and Reject button (red)
- On reject click: show `window.prompt('Motivo del rechazo:')` -- if user provides reason, call onReject

**C. Create `packages/admin/src/app/(dashboard)/finances/approvals/page.tsx`:**

`'use client'` + `force-dynamic`. Page header "Cola de Aprobaciones" with pending count badge.

Features:
- Uses `usePendingProofs()` for data
- Maps proofs to `PaymentProofCard` components in a vertical stack
- Bulk action bar at top (shown when any items selected): "Aprobar seleccionados (N)" button, "Seleccionar todos" / "Deseleccionar" toggle
- Selection state managed with `useState<Set<string>>`
- Loading state shows skeleton cards
- Empty state: "No hay comprobantes pendientes" with checkmark icon
- Error state shows error message with retry button
  </action>
  <verify>
1. `cd packages/admin && npx next build` -- succeeds.
2. Grep for `usePendingProofs` in approvals page.
3. Grep for `useApprovePaymentProof` and `useRejectPaymentProof` in hooks file.
4. Grep for `toast.success` in usePaymentProofs.ts.
5. Grep for `PaymentProofCard` in approvals page.
  </verify>
  <done>
Admin can view pending payment proofs, approve/reject individually with toast feedback, select multiple for bulk approval. Rejection requires a reason. Approving triggers database `on_payment_proof_approved` trigger which calls `record_payment`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Charge generation, balance reports, and delinquency analytics</name>
  <files>
    packages/admin/src/hooks/useCharges.ts,
    packages/admin/src/components/financial/ChargePreviewTable.tsx,
    packages/admin/src/components/financial/BalanceReportTable.tsx,
    packages/admin/src/app/(dashboard)/finances/page.tsx,
    packages/admin/src/app/(dashboard)/finances/charges/page.tsx,
    packages/admin/src/app/(dashboard)/finances/delinquency/page.tsx
  </files>
  <action>
**A. Create `packages/admin/src/hooks/useCharges.ts`:**

`'use client'` hook file with:

1. `useFeeStructures()` -- queries `fee_structures` where `community_id` matches, `deleted_at IS NULL`, `status = 'active'`. Returns list of fee structures for the charge generation dropdown.

2. `useChargePreview(feeStructureId)` -- queries all active `units` in community, then for each unit calls `calculate_fee_amount` RPC (or `get_unit_fee_amount`) to get calculated amount. Returns `Array<{unit_id, unit_number, building, coefficient, unit_type, calculated_amount}>`. Enabled only when `feeStructureId` is provided. See research Pattern 6.

3. `useGenerateCharges()` -- `useMutation` that takes `{feeStructureId, chargeDate, description}` plus the preview data. For each unit in preview, calls `record_charge` RPC: `supabase.rpc('record_charge', { p_community_id, p_unit_id, p_amount, p_charge_date, p_description, p_fee_structure_id, p_created_by })`. Uses `Promise.allSettled` for parallel execution. On complete: toast success with count, invalidate `['unit-balances']` and `['transactions']`. On partial failure: toast warning with counts.

4. `useUnitBalances()` -- queries `unit_balances` view filtered by `community_id`. Returns all columns for balance report table.

**B. Create `packages/admin/src/components/financial/ChargePreviewTable.tsx`:**

`'use client'` component. Props: `previews` (array from useChargePreview), `isLoading`. Renders a table with columns: Unidad, Edificio, Tipo, Coeficiente, Monto Calculado. Shows total at bottom. Uses `formatCurrency` for amounts.

**C. Create `packages/admin/src/components/financial/BalanceReportTable.tsx`:**

`'use client'` component wrapping DataTable. Props: `data` (from useUnitBalances), `onExport`. Columns: Unidad, Edificio, Total Cargos, Total Pagos, Saldo, Dias Vencido, Ultimo Pago. Sorting on all columns. Conditional row styling: red background tint for units with positive balance (they owe money) and days_overdue > 30.

**D. Create `/finances/page.tsx` -- Balance Reports:**

`'use client'` + `force-dynamic`. Page header "Reportes de Saldos".

Features:
- Uses `useUnitBalances()` for data
- Renders `BalanceReportTable` with full sort/filter support
- Text search filter for unit_number at top
- "Exportar a Excel" button using `exportToExcel` utility -- transforms data to Spanish column headers before export
- Summary stats above table: Total Unidades, Total Saldo Pendiente, Unidades al Dia, Unidades Morosas

**E. Create `/finances/charges/page.tsx` -- Charge Generation:**

`'use client'` + `force-dynamic`. Page header "Generacion de Cargos".

Two-step workflow:
1. **Preview step:** Fee structure selector dropdown (from `useFeeStructures`), charge date picker (defaults to 1st of current month), description text input (defaults to "Cuota de mantenimiento [month] [year]"). "Vista Previa" button triggers `useChargePreview`. Shows `ChargePreviewTable` when data loads.
2. **Confirm step:** After preview loads, show "Generar Cargos" button with confirmation modal (using a simple custom modal): "Se generaran N cargos por un total de $X.XX. Esta accion no se puede deshacer." with "Confirmar" (primary) and "Cancelar" (secondary) buttons. On confirm: call `useGenerateCharges` mutation.

Loading states, error handling throughout.

**F. Create `/finances/delinquency/page.tsx` -- Delinquency Analytics:**

`'use client'` + `force-dynamic`. Page header "Analisis de Morosidad".

Features:
- Uses `useDelinquentUnits(1)` from `useFinancials.ts` (created in 11-01) for the full delinquent units list
- Aging summary cards at top: 4 KPICards showing count/amount for 30-day, 60-day, 90-day, 120+ day buckets. Compute buckets from delinquent units data by filtering on `days_overdue` ranges.
- Delinquent units table below using DataTable: Unidad, Edificio, Saldo Pendiente, Dias Vencidos, Fecha Mas Antigua, Ultimo Pago. Sort by days_overdue descending (most delinquent first).
- Building breakdown: if units have `building` field populated, show per-building summary (building name, count, total amount) as a small summary table below main table.
  </action>
  <verify>
1. `cd packages/admin && npx next build` -- succeeds.
2. Files exist: `ls packages/admin/src/app/(dashboard)/finances/approvals/page.tsx packages/admin/src/app/(dashboard)/finances/charges/page.tsx packages/admin/src/app/(dashboard)/finances/page.tsx packages/admin/src/app/(dashboard)/finances/delinquency/page.tsx`.
3. Grep for `exportToExcel` in finances/page.tsx.
4. Grep for `record_charge` in useCharges.ts.
5. Grep for `useChargePreview` in charges/page.tsx.
6. Grep for `useDelinquentUnits` in delinquency/page.tsx.
  </verify>
  <done>
Admin can: (1) view unit-by-unit balance report with sorting and Excel export, (2) preview and generate monthly charges with confirmation, (3) view delinquency analytics with aging buckets and building breakdown. All four finance sub-pages are fully functional.
  </done>
</task>

</tasks>

<verification>
1. Build: `cd packages/admin && npx next build` succeeds.
2. Approvals page: imports usePendingProofs, PaymentProofCard, bulk selection works.
3. Charges page: two-step workflow (preview then confirm), calls record_charge RPC.
4. Balance page: DataTable with sorting, exportToExcel button.
5. Delinquency page: aging summary cards (30/60/90/120+), delinquent units table.
6. All pages have `'use client'` and `force-dynamic`.
7. All mutations use Sonner toasts for feedback.
</verification>

<success_criteria>
- Four finance sub-pages exist and render: /finances (balance), /finances/approvals, /finances/charges, /finances/delinquency
- Payment proof approval works with individual and bulk operations
- Charge generation has preview-then-confirm workflow
- Balance report exports to Excel
- Delinquency analytics shows aging breakdown
- `pnpm build` succeeds for `@upoe/admin`
</success_criteria>

<output>
After completion, create `.planning/phases/11-admin-dashboard-financial-core/11-02-SUMMARY.md`
</output>
