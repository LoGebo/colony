---
phase: 11-admin-dashboard-financial-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/package.json
  - packages/admin/src/lib/formatters.ts
  - packages/admin/src/lib/export.ts
  - packages/admin/src/components/ui/Card.tsx
  - packages/admin/src/components/ui/Badge.tsx
  - packages/admin/src/components/ui/Button.tsx
  - packages/admin/src/components/ui/DataTable.tsx
  - packages/admin/src/components/charts/KPICard.tsx
  - packages/admin/src/components/charts/CollectionChart.tsx
  - packages/admin/src/components/charts/DelinquencyChart.tsx
  - packages/admin/src/components/charts/ExpenseChart.tsx
  - packages/admin/src/hooks/useFinancials.ts
  - packages/admin/src/app/(dashboard)/page.tsx
  - packages/admin/src/app/(dashboard)/finances/reports/page.tsx
  - packages/admin/src/app/(dashboard)/layout.tsx
  - packages/admin/src/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Admin sees 4 KPI cards on dashboard home: total collected, total billed, collection rate, delinquent units"
    - "Admin sees monthly collection bar chart (billed vs collected) for last 12 months"
    - "Admin sees delinquency trend line chart showing 30/60/90 day buckets over time"
    - "Admin sees expense breakdown pie chart by account category"
    - "Admin can navigate to income vs expense report page with monthly comparison table"
    - "RLS policies allow community_admin role to read/write financial tables"
    - "record_payment and record_charge functions exist in live database"
  artifacts:
    - path: "packages/admin/src/components/charts/KPICard.tsx"
      provides: "Reusable KPI metric card"
      min_lines: 20
    - path: "packages/admin/src/components/charts/CollectionChart.tsx"
      provides: "Bar chart: billed vs collected by month"
      min_lines: 30
    - path: "packages/admin/src/hooks/useFinancials.ts"
      provides: "TanStack Query hooks for KPI and financial data"
      min_lines: 40
    - path: "packages/admin/src/app/(dashboard)/page.tsx"
      provides: "Financial overview dashboard page"
      min_lines: 50
    - path: "packages/admin/src/lib/formatters.ts"
      provides: "Currency, date, percentage formatters"
      min_lines: 15
  key_links:
    - from: "packages/admin/src/app/(dashboard)/page.tsx"
      to: "packages/admin/src/hooks/useFinancials.ts"
      via: "useKPIMonthly, useTransactionSummary hooks"
      pattern: "useKPIMonthly|useTransactionSummary"
    - from: "packages/admin/src/hooks/useFinancials.ts"
      to: "Supabase auto-API"
      via: "createClient().from('kpi_monthly') and .from('transactions')"
      pattern: "from\\('kpi_monthly'\\)|from\\('transactions'\\)"
    - from: "packages/admin/src/components/charts/CollectionChart.tsx"
      to: "recharts"
      via: "BarChart, ResponsiveContainer imports"
      pattern: "from 'recharts'"
---

<objective>
Fix critical database issues (RLS role mismatch + missing functions), install Phase 11 dependencies, create shared UI primitives and chart components, and build the financial overview dashboard with KPI cards, charts, and reports navigation.

Purpose: This is the foundation plan for Phase 11. Without the RLS fix and missing functions, NO admin dashboard feature will work. The shared components (DataTable, formatters, charts) are reused across all subsequent plans. The dashboard home page becomes the financial overview -- the primary screen admins see after login.

Output: Working financial overview dashboard at `/` with KPI cards + charts, income vs expense reports at `/finances/reports`, reusable UI primitives, and a fixed database that allows community_admin role access.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-admin-dashboard-financial-core/11-RESEARCH.md
@.planning/phases/09-auth-shared-infrastructure/09-03-SUMMARY.md
@.planning/phases/09-auth-shared-infrastructure/09-05-SUMMARY.md
@packages/admin/src/app/(dashboard)/layout.tsx
@packages/admin/src/app/(dashboard)/page.tsx
@packages/admin/src/hooks/useAuth.ts
@packages/admin/src/lib/supabase/client.ts
@packages/admin/src/lib/supabase/server.ts
@packages/admin/src/lib/supabase/admin.ts
@packages/admin/src/providers/QueryProvider.tsx
@packages/admin/src/app/layout.tsx
@packages/admin/package.json
@supabase/migrations/20260129191023_record_payment_charge.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix RLS policies, deploy missing functions, and install dependencies</name>
  <files>packages/admin/package.json, packages/admin/src/app/layout.tsx</files>
  <action>
**Step 1: Fix RLS role mismatch via Supabase MCP migration.**

Apply a migration named `fix_admin_rls_role_mismatch` that updates ALL RLS policies checking for role `'admin'` to also accept `'community_admin'`. The affected policies are:

| Table | Policy Name |
|-------|-------------|
| payment_proofs | admins_update_payment_proofs |
| payment_proofs | admins_view_community_payment_proofs |
| transactions | admins_manage_transactions |
| residents | admins_manage_residents |
| units | admins_manage_units |
| occupancies | admins_manage_occupancies |
| fee_structures | admins_manage_fee_structures |
| budgets | admins_manage_budgets |
| budget_lines | admins_manage_budget_lines |
| communities | admins_update_own_community |

For each policy: DROP the existing policy, then CREATE a new one with the same name and logic but replacing `((auth.jwt() -> 'app_metadata' ->> 'role') = 'admin')` with `((auth.jwt() -> 'app_metadata' ->> 'role') IN ('admin', 'community_admin'))`. This ensures both role names work.

**Important:** Before writing the migration, first query the live database to get the EXACT current policy definitions:
```sql
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual, with_check
FROM pg_policies
WHERE policyname IN ('admins_update_payment_proofs', 'admins_view_community_payment_proofs', 'admins_manage_transactions', 'admins_manage_residents', 'admins_manage_units', 'admins_manage_occupancies', 'admins_manage_fee_structures', 'admins_manage_budgets', 'admins_manage_budget_lines', 'admins_update_own_community');
```
Use the actual USING and WITH CHECK clauses from the live DB, not guesses.

**Step 2: Deploy missing financial functions.**

Apply a migration named `deploy_record_payment_charge` that creates (or replaces) the three missing functions: `generate_transaction_reference`, `record_payment`, `record_charge`. Copy the function definitions EXACTLY from `supabase/migrations/20260129191023_record_payment_charge.sql` -- they are production-ready.

**Step 3: Install Phase 11 npm dependencies.**

```bash
cd packages/admin && pnpm add recharts @tanstack/react-table xlsx sonner date-fns
```

**Step 4: Add Sonner's Toaster to the root layout.**

In `packages/admin/src/app/layout.tsx`, import `Toaster` from `sonner` and add `<Toaster richColors position="top-right" />` inside the body, next to the QueryProvider.
  </action>
  <verify>
1. Run `SELECT proname FROM pg_proc WHERE proname IN ('record_payment', 'record_charge', 'generate_transaction_reference')` via Supabase MCP -- should return 3 rows.
2. Run a test query as community_admin: `SELECT COUNT(*) FROM pg_policies WHERE policyname LIKE 'admins_%' AND qual::text LIKE '%community_admin%'` -- should return >= 10.
3. Run `cd packages/admin && pnpm ls recharts @tanstack/react-table xlsx sonner date-fns` -- all should show installed versions.
4. Grep for `Toaster` in `packages/admin/src/app/layout.tsx`.
  </verify>
  <done>
RLS policies accept community_admin role, record_payment/record_charge/generate_transaction_reference functions exist in live DB, recharts + @tanstack/react-table + xlsx + sonner + date-fns are installed, Toaster component is in root layout.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shared UI primitives, chart components, hooks, and financial dashboard page</name>
  <files>
    packages/admin/src/lib/formatters.ts,
    packages/admin/src/lib/export.ts,
    packages/admin/src/components/ui/Card.tsx,
    packages/admin/src/components/ui/Badge.tsx,
    packages/admin/src/components/ui/Button.tsx,
    packages/admin/src/components/ui/DataTable.tsx,
    packages/admin/src/components/charts/KPICard.tsx,
    packages/admin/src/components/charts/CollectionChart.tsx,
    packages/admin/src/components/charts/DelinquencyChart.tsx,
    packages/admin/src/components/charts/ExpenseChart.tsx,
    packages/admin/src/hooks/useFinancials.ts,
    packages/admin/src/app/(dashboard)/page.tsx,
    packages/admin/src/app/(dashboard)/finances/reports/page.tsx,
    packages/admin/src/app/(dashboard)/layout.tsx
  </files>
  <action>
**A. Create utility files:**

1. `packages/admin/src/lib/formatters.ts` -- Currency (MXN with Intl.NumberFormat es-MX), date (es-MX with day/month/year), percentage formatters. Export: `formatCurrency(amount)`, `formatPercent(value)`, `formatDate(dateStr)`, `formatMonth(year, month)`. See research Pattern 5 for reference.

2. `packages/admin/src/lib/export.ts` -- Excel export using SheetJS. Export: `exportToExcel(data, filename, sheetName)`. Uses `XLSX.utils.json_to_sheet` + `XLSX.writeFile`. See research Pattern 5.

**B. Create UI primitives (all `'use client'`):**

3. `Card.tsx` -- Wrapper div with `rounded-xl border border-gray-200 bg-white shadow-sm`. Props: `className`, `children`, `padding` (default p-6).

4. `Badge.tsx` -- Small status badge. Props: `variant` (success/warning/danger/info/neutral), `children`. Maps variants to Tailwind color classes (green/yellow/red/blue/gray).

5. `Button.tsx` -- Standard button. Props: `variant` (primary/secondary/danger/ghost), `size` (sm/md/lg), `isLoading`, `disabled`, `children`, standard button HTML props. Primary=indigo-600, secondary=white border, danger=red-600.

6. `DataTable.tsx` -- Generic TanStack Table wrapper. Props: `columns`, `data`, `pageCount`, `pagination`, `sorting`, `onPaginationChange`, `onSortingChange`, `isLoading`. Renders `<table>` with Tailwind styling, header sort indicators, pagination controls (Anterior/Siguiente). Uses `useReactTable` with `manualPagination` and `manualSorting`. See research Pattern 4 for full implementation.

**C. Create chart components (all `'use client'`):**

7. `KPICard.tsx` -- Displays title, formatted value, optional change percentage (green if positive, red if negative), optional icon. See research code example.

8. `CollectionChart.tsx` -- Recharts `BarChart` with two bars: "Facturado" (indigo) and "Cobrado" (green). Props: `data: Array<{month, billed, collected}>`. Uses `ResponsiveContainer`, `CartesianGrid`, `XAxis`, `YAxis`, `Tooltip` with MXN currency format, `Legend`.

9. `DelinquencyChart.tsx` -- Recharts `LineChart` with 3 lines for 30/60/90 day delinquency counts over months. Props: `data: Array<{month, d30, d60, d90}>`. Colors: yellow-500, orange-500, red-500.

10. `ExpenseChart.tsx` -- Recharts `PieChart` showing expense breakdown by category. Props: `data: Array<{name, value}>`. Uses `Pie` with label, `Cell` with distinct colors, `Tooltip` with MXN format.

**D. Create financial hooks:**

11. `packages/admin/src/hooks/useFinancials.ts` -- `'use client'` hook file with:
- `useKPIMonthly(year, month)` -- queries `kpi_monthly` table filtered by community_id, year, month. Returns single row with all KPI fields.
- `useKPIMonthlyRange(year, startMonth, endMonth)` -- queries `kpi_monthly` for a range of months. Returns array for chart data.
- `useTransactionSummary(year)` -- queries `transactions` grouped by month and type (charge/payment) for collection chart data. Uses `.select('amount, transaction_type, effective_date')` with year filter.
- `useExpenseBreakdown(year)` -- queries `ledger_entries` joined with `accounts` where account category = 'expense'. Groups by account name, sums amounts. Returns data for pie chart.
- `useDelinquentUnits(minDays)` -- calls `get_delinquent_units` RPC. Returns array of delinquent units.

All hooks use `useAuth()` for `communityId`, `createClient()` for Supabase, TanStack Query `useQuery` with appropriate query keys.

**E. Build dashboard pages:**

12. Replace `packages/admin/src/app/(dashboard)/page.tsx` content entirely. This becomes the financial overview dashboard:
- Keep `export const dynamic = 'force-dynamic'`
- Add `'use client'` directive
- Render page header "Panel Financiero" with current month/year
- Render 4 KPICards in a grid (2x2 on md, 4x1 on lg): Total Cobrado, Total Facturado, Tasa de Cobranza, Unidades Morosas
- Below KPIs: 2-column grid with CollectionChart (left, 12 months) and DelinquencyChart (right, 12 months)
- Below charts: ExpenseChart (full width)
- Use `useKPIMonthly` for KPI card data, `useKPIMonthlyRange` for chart data, `useExpenseBreakdown` for pie
- Handle loading states with skeleton placeholders (animated gray boxes)
- Handle empty/error states gracefully

13. Create `packages/admin/src/app/(dashboard)/finances/reports/page.tsx`:
- `'use client'` with `force-dynamic`
- Page header "Reportes Financieros"
- Subsection "Ingresos vs Egresos" with a monthly comparison table using DataTable
- Columns: Mes, Ingresos, Egresos, Balance, % Margen
- Data from `useTransactionSummary` hook, transformed into monthly rows
- Year selector dropdown at top
- Export button using `exportToExcel`

**F. Update sidebar navigation:**

14. In `packages/admin/src/app/(dashboard)/layout.tsx`, update the `navItems` array to add sub-routes for finances. Add `finances/approvals`, `finances/charges`, `finances/reports` as submenu items under Finanzas (these pages will be created in subsequent plans). Use a simple expand/collapse pattern: when "Finanzas" is active (path starts with /finances), show its children indented below it.
  </action>
  <verify>
1. `cd packages/admin && npx next build` -- should succeed without errors.
2. Grep for `'use client'` in all chart components and DataTable.
3. Grep for `useKPIMonthly` in page.tsx.
4. Grep for `formatCurrency` in formatters.ts.
5. Verify files exist: `ls packages/admin/src/components/charts/ packages/admin/src/components/ui/ packages/admin/src/hooks/useFinancials.ts packages/admin/src/lib/formatters.ts packages/admin/src/lib/export.ts`.
  </verify>
  <done>
Dashboard home page shows financial overview with 4 KPI cards, collection bar chart, delinquency line chart, and expense pie chart. Reports page shows income vs expense table with Excel export. Shared UI primitives (Card, Badge, Button, DataTable) and formatters are available for all subsequent plans.
  </done>
</task>

</tasks>

<verification>
1. Database: `record_payment`, `record_charge`, `generate_transaction_reference` functions exist in live DB.
2. Database: RLS policies on 10 tables accept `'community_admin'` role.
3. Build: `cd packages/admin && npx next build` succeeds.
4. Components: KPICard, CollectionChart, DelinquencyChart, ExpenseChart, DataTable, Card, Badge, Button all exist with `'use client'` directive.
5. Dashboard page imports and uses `useKPIMonthly` hook.
6. Reports page uses DataTable and exportToExcel.
7. Formatters: `formatCurrency`, `formatPercent`, `formatDate` are exported.
</verification>

<success_criteria>
- Admin dashboard home page (`/`) renders financial overview with KPI cards and charts instead of placeholder text
- Reports page (`/finances/reports`) shows income vs expense comparison with Excel export
- All shared UI components are reusable by Plans 11-02, 11-03, 11-04
- Database is unblocked for all admin operations (RLS + functions fixed)
- `pnpm build` succeeds for `@upoe/admin`
</success_criteria>

<output>
After completion, create `.planning/phases/11-admin-dashboard-financial-core/11-01-SUMMARY.md`
</output>
