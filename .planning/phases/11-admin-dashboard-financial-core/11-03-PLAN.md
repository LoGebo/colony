---
phase: 11-admin-dashboard-financial-core
plan: 03
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - packages/admin/src/hooks/useResidents.ts
  - packages/admin/src/hooks/useUnits.ts
  - packages/admin/src/hooks/useOccupancies.ts
  - packages/admin/src/components/residents/ResidentForm.tsx
  - packages/admin/src/components/residents/OccupancyManager.tsx
  - packages/admin/src/app/(dashboard)/residents/page.tsx
  - packages/admin/src/app/(dashboard)/residents/[id]/page.tsx
  - packages/admin/src/app/(dashboard)/residents/invite/page.tsx
  - packages/admin/src/app/(dashboard)/residents/invite/actions.ts
  - packages/admin/src/app/(dashboard)/units/page.tsx
  - packages/admin/src/app/(dashboard)/units/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view a paginated list of all residents in the community with search"
    - "Admin can create a new resident with required fields (name, email)"
    - "Admin can edit an existing resident's profile information"
    - "Admin can deactivate a resident (set onboarding_status to inactive)"
    - "Admin can invite a resident via email (creates resident record + sends Supabase invite)"
    - "Admin can view all units with type, area, coefficient, and occupancy status"
    - "Admin can assign residents to units with occupancy type (owner/tenant/authorized)"
    - "Admin can remove a resident-unit occupancy assignment"
  artifacts:
    - path: "packages/admin/src/hooks/useResidents.ts"
      provides: "CRUD hooks for residents"
      min_lines: 60
    - path: "packages/admin/src/app/(dashboard)/residents/page.tsx"
      provides: "Resident list with search, create, deactivate"
      min_lines: 80
    - path: "packages/admin/src/app/(dashboard)/residents/invite/actions.ts"
      provides: "Server Action for resident invite via Supabase Admin API"
      min_lines: 30
    - path: "packages/admin/src/app/(dashboard)/units/[id]/page.tsx"
      provides: "Unit detail with occupancy management"
      min_lines: 60
    - path: "packages/admin/src/components/residents/OccupancyManager.tsx"
      provides: "Component to assign/remove residents from units"
      min_lines: 40
  key_links:
    - from: "packages/admin/src/app/(dashboard)/residents/invite/actions.ts"
      to: "packages/admin/src/lib/supabase/admin.ts"
      via: "createAdminClient for service_role operations"
      pattern: "createAdminClient"
    - from: "packages/admin/src/app/(dashboard)/residents/invite/actions.ts"
      to: "Supabase Auth Admin API"
      via: "admin.auth.admin.inviteUserByEmail"
      pattern: "inviteUserByEmail"
    - from: "packages/admin/src/hooks/useResidents.ts"
      to: "Supabase auto-API"
      via: "createClient().from('residents')"
      pattern: "from\\('residents'\\)"
    - from: "packages/admin/src/hooks/useOccupancies.ts"
      to: "Supabase auto-API"
      via: "createClient().from('occupancies')"
      pattern: "from\\('occupancies'\\)"
---

<objective>
Build resident and unit management screens: resident list with CRUD operations, email invite workflow, unit catalog, and occupancy assignments.

Purpose: Administrators need to manage who lives in their community and which unit they belong to. The invite workflow is how new residents get onboarded -- admin creates a record and sends an invitation email, and the `handle_new_user` trigger links them when they sign up. Unit-occupancy management controls fee billing (charges are per-unit).

Output: Resident list at `/residents`, resident detail/edit at `/residents/[id]`, resident invite at `/residents/invite`, unit list at `/units`, unit detail with occupancy management at `/units/[id]`.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-admin-dashboard-financial-core/11-RESEARCH.md
@.planning/phases/11-admin-dashboard-financial-core/11-01-SUMMARY.md
@packages/admin/src/hooks/useAuth.ts
@packages/admin/src/lib/supabase/client.ts
@packages/admin/src/lib/supabase/server.ts
@packages/admin/src/lib/supabase/admin.ts
@packages/admin/src/lib/formatters.ts
@packages/admin/src/components/ui/DataTable.tsx
@packages/admin/src/components/ui/Card.tsx
@packages/admin/src/components/ui/Button.tsx
@packages/admin/src/components/ui/Badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Resident hooks, list, detail/edit, and invite workflow</name>
  <files>
    packages/admin/src/hooks/useResidents.ts,
    packages/admin/src/components/residents/ResidentForm.tsx,
    packages/admin/src/app/(dashboard)/residents/page.tsx,
    packages/admin/src/app/(dashboard)/residents/[id]/page.tsx,
    packages/admin/src/app/(dashboard)/residents/invite/page.tsx,
    packages/admin/src/app/(dashboard)/residents/invite/actions.ts
  </files>
  <action>
**A. Create `packages/admin/src/hooks/useResidents.ts`:**

`'use client'` hook file with:

1. `useResidents(search?, page?, pageSize?)` -- queries `residents` where `community_id` matches, `deleted_at IS NULL`. Select: `id, first_name, paternal_surname, maternal_surname, email, phone, onboarding_status, user_id, created_at`. If `search` provided, filter with `.or('first_name.ilike.%${search}%,paternal_surname.ilike.%${search}%,email.ilike.%${search}%')`. Paginate with `.range()`. Order by `paternal_surname` asc. Returns `{ data, count }` (use `{ count: 'exact' }` option on select for total).

2. `useResident(id)` -- queries single resident by `id`. Select: `*, occupancies(*, units(*))`. Returns resident with their unit assignments.

3. `useCreateResident()` -- `useMutation` inserting into `residents`. Required fields: `community_id`, `first_name`, `paternal_surname`, `email`. Optional: `maternal_surname`, `phone`. Sets `onboarding_status = 'invited'`, `invited_at = now`. On success: toast success, invalidate `['residents']`.

4. `useUpdateResident()` -- `useMutation` updating resident by id. Updateable fields: `first_name`, `paternal_surname`, `maternal_surname`, `email`, `phone`. On success: toast success, invalidate `['residents']` and `['resident', id]`.

5. `useDeactivateResident()` -- `useMutation` updating resident: `onboarding_status = 'inactive'`. On success: toast, invalidate queries.

**B. Create `packages/admin/src/components/residents/ResidentForm.tsx`:**

`'use client'` form component. Props: `resident?` (for edit mode, omit for create), `onSubmit(data)`, `onCancel`, `isLoading`.

Fields:
- Nombre (first_name) -- required text input
- Apellido Paterno (paternal_surname) -- required text input
- Apellido Materno (maternal_surname) -- optional text input
- Email -- required email input
- Telefono (phone) -- optional tel input

Uses simple `useState` for form state (no react-hook-form). Inline validation: required fields show "Campo requerido" on blur if empty. Email validates format.

If `resident` prop provided, pre-fills form (edit mode, title "Editar Residente"). Otherwise blank (create mode, title "Nuevo Residente").

**C. Create `/residents/page.tsx` -- Resident List:**

`'use client'` + `force-dynamic`. Page header "Residentes" with count badge.

Features:
- Search bar at top for name/email filtering (debounced 300ms)
- "Nuevo Residente" button (opens inline form or navigates to create) -- use a slide-out panel/modal with `ResidentForm` for create
- "Invitar Residente" link to `/residents/invite`
- DataTable with columns: Nombre Completo (first + paternal + maternal), Email, Telefono, Estado (Badge: active=green, invited=blue, inactive=gray), Fecha Registro, Acciones (Edit link, Deactivate button)
- Pagination via `useResidents` with page/pageSize state
- Click on resident name links to `/residents/[id]`
- Deactivate shows confirmation prompt before calling `useDeactivateResident`

**D. Create `/residents/[id]/page.tsx` -- Resident Detail/Edit:**

`'use client'` + `force-dynamic`. Uses `useResident(id)` where `id` comes from route params.

Features:
- Breadcrumb: Residentes > [Resident Name]
- Profile card showing resident info
- Edit mode toggle: clicking "Editar" button shows `ResidentForm` with resident data. Save calls `useUpdateResident`.
- Occupancy section below: lists current unit assignments (unit_number, occupancy_type, start_date). This is read-only here -- editing occupancies is done from the unit detail page.
- Status badge showing onboarding_status
- "Desactivar" button if resident is active

**E. Create `/residents/invite/page.tsx` -- Invite Resident:**

`'use client'` + `force-dynamic`. Page header "Invitar Residente".

Form fields:
- Email (required)
- Nombre (first_name, required)
- Apellido Paterno (paternal_surname, required)
- Unidad (unit_id) -- dropdown populated from `useUnits` hook (to be created in Task 2, import dynamically or create a minimal version here)
- Tipo de Ocupacion (occupancy_type) -- dropdown: Propietario (owner), Inquilino (tenant), Autorizado (authorized)

Submit calls the Server Action `inviteResident`. Show loading state, success message with "Invitacion enviada a [email]", error handling.

**F. Create `/residents/invite/actions.ts` -- Server Action:**

`'use server'` file. Exports `inviteResident(formData)` function.

Implementation (see research code example):
1. Get admin's community_id from JWT via `createClient()` (server) + `getUser()`
2. Create admin client via `createAdminClient()`
3. Insert resident record with `onboarding_status = 'invited'`, `invited_at = now`
4. Insert occupancy linking resident to unit
5. Call `admin.auth.admin.inviteUserByEmail(email, { data: { community_id } })`
6. Return `{ success: true, residentId }` or throw error

**Important:** `residents.user_id` is NULL for invited residents. The `handle_new_user` trigger will set it when they sign up.
  </action>
  <verify>
1. `cd packages/admin && npx next build` -- succeeds.
2. Grep for `useResidents` in residents/page.tsx.
3. Grep for `useCreateResident` and `useUpdateResident` in useResidents.ts.
4. Grep for `inviteUserByEmail` in actions.ts.
5. Grep for `createAdminClient` in actions.ts.
6. Files exist: `ls packages/admin/src/app/(dashboard)/residents/page.tsx packages/admin/src/app/(dashboard)/residents/\\[id\\]/page.tsx packages/admin/src/app/(dashboard)/residents/invite/page.tsx packages/admin/src/app/(dashboard)/residents/invite/actions.ts`.
  </verify>
  <done>
Admin can view paginated/searchable resident list, create residents, edit profiles, deactivate residents, and invite new residents via email (creates record + sends Supabase invite). Resident detail page shows profile and occupancy info.
  </done>
</task>

<task type="auto">
  <name>Task 2: Unit management and occupancy assignments</name>
  <files>
    packages/admin/src/hooks/useUnits.ts,
    packages/admin/src/hooks/useOccupancies.ts,
    packages/admin/src/components/residents/OccupancyManager.tsx,
    packages/admin/src/app/(dashboard)/units/page.tsx,
    packages/admin/src/app/(dashboard)/units/[id]/page.tsx
  </files>
  <action>
**A. Create `packages/admin/src/hooks/useUnits.ts`:**

`'use client'` hook file:

1. `useUnits(search?, page?, pageSize?)` -- queries `units` where `community_id` matches, `deleted_at IS NULL`. Select: `id, unit_number, unit_type, area_m2, floor_number, building, coefficient, parking_spaces, status, created_at`. If search: `.ilike('unit_number', '%${search}%')`. Paginate with `.range()`. Order by `unit_number` asc. Uses `count: 'exact'`.

2. `useUnit(id)` -- queries single unit by `id`. Select: `*, occupancies(*, residents(id, first_name, paternal_surname, maternal_surname, email, onboarding_status))`. Returns unit with current occupants.

3. `useUpdateUnit()` -- `useMutation` updating unit. Updateable: `unit_type`, `area_m2`, `floor_number`, `building`, `coefficient`, `parking_spaces`. On success: toast, invalidate.

**B. Create `packages/admin/src/hooks/useOccupancies.ts`:**

`'use client'` hook file:

1. `useCreateOccupancy()` -- `useMutation` inserting into `occupancies`. Fields: `community_id`, `unit_id`, `resident_id`, `occupancy_type`, `start_date` (defaults to today). On success: toast success "Residente asignado", invalidate `['unit', unitId]` and `['resident', residentId]`.

2. `useRemoveOccupancy()` -- `useMutation` that soft-deletes occupancy by setting `end_date = today` and `status = 'inactive'` (or deletes if the table supports it -- check if `deleted_at` column exists, if so use soft delete). On success: toast success "Asignacion removida", invalidate queries.

**C. Create `packages/admin/src/components/residents/OccupancyManager.tsx`:**

`'use client'` component. Props: `unitId`, `communityId`, `occupancies` (current list from useUnit), `onOccupancyChanged`.

Features:
- Lists current occupants: resident name, type (Badge), start_date, "Remover" button
- "Agregar Residente" button opens inline form:
  - Resident selector: text input with search-as-you-type querying `residents` table (use a simple dropdown that filters on keystrokes, NOT a full autocomplete library). Show `first_name paternal_surname - email` in options.
  - Occupancy type dropdown: owner/tenant/authorized
  - Start date input (defaults to today)
  - "Asignar" button calls `useCreateOccupancy`
- Removing calls `useRemoveOccupancy` with confirmation prompt

**D. Create `/units/page.tsx` -- Unit List:**

`'use client'` + `force-dynamic`. Page header "Unidades" with total count.

Features:
- Search bar for unit_number
- DataTable with columns: Numero, Tipo (Badge with translated type: casa, departamento, etc.), Edificio, Area m2, Coeficiente, Estacionamientos, Estado, Acciones (view detail link)
- Unit type translations: casa=Casa, departamento=Depto, local=Local, bodega=Bodega, oficina=Oficina, terreno=Terreno, estacionamiento=Est
- Click on unit number links to `/units/[id]`
- Pagination

Note: Unit creation is not in scope (units are pre-configured in the community setup). Only viewing and editing existing units.

**E. Create `/units/[id]/page.tsx` -- Unit Detail:**

`'use client'` + `force-dynamic`. Uses `useUnit(id)`.

Features:
- Breadcrumb: Unidades > [Unit Number]
- Unit info card: number, type, building, floor, area, coefficient, parking spaces
- Inline edit for coefficient, area, parking (editable fields, save with `useUpdateUnit`)
- OccupancyManager component below showing current residents and allowing add/remove
- Balance summary (uses `useUnitBalances` or a simple query to `unit_balances` view for this specific unit): current balance, last payment date, days overdue. Display in a small card.
  </action>
  <verify>
1. `cd packages/admin && npx next build` -- succeeds.
2. Files exist: `ls packages/admin/src/app/(dashboard)/units/page.tsx packages/admin/src/app/(dashboard)/units/\\[id\\]/page.tsx`.
3. Grep for `OccupancyManager` in units/[id]/page.tsx.
4. Grep for `useCreateOccupancy` and `useRemoveOccupancy` in useOccupancies.ts.
5. Grep for `useUnits` in units/page.tsx.
  </verify>
  <done>
Admin can view all units with type/area/coefficient, edit unit properties, view current occupants, assign new residents to units with occupancy type, and remove occupancy assignments. Unit detail shows financial balance summary.
  </done>
</task>

</tasks>

<verification>
1. Build: `cd packages/admin && npx next build` succeeds.
2. Resident list page: search, pagination, CRUD operations, deactivation.
3. Resident invite: Server Action calls `inviteUserByEmail`, creates resident + occupancy records.
4. Unit list page: search, pagination, type badges.
5. Unit detail: occupancy manager with add/remove functionality.
6. All pages have `'use client'` and `force-dynamic`.
7. All mutations use Sonner toasts for feedback.
</verification>

<success_criteria>
- Resident list at `/residents` shows paginated, searchable resident directory
- Admin can create, edit, and deactivate residents
- Invite workflow creates resident record + sends email via Supabase Auth
- Unit list at `/units` shows all community units
- Unit detail at `/units/[id]` shows occupancy manager and financial balance
- Occupancy assignments can be created and removed
- `pnpm build` succeeds for `@upoe/admin`
</success_criteria>

<output>
After completion, create `.planning/phases/11-admin-dashboard-financial-core/11-03-SUMMARY.md`
</output>
