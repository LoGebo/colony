---
phase: 09-auth-shared-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mobile/package.json
  - packages/mobile/app.json
  - packages/mobile/index.ts
  - packages/mobile/App.tsx
  - packages/mobile/babel.config.js
  - packages/mobile/metro.config.js
  - packages/mobile/tailwind.config.js
  - packages/mobile/global.css
  - packages/mobile/nativewind-env.d.ts
  - packages/mobile/tsconfig.json
  - packages/mobile/src/lib/supabase.ts
  - packages/mobile/src/providers/SessionProvider.tsx
  - packages/mobile/src/providers/QueryProvider.tsx
  - packages/mobile/app/_layout.tsx
  - packages/mobile/app/index.tsx
  - packages/mobile/app/(auth)/_layout.tsx
  - packages/mobile/app/(auth)/sign-in.tsx
  - packages/mobile/app/(auth)/sign-up.tsx
  - packages/mobile/app/(auth)/forgot-password.tsx
  - packages/mobile/app/(auth)/onboarding.tsx
  - packages/mobile/app/(resident)/_layout.tsx
  - packages/mobile/app/(resident)/index.tsx
  - packages/mobile/app/(guard)/_layout.tsx
  - packages/mobile/app/(guard)/index.tsx
  - packages/mobile/app/(admin)/_layout.tsx
  - packages/mobile/app/(admin)/index.tsx
autonomous: true

must_haves:
  truths:
    - "Mobile app launches with Expo Router and shows auth screens when no session exists"
    - "NativeWind className prop applies Tailwind styles to React Native components"
    - "Session is persisted to expo-sqlite and survives app restart"
    - "Authenticated user with role 'resident' sees resident tab layout"
    - "Authenticated user with role 'guard' sees guard tab layout"
    - "Authenticated user with role 'pending_setup' is routed to onboarding screen"
  artifacts:
    - path: "packages/mobile/app/_layout.tsx"
      provides: "Root layout with Stack.Protected guards for role-based routing"
      contains: "Stack.Protected"
    - path: "packages/mobile/src/lib/supabase.ts"
      provides: "Mobile Supabase client with expo-sqlite localStorage storage"
      contains: "expo-sqlite/localStorage/install"
    - path: "packages/mobile/src/providers/SessionProvider.tsx"
      provides: "React context for auth session state with onAuthStateChange listener"
      exports: ["SessionProvider", "useSession"]
    - path: "packages/mobile/app/(resident)/_layout.tsx"
      provides: "Resident tab navigator with home, visitors, payments, community, more tabs"
      contains: "Tabs"
    - path: "packages/mobile/app/(guard)/_layout.tsx"
      provides: "Guard tab navigator with gate, patrol, incidents tabs"
      contains: "Tabs"
  key_links:
    - from: "packages/mobile/app/_layout.tsx"
      to: "packages/mobile/src/providers/SessionProvider.tsx"
      via: "SessionProvider wrapper and useSession hook"
      pattern: "useSession"
    - from: "packages/mobile/src/lib/supabase.ts"
      to: "expo-sqlite"
      via: "localStorage polyfill import before createClient"
      pattern: "import 'expo-sqlite/localStorage/install'"
    - from: "packages/mobile/app/_layout.tsx"
      to: "packages/mobile/app/(resident)/_layout.tsx"
      via: "Stack.Protected guard on role === resident"
      pattern: "guard=.*RESIDENT"
---

<objective>
Convert the mobile app from bare App.tsx to Expo Router with file-based routing, configure NativeWind v4.2 with Tailwind CSS v3, set up expo-sqlite as the Supabase auth storage adapter, create SessionProvider for auth state management, and define role-based route groups with Stack.Protected guards.

Purpose: This is the mobile app's structural foundation. Every mobile screen in phases 10-16 will be a file inside these route groups. Auth storage and session management are critical for session persistence (AUTH-05) and role-based navigation (AUTH-07, INFRA-02).
Output: Working Expo Router app with (auth), (resident), (guard), (admin) route groups, NativeWind styling, and session-aware role routing.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-auth-shared-infrastructure/09-RESEARCH.md

# Existing mobile package
@packages/mobile/package.json
@packages/mobile/app.json
@packages/mobile/App.tsx
@packages/mobile/index.ts
@packages/mobile/tsconfig.json

# Shared constants already available
@packages/shared/src/constants/roles.ts
@packages/shared/src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, convert to Expo Router, and configure NativeWind</name>
  <files>
    packages/mobile/package.json
    packages/mobile/app.json
    packages/mobile/index.ts
    packages/mobile/App.tsx
    packages/mobile/babel.config.js
    packages/mobile/metro.config.js
    packages/mobile/tailwind.config.js
    packages/mobile/global.css
    packages/mobile/nativewind-env.d.ts
    packages/mobile/tsconfig.json
  </files>
  <action>
    1. Install Expo Router and NativeWind dependencies in packages/mobile:
       ```bash
       cd packages/mobile
       npx expo install expo-router expo-linking expo-constants expo-sqlite expo-splash-screen react-native-safe-area-context react-native-screens nativewind react-native-reanimated @supabase/supabase-js @tanstack/react-query
       pnpm add -D tailwindcss@3.4.17
       ```

    2. Update `packages/mobile/app.json`:
       - Add `"scheme": "upoe"` under expo
       - Add `"web": { "bundler": "metro" }` under expo
       - Update `"name"` to `"UPOE"` and `"slug"` to `"upoe"`

    3. Update `packages/mobile/package.json`:
       - Change `"main"` from `"index.ts"` to `"expo-router/entry"`

    4. DELETE `packages/mobile/App.tsx` (replaced by app/_layout.tsx)
    5. DELETE `packages/mobile/index.ts` (replaced by expo-router/entry)

    6. Create `packages/mobile/babel.config.js`:
       ```javascript
       module.exports = function (api) {
         api.cache(true);
         return {
           presets: [
             ['babel-preset-expo', { jsxImportSource: 'nativewind' }],
             'nativewind/babel',
           ],
           plugins: ['react-native-reanimated/plugin'],
         };
       };
       ```
       CRITICAL: Do NOT add react-native-worklets/plugin. Reanimated v4 includes worklets internally.

    7. Create `packages/mobile/metro.config.js`:
       ```javascript
       const { getDefaultConfig } = require('expo/metro-config');
       const { withNativeWind } = require('nativewind/metro');
       const path = require('path');

       const projectRoot = __dirname;
       const monorepoRoot = path.resolve(projectRoot, '../..');

       const config = getDefaultConfig(projectRoot);

       // Monorepo: watch all packages
       config.watchFolders = [monorepoRoot];
       // Monorepo: resolve node_modules from both project and root
       config.resolver.nodeModulesPaths = [
         path.resolve(projectRoot, 'node_modules'),
         path.resolve(monorepoRoot, 'node_modules'),
       ];

       module.exports = withNativeWind(config, { input: './global.css' });
       ```

    8. Create `packages/mobile/tailwind.config.js`:
       ```javascript
       /** @type {import('tailwindcss').Config} */
       module.exports = {
         content: [
           './app/**/*.{js,jsx,ts,tsx}',
           './src/**/*.{js,jsx,ts,tsx}',
         ],
         presets: [require('nativewind/preset')],
         theme: {
           extend: {},
         },
         plugins: [],
       };
       ```

    9. Create `packages/mobile/global.css`:
       ```css
       @tailwind base;
       @tailwind components;
       @tailwind utilities;
       ```

    10. Create `packages/mobile/nativewind-env.d.ts`:
        ```typescript
        /// <reference types="nativewind/types" />
        ```

    11. Update `packages/mobile/tsconfig.json` to add path alias:
        ```json
        {
          "extends": "expo/tsconfig.base",
          "compilerOptions": {
            "strict": true,
            "paths": {
              "@/*": ["./src/*"]
            }
          },
          "include": ["**/*.ts", "**/*.tsx", ".expo/types/**/*.ts", "nativewind-env.d.ts"]
        }
        ```
  </action>
  <verify>
    Verify packages installed: check package.json has expo-router, nativewind, expo-sqlite, @supabase/supabase-js, tailwindcss@3.x.
    Verify App.tsx and index.ts are deleted.
    Verify app.json has scheme: "upoe" and main is "expo-router/entry".
  </verify>
  <done>
    Mobile app converted from App.tsx entry to Expo Router entry. NativeWind v4.2 configured with Tailwind CSS v3.4.17. All config files (babel, metro, tailwind) created correctly. Old App.tsx and index.ts removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Supabase client, SessionProvider, and role-based route structure</name>
  <files>
    packages/mobile/src/lib/supabase.ts
    packages/mobile/src/providers/SessionProvider.tsx
    packages/mobile/src/providers/QueryProvider.tsx
    packages/mobile/app/_layout.tsx
    packages/mobile/app/index.tsx
    packages/mobile/app/(auth)/_layout.tsx
    packages/mobile/app/(auth)/sign-in.tsx
    packages/mobile/app/(auth)/sign-up.tsx
    packages/mobile/app/(auth)/forgot-password.tsx
    packages/mobile/app/(auth)/onboarding.tsx
    packages/mobile/app/(resident)/_layout.tsx
    packages/mobile/app/(resident)/index.tsx
    packages/mobile/app/(guard)/_layout.tsx
    packages/mobile/app/(guard)/index.tsx
    packages/mobile/app/(admin)/_layout.tsx
    packages/mobile/app/(admin)/index.tsx
  </files>
  <action>
    1. Create `packages/mobile/src/lib/supabase.ts`:
       - FIRST LINE must be: `import 'expo-sqlite/localStorage/install';` (CRITICAL: before any other import)
       - Import createClient from @supabase/supabase-js
       - Import AppState from react-native
       - Import Database type from @upoe/shared
       - Use `process.env.EXPO_PUBLIC_SUPABASE_URL` and `process.env.EXPO_PUBLIC_SUPABASE_PUBLISHABLE_KEY`
       - Create client with `auth: { storage: localStorage, autoRefreshToken: true, persistSession: true, detectSessionInUrl: false }`
       - Add AppState listener for auto-refresh management (startAutoRefresh on 'active', stopAutoRefresh otherwise)
       - Export `supabase` instance

    2. Create `packages/mobile/src/providers/SessionProvider.tsx`:
       - Create React context with `{ session: Session | null, isLoading: boolean }`
       - `useSession()` hook that reads context
       - `SessionProvider` component that:
         - Calls `supabase.auth.getSession()` on mount to restore session
         - Subscribes to `supabase.auth.onAuthStateChange` for reactive updates
         - Cleans up subscription on unmount
         - Sets isLoading=false after initial getSession resolves

    3. Create `packages/mobile/src/providers/QueryProvider.tsx`:
       - Create QueryClient with defaults: staleTime 60s, gcTime 300s, retry 2, refetchOnWindowFocus false
       - Wrap children in QueryClientProvider
       - Use useState for stable QueryClient instance

    4. Create `packages/mobile/app/_layout.tsx` (ROOT layout):
       - Import '../global.css' (FIRST import for NativeWind)
       - Import Stack from expo-router
       - Import SplashScreen from expo-splash-screen (call preventAutoHideAsync at module level)
       - Wrap entire app in: SessionProvider > QueryProvider > RootNavigator
       - RootNavigator function:
         - Get { session, isLoading } from useSession()
         - Extract role from session?.user?.app_metadata?.role
         - If isLoading, return null (splash screen stays visible)
         - Call SplashScreen.hideAsync() once loaded
         - Return Stack with headerShown: false and Stack.Protected guards:
           - guard={!session} -> (auth) group
           - guard={role === SYSTEM_ROLES.RESIDENT} -> (resident) group
           - guard={role === SYSTEM_ROLES.GUARD} -> (guard) group
           - guard={role === SYSTEM_ROLES.COMMUNITY_ADMIN || role === SYSTEM_ROLES.MANAGER} -> (admin) group
           - guard={role === 'pending_setup'} -> (auth) group (for onboarding)
       - Import SYSTEM_ROLES from @upoe/shared

    5. Create `packages/mobile/app/index.tsx`:
       - Simple redirect component: import { Redirect } from 'expo-router' and useSession
       - If session exists, redirect based on role to the appropriate group
       - If no session, redirect to /(auth)/sign-in
       - This handles the initial deep link entry point

    6. Create `packages/mobile/app/(auth)/_layout.tsx`:
       - Stack navigator with headerShown: false
       - Screens: sign-in, sign-up, forgot-password, onboarding

    7. Create PLACEHOLDER screens (content will be added in Plan 09-04):
       - `app/(auth)/sign-in.tsx`: View with Text "Iniciar Sesion" placeholder + className for NativeWind test
       - `app/(auth)/sign-up.tsx`: View with Text "Crear Cuenta" placeholder
       - `app/(auth)/forgot-password.tsx`: View with Text "Recuperar Contrasena" placeholder
       - `app/(auth)/onboarding.tsx`: View with Text "Configuracion Inicial" placeholder

    8. Create `packages/mobile/app/(resident)/_layout.tsx`:
       - Tabs navigator with 5 tabs: Inicio (home icon), Visitantes (people icon), Pagos (card icon), Comunidad (chat icon), Mas (menu icon)
       - Use Tab.Screen with tabBarLabel in Spanish
       - headerShown: false

    9. Create `packages/mobile/app/(resident)/index.tsx`: Placeholder "Dashboard Residente" view

    10. Create `packages/mobile/app/(guard)/_layout.tsx`:
        - Tabs navigator with 4 tabs: Caseta (shield icon), Visitantes (people icon), Patrulla (map icon), Incidentes (alert icon)
        - headerShown: false

    11. Create `packages/mobile/app/(guard)/index.tsx`: Placeholder "Dashboard Guardia" view

    12. Create `packages/mobile/app/(admin)/_layout.tsx`:
        - Tabs navigator with 4 tabs: Resumen (chart icon), Usuarios (people icon), Reportes (file icon), Config (settings icon)
        - headerShown: false

    13. Create `packages/mobile/app/(admin)/index.tsx`: Placeholder "Dashboard Admin" view

    14. Create .env.example at packages/mobile/.env.example:
        ```
        EXPO_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
        EXPO_PUBLIC_SUPABASE_PUBLISHABLE_KEY=your-publishable-key
        ```

    CRITICAL NOTES:
    - expo-sqlite import MUST come before createClient (Pitfall 3 from research)
    - detectSessionInUrl MUST be false for React Native (not a browser)
    - Do NOT use expo-secure-store or MMKV -- expo-sqlite/localStorage/install is the official recommendation
    - Do NOT add react-native-worklets/plugin to babel config (Pitfall 1)
    - Tab icons: use simple emoji or text labels for now; icons will be added with a UI library later
  </action>
  <verify>
    Run `cd packages/mobile && npx expo export --platform web --output-dir /tmp/test-export 2>&1 | head -20` to check for compilation errors.
    If that fails, at minimum check: `cd packages/mobile && npx tsc --noEmit` for type errors.
    Verify file structure: `ls -R packages/mobile/app/` shows all route groups and layouts.
  </verify>
  <done>
    Mobile app has: Supabase client with expo-sqlite storage, SessionProvider with auth state change listener, QueryProvider, root layout with Stack.Protected role guards, (auth)/(resident)/(guard)/(admin) route groups with tab layouts and placeholder screens. NativeWind className prop works on React Native Views.
  </done>
</task>

</tasks>

<verification>
1. `ls packages/mobile/app/` shows _layout.tsx, index.tsx, (auth)/, (resident)/, (guard)/, (admin)/
2. `grep -r "expo-sqlite/localStorage/install" packages/mobile/src/` returns supabase.ts
3. `grep -r "Stack.Protected" packages/mobile/app/_layout.tsx` returns role guard lines
4. `grep "tailwindcss" packages/mobile/package.json` shows version 3.4.x (NOT 4.x)
5. `grep "nativewind" packages/mobile/package.json` shows version 4.2.x+
6. App.tsx and index.ts no longer exist in packages/mobile/
7. package.json main is "expo-router/entry"
</verification>

<success_criteria>
- Mobile app entry point is Expo Router (not App.tsx)
- NativeWind v4.2 + Tailwind CSS v3.4 configured with babel/metro/tailwind configs
- Supabase client uses expo-sqlite localStorage with session persistence
- SessionProvider manages auth state with onAuthStateChange subscription
- Root layout uses Stack.Protected for role-based routing (resident, guard, admin, pending_setup, unauthenticated)
- All 4 route groups have tab layouts with placeholder screens
</success_criteria>

<output>
After completion, create `.planning/phases/09-auth-shared-infrastructure/09-02-SUMMARY.md`
</output>
