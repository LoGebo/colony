---
phase: 09-auth-shared-infrastructure
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/admin/package.json
  - packages/admin/src/lib/supabase/client.ts
  - packages/admin/src/lib/supabase/server.ts
  - packages/admin/src/lib/supabase/proxy.ts
  - packages/admin/src/lib/supabase/admin.ts
  - packages/admin/src/middleware.ts
  - packages/admin/src/app/auth/callback/route.ts
  - packages/admin/src/app/layout.tsx
  - packages/admin/src/app/(auth)/layout.tsx
  - packages/admin/src/app/(auth)/sign-in/page.tsx
  - packages/admin/src/app/(auth)/sign-up/page.tsx
  - packages/admin/src/app/(auth)/forgot-password/page.tsx
  - packages/admin/src/app/(auth)/onboarding/page.tsx
  - packages/admin/src/app/(dashboard)/layout.tsx
  - packages/admin/src/app/(dashboard)/page.tsx
  - packages/admin/next.config.ts
autonomous: true

must_haves:
  truths:
    - "Unauthenticated user visiting / is redirected to /sign-in by middleware"
    - "Authenticated user visiting /sign-in is redirected to / by middleware"
    - "Auth callback route exchanges code for session via @supabase/ssr"
    - "Dashboard layout shows sidebar navigation with admin menu items"
    - "Middleware validates JWT using getClaims() (NOT getSession())"
  artifacts:
    - path: "packages/admin/src/lib/supabase/client.ts"
      provides: "Browser Supabase client using createBrowserClient from @supabase/ssr"
      exports: ["createClient"]
    - path: "packages/admin/src/lib/supabase/server.ts"
      provides: "Server Supabase client with cookie-based auth"
      exports: ["createClient"]
    - path: "packages/admin/src/lib/supabase/proxy.ts"
      provides: "Middleware session update function using getClaims()"
      exports: ["updateSession"]
    - path: "packages/admin/src/middleware.ts"
      provides: "Next.js middleware that refreshes auth and redirects unauthenticated"
      exports: ["middleware", "config"]
    - path: "packages/admin/src/app/(dashboard)/layout.tsx"
      provides: "Admin sidebar layout wrapping authenticated pages"
      contains: "sidebar"
  key_links:
    - from: "packages/admin/src/middleware.ts"
      to: "packages/admin/src/lib/supabase/proxy.ts"
      via: "updateSession import"
      pattern: "import.*updateSession.*from.*proxy"
    - from: "packages/admin/src/lib/supabase/server.ts"
      to: "next/headers cookies"
      via: "cookie-based server client"
      pattern: "cookies.*from.*next/headers"
    - from: "packages/admin/src/app/auth/callback/route.ts"
      to: "packages/admin/src/lib/supabase/server.ts"
      via: "exchangeCodeForSession"
      pattern: "exchangeCodeForSession"
---

<objective>
Set up the Next.js 16 admin dashboard with @supabase/ssr cookie-based auth, middleware for JWT validation and session refresh, auth callback route, and a sidebar layout for the dashboard. Create auth and dashboard route groups.

Purpose: This is the admin dashboard's structural foundation. Middleware ensures only authenticated users access the dashboard (AUTH-04, AUTH-05, AUTH-06). The sidebar layout provides navigation for all admin features in phases 11-15 (INFRA-03). The @supabase/ssr setup handles cookie-based auth correctly for SSR.
Output: Working Next.js app with (auth) and (dashboard) route groups, @supabase/ssr clients for browser/server/middleware, and auth-aware middleware redirects.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-auth-shared-infrastructure/09-RESEARCH.md

# Existing admin package
@packages/admin/package.json
@packages/admin/src/app/layout.tsx
@packages/admin/src/app/page.tsx
@packages/admin/next.config.ts
@packages/admin/tsconfig.json

# Shared constants already available
@packages/shared/src/constants/roles.ts
@packages/shared/src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @supabase/ssr and create Supabase client files + middleware</name>
  <files>
    packages/admin/package.json
    packages/admin/src/lib/supabase/client.ts
    packages/admin/src/lib/supabase/server.ts
    packages/admin/src/lib/supabase/proxy.ts
    packages/admin/src/lib/supabase/admin.ts
    packages/admin/src/middleware.ts
    packages/admin/src/app/auth/callback/route.ts
    packages/admin/next.config.ts
  </files>
  <action>
    1. Install dependencies in packages/admin:
       ```bash
       cd packages/admin && pnpm add @supabase/supabase-js @supabase/ssr
       ```

    2. Create `packages/admin/src/lib/supabase/client.ts` (Browser Client):
       - Import createBrowserClient from @supabase/ssr
       - Import Database type from @upoe/shared
       - Export function `createClient()` that returns `createBrowserClient<Database>(NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY)`

    3. Create `packages/admin/src/lib/supabase/server.ts` (Server Client):
       - Import createServerClient from @supabase/ssr
       - Import cookies from next/headers
       - Import Database type from @upoe/shared
       - Export async function `createClient()` that:
         - Awaits cookies()
         - Returns createServerClient<Database> with cookie getAll/setAll handlers
         - setAll wrapped in try/catch (Server Components are read-only)

    4. Create `packages/admin/src/lib/supabase/proxy.ts` (Middleware session handler):
       - Import createServerClient from @supabase/ssr
       - Import NextResponse, NextRequest from next/server
       - Export async function `updateSession(request: NextRequest)`:
         - Create supabase client with request.cookies.getAll/setAll
         - Call `supabase.auth.getClaims()` (NOT getSession, NOT getUser)
         - Define auth routes: /sign-in, /sign-up, /forgot-password, /auth/callback, /onboarding
         - If no claims AND not auth route -> redirect to /sign-in
         - If claims AND is auth route (except /onboarding) -> redirect to /
         - If claims AND role is 'pending_setup' AND not /onboarding -> redirect to /onboarding
         - If claims AND role is NOT 'pending_setup' AND is /onboarding -> redirect to /
         - Return supabaseResponse

       CRITICAL: Use getClaims() not getSession(). getClaims validates JWT via JWKS. getSession reads cookies without validation and is spoofable on server.

       FALLBACK: If getClaims() is not available (older @supabase/ssr), use getUser() instead. Add a comment documenting this.

    5. Create `packages/admin/src/lib/supabase/admin.ts` (Service Role Client):
       - Import createClient from @supabase/supabase-js
       - Import Database type from @upoe/shared
       - Export function `createAdminClient()` that returns createClient<Database> with:
         - `process.env.NEXT_PUBLIC_SUPABASE_URL`
         - `process.env.SUPABASE_SERVICE_ROLE_KEY` (NOT NEXT_PUBLIC_ prefixed)
         - auth: { autoRefreshToken: false, persistSession: false }
       - Add JSDoc comment: "Server-side only. NEVER import in 'use client' files."

    6. Create `packages/admin/src/middleware.ts`:
       - Import updateSession from @/lib/supabase/proxy
       - Export middleware function that calls updateSession
       - Export config.matcher that excludes static files: `/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)`

    7. Create `packages/admin/src/app/auth/callback/route.ts`:
       - Import NextResponse from next/server
       - Import createClient from @/lib/supabase/server
       - Export GET handler that:
         - Extracts `code` and `next` params from URL
         - If code exists, exchanges it for session via `supabase.auth.exchangeCodeForSession(code)`
         - On success, redirects to `next` param (default /)
         - On failure, redirects to /sign-in?error=auth_callback_error

    8. Update `packages/admin/next.config.ts` to add transpilePackages for shared:
       ```typescript
       import type { NextConfig } from "next";

       const nextConfig: NextConfig = {
         transpilePackages: ['@upoe/shared'],
       };

       export default nextConfig;
       ```

    9. Create `.env.example` at `packages/admin/.env.example`:
       ```
       NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
       NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=your-publishable-key
       SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
       NEXT_PUBLIC_SITE_URL=http://localhost:3000
       ```
  </action>
  <verify>
    Run `cd packages/admin && pnpm build 2>&1 | tail -20` to check for compilation errors.
    Verify middleware.ts exists and imports from proxy.ts.
    Verify admin.ts does NOT use NEXT_PUBLIC_ prefix for service role key.
  </verify>
  <done>
    4 Supabase client files created (browser, server, proxy/middleware, admin). Middleware validates JWT via getClaims and handles auth redirects. Auth callback route exchanges codes for sessions. next.config.ts transpiles @upoe/shared.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auth and dashboard route groups with sidebar layout</name>
  <files>
    packages/admin/src/app/layout.tsx
    packages/admin/src/app/(auth)/layout.tsx
    packages/admin/src/app/(auth)/sign-in/page.tsx
    packages/admin/src/app/(auth)/sign-up/page.tsx
    packages/admin/src/app/(auth)/forgot-password/page.tsx
    packages/admin/src/app/(auth)/onboarding/page.tsx
    packages/admin/src/app/(dashboard)/layout.tsx
    packages/admin/src/app/(dashboard)/page.tsx
    packages/admin/src/app/page.tsx
  </files>
  <action>
    1. Update `packages/admin/src/app/layout.tsx`:
       - Change metadata title to "UPOE Admin" and description to "Panel de administracion UPOE"
       - Change html lang to "es"
       - Keep Geist fonts and globals.css import
       - This is the root layout -- no auth logic here (middleware handles redirects)

    2. DELETE `packages/admin/src/app/page.tsx` (the default Next.js welcome page -- replaced by (dashboard)/page.tsx)

    3. Create `packages/admin/src/app/(auth)/layout.tsx`:
       - Simple centered layout: flex min-h-screen items-center justify-center bg-gray-50
       - Wraps children in a card-like container: max-w-md w-full bg-white rounded-xl shadow-lg p-8
       - Add UPOE logo/text header above the card

    4. Create PLACEHOLDER auth pages (content added in Plan 09-04):
       - `packages/admin/src/app/(auth)/sign-in/page.tsx`: Simple page with h1 "Iniciar Sesion" and placeholder text
       - `packages/admin/src/app/(auth)/sign-up/page.tsx`: Simple page with h1 "Crear Cuenta"
       - `packages/admin/src/app/(auth)/forgot-password/page.tsx`: Simple page with h1 "Recuperar Contrasena"
       - `packages/admin/src/app/(auth)/onboarding/page.tsx`: Simple page with h1 "Configuracion Inicial"

    5. Create `packages/admin/src/app/(dashboard)/layout.tsx` (Sidebar Layout):
       - This is a Server Component
       - Create sidebar with navigation items (Spanish labels):
         - Inicio (/) -- dashboard icon
         - Finanzas (/finances) -- dollar icon
         - Residentes (/residents) -- people icon
         - Operaciones (/operations) -- wrench icon
         - Reportes (/reports) -- chart icon
         - Configuracion (/settings) -- gear icon
       - Use simple HTML/Tailwind for sidebar (no external component library yet)
       - Sidebar: fixed left, w-64, h-screen, bg-gray-900 text-white, with UPOE branding at top
       - Main content: ml-64, p-6, min-h-screen, bg-gray-50
       - Navigation items: flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-800 transition
       - Active state will be added later with usePathname (needs 'use client')
       - Bottom of sidebar: user info area (placeholder)

    6. Create `packages/admin/src/app/(dashboard)/page.tsx`:
       - Simple dashboard placeholder: h1 "Panel de Administracion", p "Bienvenido a UPOE"
       - This replaces the old app/page.tsx that was the Next.js default

    IMPORTANT: The sidebar layout is a Server Component for performance. Active link highlighting will use a small client component wrapper later. Keep it simple for now.
  </action>
  <verify>
    Run `cd packages/admin && pnpm build 2>&1 | tail -20` -- should build successfully.
    Verify route structure: `ls -R packages/admin/src/app/` shows (auth)/ and (dashboard)/ groups.
    Verify old page.tsx is gone (replaced by (dashboard)/page.tsx).
  </verify>
  <done>
    Admin app has (auth) route group with centered card layout and 4 placeholder pages. (dashboard) route group has sidebar layout with navigation items and a dashboard placeholder page. Root layout updated with UPOE branding. Middleware handles all auth redirects.
  </done>
</task>

</tasks>

<verification>
1. `cd packages/admin && pnpm build` completes without errors
2. `ls packages/admin/src/lib/supabase/` shows client.ts, server.ts, proxy.ts, admin.ts
3. `ls packages/admin/src/app/(auth)/` shows layout.tsx, sign-in/, sign-up/, forgot-password/, onboarding/
4. `ls packages/admin/src/app/(dashboard)/` shows layout.tsx, page.tsx
5. middleware.ts exists at packages/admin/src/middleware.ts
6. auth/callback/route.ts exists at packages/admin/src/app/auth/callback/route.ts
7. `grep "getClaims" packages/admin/src/lib/supabase/proxy.ts` returns match
8. `grep "SUPABASE_SERVICE_ROLE_KEY" packages/admin/src/lib/supabase/admin.ts` shows NO NEXT_PUBLIC_ prefix
</verification>

<success_criteria>
- @supabase/ssr installed and 4 client files created (browser, server, proxy, admin)
- Middleware redirects unauthenticated users to /sign-in and authenticated users away from auth pages
- Middleware handles pending_setup role by routing to /onboarding
- Auth callback route exchanges code for session
- Dashboard sidebar layout provides navigation structure for all admin features
- `pnpm build` succeeds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-auth-shared-infrastructure/09-03-SUMMARY.md`
</output>
