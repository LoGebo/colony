---
phase: 09-auth-shared-infrastructure
plan: 04
type: execute
wave: 2
depends_on: ["09-01", "09-02", "09-03"]
files_modified:
  - packages/mobile/app/(auth)/sign-in.tsx
  - packages/mobile/app/(auth)/sign-up.tsx
  - packages/mobile/app/(auth)/forgot-password.tsx
  - packages/mobile/app/(auth)/onboarding.tsx
  - packages/admin/src/app/(auth)/sign-in/page.tsx
  - packages/admin/src/app/(auth)/sign-up/page.tsx
  - packages/admin/src/app/(auth)/forgot-password/page.tsx
  - packages/admin/src/app/(auth)/onboarding/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can enter email and password on mobile sign-in screen and authenticate via supabase.auth.signInWithPassword"
    - "User can enter email, password, confirm password on mobile sign-up screen and register via supabase.auth.signUp"
    - "User can enter email on forgot-password screen and trigger reset via supabase.auth.resetPasswordForEmail"
    - "Admin can enter org name and community name on onboarding screen and call complete_admin_onboarding RPC"
    - "All forms validate input using Zod schemas from @upoe/shared before submitting"
    - "Admin sign-in on web uses Supabase browser client and redirects on success"
    - "Admin onboarding calls refreshSession() after complete_admin_onboarding to get updated claims"
  artifacts:
    - path: "packages/mobile/app/(auth)/sign-in.tsx"
      provides: "Mobile sign-in screen with email/password form, Zod validation, Supabase auth"
      contains: "signInWithPassword"
    - path: "packages/mobile/app/(auth)/onboarding.tsx"
      provides: "Admin onboarding screen calling complete_admin_onboarding RPC"
      contains: "complete_admin_onboarding"
    - path: "packages/admin/src/app/(auth)/sign-in/page.tsx"
      provides: "Web sign-in page with form and Supabase browser client auth"
      contains: "signInWithPassword"
    - path: "packages/admin/src/app/(auth)/onboarding/page.tsx"
      provides: "Web admin onboarding page with org/community creation form"
      contains: "complete_admin_onboarding"
  key_links:
    - from: "packages/mobile/app/(auth)/sign-in.tsx"
      to: "packages/shared/src/validators/auth.ts"
      via: "signInSchema import for validation"
      pattern: "import.*signInSchema.*from.*@upoe/shared"
    - from: "packages/mobile/app/(auth)/onboarding.tsx"
      to: "supabase.rpc('complete_admin_onboarding')"
      via: "RPC call after form validation"
      pattern: "rpc.*complete_admin_onboarding"
    - from: "packages/admin/src/app/(auth)/sign-in/page.tsx"
      to: "packages/admin/src/lib/supabase/client.ts"
      via: "browser client for auth"
      pattern: "createClient.*from.*@/lib/supabase/client"
---

<objective>
Implement functional auth screens on both mobile and web platforms: sign-in, sign-up, forgot-password, and admin onboarding. All screens use Zod validators from @upoe/shared and call appropriate Supabase Auth methods.

Purpose: These screens implement AUTH-01 through AUTH-04 and AUTH-09. They are the primary user-facing auth flows. The onboarding screen implements AUTH-03 by calling the existing complete_admin_onboarding RPC. After this plan, users can actually authenticate and navigate to role-appropriate content.
Output: 8 functional auth screens (4 mobile + 4 web) with form validation, loading states, error handling, and correct Supabase Auth method calls.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-auth-shared-infrastructure/09-RESEARCH.md

# Prior plan outputs (read SUMMARYs)
@.planning/phases/09-auth-shared-infrastructure/09-01-SUMMARY.md
@.planning/phases/09-auth-shared-infrastructure/09-02-SUMMARY.md
@.planning/phases/09-auth-shared-infrastructure/09-03-SUMMARY.md

# Key source files from prior plans
@packages/shared/src/validators/auth.ts
@packages/mobile/src/lib/supabase.ts
@packages/mobile/src/providers/SessionProvider.tsx
@packages/admin/src/lib/supabase/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement mobile auth screens (sign-in, sign-up, forgot-password, onboarding)</name>
  <files>
    packages/mobile/app/(auth)/sign-in.tsx
    packages/mobile/app/(auth)/sign-up.tsx
    packages/mobile/app/(auth)/forgot-password.tsx
    packages/mobile/app/(auth)/onboarding.tsx
  </files>
  <action>
    Replace the placeholder screens from Plan 09-02 with functional implementations.

    **sign-in.tsx:**
    - State: email, password, loading, error
    - Import signInSchema from @upoe/shared for validation
    - Import supabase from @/lib/supabase
    - On submit: validate with signInSchema.safeParse(), if invalid show first error, if valid call supabase.auth.signInWithPassword({ email, password })
    - On error: show Alert with error.message
    - On success: session state change triggers Stack.Protected re-evaluation (no manual navigation needed)
    - UI (NativeWind): centered layout, "Iniciar Sesion" h1, email TextInput (autoCapitalize: none, keyboardType: email-address), password TextInput (secureTextEntry), submit Pressable button, loading state disables button and shows "Cargando..."
    - Link to sign-up and forgot-password screens using `import { Link } from 'expo-router'`

    **sign-up.tsx:**
    - State: email, password, confirmPassword, loading, error
    - Import signUpSchema from @upoe/shared
    - On submit: validate with signUpSchema.safeParse(), if valid call supabase.auth.signUp({ email, password })
    - Show success message after signup: "Revisa tu email para confirmar tu cuenta" (invited users will be auto-confirmed by the trigger)
    - Link back to sign-in

    **forgot-password.tsx:**
    - State: email, loading, sent (boolean)
    - Import resetPasswordSchema from @upoe/shared
    - On submit: validate, call supabase.auth.resetPasswordForEmail(email, { redirectTo: 'upoe://reset-password' })
    - After success: show "Te enviamos un enlace para restablecer tu contrasena"
    - Link back to sign-in

    **onboarding.tsx:**
    - State: orgName, communityName, communityAddress, communityCity, communityState, communityZip, firstName, paternalSurname, loading, error, step (1 or 2 for multi-step)
    - Import adminOnboardingSchema from @upoe/shared
    - Import supabase from @/lib/supabase
    - Step 1: Organization name + community name (required), community address fields (optional)
    - Step 2: Admin name fields (optional), review + submit
    - On submit: validate with adminOnboardingSchema.safeParse(), then call:
      ```typescript
      const { data, error } = await supabase.rpc('complete_admin_onboarding', {
        p_org_name: orgName,
        p_community_name: communityName,
        p_community_address: communityAddress || null,
        p_community_city: communityCity || null,
        p_community_state: communityState || null,
        p_community_zip: communityZip || null,
        p_first_name: firstName || null,
        p_paternal_surname: paternalSurname || null,
      });
      ```
    - CRITICAL: After successful RPC, call `await supabase.auth.refreshSession()` to get updated app_metadata (role changes from pending_setup to community_admin). This triggers Stack.Protected to re-evaluate and route to admin group.
    - Show error state if RPC fails

    IMPORTANT for all screens:
    - Use NativeWind className for styling (flex-1, justify-center, px-6, etc.)
    - Use React Native components (View, Text, TextInput, Pressable, Alert)
    - Do NOT use react-hook-form yet (simple useState is sufficient for these forms)
    - KeyboardAvoidingView is recommended for screens with multiple inputs
    - All text in Spanish
  </action>
  <verify>
    Run `cd packages/mobile && npx tsc --noEmit 2>&1 | head -30` to check for type errors.
    Verify each file imports from @upoe/shared (Zod schemas) and @/lib/supabase (client).
    Verify onboarding.tsx contains 'complete_admin_onboarding' and 'refreshSession'.
  </verify>
  <done>
    4 mobile auth screens implemented: sign-in with email/password, sign-up with confirmation, forgot-password with email input, onboarding with multi-step form calling complete_admin_onboarding RPC. All validate with Zod and use NativeWind styling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement admin web auth pages (sign-in, sign-up, forgot-password, onboarding)</name>
  <files>
    packages/admin/src/app/(auth)/sign-in/page.tsx
    packages/admin/src/app/(auth)/sign-up/page.tsx
    packages/admin/src/app/(auth)/forgot-password/page.tsx
    packages/admin/src/app/(auth)/onboarding/page.tsx
  </files>
  <action>
    Replace the placeholder pages from Plan 09-03 with functional implementations.

    All 4 pages are 'use client' components (they manage form state and call Supabase browser client).

    **sign-in/page.tsx:**
    - 'use client'
    - Import createClient from @/lib/supabase/client
    - Import signInSchema, type SignInForm from @upoe/shared
    - Import useRouter from next/navigation
    - State: email, password, loading, error
    - On submit: validate with signInSchema, call supabase.auth.signInWithPassword({ email, password })
    - On success: router.push('/') (middleware will handle routing)
    - On error: set error state, display inline error message
    - UI (Tailwind CSS): form with labeled inputs, "Iniciar Sesion" heading, submit button with loading state, links to /sign-up and /forgot-password
    - Button style: bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg

    **sign-up/page.tsx:**
    - 'use client'
    - Import createClient from @/lib/supabase/client
    - Import signUpSchema from @upoe/shared
    - State: email, password, confirmPassword, loading, error, success
    - On submit: validate, call supabase.auth.signUp({ email, password })
    - On success: show confirmation message
    - Link back to /sign-in

    **forgot-password/page.tsx:**
    - 'use client'
    - Import createClient from @/lib/supabase/client
    - Import resetPasswordSchema from @upoe/shared
    - State: email, loading, sent
    - On submit: validate, call supabase.auth.resetPasswordForEmail(email, { redirectTo: `${window.location.origin}/auth/callback?next=/reset-password` })
    - After success: show confirmation
    - Link back to /sign-in

    **onboarding/page.tsx:**
    - 'use client'
    - Import createClient from @/lib/supabase/client
    - Import adminOnboardingSchema from @upoe/shared
    - Import useRouter from next/navigation
    - State: all onboarding fields, loading, error, step
    - Step 1: Org name + community name (required), address fields
    - Step 2: Admin name, review + submit
    - On submit: validate, call supabase.rpc('complete_admin_onboarding', { ...params })
    - CRITICAL: After success, call `await supabase.auth.refreshSession()` to get updated claims
    - Then router.push('/') -- middleware will now see community_admin role and allow access
    - Show error if RPC fails

    IMPORTANT:
    - All pages are 'use client' (form state + browser Supabase client)
    - All text in Spanish
    - Use Tailwind CSS (v4 syntax, which the admin package uses)
    - Form inputs: standard HTML input/button elements with Tailwind styling
    - Error messages displayed inline below inputs (not just alerts)
    - Use the existing (auth) layout from 09-03 which provides the centered card container
  </action>
  <verify>
    Run `cd packages/admin && pnpm build 2>&1 | tail -30` to check build succeeds.
    Verify all 4 pages exist and have 'use client' directive.
    Verify sign-in page imports createClient from @/lib/supabase/client (NOT server).
    Verify onboarding page calls 'complete_admin_onboarding' and 'refreshSession'.
  </verify>
  <done>
    4 admin auth pages implemented: sign-in with email/password, sign-up with confirmation, forgot-password with email, onboarding with multi-step org/community creation calling complete_admin_onboarding RPC. All validate with Zod, use browser Supabase client, and display errors inline. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. All 8 auth screen files exist (4 mobile + 4 web)
2. `grep -r "signInSchema" packages/mobile/app/(auth)/sign-in.tsx` returns match (validates with shared schema)
3. `grep -r "signInSchema" packages/admin/src/app/(auth)/sign-in/page.tsx` returns match
4. `grep -r "complete_admin_onboarding" packages/mobile/app/(auth)/onboarding.tsx` returns match
5. `grep -r "refreshSession" packages/mobile/app/(auth)/onboarding.tsx` returns match (critical for role update)
6. `grep -r "refreshSession" packages/admin/src/app/(auth)/onboarding/page.tsx` returns match
7. `grep "'use client'" packages/admin/src/app/(auth)/sign-in/page.tsx` returns match
8. Mobile screens use NativeWind className; admin pages use Tailwind CSS
</verification>

<success_criteria>
- Mobile sign-in: email + password -> signInWithPassword -> session triggers role routing
- Mobile sign-up: email + password + confirm -> signUp -> confirmation message
- Mobile forgot-password: email -> resetPasswordForEmail -> confirmation
- Mobile onboarding: org + community form -> complete_admin_onboarding RPC -> refreshSession -> routes to admin
- Admin sign-in: email + password -> signInWithPassword -> router.push('/')
- Admin sign-up: email + password + confirm -> signUp -> confirmation
- Admin forgot-password: email -> resetPasswordForEmail -> confirmation
- Admin onboarding: org + community form -> complete_admin_onboarding RPC -> refreshSession -> router.push('/')
- All forms validate with Zod schemas from @upoe/shared before submitting
</success_criteria>

<output>
After completion, create `.planning/phases/09-auth-shared-infrastructure/09-04-SUMMARY.md`
</output>
