---
phase: 09-auth-shared-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/shared/package.json
  - packages/shared/src/index.ts
  - packages/shared/src/validators/auth.ts
  - packages/shared/src/validators/index.ts
  - packages/shared/src/queries/keys.ts
  - packages/shared/src/queries/index.ts
  - packages/shared/src/constants/index.ts
  - packages/shared/src/constants/routes.ts
  - packages/shared/src/lib/supabase.ts
autonomous: true

must_haves:
  truths:
    - "Importing { signInSchema, signUpSchema, adminOnboardingSchema, resetPasswordSchema } from @upoe/shared compiles without error"
    - "Importing { queryKeys } from @upoe/shared provides typed query key factories for residents, visitors, payments, access-logs, amenities, notifications, kpis"
    - "Zod validators produce Spanish error messages on invalid input"
    - "Query key factories produce correct array keys for list, detail, and filter queries"
  artifacts:
    - path: "packages/shared/src/validators/auth.ts"
      provides: "Zod v4 form validation schemas for sign-in, sign-up, admin onboarding, password reset"
      exports: ["signInSchema", "signUpSchema", "adminOnboardingSchema", "resetPasswordSchema", "inviteUserSchema"]
    - path: "packages/shared/src/queries/keys.ts"
      provides: "Typed query key factories using @lukemorales/query-key-factory"
      exports: ["queryKeys"]
    - path: "packages/shared/src/constants/routes.ts"
      provides: "Route path constants for mobile and admin platforms"
      exports: ["MOBILE_ROUTES", "ADMIN_ROUTES"]
  key_links:
    - from: "packages/shared/src/index.ts"
      to: "packages/shared/src/validators/index.ts"
      via: "re-export"
      pattern: "export .* from './validators'"
    - from: "packages/shared/src/index.ts"
      to: "packages/shared/src/queries/index.ts"
      via: "re-export"
      pattern: "export .* from './queries'"
---

<objective>
Create the shared package foundation: Zod v4 validators for auth forms, query key factories for TanStack Query, and route constants. These are platform-independent utilities consumed by both mobile and admin apps.

Purpose: Every subsequent plan and phase depends on these shared validators, query keys, and constants. Building them first (Wave 1) unblocks parallel development of mobile and admin platforms.
Output: Extended @upoe/shared package with validators/, queries/, and enhanced constants/ directories, all re-exported from index.ts.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-auth-shared-infrastructure/09-RESEARCH.md

# Existing shared package structure
@packages/shared/package.json
@packages/shared/src/index.ts
@packages/shared/src/constants/index.ts
@packages/shared/src/constants/roles.ts
@packages/shared/src/constants/storage.ts
@packages/shared/src/lib/supabase.ts
@packages/shared/src/types/index.ts
@packages/shared/tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create Zod v4 auth validators</name>
  <files>
    packages/shared/package.json
    packages/shared/src/validators/auth.ts
    packages/shared/src/validators/index.ts
  </files>
  <action>
    1. Install dependencies in packages/shared:
       ```
       cd packages/shared && pnpm add zod@^4.3 @lukemorales/query-key-factory
       ```

    2. Create `packages/shared/src/validators/auth.ts` with Zod v4 schemas:
       - `signInSchema`: email (z.email with Spanish error), password (min 8, Spanish error)
       - `signUpSchema`: email, password, confirmPassword with .refine() to check match. Spanish error messages.
       - `adminOnboardingSchema`: orgName (required), communityName (required), communityAddress (optional), communityCity (optional), communityState (optional), communityZip (optional), firstName (optional), paternalSurname (optional). All Spanish errors.
       - `resetPasswordSchema`: email (z.email with Spanish error)
       - `inviteUserSchema`: email (z.email), firstName (min 1), paternalSurname (min 1), unitId (z.string().uuid()), role (z.enum(['resident', 'guard'])). Spanish errors.
       - Export TypeScript inferred types: `SignInForm`, `SignUpForm`, `AdminOnboardingForm`, `ResetPasswordForm`, `InviteUserForm`
       - Use Zod v4 syntax: `{ error: 'message' }` NOT `{ message: 'message' }`. Use `z.email()` for top-level email validator.

    3. Create `packages/shared/src/validators/index.ts` that re-exports everything from `./auth`.

    IMPORTANT: Use Zod v4 API. Error customization uses `{ error: "..." }` not `{ message: "..." }`. Top-level `z.email()` is preferred over `z.string().email()`.
  </action>
  <verify>
    Run `cd packages/shared && pnpm typecheck` -- should pass with no errors.
    Verify zod and @lukemorales/query-key-factory appear in package.json dependencies.
  </verify>
  <done>
    5 Zod schemas (signIn, signUp, adminOnboarding, resetPassword, inviteUser) exist with Spanish error messages and TypeScript type exports. All use Zod v4 syntax.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create query key factories and route constants</name>
  <files>
    packages/shared/src/queries/keys.ts
    packages/shared/src/queries/index.ts
    packages/shared/src/constants/routes.ts
    packages/shared/src/constants/index.ts
    packages/shared/src/index.ts
  </files>
  <action>
    1. Create `packages/shared/src/queries/keys.ts` using @lukemorales/query-key-factory:
       - Import `createQueryKeys` and `mergeQueryKeys`
       - Create key factories for: `residents` (all, list by communityId, detail by id, byUnit), `visitors` (all, list with filters, active by communityId, detail), `payments` (all, byUnit, balance by unitId), `accessLogs` (all, recent by accessPointId, today by communityId), `amenities` (all, list by communityId, reservations by amenityId+date), `notifications` (all, unread by userId), `kpis` (all, summary by communityId+period), `communities` (all, detail by id, settings by id), `units` (all, list by communityId, detail), `guards` (all, list by communityId, detail)
       - Export merged `queryKeys` object

    2. Create `packages/shared/src/queries/index.ts` re-exporting from `./keys`.

    3. Create `packages/shared/src/constants/routes.ts`:
       - `MOBILE_ROUTES` object with paths: `SIGN_IN: '/(auth)/sign-in'`, `SIGN_UP: '/(auth)/sign-up'`, `FORGOT_PASSWORD: '/(auth)/forgot-password'`, `ONBOARDING: '/(auth)/onboarding'`, `RESIDENT_HOME: '/(resident)/'`, `GUARD_HOME: '/(guard)/'`, `ADMIN_HOME: '/(admin)/'`
       - `ADMIN_ROUTES` object with paths: `SIGN_IN: '/sign-in'`, `SIGN_UP: '/sign-up'`, `DASHBOARD: '/'`, `AUTH_CALLBACK: '/auth/callback'`, `ONBOARDING: '/onboarding'`, `USERS: '/users'`, `SETTINGS: '/settings'`
       - `AUTH_ROUTES` array listing all auth paths (used by middleware to skip auth checks)

    4. Update `packages/shared/src/constants/index.ts` to add: `export * from './routes';`

    5. Update `packages/shared/src/index.ts` to add:
       ```typescript
       // Validators
       export * from './validators';

       // Queries
       export * from './queries';
       ```
       Keep existing exports intact.

    IMPORTANT: The existing supabase.ts client factory in shared/src/lib/ should remain as-is. It's a generic factory used differently by each platform. Do NOT modify it.
  </action>
  <verify>
    Run `cd packages/shared && pnpm typecheck` -- should pass.
    Verify that `import { queryKeys, signInSchema, MOBILE_ROUTES, ADMIN_ROUTES, SYSTEM_ROLES } from './src/index'` would resolve (check exports chain).
  </verify>
  <done>
    Query key factories exist for 10 domains with typed parameters. Route constants exist for mobile and admin. All re-exported from shared index.ts. Typecheck passes.
  </done>
</task>

</tasks>

<verification>
1. `cd packages/shared && pnpm typecheck` passes with zero errors
2. All new files exist: validators/auth.ts, validators/index.ts, queries/keys.ts, queries/index.ts, constants/routes.ts
3. package.json includes zod@^4.3 and @lukemorales/query-key-factory as dependencies
4. index.ts exports validators, queries, constants, types, and lib
</verification>

<success_criteria>
- Shared package compiles cleanly with `pnpm typecheck`
- Zod v4 auth schemas validate input and produce Spanish error messages
- Query key factories provide typed keys for all major domains
- Route constants define paths for both mobile and admin platforms
- All exports accessible via `import { ... } from '@upoe/shared'`
</success_criteria>

<output>
After completion, create `.planning/phases/09-auth-shared-infrastructure/09-01-SUMMARY.md`
</output>
