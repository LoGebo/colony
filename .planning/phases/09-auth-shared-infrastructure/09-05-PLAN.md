---
phase: 09-auth-shared-infrastructure
plan: 05
type: execute
wave: 2
depends_on: ["09-01", "09-02", "09-03"]
files_modified:
  - packages/shared/src/lib/upload.ts
  - packages/shared/src/index.ts
  - packages/mobile/src/hooks/useAuth.ts
  - packages/mobile/src/hooks/useRole.ts
  - packages/mobile/src/lib/upload.ts
  - packages/admin/src/hooks/useAuth.ts
  - packages/admin/src/hooks/useRole.ts
  - packages/admin/src/providers/QueryProvider.tsx
  - packages/admin/src/app/(dashboard)/layout.tsx
  - packages/admin/src/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "useAuth() hook returns { user, session, role, communityId, signOut, isLoading } on both platforms"
    - "useRole() hook returns { isResident, isGuard, isAdmin, isSuperAdmin, role } on both platforms"
    - "signOut() method clears session and redirects to sign-in on both platforms"
    - "TanStack Query provider wraps admin app with configured QueryClient"
    - "File upload utility generates correct storage path using getStoragePath from @upoe/shared"
    - "Admin sidebar shows user name and logout button from useAuth hook"
  artifacts:
    - path: "packages/mobile/src/hooks/useAuth.ts"
      provides: "Mobile auth hook extracting user, role, communityId from SessionProvider"
      exports: ["useAuth"]
    - path: "packages/mobile/src/hooks/useRole.ts"
      provides: "Mobile role check hook with boolean helpers"
      exports: ["useRole"]
    - path: "packages/admin/src/hooks/useAuth.ts"
      provides: "Admin auth hook using browser Supabase client"
      exports: ["useAuth"]
    - path: "packages/admin/src/providers/QueryProvider.tsx"
      provides: "TanStack Query provider for admin app"
      exports: ["QueryProvider"]
    - path: "packages/mobile/src/lib/upload.ts"
      provides: "Mobile file upload utility using ImagePicker + Supabase Storage"
      exports: ["pickAndUploadImage"]
    - path: "packages/shared/src/lib/upload.ts"
      provides: "Shared upload path generation and content type utilities"
      exports: ["generateUploadPath", "getContentType"]
  key_links:
    - from: "packages/mobile/src/hooks/useAuth.ts"
      to: "packages/mobile/src/providers/SessionProvider.tsx"
      via: "useSession hook for session data"
      pattern: "useSession"
    - from: "packages/admin/src/app/(dashboard)/layout.tsx"
      to: "packages/admin/src/hooks/useAuth.ts"
      via: "client component sidebar user info"
      pattern: "useAuth"
    - from: "packages/mobile/src/lib/upload.ts"
      to: "packages/shared/src/constants/storage.ts"
      via: "STORAGE_BUCKETS and getStoragePath imports"
      pattern: "getStoragePath.*from.*@upoe/shared"
---

<objective>
Create shared hooks (useAuth, useRole) for both platforms, set up TanStack Query provider for the admin app, implement file upload utilities for Supabase Storage, and wire logout and user info into the admin sidebar.

Purpose: These hooks and utilities are consumed by every feature screen in phases 10-16. useAuth provides consistent access to user/role/community across both platforms (AUTH-07, AUTH-08). TanStack Query provider enables data fetching in the admin dashboard (INFRA-04). File upload utility supports payment proofs, incident photos, etc. (INFRA-05). The signOut implementation completes AUTH-08.
Output: Platform-specific auth hooks, admin QueryProvider, file upload utility, and a wired sidebar with user info and logout.
</objective>

<execution_context>
@C:\Users\PC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\PC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-auth-shared-infrastructure/09-RESEARCH.md

# Prior plan outputs (read SUMMARYs)
@.planning/phases/09-auth-shared-infrastructure/09-01-SUMMARY.md
@.planning/phases/09-auth-shared-infrastructure/09-02-SUMMARY.md
@.planning/phases/09-auth-shared-infrastructure/09-03-SUMMARY.md

# Key source files from prior plans
@packages/mobile/src/providers/SessionProvider.tsx
@packages/mobile/src/lib/supabase.ts
@packages/admin/src/lib/supabase/client.ts
@packages/shared/src/constants/storage.ts
@packages/shared/src/constants/roles.ts
@packages/shared/src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useAuth and useRole hooks for both platforms</name>
  <files>
    packages/mobile/src/hooks/useAuth.ts
    packages/mobile/src/hooks/useRole.ts
    packages/admin/src/hooks/useAuth.ts
    packages/admin/src/hooks/useRole.ts
  </files>
  <action>
    1. Create `packages/mobile/src/hooks/useAuth.ts`:
       - Import useSession from @/providers/SessionProvider
       - Import supabase from @/lib/supabase
       - Import useRouter from expo-router
       - Import AppMetadata from @upoe/shared
       - Return object:
         - `user`: session?.user or null
         - `session`: full session object
         - `role`: session?.user?.app_metadata?.role as string | undefined
         - `communityId`: session?.user?.app_metadata?.community_id as string | undefined
         - `residentId`: session?.user?.app_metadata?.resident_id as string | undefined
         - `guardId`: session?.user?.app_metadata?.guard_id as string | undefined
         - `organizationId`: session?.user?.app_metadata?.organization_id as string | undefined
         - `isLoading`: from useSession
         - `signOut`: async function that calls supabase.auth.signOut(). No manual navigation needed -- Stack.Protected handles redirect when session becomes null.
         - `refreshSession`: async function that calls supabase.auth.refreshSession() and returns the new session. Useful after onboarding.

    2. Create `packages/mobile/src/hooks/useRole.ts`:
       - Import useAuth from ./useAuth
       - Import SYSTEM_ROLES from @upoe/shared
       - Return object:
         - `role`: from useAuth
         - `isResident`: role === SYSTEM_ROLES.RESIDENT
         - `isGuard`: role === SYSTEM_ROLES.GUARD
         - `isAdmin`: role === SYSTEM_ROLES.COMMUNITY_ADMIN
         - `isManager`: role === SYSTEM_ROLES.MANAGER
         - `isSuperAdmin`: role === SYSTEM_ROLES.SUPER_ADMIN
         - `isPendingSetup`: role === 'pending_setup'
         - `isAdminRole`: isAdmin || isManager || isSuperAdmin (can access admin features)

    3. Create `packages/admin/src/hooks/useAuth.ts`:
       - 'use client' (browser hook)
       - Import createClient from @/lib/supabase/client
       - Import { useRouter } from next/navigation
       - Import { useEffect, useState, useCallback } from react
       - Import type { User, Session } from @supabase/supabase-js
       - Create supabase client via createClient()
       - Hook manages its own state: user, session, isLoading
       - useEffect: call supabase.auth.getSession() on mount, subscribe to onAuthStateChange
       - Return same shape as mobile: user, session, role, communityId, residentId, guardId, organizationId, isLoading
       - signOut: call supabase.auth.signOut(), then router.push('/sign-in')
       - refreshSession: call supabase.auth.refreshSession()

    4. Create `packages/admin/src/hooks/useRole.ts`:
       - 'use client'
       - Same logic as mobile useRole but imports from ./useAuth
       - Returns: role, isResident, isGuard, isAdmin, isManager, isSuperAdmin, isPendingSetup, isAdminRole

    IMPORTANT: Both platforms expose the same API shape from useAuth and useRole. This is intentional -- feature code can use the same patterns regardless of platform.
  </action>
  <verify>
    Run `cd packages/mobile && npx tsc --noEmit 2>&1 | head -20` for mobile type check.
    Run `cd packages/admin && pnpm build 2>&1 | tail -20` for admin build check.
    Verify useAuth exports signOut on both platforms.
  </verify>
  <done>
    useAuth hook exists on both platforms with identical API shape: user, session, role, communityId, signOut, refreshSession, isLoading. useRole hook provides boolean helpers (isResident, isGuard, isAdmin, etc.) on both platforms.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin QueryProvider, file upload utilities, and wire sidebar</name>
  <files>
    packages/shared/src/lib/upload.ts
    packages/shared/src/index.ts
    packages/mobile/src/lib/upload.ts
    packages/admin/src/providers/QueryProvider.tsx
    packages/admin/src/app/(dashboard)/layout.tsx
    packages/admin/src/app/layout.tsx
  </files>
  <action>
    1. Create `packages/shared/src/lib/upload.ts` (platform-agnostic utilities):
       ```typescript
       import { STORAGE_BUCKETS, type StorageBucket, getStoragePath } from '../constants/storage';

       /**
        * Generate a unique upload path for a file in Supabase Storage.
        * Pattern: {communityId}/{category}/{timestamp}-{random}.{ext}
        */
       export function generateUploadPath(
         communityId: string,
         category: string,
         filename: string
       ): string {
         const ext = filename.split('.').pop() ?? 'jpg';
         const timestamp = Date.now();
         const random = Math.random().toString(36).substring(2, 8);
         return getStoragePath(
           STORAGE_BUCKETS.PAYMENT_PROOFS as StorageBucket,
           communityId,
           `${category}/${timestamp}-${random}.${ext}`
         );
       }

       export function getContentType(filename: string): string {
         const ext = filename.split('.').pop()?.toLowerCase();
         const types: Record<string, string> = {
           jpg: 'image/jpeg',
           jpeg: 'image/jpeg',
           png: 'image/png',
           gif: 'image/gif',
           webp: 'image/webp',
           pdf: 'application/pdf',
           mp4: 'video/mp4',
         };
         return types[ext ?? ''] ?? 'application/octet-stream';
       }

       export { STORAGE_BUCKETS, getStoragePath };
       ```

    2. Update `packages/shared/src/index.ts` to add:
       ```typescript
       // Upload utilities
       export { generateUploadPath, getContentType } from './lib/upload';
       ```
       Keep all existing exports intact.

    3. Create `packages/mobile/src/lib/upload.ts` (mobile-specific with ImagePicker):
       - Import * as ImagePicker from expo-image-picker (add expo-image-picker as dependency: `npx expo install expo-image-picker`)
       - Import supabase from ./supabase
       - Import { getStoragePath, getContentType, STORAGE_BUCKETS } from @upoe/shared
       - Export async function `pickAndUploadImage(bucket: string, communityId: string, category: string)`:
         - Launch ImagePicker.launchImageLibraryAsync with mediaTypes: ['images'], allowsEditing: true, quality: 0.8
         - If canceled, return null
         - Get asset URI, derive extension
         - Generate path: `getStoragePath(bucket as any, communityId, category + '/' + timestamp + '.' + ext)`
         - Fetch URI to ArrayBuffer (correct RN pattern: `const response = await fetch(asset.uri); const arrayBuffer = await response.arrayBuffer();`)
         - Upload to Supabase Storage: `supabase.storage.from(bucket).upload(path, arrayBuffer, { contentType, upsert: true })`
         - Return uploaded path string or null on error

    4. Create `packages/admin/src/providers/QueryProvider.tsx`:
       - 'use client'
       - Import QueryClient, QueryClientProvider from @tanstack/react-query
       - Install: `cd packages/admin && pnpm add @tanstack/react-query`
       - Create QueryClient with defaults: staleTime 60s, gcTime 300s, retry 1
       - Use useState for stable instance
       - Export QueryProvider component

    5. Update `packages/admin/src/app/layout.tsx`:
       - Import QueryProvider
       - Wrap children: `<QueryProvider>{children}</QueryProvider>`
       - Note: QueryProvider is 'use client' but can be composed in a Server Component layout via the children boundary

    6. Update `packages/admin/src/app/(dashboard)/layout.tsx` to add user info and logout:
       - The sidebar itself is a Server Component, but add a small Client Component for the user section at the bottom
       - Create an inline or separate `SidebarUser` component ('use client') that:
         - Uses useAuth hook to get user email and role
         - Displays user email (truncated if long)
         - Displays role label from ROLE_LABELS (imported from @upoe/shared)
         - Has a "Cerrar Sesion" button that calls signOut()
       - This component renders at the bottom of the sidebar
       - Also add active link highlighting using a `NavLink` client component that reads usePathname from next/navigation and applies bg-gray-800 when active
  </action>
  <verify>
    Run `cd packages/admin && pnpm build 2>&1 | tail -30` to verify build.
    Run `cd packages/mobile && npx tsc --noEmit 2>&1 | head -20` for mobile type check.
    Verify QueryProvider wraps admin app in layout.tsx.
    Verify sidebar has SidebarUser component with signOut.
    Verify mobile upload.ts imports from @upoe/shared.
  </verify>
  <done>
    Admin QueryProvider wraps the app. useAuth/useRole hooks functional on both platforms. File upload utility works for mobile (ImagePicker) with shared path generation. Admin sidebar shows user email, role label, and functional "Cerrar Sesion" button. Active nav link highlighting works.
  </done>
</task>

</tasks>

<verification>
1. `grep -r "useAuth" packages/mobile/src/hooks/` returns useAuth.ts
2. `grep -r "useAuth" packages/admin/src/hooks/` returns useAuth.ts
3. `grep -r "signOut" packages/mobile/src/hooks/useAuth.ts` returns match
4. `grep -r "signOut" packages/admin/src/hooks/useAuth.ts` returns match
5. `grep -r "QueryProvider" packages/admin/src/app/layout.tsx` returns match (wrapped)
6. `grep -r "pickAndUploadImage" packages/mobile/src/lib/upload.ts` returns match
7. `grep -r "Cerrar Sesion" packages/admin/src/app/(dashboard)/` returns match (sidebar logout)
8. `cd packages/admin && pnpm build` succeeds
</verification>

<success_criteria>
- useAuth() returns user, session, role, communityId, signOut, isLoading on both platforms
- useRole() returns boolean helpers (isResident, isGuard, isAdmin, etc.) on both platforms
- signOut clears session and navigates to auth screen on both platforms
- TanStack Query provider configured and wrapping admin app
- Mobile file upload utility picks image and uploads to Supabase Storage
- Admin sidebar displays user info and has working logout button
- Both apps build/typecheck without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-auth-shared-infrastructure/09-05-SUMMARY.md`
</output>
