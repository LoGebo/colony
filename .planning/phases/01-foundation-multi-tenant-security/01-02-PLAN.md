---
phase: 01-foundation-multi-tenant-security
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00003_base_enums.sql
autonomous: true

must_haves:
  truths:
    - "Status enums exist for common workflow states"
    - "Unit types enum covers all property types (casa, departamento, local, bodega)"
    - "User roles enum defines all system roles"
    - "Financial amount type is NUMERIC(15,4) not float"
  artifacts:
    - path: "database type: status_enum"
      provides: "Common active/inactive/pending/archived states"
    - path: "database type: unit_type_enum"
      provides: "Property types for CRM phase"
    - path: "database type: user_role_enum"
      provides: "System roles for access control"
    - path: "database domain: money_amount"
      provides: "NUMERIC(15,4) type for all financial fields"
  key_links:
    - from: "status_enum"
      to: "All tables with status columns"
      via: "Column type definition"
    - from: "money_amount"
      to: "All financial tables (Phase 4)"
      via: "Column type for amount fields"
---

<objective>
Create base database types and enums that will be used across all subsequent phases. This includes status enums, domain-specific enums, and the money_amount domain type for financial calculations.

Purpose: Define types once, use everywhere. Prevents inconsistencies (e.g., one table using 'ACTIVE', another using 'active', another using 1). Critical for financial amounts - NUMERIC(15,4) prevents floating point errors.

Output: One migration with all base types and enums.
</objective>

<execution_context>
@C:\Users\PC\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\PC\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/research/PITFALLS.md

Key decisions from research:
- NUMERIC(15,4) for money - GAAP requires 4 decimal places, never use float/real/money type
- Status values should be lowercase for consistency
- Enums are immutable once in production - design carefully
- Mexican property management context: unit types are casa, departamento, local, bodega
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create base enums and domain types</name>
  <files>supabase/migrations/00003_base_enums.sql</files>
  <action>
Apply a Supabase migration using mcp__supabase__apply_migration with name "base_enums" containing:

```sql
-- ============================================
-- BASE ENUMS FOR UPOE
-- ============================================
-- These enums are used across multiple tables and phases.
-- IMPORTANT: Enum values cannot be removed in production,
-- only added. Design carefully.

-- ============================================
-- GENERAL STATUS ENUM
-- ============================================
-- Universal status for records that can be activated/deactivated

CREATE TYPE general_status AS ENUM (
  'active',
  'inactive',
  'pending',
  'archived',
  'suspended'
);

COMMENT ON TYPE general_status IS
  'Universal status enum for entities. Use pending for items awaiting action.';

-- ============================================
-- APPROVAL STATUS ENUM
-- ============================================
-- For items that go through approval workflow

CREATE TYPE approval_status AS ENUM (
  'pending',
  'approved',
  'rejected',
  'cancelled',
  'expired'
);

COMMENT ON TYPE approval_status IS
  'Status for items in approval workflows (invitations, payments, documents).';

-- ============================================
-- USER ROLES ENUM
-- ============================================
-- System-wide user roles

CREATE TYPE user_role AS ENUM (
  'super_admin',    -- Platform level, all communities
  'admin',          -- Community administrator
  'manager',        -- Community manager (partial admin)
  'guard',          -- Security personnel
  'resident',       -- Property resident (owner or tenant)
  'provider',       -- Service provider
  'visitor'         -- Temporary access
);

COMMENT ON TYPE user_role IS
  'System roles determining access level. Stored in JWT app_metadata.';

-- ============================================
-- UNIT TYPES ENUM
-- ============================================
-- Types of properties within a community

CREATE TYPE unit_type AS ENUM (
  'casa',           -- House
  'departamento',   -- Apartment
  'local',          -- Commercial space
  'bodega',         -- Storage unit
  'oficina',        -- Office
  'terreno',        -- Land/lot
  'estacionamiento' -- Parking space (when sold/rented separately)
);

COMMENT ON TYPE unit_type IS
  'Property unit types in Mexican residential communities.';

-- ============================================
-- OCCUPANCY TYPES ENUM
-- ============================================
-- Relationship between resident and unit

CREATE TYPE occupancy_type AS ENUM (
  'owner',          -- Property owner
  'tenant',         -- Renting the property
  'authorized',     -- Authorized occupant (family member, etc.)
  'employee'        -- Domestic employee living on premises
);

COMMENT ON TYPE occupancy_type IS
  'Type of resident relationship to a unit.';

-- ============================================
-- ACCESS DECISION ENUM
-- ============================================
-- Security access decisions

CREATE TYPE access_decision AS ENUM (
  'allowed',
  'pending',
  'denied',
  'blocked'
);

COMMENT ON TYPE access_decision IS
  'Access control decisions. blocked > denied > pending > allowed for conflict resolution.';

-- ============================================
-- EMERGENCY TYPES ENUM
-- ============================================
-- Types of emergency alerts

CREATE TYPE emergency_type AS ENUM (
  'panic',          -- Panic button / general emergency
  'medical',        -- Medical emergency
  'fire',           -- Fire emergency
  'intrusion',      -- Security breach
  'natural_disaster' -- Earthquake, flood, etc.
);

COMMENT ON TYPE emergency_type IS
  'Types of emergency alerts for quick categorization and response.';

-- ============================================
-- PRIORITY LEVELS ENUM
-- ============================================
-- Universal priority levels

CREATE TYPE priority_level AS ENUM (
  'low',
  'medium',
  'high',
  'urgent',
  'critical'
);

COMMENT ON TYPE priority_level IS
  'Priority levels for tickets, alerts, and notifications.';

-- ============================================
-- MONEY AMOUNT DOMAIN TYPE
-- ============================================
-- CRITICAL: Always use this for financial amounts
-- NEVER use float, real, double precision, or money type

CREATE DOMAIN money_amount AS NUMERIC(15, 4)
  CHECK (VALUE IS NULL OR VALUE >= 0);

COMMENT ON DOMAIN money_amount IS
  'Domain type for all monetary values.
   NUMERIC(15,4) supports up to 99,999,999,999.9999 with 4 decimal precision.
   4 decimals required for GAAP compliance and interest calculations.
   NEVER use float/real/money types for financial data.';

-- For amounts that can be negative (credits, adjustments)
CREATE DOMAIN money_amount_signed AS NUMERIC(15, 4);

COMMENT ON DOMAIN money_amount_signed IS
  'Domain type for monetary values that can be negative (credits, adjustments, journal entries).';

-- ============================================
-- CURRENCY CODE TYPE
-- ============================================
-- ISO 4217 currency codes

CREATE DOMAIN currency_code AS VARCHAR(3)
  CHECK (VALUE ~ '^[A-Z]{3}$');

COMMENT ON DOMAIN currency_code IS
  'ISO 4217 3-letter currency code (MXN, USD, EUR, etc.).';

-- ============================================
-- PHONE NUMBER TYPE
-- ============================================
-- E.164 format phone numbers

CREATE DOMAIN phone_number AS VARCHAR(20)
  CHECK (VALUE IS NULL OR VALUE ~ '^\+?[0-9]{10,15}$');

COMMENT ON DOMAIN phone_number IS
  'Phone number in E.164 format. Allows + prefix and 10-15 digits.';

-- ============================================
-- TIMEZONE TYPE
-- ============================================
-- Valid PostgreSQL timezone names

CREATE DOMAIN timezone_name AS TEXT
  CHECK (VALUE IS NULL OR VALUE IN (
    SELECT name FROM pg_timezone_names
  ));

-- Note: The CHECK constraint above is evaluated at domain creation.
-- For dynamic validation, use a trigger instead.

-- Simpler version that accepts any text (validate in application):
DROP DOMAIN IF EXISTS timezone_name;
CREATE DOMAIN timezone_name AS TEXT;

COMMENT ON DOMAIN timezone_name IS
  'Timezone identifier (e.g., America/Mexico_City). Validated at application level.';

-- ============================================
-- LOCALE TYPE
-- ============================================
-- Language/region codes

CREATE DOMAIN locale_code AS VARCHAR(10)
  CHECK (VALUE IS NULL OR VALUE ~ '^[a-z]{2}(-[A-Z]{2})?$');

COMMENT ON DOMAIN locale_code IS
  'BCP 47 locale code (es, es-MX, en-US, etc.).';
```

CRITICAL REMINDERS:
- money_amount uses NUMERIC(15,4), NOT float/real/money
- Enum values are lowercase for consistency
- Enums can only ADD values in production, never remove
- Domain types with CHECK constraints provide data integrity
  </action>
  <verify>
Execute SQL via mcp__supabase__execute_sql to verify all types exist:

```sql
-- Test 1: Verify all enums exist
SELECT
  t.typname AS enum_name,
  array_agg(e.enumlabel ORDER BY e.enumsortorder) AS values
FROM pg_type t
JOIN pg_enum e ON t.oid = e.enumtypid
WHERE t.typname IN (
  'general_status',
  'approval_status',
  'user_role',
  'unit_type',
  'occupancy_type',
  'access_decision',
  'emergency_type',
  'priority_level'
)
GROUP BY t.typname
ORDER BY t.typname;

-- Test 2: Verify domain types exist
SELECT
  domain_name,
  data_type,
  numeric_precision,
  numeric_scale
FROM information_schema.domains
WHERE domain_schema = 'public'
  AND domain_name IN ('money_amount', 'money_amount_signed', 'currency_code', 'phone_number', 'timezone_name', 'locale_code');

-- Test 3: Verify money_amount has correct precision
SELECT
  domain_name,
  numeric_precision = 15 AS correct_precision,
  numeric_scale = 4 AS correct_scale
FROM information_schema.domains
WHERE domain_name = 'money_amount';
```

Should show:
- 8 enum types with their values
- 6 domain types
- money_amount with precision=15, scale=4
  </verify>
  <done>
All base enums (general_status, approval_status, user_role, unit_type, occupancy_type, access_decision, emergency_type, priority_level) and domain types (money_amount, currency_code, phone_number, timezone_name, locale_code) exist in database with correct constraints.
  </done>
</task>

</tasks>

<verification>
Quick verification that critical types exist:

```sql
-- Verify enum count
SELECT COUNT(DISTINCT typname) AS enum_count
FROM pg_type t
JOIN pg_enum e ON t.oid = e.enumtypid
WHERE t.typnamespace = 'public'::regnamespace;

-- Should be 8

-- Verify money_amount works correctly
SELECT
  '100.1234'::money_amount AS test_amount,
  '100.1234'::money_amount + '0.0001'::money_amount AS precise_addition,
  '1000000000.9999'::money_amount AS large_amount;
```
</verification>

<success_criteria>
- [ ] general_status enum has: active, inactive, pending, archived, suspended
- [ ] approval_status enum has: pending, approved, rejected, cancelled, expired
- [ ] user_role enum has: super_admin, admin, manager, guard, resident, provider, visitor
- [ ] unit_type enum has: casa, departamento, local, bodega, oficina, terreno, estacionamiento
- [ ] money_amount domain is NUMERIC(15,4) with CHECK >= 0
- [ ] money_amount_signed domain is NUMERIC(15,4) without positivity check
- [ ] currency_code domain validates 3-letter codes
- [ ] phone_number domain accepts E.164 format
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-multi-tenant-security/01-02-SUMMARY.md`
</output>
