# Roadmap: UPOE Database Architecture

## Overview

This roadmap delivers the complete Supabase database schema for UPOE (Unified Property Operations Ecosystem) across 8 phases. Starting with multi-tenant foundation and RLS security, we build through identity, access control, financials, community features, and operational systems. Each phase creates tables, types, RLS policies, and indexes that subsequent phases depend on. The 147 requirements across 24 domains map to natural delivery boundaries where each phase delivers a coherent, testable capability.

## Phases

**Phase Numbering:**
- Integer phases (1, 2, 3): Planned milestone work
- Decimal phases (2.1, 2.2): Urgent insertions (marked with INSERTED)

Decimal phases appear between their surrounding integers in numeric order.

- [x] **Phase 1: Foundation & Multi-Tenant Security** - Core tables, RLS patterns, audit infrastructure ✓
- [x] **Phase 2: Identity & CRM** - Units, residents, vehicles, pets, onboarding ✓
- [x] **Phase 3: Access Control & Security** - Gates, guards, visitors, patrols, emergencies ✓
- [x] **Phase 4: Financial Engine** - Double-entry ledger, fees, payments, reconciliation ✓
- [x] **Phase 5: Amenities, Communication & Marketplace** - Reservations, social wall, listings ✓
- [x] **Phase 6: Maintenance, Chat, Documents & Notifications** - Tickets, messaging, files, alerts ✓
- [x] **Phase 7: Operations & Compliance** - Packages, providers, moves, audit, config ✓
- [ ] **Phase 8: Governance & Analytics** - Incidents, voting, parking, keys, violations, metrics, integrations

## Phase Details

### Phase 1: Foundation & Multi-Tenant Security
**Goal**: Establish the multi-tenant architecture with RLS-enforced isolation, audit patterns, and base types that all subsequent tables depend on
**Depends on**: Nothing (first phase)
**Requirements**: FOUND-01, FOUND-02, FOUND-03, FOUND-04, FOUND-05, FOUND-06, FOUND-07
**Success Criteria** (what must be TRUE):
  1. Organizations and communities tables exist with proper RLS policies
  2. All tables use UUID v7 primary keys generated by database functions
  3. Soft delete pattern (deleted_at) functions correctly on test tables
  4. RLS policies correctly filter by community_id from JWT app_metadata
  5. Audit columns (created_at, updated_at, deleted_at, created_by) auto-populate via triggers
**Plans**: 3 plans in 2 waves

Plans:
- [x] 01-01-PLAN.md - Core utilities: UUID v7 function, audit triggers, RLS helpers (Wave 1) ✓
- [x] 01-02-PLAN.md - Base enums and domain types for status fields (Wave 1) ✓
- [x] 01-03-PLAN.md - Organizations and communities tables with RLS policies (Wave 2) ✓

### Phase 2: Identity & CRM
**Goal**: Model the core entities that identify who lives in each community - units, residents, vehicles, and pets with their relationships
**Depends on**: Phase 1 (needs community_id, RLS patterns, audit columns)
**Requirements**: CRM-01, CRM-02, CRM-03, CRM-04, CRM-05, CRM-06, CRM-07
**Success Criteria** (what must be TRUE):
  1. Units can be created with type (casa, departamento, local, bodega), area, and coefficient
  2. Residents link to units via occupancy junction with owner/tenant/authorized roles
  3. Vehicles link to residents/units with LPR-ready plate storage
  4. Pets have vaccination records and incident history tracking
  5. Onboarding workflow states transition correctly (invited -> registered -> verified -> active)
**Plans**: 3 plans in 3 waves

Plans:
- [x] 02-01-PLAN.md - Create units table with types, areas, coefficients, and CRM enums (Wave 1) ✓
- [x] 02-02-PLAN.md - Create residents, occupancies, vehicles, pets tables with RLS (Wave 2) ✓
- [x] 02-03-PLAN.md - Create resident documents table and storage bucket with RLS (Wave 3) ✓

### Phase 3: Access Control & Security
**Goal**: Model the security operations infrastructure - access points, guards, visitors, patrols, and emergency alerts
**Depends on**: Phase 2 (needs residents, units, vehicles for visitor relationships)
**Requirements**: ACC-01, ACC-02, ACC-03, ACC-04, ACC-05, ACC-06, ACC-07, ACC-08, ACC-09, ACC-10, ACC-11
**Success Criteria** (what must be TRUE):
  1. Access points (gates, barriers, doors) can be configured per community
  2. Invitations support single-use, event, recurring, and vehicle pre-auth types
  3. Access logs are immutable with photos, timestamps, method, and result
  4. Blacklist entries have protocols, evidence, and expiration dates
  5. Patrol routes with NFC checkpoints can be defined and logged
  6. Emergency alerts (panic, fire, medical) capture type, location, and dispatch status
  7. QR codes store cryptographic signatures with burn status
**Plans**: 4 plans in 3 waves

Plans:
- [x] 03-01-PLAN.md - Access point enums and tables, guards, shifts, assignments (Wave 1) ✓
- [x] 03-02-PLAN.md - Invitations with polymorphic validation, immutable access logs, blacklist (Wave 2) ✓
- [x] 03-03-PLAN.md - Patrol checkpoints with NFC serial, routes, patrol logs (Wave 2) ✓
- [x] 03-04-PLAN.md - QR codes with HMAC signatures, emergency alerts and responders (Wave 3) ✓

### Phase 4: Financial Engine
**Goal**: Implement double-entry accounting with fee structures, payments, reconciliation, and delinquency management
**Depends on**: Phase 2 (needs units for fee assignment, residents for payment attribution)
**Requirements**: FIN-01, FIN-02, FIN-03, FIN-04, FIN-05, FIN-06, FIN-07, FIN-08, FIN-09, FIN-10, FIN-11
**Success Criteria** (what must be TRUE):
  1. Fee structures support fixed, coefficient-based, and hybrid formulas
  2. Chart of accounts enables proper double-entry categorization
  3. Ledger entries enforce debit/credit balance (sum must equal zero)
  4. Transactions (payments, charges, adjustments) create corresponding ledger entries
  5. Interest/penalty rules can be configured per community
  6. Delinquency triggers (days -> action) are configurable
  7. Bank accounts and statement imports support reconciliation workflow
  8. Payment proofs flow through validation workflow (pending -> approved/rejected)
**Plans**: 4 plans in 3 waves

Plans:
- [x] 04-01-PLAN.md - Chart of accounts and ledger entries with immutability triggers (Wave 1) ✓
- [x] 04-02-PLAN.md - Fee structures, schedules, payment/charge recording functions (Wave 2) ✓
- [x] 04-03-PLAN.md - Interest rules, delinquency triggers, budgets (Wave 2) ✓
- [x] 04-04-PLAN.md - Bank accounts, statement imports, payment proofs, unit_balances view (Wave 3) ✓

### Phase 5: Amenities, Communication & Marketplace
**Goal**: Enable community engagement through amenity reservations, social communication, and internal marketplace
**Depends on**: Phase 2 (needs residents/units for reservations, posts, listings)
**Requirements**: AMEN-01, AMEN-02, AMEN-03, AMEN-04, AMEN-05, AMEN-06, AMEN-07, COMM-01, COMM-02, COMM-03, COMM-04, COMM-05, COMM-06, COMM-07, COMM-08, COMM-09, MRKT-01, MRKT-02, MRKT-03, MRKT-04, MRKT-05, MRKT-06, MRKT-07
**Success Criteria** (what must be TRUE):
  1. Amenities have schedules, capacity, rules, and photos
  2. Reservation slots prevent double-booking via exclusion constraints
  3. Booking rules engine enforces quotas, advance windows, and restrictions
  4. Waitlist entries auto-promote when slots become available
  5. Channels support categorized community discussions with moderation
  6. Posts have content, media, reactions, and nested comments
  7. Announcements target segments with read receipt tracking
  8. Surveys enforce one-vote-per-unit
  9. Marketplace listings support sale, service, rental, wanted types
  10. Safe exchange zones and moderation queue function correctly
**Plans**: 5 plans in 2 waves

Plans:
- [x] 05-01-PLAN.md - Amenity enums, amenities table with schedules, booking rules engine (Wave 1) ✓
- [x] 05-02-PLAN.md - Reservations with exclusion constraints, waitlist auto-promotion, fees (Wave 2) ✓
- [x] 05-03-PLAN.md - Channels, posts, nested comments, reactions with denormalized counters (Wave 1) ✓
- [x] 05-04-PLAN.md - Announcements with segment targeting, surveys with one-vote-per-unit (Wave 2) ✓
- [x] 05-05-PLAN.md - Marketplace listings, exchange zones, moderation queue with SKIP LOCKED (Wave 1) ✓

### Phase 6: Maintenance, Chat, Documents & Notifications
**Goal**: Operational support systems for maintenance requests, real-time messaging, document management, and notification delivery
**Depends on**: Phase 2 (needs residents for ticket creation, messaging), Phase 5 (patterns for media/attachments)
**Requirements**: MAINT-01, MAINT-02, MAINT-03, MAINT-04, MAINT-05, MAINT-06, MAINT-07, MAINT-08, MAINT-09, MAINT-10, CHAT-01, CHAT-02, CHAT-03, CHAT-04, CHAT-05, CHAT-06, DOCS-01, DOCS-02, DOCS-03, DOCS-04, DOCS-05, DOCS-06, NOTIF-01, NOTIF-02, NOTIF-03, NOTIF-04, NOTIF-05, NOTIF-06
**Success Criteria** (what must be TRUE):
  1. Tickets have category, priority, status, SLA tracking, and assignment workflow
  2. SLA definitions per category/priority enable breach detection
  3. Preventive maintenance schedules auto-generate tickets
  4. Asset registry tracks community infrastructure (pumps, elevators)
  5. Conversations support 1:1, group, and guard-booth patterns
  6. Messages have text, media, read receipts, and reactions
  7. Document categories organize legal, assembly, financial, operational files
  8. Documents support versioning and access permissions
  9. Regulation signatures capture timestamp, IP, device
  10. Notifications track type, channel, recipient, and delivery status
  11. Push tokens register FCM/APNs devices
  12. User notification preferences control what and how
**Plans**: 5 plans in 2 waves

Plans:
- [x] 06-01-PLAN.md - Ticket categories, tickets with state machine, SLA definitions, assignments (Wave 1) ✓
- [x] 06-02-PLAN.md - Assets, preventive schedules with RRULE, escalation rules (Wave 2) ✓
- [x] 06-03-PLAN.md - Conversations, participants, messages, read receipts, reactions (Wave 1) ✓
- [x] 06-04-PLAN.md - Documents, versioning, permissions, regulation signatures (Wave 1) ✓
- [x] 06-05-PLAN.md - Notifications, push tokens, preferences, templates (Wave 2) ✓

### Phase 7: Operations & Compliance
**Goal**: Package management, provider relationships, move coordination, comprehensive audit logging, and system configuration
**Depends on**: Phase 2 (residents for packages), Phase 3 (access for provider schedules), Phase 4 (deposits for moves)
**Requirements**: PKG-01, PKG-02, PKG-03, PKG-04, PKG-05, PKG-06, PROV-01, PROV-02, PROV-03, PROV-04, PROV-05, PROV-06, MOVE-01, MOVE-02, MOVE-03, MOVE-04, MOVE-05, AUDIT-01, AUDIT-02, AUDIT-03, AUDIT-04, AUDIT-05, CONFIG-01, CONFIG-02, CONFIG-03, CONFIG-04, CONFIG-05
**Success Criteria** (what must be TRUE):
  1. Packages track carrier, recipient, storage location, and pickup workflow
  2. Pickup codes (PIN/QR) and signatures validate package handoff
  3. Provider companies have contact, specialties, and authorized personnel
  4. Provider documentation tracks insurance/certifications with expiration
  5. Provider access schedules restrict allowed days/hours
  6. Move requests coordinate date, time window, moving company
  7. Pre-move validations check debt-free, keys, vehicles
  8. Damage deposits flow through refund workflow
  9. Audit log captures entity, action, actor, before/after for all sensitive operations
  10. User sessions track device, IP, location
  11. Community settings configure hours, rules, branding
  12. Feature flags enable/disable features per community
  13. Roles and permissions matrix is configurable
**Plans**: 5 plans in 2 waves

Plans:
- [x] 07-01-PLAN.md - Packages, storage locations, pickup codes (PIN/QR with HMAC), signatures (Wave 1) ✓
- [x] 07-02-PLAN.md - Providers, documents with expiration tracking, personnel, access schedules (Wave 1) ✓
- [x] 07-03-PLAN.md - Move requests, auto-generated validations, damage deposits with refund workflow (Wave 1) ✓
- [x] 07-04-PLAN.md - Audit schema, immutable audit_log, user sessions, security events (Wave 2) ✓
- [x] 07-05-PLAN.md - Community settings, JSONB feature flags, roles, permissions, RBAC functions (Wave 2) ✓

### Phase 8: Governance & Analytics
**Goal**: Complete the system with incident management, formal voting, parking, keys, violations, pre-computed analytics, and external integrations
**Depends on**: All previous phases (incidents reference many entities, analytics aggregate all data)
**Requirements**: INC-01, INC-02, INC-03, INC-04, INC-05, INC-06, VOTE-01, VOTE-02, VOTE-03, VOTE-04, VOTE-05, VOTE-06, VOTE-07, PARK-01, PARK-02, PARK-03, PARK-04, PARK-05, KEY-01, KEY-02, KEY-03, KEY-04, KEY-05, KEY-06, EMERG-01, EMERG-02, EMERG-03, EMERG-04, VIOL-01, VIOL-02, VIOL-03, VIOL-04, VIOL-05, VIOL-06, ANLY-01, ANLY-02, ANLY-03, ANLY-04, ANLY-05, ANLY-06, INTG-01, INTG-02, INTG-03, INTG-04, INTG-05, INTG-06
**Success Criteria** (what must be TRUE):
  1. Incidents have type, severity, location, media, timeline, and resolution workflow
  2. Elections support board elections and extraordinary decisions
  3. Ballots enable weighted voting by coefficient with quorum tracking
  4. Assembly events track attendance and proxy delegation
  5. Parking spots are inventoried by type with assignments per unit
  6. Visitor parking reservations and violations are tracked
  7. Access devices (tag, remote, key, card) have inventory with serial numbers
  8. Device assignments, returns, and lost reports flow correctly
  9. Emergency contacts per resident have relationship and priority
  10. Medical conditions and accessibility requirements are recorded
  11. Violation types have default penalties; records capture evidence
  12. Warnings, sanctions, and appeals flow through resolution
  13. Pre-computed KPIs aggregate daily/weekly/monthly metrics
  14. Access patterns, financial summaries, and utilization stats are queryable
  15. Integration configurations store credentials and connection status
  16. Webhook endpoints and API keys enable third-party access
**Plans**: TBD

Plans:
- [ ] 08-01: Create incident types, incidents, media, timeline
- [ ] 08-02: Create elections, candidates, ballots, quorum
- [ ] 08-03: Create assembly events, attendance, agreements
- [ ] 08-04: Create parking spots, assignments, reservations, violations
- [ ] 08-05: Create access device types, inventory, assignments
- [ ] 08-06: Create emergency contacts, medical conditions, responders
- [ ] 08-07: Create violation types, records, sanctions, appeals
- [ ] 08-08: Create analytics KPIs, summaries, metrics tables
- [ ] 08-09: Create integrations, webhooks, API keys, sync status

## Progress

**Execution Order:**
Phases execute in numeric order: 1 -> 2 -> 3 -> 4 -> 5 -> 6 -> 7 -> 8

| Phase | Plans Complete | Status | Completed |
|-------|----------------|--------|-----------|
| 1. Foundation & Multi-Tenant Security | 3/3 | Complete ✓ | 2026-01-29 |
| 2. Identity & CRM | 3/3 | Complete ✓ | 2026-01-29 |
| 3. Access Control & Security | 4/4 | Complete ✓ | 2026-01-29 |
| 4. Financial Engine | 4/4 | Complete ✓ | 2026-01-29 |
| 5. Amenities, Communication & Marketplace | 5/5 | Complete ✓ | 2026-01-29 |
| 6. Maintenance, Chat, Documents & Notifications | 5/5 | Complete ✓ | 2026-01-30 |
| 7. Operations & Compliance | 5/5 | Complete ✓ | 2026-01-30 |
| 8. Governance & Analytics | 0/9 | Not started | - |

**Total:** 29/38 plans

---
*Roadmap created: 2026-01-29*
*Last updated: 2026-01-30 - Phase 7 complete*
